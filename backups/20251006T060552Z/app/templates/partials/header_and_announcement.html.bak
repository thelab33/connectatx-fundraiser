{# =========================
   Header — MVP v1.4 (Refined • A11y/Perf/Safety)
   SAFE: computes its own funds/pct with fallbacks
   ========================= #}
{% set NONCE    = NONCE if NONCE is defined else (csp_nonce if csp_nonce is defined else '') %}
{% set _hdr_id  = header_id if header_id is defined and header_id else 'site-header' %}
{% set _team    = team if team is defined and team else none %}

{% set platform_name  = platform_name if platform_name is defined and platform_name else 'FundChamps' %}
{% set platform_url   = platform_url if platform_url is defined and platform_url else '/' %}
{% set _p_logo_svg    = 'images/fundchamps-logo.svg' %}
{% set platform_logo_svg = (url_for('static', filename=_p_logo_svg) if url_for is defined else '/static/' ~ _p_logo_svg) %}

{% set team_name   = _team.team_name if _team and _team.team_name is defined else 'Connect ATX Elite' %}
{% set brand_color = (_team.theme_color if _team and _team.theme_color is defined and _team.theme_color else '#facc15') %}
{% set stripe_payment_link = (stripe_payment_link|default('', true)) %}

{# ---- SAFE progress math (never raises) ---- #}
{% set _fr  = (funds_raised|default(0, true))|float %}
{% set _fg0 = (fundraising_goal|default(10000, true))|float %}
{% set _fg  = (1.0 if _fg0 <= 0 else _fg0) %}
{% set _raw = (_fr / _fg * 100.0) %}
{% set pct  = 0.0 if _raw < 0 else (100.0 if _raw > 100 else _raw) %}

{% set _logo = (_team.logo if _team and _team.logo else 'images/logo.webp') %}
{% set logoSrc = (_logo if _logo.startswith('http') else (url_for('static', filename=_logo.lstrip('/')) if url_for is defined else '/static/' ~ _logo.lstrip('/'))) %}

{# Optional: preconnect to Stripe when a payment link exists #}
{% if stripe_payment_link %}
<link rel="preconnect" href="https://js.stripe.com" crossorigin>
{% endif %}

<header id="{{ _hdr_id }}"
        class="fc-header"
        role="banner"
        data-accent="{{ ACCENT_HEX }}"
        style="--accent:{{ ACCENT_HEX }}">
  <div class="hdr-grid">
    <!-- 1) Platform crest -->
    <a href="{{ platform_url }}"
       class="crest"
       aria-label="{{ platform_name }} home"
       data-analytics="nav:brand">
      <img src="{{ platform_logo_svg }}" alt="" class="crest-logo" />
      <span class="crest-meta">
        <small class="powered">POWERED&nbsp;BY</small>
        <span class="word">Fund<span>Champs</span></span>
      </span>
    </a>

    <!-- 2) Centre hub -->
    <div class="hub" role="group" aria-label="Fundraiser status and actions">
      <!-- progress meter -->
      <div id="hdr-meter"
           class="meter"
           role="meter"
           aria-valuemin="0" aria-valuemax="100"
           aria-valuenow="{{ pct|round(1) }}"
           aria-label="Fundraising progress">
        <div class="track" aria-hidden="true">
          <div class="fill" style="width:{{ pct|round(1) }}%"></div>
        </div>
        <span class="pct">{{ pct|round(0) }}%</span>
      </div>

      <!-- CTAs -->
      <div class="cta" role="group" aria-label="Primary actions">
        <a href="#tiers" class="btn btn-ghost hide-sm">Sponsor a Champion</a>

        <a href="{{ HREF_DONATE }}"
           class="btn btn-donate pulse"
           id="hdr-donate"
           data-analytics="cta:donate-header">
          Donate with FundChamps
        </a>

        <span id="hdr-total-pill" class="pill hide-sm" aria-live="polite">$0</span>

        <button id="hdr-share"
                class="btn btn-lite btn-sm"
                aria-label="Share this fundraiser"
                data-share='{{ {
                  "title":"Support "~team_name,
                  "text":"Every dollar moves a kid forward — join us!",
                  "url":(request.base_url if request is defined else "/")
                }|tojson|e }}'>
          Share
        </button>

        <!-- theme toggle (optional JS already prepared) -->
        <button id="theme-toggle" class="btn btn-lite btn-sm" aria-label="Toggle theme">
          <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor"
               stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"
               aria-hidden="true">
            <g class="sun">
              <circle cx="12" cy="12" r="5"/>
              <line x1="12" y1="1"  x2="12" y2="3"/>
              <line x1="12" y1="21" x2="12" y2="23"/>
              <line x1="4.22" y1="4.22"  x2="5.64" y2="5.64"/>
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
              <line x1="1" y1="12" x2="3"  y2="12"/>
              <line x1="21" y1="12" x2="23" y2="12"/>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
            </g>
            <path class="moon" d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79Z" style="display:none"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- 3) Team crest -->
    <a href="{{ home_url|default('/') }}"
       class="team-link"
       aria-label="{{ team_name }} home"
       data-analytics="nav:team">
      <img src="{{ logoSrc }}" alt="" class="team-logo"/>
      <span class="team-chip">{{ team_name }}</span>
    </a>

    <!-- mobile burger -->
    <button id="menu-toggle"
            class="burger"
            aria-label="Open menu"
            aria-expanded="false"
            aria-controls="site-menu">
      <span class="burger-line"></span>
    </button>
  </div>
</header>

<!-- Micro ticker: rendered only if we want a header ribbon -->
<div id="sponsor-leaderboard" hidden aria-live="polite" role="status"></div>

<!-- mobile slide-in -->
<template id="mobile-nav-tpl">
  <nav id="site-menu" class="mobile-sheet hidden" role="dialog" aria-modal="true" aria-label="Mobile menu">
    <button class="close" aria-label="Close">✕</button>
    <a href="#tiers">Tiers</a>
    <a href="#impact">Impact</a>
    <a href="#about">About</a>
    <a href="{{ HREF_DONATE }}" class="btn btn-donate mt-auto">Donate</a>
  </nav>
</template>

<!-- Quick-donate pill -->
<a href="#donate"
   class="quick-donate"
   data-open-donate-modal
   data-analytics="cta:quick-donate"
   aria-label="Quick donate button"
   hidden></a>
   
   <style {{ nonce_attr() }}>
/* ==========================================================
   FundChamps • Header Elite v5 (agency-polished)
   - Three-lane grid (crest | hub | team)
   - Dark-first, glassy surface, motion-safe
   - All original IDs/classes preserved for JS
   ========================================================== */

/* ---------- Theme tokens */
:root{
  --accent: {{ ACCENT_HEX }};
  --surface: rgba(16,16,20,.86);
  --surface-2: rgba(22,24,30,.9);
  --border: rgba(255,255,255,.06);
  --text: #e8eaf0;
  --muted: #aeb2bb;
  --donate: var(--accent, #facc15);
}
[data-theme="light"]{
  --surface: rgba(255,255,255,.82);
  --surface-2: rgba(245,247,251,.96);
  --border: rgba(0,0,0,.08);
  --text: #17181c;
  --muted: #51555d;
}

/* ---------- Header container */
.fc-header{
  position: sticky; top: 0; inset-inline: 0; z-index: 60;
  background: var(--surface);
  backdrop-filter: blur(14px) saturate(1.05);
  border-bottom: 1px solid var(--border);
  box-shadow: 0 10px 28px rgba(0,0,0,.35), 0 0 0 1px rgba(255,255,255,.04) inset;
  transition: transform .35s ease, background .35s ease;
}
.fc-header::after{
  content:""; position:absolute; left:0; right:0; bottom:-1px; height:4px;
  background: linear-gradient(90deg,var(--accent),#fff3 50%,var(--accent));
  background-size:200% 100%;
  animation: hdrBar 7s linear infinite;
}
@keyframes hdrBar { to { background-position:-200% 0; } }

/* ---------- Grid lanes */
.hdr-grid{
  display:grid; grid-template-columns:auto 1fr auto;
  align-items:center; gap:.9rem;
  max-width:112rem; margin-inline:auto; padding:.6rem 1rem;
}

/* ---------- Crest (platform brand) */
.crest{ display:flex; align-items:center; gap:.8rem; text-decoration:none; }
.crest-logo{ height:42px; width:auto; max-width:170px; object-fit:contain; }
.crest-meta{ display:flex; flex-direction:column; line-height:1; }
.powered{ font:700 .68rem/1 "Inter",system-ui; color:color-mix(in srgb,var(--accent) 70%, #fff); letter-spacing:.06em }
.word{ font:800 1.05rem/1 "Poppins",system-ui; color:var(--text); text-transform:uppercase }
.word span{ color:color-mix(in srgb,var(--accent) 85%, #ffec) }

/* ---------- Hub (meter + CTAs) */
.hub{ justify-self:center; min-width:clamp(240px,42vw,520px); max-width:100%; display:flex; flex-direction:column; gap:.5rem; min-height:0; overflow:hidden; }
.hub > *{ min-width:0; }

/* Progress meter (slim rail) */
.meter{ display:grid; grid-template-columns:1fr auto; align-items:center; gap:.6rem; color:var(--text); }
.meter .track{
  position:relative; height:6px; border-radius:999px; overflow:hidden;
  background: linear-gradient(180deg, #0b0d12, #151820);
  box-shadow: 0 1px 0 rgba(255,255,255,.06) inset, 0 2px 6px rgba(0,0,0,.35);
  border: none;
}
.meter .fill{
  position:absolute; inset:0; width:inherit; /* width is inline style */
  background: linear-gradient(90deg, var(--accent), #fff8 78%);
  box-shadow: 0 0 18px color-mix(in srgb, var(--accent) 32%, transparent);
  transform-origin:left; transition: width .45s cubic-bezier(.2,.9,.35,1.2);
}
.meter .pct{ font:900 .78rem/1 "Inter"; letter-spacing:.02em; color:#f6f6f8; opacity:.9; }

/* CTA row + buttons */
.cta{ display:flex; align-items:center; gap:.55rem; flex-wrap:wrap; justify-content:center; }
.btn{
  display:inline-flex; align-items:center; justify-content:center; gap:.45em;
  padding:.62rem 1.05rem; border-radius:999px; text-transform:uppercase;
  font:900 .82rem/1 "Inter"; letter-spacing:.03em;
  background: var(--surface-2); color: var(--text);
  border:1px solid var(--border);
  box-shadow: 0 0 0 1px rgba(0,0,0,.2) inset;
  transition: transform .18s cubic-bezier(.2,.9,.35,1.2), box-shadow .18s, background .2s, color .2s;
}
.btn:hover,.btn:focus-visible{ transform: translateY(-2px); box-shadow: 0 10px 26px rgba(0,0,0,.28); outline:none; }

.btn-sm{ padding:.45rem .85rem; font-size:.75rem; }
.btn-ghost{
  background: transparent;
  border-style:dashed;
  border-color: color-mix(in srgb, var(--accent) 65%, #fff2);
}
.btn-ghost:hover{ background: color-mix(in srgb, var(--accent) 14%, transparent); }

.btn-lite{ background:#1d2128; border-color:#2a2e36; }
[data-theme="light"] .btn-lite{ background:#f5f7fb; border-color:#e8ecf3; }

.btn-donate{
  position:relative; isolation:isolate;
  border:2px solid var(--donate);
  color:#111; background: linear-gradient(180deg,#fffde9 0%, var(--donate) 98%);
  text-shadow: 0 1px 0 rgba(255,255,255,.6);
  padding:.78rem 2rem .78rem 2.35rem;
}
.btn-donate::before{
  content:"⚡"; position:absolute; left:1rem; top:50%; translate:0 -50%; font-size:1.05em;
}
.btn-donate::after{
  content:""; position:absolute; inset:0; border-radius:inherit;
  background: radial-gradient(ellipse at 50% 115%, rgba(255,255,255,.26), transparent 70%);
  filter: blur(10px); opacity:0; transition: opacity .25s;
}
.btn-donate:hover::after{ opacity:.9; }

/* Pulse utility (kept for donate) */
.pulse{ animation: pulseGlow 2s infinite; }
@keyframes pulseGlow{
  0%,100%{ filter: drop-shadow(0 0 0 rgba(255,255,255,0)); }
  50%    { filter: drop-shadow(0 0 10px rgba(255,255,255,.45)); }
}

/* Live total pill */
.pill{
  display:inline-block; padding:.28rem .75rem; border-radius:999px;
  font:700 .78rem/1 "Inter"; background:#e8ebf0; color:#111;
}
.pill[data-val]:not([data-val="0"]){ background: var(--accent); color:#111; }

/* ---------- Team end-cap */
.team-link{ display:inline-flex; align-items:center; gap:.6rem; text-decoration:none; transition: transform .2s ease; }
.team-link:hover{ transform: translateY(-1px); }
.team-logo{ height:42px; width:42px; border-radius:.5rem; object-fit:cover; box-shadow: 0 2px 8px rgba(0,0,0,.25); }
.team-chip{ max-width:10rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font:700 .85rem/1 "Inter"; color:var(--text); opacity:.9; }

/* Hide chip a bit earlier to prevent crowding */
@media (max-width:1100px){ .team-chip{ display:none; } }

/* ---------- Burger (mobile) */
.burger{
  grid-column:3; justify-self:end; display:none;
  width:40px; aspect-ratio:1; border-radius:.6rem;
  border:1px solid var(--border); background:var(--surface-2); color:var(--text);
  align-items:center; justify-content:center;
}
.burger-line, .burger-line::before, .burger-line::after{
  display:block; content:""; width:18px; height:2px; background:currentColor; border-radius:2px;
}
.burger-line{ position:relative; }
.burger-line::before{ position:absolute; left:0; top:-6px; }
.burger-line::after{ position:absolute; left:0; top:6px; }

/* ---------- Mobile sheet */
.mobile-sheet.hidden{ display:none; }
.mobile-sheet{
  position:fixed; inset:0; display:flex; flex-direction:column; gap:1rem;
  background: rgba(0,0,0,.65); backdrop-filter: blur(12px) saturate(1.1);
  padding:1rem; z-index:70;
}
.mobile-sheet .close{ align-self:flex-end; font-size:1.65rem; font-weight:800; color:var(--text); }
.mobile-sheet a{ color:var(--text); text-decoration:none; font:800 1rem/1.2 "Inter"; }
.mobile-sheet a:hover{ color: var(--accent); }
.mobile-sheet .btn-donate{ align-self:flex-start; margin-top:auto; }

/* ---------- Quick donate pill */
.quick-donate{
  position:fixed; right:1rem; bottom:1rem; z-index:60;
  background: color-mix(in srgb, var(--accent) 96%, #fff 12%);
  color:#111; font:900 .9rem/1 "Inter";
  padding:.65rem 1.1rem; border-radius:999px; box-shadow:0 10px 28px rgba(0,0,0,.25);
  transition: transform .2s ease, filter .2s ease;
}
.quick-donate:hover{ transform: translateY(-2px); filter: brightness(1.03); }

/* ---------- Utilities, a11y, motion */
.hide-sm{ display:inline-flex; }
:where(a,button,.btn,.burger):focus-visible{
  outline:none; box-shadow: 0 0 0 2px #000, 0 0 0 4px var(--accent);
}
.fc-header img, .fc-header svg{ max-height:46px; max-width:220px; object-fit:contain; }

@media (max-width:960px){
  .hide-sm{ display:none !important; }
  .burger{ display:inline-flex; }
  .hub{ min-width:unset; width:100%; }
}
@media (max-width:620px){
  .hdr-grid{ grid-template-columns:1fr auto; }
  .crest-meta, .team-chip{ display:none; }
  .team-link{ order:3; justify-self:start; }
  .burger{ order:4; }
  .cta{ justify-content:center; }
}
@media (max-width:420px){
  .btn-donate{ font-size:.8rem; padding:.7rem 1.6rem .7rem 2rem; }
}
@media (prefers-reduced-motion:reduce){
  *, *::before, *::after{ transition:none !important; animation:none !important; }
}

/* ---------- Scroll-hide utility (opt-in) */
html:not([data-hdr-static]) .fc-header.hide{ transform: translateY(-110%); }

/* ==========================================================
   Header Elite v5.1 — visual tune based on screenshot
   (Place after the v5 block)
   ========================================================== */

/* 1) Hub compacting: rail closer to CTAs, tighter rhythm */
.hub{ gap:.42rem; }

/* 2) Meter alignment and typography tweak */
.meter{ grid-template-columns: 1fr auto; gap:.5rem; }
.meter .track{ height:5px; }
.meter .pct{ font-size:.74rem; opacity:.85; }

/* 3) CTA height + pill radius tighter */
.btn{ padding:.56rem 1rem; border-radius:999px; }
.btn-sm{ padding:.42rem .8rem; }

/* 4) Donate stands out without feeling heavier */
.btn-donate{
  padding:.72rem 1.85rem .72rem 2.2rem;
  box-shadow: 0 1px 0 rgba(255,255,255,.4) inset, 0 6px 20px rgba(0,0,0,.25);
}
.btn-donate::before{ left:.95rem; }

/* 5) Header shrink state (works with your script’s .is-shrunk) */
.fc-header.is-shrunk .hdr-grid{ padding:.35rem 1rem; }
.fc-header.is-shrunk .crest-logo,
.fc-header.is-shrunk .team-logo{ height:36px; width:auto; }
.fc-header.is-shrunk .btn{ transform: none !important; }
.fc-header.is-shrunk .btn,
.fc-header.is-shrunk .btn-donate{ padding:.48rem .9rem; font-size:.78rem; }
.fc-header.is-shrunk .meter .pct{ font-size:.7rem; }

/* 6) Sponsor ticker: glass, fade mask, pause on hover
      (targets #hdr-ticker if you render it under the header) */
#hdr-ticker{
  --gap:1.1rem;
  position:absolute; left:50%; translate:-50% 0; top:100%;
  height:30px; display:flex; align-items:center; gap:var(--gap);
  padding-inline:1rem; white-space:nowrap; overflow:hidden;
  background: rgba(14,14,18,.7);
  border-bottom:1px solid rgba(255,255,255,.06);
  backdrop-filter: blur(10px) saturate(1.15);
  mask: linear-gradient(90deg, transparent 0, #000 6%, #000 94%, transparent);
  z-index: 59;
}
#hdr-ticker .item{
  flex:0 0 auto; padding:.3rem .7rem; border-radius:999px;
  font:800 .76rem/1 "Inter"; color:#f3f4f6;
  background: rgba(30,32,40,.45);
  border:1px solid rgba(255,255,255,.12);
  box-shadow: 0 1px 3px rgba(0,0,0,.25);
}
#hdr-ticker.scrolling{ animation: fcScrollX 22s linear infinite; }
#hdr-ticker:hover{ animation-play-state: paused; }
@keyframes fcScrollX{ to { transform: translateX(-50%); } }

/* 7) $0 pill readability on dark */
.pill{ background:#eef1f6; color:#0f1216; }
[data-theme="light"] .pill{ background:#101318; color:#fff; }

/* 8) Slightly stronger rail sheen */
.fc-header::after{ height:3px; background-size:220% 100%; }

/* 9) Better small-screen fit */
@media (max-width:960px){
  .hub{ width:100%; min-width:unset; }
}
@media (max-width:520px){
  .btn-ghost{ display:none; }
  .meter .pct{ display:none; }     /* tiny screens: rail only */
}
/* Micro Header Ticker — glass ribbon that sits under the header */
#hdr-ticker{
  --gap:1.1rem;
  position:sticky; top: var(--fc-header-h, 0px); /* sticks beneath header */
  height:30px; z-index:59;
  display:flex; align-items:center; gap:var(--gap);
  padding-inline:1rem; white-space:nowrap; overflow:hidden;
  background: rgba(14,14,18,.72);
  border-bottom:1px solid rgba(255,255,255,.06);
  backdrop-filter: blur(10px) saturate(1.15);
  mask: linear-gradient(90deg, transparent 0, #000 6%, #000 94%, transparent);
}
#hdr-ticker .item{
  flex:0 0 auto; padding:.3rem .7rem; border-radius:999px;
  font:800 .76rem/1 "Inter"; color:#f3f4f6;
  background: rgba(30,32,40,.45);
  border:1px solid rgba(255,255,255,.12);
  box-shadow: 0 1px 3px rgba(0,0,0,.25);
}
#hdr-ticker.scrolling{ animation: hdrScrollX 22s linear infinite; }
#hdr-ticker:hover{ animation-play-state: paused; }

@keyframes hdrScrollX{ to{ transform: translateX(-50%); } }

@media (max-width: 820px){ #hdr-ticker{ display:none; } } /* optional: hide on small */
@media (prefers-reduced-motion: reduce){ #hdr-ticker{ animation:none !important; } }

</style>

<script nonce="{{ NONCE }}">
(() => {
  // ──────────────────────────────────────────────────────────
  // Guard (single init)
  // ──────────────────────────────────────────────────────────
  if (window.__fcHeaderElite) return;
  window.__fcHeaderElite = true;

  // Helpers
  const $  = (sel, el = document) => el.querySelector(sel);
  const $$ = (sel, el = document) => Array.from(el.querySelectorAll(sel));
  const clamp = (v, lo, hi) => Math.min(hi, Math.max(lo, v));
  const fmtPct = n => `${Math.round(n)}%`;
  const fmtMoney = (n) => {
    const v = Number(n) || 0;
    try { return v.toLocaleString(undefined, { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }); }
    catch { return `$${Math.round(v).toLocaleString()}`; }
  };

  // ──────────────────────────────────────────────────────────
  // Respect user motion / data saver
  // ──────────────────────────────────────────────────────────
  try {
    const prefersReduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const saveData = navigator.connection?.saveData;
    if (prefersReduce || saveData) document.documentElement.classList.add('fc-reduced');
  } catch {}

  // ──────────────────────────────────────────────────────────
  // Element cache (matches your posted markup)
  // ──────────────────────────────────────────────────────────
  const hdrId = '{{ _hdr_id|default("site-header") }}';
  const hdr   = document.getElementById(hdrId);
  if (!hdr) return;

  const meter   = $('#hdr-meter', hdr);
  const fill    = meter ? $('.fill', meter) : null;
  const pctTxt  = meter ? $('.pct',  meter) : null;
  const totalPill = $('#hdr-total-pill', hdr);

  const burger  = $('#menu-toggle', hdr);
  const tpl     = document.getElementById('mobile-nav-tpl');
  const shareBtn = $('#hdr-share', hdr);
  const themeBtn = $('#theme-toggle', hdr);
  const teamLogo = $('.team-link .team-logo', hdr);

  // ──────────────────────────────────────────────────────────
  // Scroll behavior: gentle shrink with hysteresis
  // ──────────────────────────────────────────────────────────
  let shrunk = false, ticking = false;
  const SHRINK_ON = 64, SHRINK_OFF = 20;

  const onScroll = () => {
    const y = window.scrollY || document.documentElement.scrollTop || 0;
    if (y > SHRINK_ON && !shrunk) {
      hdr.classList.add('is-shrunk'); shrunk = true;
    } else if (y < SHRINK_OFF && shrunk) {
      hdr.classList.remove('is-shrunk'); shrunk = false;
    }
    ticking = false;
  };
  const scrollHandler = () => { if (!ticking) { ticking = true; requestAnimationFrame(onScroll); } };
  onScroll();
  window.addEventListener('scroll', scrollHandler, { passive: true });

  // ──────────────────────────────────────────────────────────
  // Mobile sheet (from <template>)
  // ──────────────────────────────────────────────────────────
  let sheet = null;
  const openMenu = () => {
    if (!tpl) return;
    if (!sheet) {
      sheet = tpl.content.firstElementChild.cloneNode(true);
      document.body.appendChild(sheet);
      $('.close', sheet)?.addEventListener('click', closeMenu);
      // Close on backdrop click
      sheet.addEventListener('click', (e) => { if (e.target === sheet) closeMenu(); });
      // ESC to close
      document.addEventListener('keydown', escHandler);
    }
    sheet.classList.remove('hidden');
    burger?.setAttribute('aria-expanded', 'true');
  };
  const closeMenu = () => {
    sheet?.classList.add('hidden');
    burger?.setAttribute('aria-expanded', 'false');
  };
  const escHandler = (e) => { if (e.key === 'Escape') closeMenu(); };
  burger?.addEventListener('click', openMenu);

  // ──────────────────────────────────────────────────────────
  // Theme toggle (persist in localStorage)
  // ──────────────────────────────────────────────────────────
  const THEME_KEY = 'fc:theme';
  const applyTheme = (mode) => {
    const root = document.documentElement;
    if (mode === 'light' || mode === 'dark') {
      root.setAttribute('data-theme', mode);
      try { localStorage.setItem(THEME_KEY, mode); } catch {}
    }
  };
  // Honor stored preference once
  try {
    const stored = localStorage.getItem(THEME_KEY);
    if (stored) applyTheme(stored);
  } catch {}
  themeBtn?.addEventListener('click', () => {
    const root = document.documentElement;
    const next = (root.getAttribute('data-theme') === 'light') ? 'dark' : 'light';
    applyTheme(next);
  });

  // ──────────────────────────────────────────────────────────
  // Share (Web Share API -> clipboard fallback)
  // ──────────────────────────────────────────────────────────
  if (shareBtn) {
    let payload = {};
    try { payload = JSON.parse(shareBtn.dataset.share || '{}'); } catch {}
    shareBtn.addEventListener('click', async () => {
      try {
        if (navigator.share) {
          await navigator.share(payload);
        } else if (payload.url || location.href) {
          await navigator.clipboard?.writeText(payload.url || location.href);
          shareBtn.dataset._label = shareBtn.textContent;
          shareBtn.textContent = 'Link Copied';
          setTimeout(() => { shareBtn.textContent = shareBtn.dataset._label || 'Share'; }, 1400);
        }
      } catch { /* user cancelled */ }
    });
  }

  // ──────────────────────────────────────────────────────────
  // Live fundraising meter + total pill updates
  // ──────────────────────────────────────────────────────────
  const setMeter = (raised, goal) => {
    const g = Math.max(1, Number(goal) || 1);
    const r = Math.max(0, Number(raised) || 0);
    const pct = clamp((r / g) * 100, 0, 100);

    if (fill)     fill.style.width = pct.toFixed(1) + '%';
    if (pctTxt)   pctTxt.textContent = fmtPct(pct);
    if (meter)    meter.setAttribute('aria-valuenow', pct.toFixed(1));

    // Tasteful social-proof pulse on team logo
    if (teamLogo) {
      teamLogo.classList.add('pulse');
      setTimeout(() => teamLogo.classList.remove('pulse'), 1200);
    }
  };

  const setTotal = (total) => {
    if (!totalPill) return;
    const val = Math.max(0, Number(total) || 0);
    totalPill.textContent = fmtMoney(val);
    totalPill.dataset.val = String(val); // CSS hook: .pill[data-val]
    // Small attention nudge when value increases
    totalPill.animate?.(
      [{ transform:'scale(1)' }, { transform:'scale(1.06)' }, { transform:'scale(1)' }],
      { duration: 260, easing: 'cubic-bezier(.2,.9,.35,1.2)' }
    );
  };

  // Custom event hooks you can dispatch from anywhere:
  // window.dispatchEvent(new CustomEvent('fc:meter:update', { detail: { raised, goal, total } }))
  window.addEventListener('fc:meter:update', (e) => {
    const d = e.detail || {};
    if (d.raised != null || d.goal != null) setMeter(d.raised, d.goal);
    if (d.total  != null) setTotal(d.total);
  }, { passive: true });

  // Expose small API for your app code
  window.fcHeader = {
    setMeter,
    setTotal,
    openMenu,
    closeMenu,
    setTheme: (mode) => applyTheme(mode) // 'light' | 'dark'
  };
})();
</script>

<script nonce="{{ NONCE }}">
(() => {
  const ticker = document.getElementById('hdr-ticker');
  if (!ticker) return;

  // Respect reduced motion
  const prefersReduce = matchMedia?.('(prefers-reduced-motion: reduce)').matches;
  if (prefersReduce) ticker.classList.remove('scrolling');

  // Only animate if content is wider than viewport mask
  const needsScroll = () => ticker.scrollWidth > ticker.clientWidth + 48;
  const setScroll = () => {
    if (needsScroll()) ticker.classList.add('scrolling');
    else ticker.classList.remove('scrolling');
  };
  new ResizeObserver(setScroll).observe(ticker);
  setScroll();
})();
</script>


