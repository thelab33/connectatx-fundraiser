{# ============================================================================
newsletter.html — SV-Prestige "Hoops" (CSP-safe, popup-ready) - Inline growth
card + optional modal popup (time / scroll / exit-intent) - Brand via
--fc-brand; basketball-court lines + subtle hoop accent - Zero-backend demo
until newsletter_endpoint is set - CSRF cookie support; honeypot; a11y
modal/focus trap; duplicate guards - LocalStorage keys per team: subscribed +
dismissed; debug override: ?debug_newsletter=1
============================================================================ #}
{% set NONCE = NONCE if NONCE is defined else (csp_nonce() if csp_nonce is
defined else '') %} {% set brand_color = (team.theme_color if team and
team.theme_color else '#facc15') %} {% set team_slug = team.slug if team and
team.slug is defined else 'default' %} {% set _uid = 'nl-' ~ (range(1,
999999)|random) %} {% set endpoint = newsletter_endpoint if newsletter_endpoint
is defined else '' %} {% set privacy_url = privacy_url if privacy_url is defined
else '' %} {# --- Popup triggers (override in view if you like) --- #} {% set
nl_auto_ms = nl_auto_ms|default(9000) %} {% set nl_scroll_pct =
nl_scroll_pct|default(55) %} {% set nl_exit_intent =
nl_exit_intent|default(true) %} {% set nl_disable_popup=
nl_disable_popup|default(false) %}

<section
  id="newsletter"
  data-ui="newsletter"
  class="relative py-14 px-6 md:py-18 md:px-10"
  style="--fc-brand: {{ brand_color }}; --fc-brand-200: color-mix(in srgb, {{ brand_color }} 22%, transparent)"
>
  <style nonce="{{ NONCE }}">
    /* ===== scoped to #newsletter ===== */
    #newsletter {
      position: relative;
      background:
        repeating-linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.04) 0 1px,
          transparent 1px 80px
        ),
        repeating-linear-gradient(
          0deg,
          rgba(255, 255, 255, 0.03) 0 1px,
          transparent 1px 80px
        ),
        radial-gradient(
          80% 120% at 50% -10%,
          color-mix(in srgb, var(--fc-brand) 10%, transparent),
          transparent 60%
        ),
        linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.03),
          rgba(255, 255, 255, 0)
        );
      border-block: 1px solid
        color-mix(in srgb, var(--fc-brand) 18%, transparent);
      overflow: clip;
    }
    #newsletter .wrap {
      max-width: 64rem;
      margin: 0 auto;
      text-align: center;
    }

    /* Inline card */
    #newsletter .card {
      display: grid;
      gap: 0.9rem;
      justify-items: center;
      padding: 1.25rem 1.35rem;
      background:
        radial-gradient(
          120% 140% at 50% -40%,
          color-mix(in srgb, var(--fc-brand) 10%, transparent),
          transparent 60%
        ),
        linear-gradient(135deg, var(--fc-brand-200), rgba(255, 255, 255, 0.04));
      border: 1px solid var(--fc-brand-200);
      border-radius: 1.25rem;
      box-shadow:
        0 18px 60px color-mix(in srgb, var(--fc-brand) 14%, transparent),
        inset 0 0 40px color-mix(in srgb, var(--fc-brand) 7%, transparent);
      position: relative;
      overflow: hidden;
    }
    #newsletter .title {
      font-weight: 900;
      letter-spacing: 0.2px;
    }
    #newsletter .sub {
      opacity: 0.86;
    }
    #newsletter .form {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      margin-top: 0.9rem;
      align-items: stretch;
      justify-content: center;
    }
    #newsletter .email {
      flex: 1 1 18rem;
      min-width: 14rem;
      background: rgba(0, 0, 0, 0.45);
      border: 1px solid color-mix(in srgb, var(--fc-brand) 28%, transparent);
      border-radius: 0.9rem;
      padding: 0.95rem 1rem;
      color: #fff;
      outline: none;
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.06) inset;
      transition: border-color 0.2s ease;
    }
    #newsletter .email::placeholder {
      color: rgba(255, 255, 255, 0.55);
    }
    #newsletter .email:focus {
      border-color: var(--fc-brand);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--fc-brand) 30%, transparent);
    }
    #newsletter .submit {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--fc-brand);
      color: #111;
      font-weight: 900;
      border-radius: 0.9rem;
      padding: 0.95rem 1.15rem;
      border: 1px solid color-mix(in srgb, var(--fc-brand) 35%, transparent);
      box-shadow: 0 10px 30px
        color-mix(in srgb, var(--fc-brand) 18%, transparent);
      transition:
        transform 0.15s ease,
        filter 0.15s ease,
        box-shadow 0.15s ease;
    }
    #newsletter .submit:hover {
      transform: translateY(-1px);
      filter: brightness(0.98);
    }
    #newsletter .submit[disabled] {
      opacity: 0.7;
      cursor: not-allowed;
    }
    #newsletter .spin {
      width: 1.05em;
      height: 1.05em;
      border-radius: 9999px;
      border: 2px solid #111;
      border-top-color: transparent;
      display: inline-block;
      animation: nl-spin 1s linear infinite;
    }
    @keyframes nl-spin {
      to {
        transform: rotate(360deg);
      }
    }
    #newsletter .fine {
      font-size: 0.82rem;
      opacity: 0.75;
    }
    #newsletter .msg {
      margin-top: 0.75rem;
      font-weight: 800;
      min-height: 1.25rem;
    }
    #newsletter .ok {
      color: #bef264;
    } /* lime-300 */
    #newsletter .bad {
      color: #fca5a5;
    } /* rose-300 */
    #newsletter .hp {
      position: absolute;
      left: -10000px;
      width: 1px;
      height: 1px;
      overflow: hidden;
    }

    /* Little hoop accent (SVG) */
    #newsletter .hoop {
      position: absolute;
      inset: auto -12px -12px auto;
      width: 88px;
      opacity: 0.45;
      transform: rotate(-6deg);
      filter: drop-shadow(0 2px 12px rgba(0, 0, 0, 0.4));
    }

    /* Modal shell */
    .nl-modal-backdrop[hidden] {
      display: none !important;
    }
    .nl-modal-backdrop {
      position: fixed;
      inset: 0;
      z-index: 9998;
      background: rgba(0, 0, 0, 0.55);
      backdrop-filter: blur(3px);
      display: grid;
      place-items: center;
      padding: 24px;
    }
    .nl-modal {
      width: min(560px, 92vw);
      border-radius: 1.25rem;
      border: 1px solid var(--fc-brand-200);
      overflow: hidden;
      background:
        linear-gradient(180deg, rgba(15, 15, 15, 0.92), rgba(15, 15, 15, 0.98)),
        linear-gradient(135deg, var(--fc-brand-200), rgba(255, 255, 255, 0.04));
      box-shadow:
        0 30px 120px color-mix(in srgb, var(--fc-brand) 20%, transparent),
        0 10px 30px rgba(0, 0, 0, 0.5);
      transform: translateY(8px) scale(0.98);
      opacity: 0;
      transition:
        transform 0.22s ease,
        opacity 0.2s ease;
    }
    .nl-modal[data-open] {
      transform: none;
      opacity: 1;
    }
    .nl-modal .hdr {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 16px;
      border-bottom: 1px solid
        color-mix(in srgb, var(--fc-brand) 20%, transparent);
    }
    .nl-modal .hdr .ttl {
      font-weight: 900;
      font-size: 1.05rem;
      letter-spacing: 0.2px;
    }
    .nl-modal .xbtn {
      appearance: none;
      border: 0;
      background: transparent;
      color: #fff;
      font-size: 1.25rem;
      line-height: 1;
      padding: 0.25rem;
      border-radius: 0.5rem;
    }
    .nl-modal .xbtn:hover {
      background: rgba(255, 255, 255, 0.07);
    }
    .nl-modal .body {
      padding: 1rem;
    }
    .nl-modal .foot {
      padding: 0.6rem 1rem 1rem;
    }
    @media (prefers-reduced-motion: reduce) {
      .nl-modal {
        transition: none;
      }
      .submit {
        transition: none;
      }
    }
  </style>

  <div class="wrap">
    <div class="card">
      <svg class="hoop" viewBox="0 0 120 120" aria-hidden="true">
        <circle
          cx="60"
          cy="40"
          r="24"
          fill="none"
          stroke="white"
          stroke-opacity=".35"
          stroke-width="6"
        />
        <path
          d="M36 60 L84 60 L78 96 L42 96 Z"
          fill="none"
          stroke="white"
          stroke-opacity=".25"
          stroke-width="4"
        />
        <path
          d="M42 70 L78 70 M45 80 L75 80 M48 90 L72 90"
          stroke="white"
          stroke-opacity=".18"
          stroke-width="2"
        />
      </svg>

      <h2 class="title text-2xl sm:text-3xl">
        Join the <span style="color: var(--fc-brand)">Hoops Insider</span> —
        events, goals & wins
      </h2>
      <p class="sub">One or two emails a month. Unsubscribe anytime.</p>

      <form
        id="{{ _uid }}-form"
        class="form"
        method="post"
        {%
        if
        endpoint
        %}
        action="{{ endpoint }}"
        {%
        else
        %}
        action="#"
        {%
        endif
        %}
        data-endpoint="{{ endpoint }}"
        data-key="fc:nl:{{ team_slug }}"
        novalidate
      >
        <label for="{{ _uid }}-email" class="sr-only">Email</label>
        <input
          id="{{ _uid }}-email"
          class="email"
          name="email"
          type="email"
          inputmode="email"
          autocomplete="email"
          required
          placeholder="you@email.com"
          aria-describedby="{{ _uid }}-help"
        />
        <input
          type="text"
          class="hp"
          name="company"
          tabindex="-1"
          autocomplete="off"
          aria-hidden="true"
        />
        <button
          id="{{ _uid }}-btn"
          type="submit"
          class="submit"
          aria-label="Subscribe to newsletter"
        >
          <span class="lbl">Subscribe</span>
          <span class="spin" hidden aria-hidden="true"></span>
        </button>
        <div
          id="{{ _uid }}-msg"
          class="msg"
          role="status"
          aria-live="polite"
          aria-atomic="true"
        ></div>
        <p id="{{ _uid }}-help" class="fine">
          We respect your privacy. No spam. {% if privacy_url %}<a
            href="{{ privacy_url }}"
            class="underline"
            target="_blank"
            rel="noopener"
            >Privacy</a
          >{% endif %}
        </p>
      </form>
    </div>
  </div>

  {# ======== Modal popup (same form experience, shares storage keys) ========
  #}
  <div
    id="{{ _uid }}-backdrop"
    class="nl-modal-backdrop"
    hidden
    aria-hidden="true"
  >
    <div
      id="{{ _uid }}-modal"
      class="nl-modal"
      role="dialog"
      aria-labelledby="{{ _uid }}-ttl"
      aria-modal="true"
      tabindex="-1"
    >
      <div class="hdr">
        <div id="{{ _uid }}-ttl" class="ttl">
          Get team updates & exclusive wins
        </div>
        <button class="xbtn" type="button" data-close aria-label="Close">
          ✕
        </button>
      </div>
      <div class="body">
        {# We keep a second minimal form inside modal to avoid DOM moves; unique
        ids per _uid #}
        <form
          id="{{ _uid }}-mform"
          class="form"
          method="post"
          {%
          if
          endpoint
          %}
          action="{{ endpoint }}"
          {%
          else
          %}
          action="#"
          {%
          endif
          %}
          data-endpoint="{{ endpoint }}"
          data-key="fc:nl:{{ team_slug }}"
          novalidate
        >
          <label for="{{ _uid }}-memail" class="sr-only">Email</label>
          <input
            id="{{ _uid }}-memail"
            class="email"
            name="email"
            type="email"
            inputmode="email"
            autocomplete="email"
            required
            placeholder="you@email.com"
          />
          <input
            type="text"
            class="hp"
            name="company"
            tabindex="-1"
            autocomplete="off"
            aria-hidden="true"
          />
          <button
            id="{{ _uid }}-mbtn"
            type="submit"
            class="submit"
            aria-label="Subscribe to newsletter"
          >
            <span class="lbl">Subscribe</span
            ><span class="spin" hidden aria-hidden="true"></span>
          </button>
          <div
            id="{{ _uid }}-mmsg"
            class="msg"
            role="status"
            aria-live="polite"
            aria-atomic="true"
          ></div>
        </form>
      </div>
      <div class="foot fine">Pro hoops energy. Real community impact.</div>
    </div>
  </div>

  <script nonce="{{ NONCE }}">
    (() => {
      /* ===== duplicate guard ===== */
      const ID = '{{ _uid }}'; if (window.__nlBound && window.__nlBound[ID]) return;
      window.__nlBound = window.__nlBound || {}; window.__nlBound[ID] = true;

      const reduce = matchMedia?.('(prefers-reduced-motion: reduce)')?.matches;
      const force  = /[?&]debug_newsletter=1/.test(location.search);
      const DISABLE_POPUP = {{ 'true' if nl_disable_popup else 'false' }};
      const AUTO_MS   = {{ nl_auto_ms|int }};
      const SCROLL_PCT= {{ nl_scroll_pct|int }};
      const EXIT_INT  = {{ 'true' if nl_exit_intent else 'false' }};

      /* ===== nodes (inline) ===== */
      const form  = document.getElementById(ID+'-form');
      const email = document.getElementById(ID+'-email');
      const btn   = document.getElementById(ID+'-btn');
      const msg   = document.getElementById(ID+'-msg');

      /* ===== nodes (modal) ===== */
      const backdrop = document.getElementById(ID+'-backdrop');
      const modal    = document.getElementById(ID+'-modal');
      const mform    = document.getElementById(ID+'-mform');
      const memail   = document.getElementById(ID+'-memail');
      const mbtn     = document.getElementById(ID+'-mbtn');
      const mmsg     = document.getElementById(ID+'-mmsg');

      /* ===== helpers ===== */
      const getStoreKey = (el) => el?.dataset?.key || 'fc:nl:default';
      const subscribed  = (key) => { try { return localStorage.getItem(key)==='1'; } catch { return false; } };
      const dismissed   = (key) => { try { return sessionStorage.getItem(key+':dismiss')==='1'; } catch { return false; } };
      const markSub     = (key) => { try { localStorage.setItem(key,'1'); } catch {} };
      const markDismiss = (key) => { try { sessionStorage.setItem(key+':dismiss','1'); } catch {} };
      const getCSRF = () => { try { const m=document.cookie.match(/(?:^|; )csrf_token=([^;]+)/); return m?decodeURIComponent(m[1]):''; } catch { return ''; } };
      const announce = (node, text, ok) => { if(!node) return; node.textContent=text; node.classList.toggle('ok',!!ok); node.classList.toggle('bad',!ok); };
      const busy = (btn, on) => {
        if (!btn) return; const spin=btn.querySelector('.spin'), lbl=btn.querySelector('.lbl');
        if (on) { btn.setAttribute('disabled','true'); if(spin) spin.hidden=false; if(lbl) lbl.textContent='Subscribing…'; }
        else { btn.removeAttribute('disabled'); if(spin) spin.hidden=true; if(lbl) lbl.textContent='Subscribe'; }
      };
      const validEmail = (v) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v||'');

      /* ===== core submit (shared) ===== */
      function bindForm(scope){
        const f=scope.form, em=scope.email, b=scope.btn, m=scope.msg;
        const endpoint = f?.dataset?.endpoint || '';
        const storeKey = getStoreKey(f);
        // Respect prior success
        if (!force && subscribed(storeKey)) {
          if (em) em.disabled = true; if (b) b.disabled = true;
          announce(m, 'You’re on the list — thank you! 💛', true);
        }
        f?.addEventListener('submit', async (e)=>{
          e.preventDefault(); if(!f||!em||!b) return;
          const hp = f.querySelector('.hp'); if (hp && hp.value){ announce(m,'You’re in! (Thanks)',true); f.reset(); return; }
          const val = (em.value||'').trim(); if (!validEmail(val)){ em.setAttribute('aria-invalid','true'); announce(m,'Please enter a valid email.',false); return; }
          em.removeAttribute('aria-invalid');
          // Demo path
          if (!endpoint){
            busy(b,true);
            setTimeout(()=>{ busy(b,false); announce(m,'You’re in! Check your inbox for a welcome note. (Demo)',true);
              markSub(storeKey); try { f.reset(); } catch {}
              window.dispatchEvent(new CustomEvent('fc:newsletter:subscribed',{ detail:{ email: val, demo:true }}));
              closeModal(); }, 480);
            return;
          }
          // Real fetch
          busy(b,true);
          try{
            const r = await fetch(endpoint,{
              method:'POST', credentials:'same-origin',
              headers:{ 'Content-Type':'application/json', 'Accept':'application/json', 'X-Requested-With':'XMLHttpRequest', 'X-CSRFToken': getCSRF() },
              body: JSON.stringify({ email: val, page_url: location.href, referrer: document.referrer || null, team: '{{ team_slug }}', ts: Date.now() })
            });
            if (r.ok){
              announce(m,'You’re in! Check your inbox for a welcome note.',true);
              markSub(storeKey); try { f.reset(); } catch {}
              window.dispatchEvent(new CustomEvent('fc:newsletter:subscribed',{ detail:{ email: val }}));
              closeModal();
            } else {
              announce(m, (r.status===409?'You’re already subscribed — thank you!': (r.status===400?'That email doesn’t look valid.':'Could not subscribe right now. Please try again.')) , r.status===409);
            }
          }catch{ announce(m,'Network error. Please try again.',false); }
          finally{ busy(b,false); }
        });
      }

      /* ===== modal controls + triggers ===== */
      let lastFocus=null; let opened=false;
      function openModal(){
        if (DISABLE_POPUP) return;
        const key=getStoreKey(form||mform);
        if (!force && (subscribed(key) || dismissed(key))) return;
        if (opened) return; opened = true;
        backdrop?.removeAttribute('hidden'); backdrop?.setAttribute('aria-hidden','false');
        modal?.setAttribute('data-open',''); lastFocus = document.activeElement;
        (memail || email)?.focus?.();
        document.body.style.overflow='hidden';
      }
      function closeModal(){
        if (!opened) return;
        const key=getStoreKey(form||mform);
        try { markDismiss(key); } catch {}
        modal?.removeAttribute('data-open');
        backdrop?.setAttribute('aria-hidden','true'); backdrop?.setAttribute('hidden','');
        document.body.style.overflow='';
        opened=false; lastFocus?.focus?.();
      }

      backdrop?.addEventListener('click', (e)=>{ if (e.target===backdrop) closeModal(); });
      modal?.querySelector('[data-close]')?.addEventListener('click', closeModal);
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && opened) closeModal(); });

      // Expose a public opener
      window.FC = Object.assign({}, window.FC||{}, { newsletter:{ open: openModal, close: closeModal }});
      document.addEventListener('click',(e)=>{
        const t=e.target.closest('[data-open-newsletter]'); if(t){ e.preventDefault(); openModal(); }
      }, { capture:true });

      // Triggers (only if not already subscribed/dismissed)
      if (!DISABLE_POPUP && (force || !(subscribed(getStoreKey(form||mform)) || dismissed(getStoreKey(form||mform))))){
        if (AUTO_MS>0){ setTimeout(()=>openModal(), AUTO_MS); }
        if (SCROLL_PCT>0){
          const onScroll=()=>{
            const pct = (scrollY / Math.max(1, document.documentElement.scrollHeight - innerHeight))*100;
            if (pct >= SCROLL_PCT){ openModal(); removeEventListener('scroll', onScroll, { passive:true }); }
          }; addEventListener('scroll', onScroll, { passive:true });
        }
        if (EXIT_INT && !reduce){
          const onLeave=(e)=>{ if(e.clientY<=0){ openModal(); removeEventListener('mouseout', onLeave); } };
          addEventListener('mouseout', onLeave);
        }
      }

      // Bind both forms
      bindForm({ form, email, btn, msg });
      bindForm({ form: mform, email: memail, btn: mbtn, msg: mmsg });
    })();
  </script>
</section>
