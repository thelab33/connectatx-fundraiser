{# ================= Admin Onboarding Popover (CSP/HTMX/Alpine, Single-File, Elite) ================= #}
{% if current_user and current_user.is_authenticated and current_user.is_admin and not session.get('onboarded') %}

{# ---- Safe route resolution (no current_app) ---- #}
{% set _has = has_endpoint if has_endpoint is defined else (lambda x: false) %}
{% set href_dashboard = (safe_url_for('admin.dashboard')        if (safe_url_for is defined and _has('admin.dashboard'))        else '/admin/') %}
{% set href_invite    = (safe_url_for('admin.invite')           if (safe_url_for is defined and _has('admin.invite'))           else '/admin/invite') %}
{% set href_import    = (safe_url_for('admin.import_contacts')  if (safe_url_for is defined and _has('admin.import_contacts'))  else '/admin/import') %}
{% set href_dismiss   = (safe_url_for('admin.dismiss_onboarding') if (safe_url_for is defined and _has('admin.dismiss_onboarding')) else '/admin/dismiss-onboarding') %}
{% set href_sync      = (safe_url_for('admin.onboarding_sync')  if (safe_url_for is defined and _has('admin.onboarding_sync'))  else '/admin/onboarding/sync') %}
{% set csrf_val       = (csrf_token() if csrf_token is defined else '') %}

{# ---- Namespaced storage key + theming ---- #}
{% set storage_key = 'adminOnboardSteps:' ~ (team.id if team and team.id is defined else 'global') %}
{% set brand_color = (team.theme_color if team and team.theme_color else '#facc15') %}
{% set step_labels = step_labels if step_labels is defined else ['Visit Dashboard','Invite Sponsors','Import Contacts'] %}

<div
  id="admin-onboarding-popover"
  x-data="adminOnboardPopover()"
  x-init="init()"
  x-show="open"
  x-transition.opacity.duration.400ms
  @keydown.window.escape="close(true)"
  role="dialog"
  aria-modal="true"
  aria-labelledby="onboard-title-admin"
  aria-describedby="onboard-desc"
  tabindex="-1"
  class="fixed bottom-6 right-6 z-[1050] w-[22rem] max-w-[92vw] rounded-2xl border border-yellow-400/20 bg-zinc-950/95 p-5 text-zinc-100 shadow-2xl backdrop-blur-xl"
  data-storage-key="{{ storage_key }}"
  data-sync-url="{{ href_sync }}"
  data-csrf="{{ csrf_val }}"
  style="--fc-brand: {{ brand_color }}; --fc-brand-200: color-mix(in srgb, {{ brand_color }} 20%, transparent);"
>
  <h3 id="onboard-title-admin" class="flex items-center gap-2 text-lg font-extrabold text-yellow-300">
    <span aria-hidden="true">ğŸ¯</span> Welcome, Admin!
  </h3>
  <p id="onboard-desc" class="mt-1 text-xs text-zinc-300">
    Quick setup checklist so you can launch fundraising in minutes.
  </p>

  <!-- Progress -->
  <div class="mt-3">
    <div class="h-2 w-full overflow-hidden rounded-full bg-zinc-800 ring-1 ring-[color:var(--fc-brand-200)]" aria-hidden="true">
      <div id="onboard-bar" class="h-full bg-gradient-to-r from-yellow-400 to-amber-300 transition-[width] duration-500" style="width:0%"></div>
    </div>
    <div class="mt-1 text-right text-[11px] text-zinc-400">
      <span id="onboard-progress" aria-live="polite" aria-atomic="true">0 / {{ step_labels|length }} complete</span>
    </div>
  </div>

  <!-- Onboarding Steps -->
  <ol class="mt-3 space-y-2" aria-label="Onboarding steps">
    {% for lbl in step_labels %}
    <li class="flex items-start gap-3">
      <button
        type="button"
        :aria-checked="steps[{{ loop.index0 }}]"
        role="checkbox"
        tabindex="0"
        @click="toggleStep({{ loop.index0 }})"
        @keydown.enter.prevent="toggleStep({{ loop.index0 }})"
        @keydown.space.prevent="toggleStep({{ loop.index0 }})"
        class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded border border-yellow-400/40 bg-zinc-900/70 focus:outline-none focus:ring-2 focus:ring-yellow-300"
        :class="steps[{{ loop.index0 }}] ? 'bg-yellow-400 text-black' : 'bg-zinc-900/70 text-transparent'"
        aria-label="Mark step as complete"
        data-analytics="onboarding:toggle"
      >
        <span x-show="steps[{{ loop.index0 }}]" aria-hidden="true">âœ”ï¸</span>
      </button>
      <span class="text-sm" :class="steps[{{ loop.index0 }}] ? 'text-yellow-200 font-semibold' : 'text-zinc-300'">{{ lbl }}</span>
    </li>
    {% endfor %}
  </ol>

  <!-- Quick Actions -->
  <div class="mt-4 grid grid-cols-3 gap-2 text-sm">
    <a href="{{ href_dashboard }}" @click="stepQuick(0)"
       class="rounded-lg border border-yellow-400/20 bg-zinc-900/70 px-3 py-2 text-center hover:bg-zinc-900 focus:outline-none focus:ring-2 focus:ring-yellow-300"
       aria-label="Go to Dashboard" data-analytics="onboarding:dashboard">Dashboard</a>

    <a href="{{ href_invite }}" @click="stepQuick(1)"
       class="rounded-lg border border-yellow-400/20 bg-zinc-900/70 px-3 py-2 text-center hover:bg-zinc-900 focus:outline-none focus:ring-2 focus:ring-yellow-300"
       aria-label="Invite Sponsors" data-analytics="onboarding:invite">Invite</a>

    <a href="{{ href_import }}" @click="stepQuick(2)"
       class="rounded-lg border border-yellow-400/20 bg-zinc-900/70 px-3 py-2 text-center hover:bg-zinc-900 focus:outline-none focus:ring-2 focus:ring-yellow-300"
       aria-label="Import Contacts" data-analytics="onboarding:import">Import</a>
  </div>

  <p class="mt-3 text-xs text-zinc-300" id="ai-concierge-desc">
    ğŸ’¡ Need help? Use the AI Concierge <span aria-hidden="true">ğŸ’¬</span> at any time.
  </p>

  <div class="mt-4 space-y-2">
    <button
      class="inline-flex w-full items-center justify-center rounded-lg border border-yellow-400/30 bg-black/60 px-4 py-2 font-bold text-yellow-200 hover:bg-black/70 focus:outline-none focus:ring-2 focus:ring-yellow-300"
      type="button"
      @click="close(true)"
      hx-post="{{ href_dismiss }}"
      hx-headers='{"X-CSRFToken":"{{ csrf_val }}"}'
      hx-swap="none"
      aria-label="Dismiss Onboarding"
      data-analytics="onboarding:dismiss"
    >
      Got it!
    </button>

    <button
      class="w-full text-xs text-zinc-400 underline underline-offset-4 hover:text-zinc-200 focus:outline-none"
      type="button"
      @click="reset()"
      aria-label="Reset onboarding checklist"
      data-analytics="onboarding:reset"
    >
      Reset checklist
    </button>
  </div>
</div>
{% endif %}

{# --- AI Concierge Tooltip (shows even if popover is dismissed) --- #}
<div
  id="ai-concierge-tip"
  class="fixed bottom-24 right-6 z-[1049] translate-y-2 rounded-lg border border-yellow-400/20 bg-black/80 px-3 py-2 text-xs text-yellow-200 opacity-0 shadow-lg transition"
  aria-live="polite"
  aria-atomic="true"
  role="status"
  data-ai-tip
>
  ğŸ‘‹ Click the chat icon for AI support!
</div>

<style>
  #ai-concierge-tip { will-change: transform, opacity; }
</style>

<script nonce="{{ csp_nonce() if csp_nonce is defined else '' }}">
(() => {
  // Lightweight celebration
  function confettiLite() {
    try { if (typeof window.launchConfetti === 'function') { window.launchConfetti({ particleCount: 60, spread: 80, origin: { y: 0.6 } }); } } catch(_) {}
  }
  // Focus trap fallback when Alpine x-trap isn't present
  function trapFocus(container) {
    if (!container) return () => {};
    function onKeydown(e) {
      if (e.key !== 'Tab') return;
      const focusables = container.querySelectorAll('a, button, input, select, textarea, [tabindex]:not([tabindex="-1"])');
      const list = Array.from(focusables).filter(el => !el.hasAttribute('disabled'));
      if (!list.length) return;
      const first = list[0], last = list[list.length - 1];
      if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
      else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
    }
    container.addEventListener('keydown', onKeydown);
    return () => container.removeEventListener('keydown', onKeydown);
  }
  const STORAGE_KEY_FALLBACK = 'adminOnboardSteps:global';

  // Alpine component namespace
  window.adminOnboardPopover = function adminOnboardPopover() {
    return {
      open: true,
      steps: [],               // boolean[]
      stepLabels: {{ step_labels|tojson if tojson is defined else '["Visit Dashboard","Invite Sponsors","Import Contacts"]' }},
      _initDone: false,
      _untrap: null,
      _bc: null,               // BroadcastChannel

      init() {
        const root = document.getElementById('admin-onboarding-popover');
        const key = root?.dataset?.storageKey || STORAGE_KEY_FALLBACK;
        const syncUrl = root?.dataset?.syncUrl || '';
        const csrf = root?.dataset?.csrf || '';

        // initialize steps from storage or zeros
        try {
          const saved = JSON.parse(localStorage.getItem(key) || 'null');
          this.steps = (Array.isArray(saved) && saved.length === this.stepLabels.length)
            ? saved : this.stepLabels.map(() => false);
        } catch(_) { this.steps = this.stepLabels.map(() => false); }

        // BroadcastChannel to sync across tabs
        try { this._bc = new BroadcastChannel(key); this._bc.onmessage = (e) => { if (Array.isArray(e.data)) { this.steps = e.data; this.$nextTick(this.updateProgress); } }; } catch(_) {}

        // Watcher: persist, celebrate newly-completed, auto-dismiss on completion, update UI, sync server + tabs
        this.$watch('steps', (now, old) => {
          try { localStorage.setItem(key, JSON.stringify(now)); } catch(_) {}
          if (this._bc) { try { this._bc.postMessage(now); } catch(_) {} }
          if (this._initDone) {
            for (let i=0; i<now.length; i++) if (now[i] && !(old && old[i])) confettiLite();
          }
          this.updateProgress();
          if (now.every(Boolean)) setTimeout(() => { this.open = false; setTimeout(confettiLite, 250); }, 350);

          // Optional server sync (HTMX if present; else fetch)
          if (syncUrl) {
            const payload = { steps: now };
            if (window.htmx) {
              try { htmx.ajax('POST', syncUrl, { values: payload, headers: { 'X-CSRFToken': csrf }, swap: 'none' }); } catch(_) {}
            } else {
              try { fetch(syncUrl, { method: 'POST', headers: { 'Content-Type': 'application/json','X-CSRFToken': csrf }, credentials: 'same-origin', body: JSON.stringify(payload) }); } catch(_) {}
            }
          }
        });

        // Focus + trap fallback
        this.$nextTick(() => {
          root?.focus();
          if (!window.Alpine || !('trap' in (window.Alpine?.directive || (()=>({}))))) this._untrap = trapFocus(root);
          this.updateProgress();
        });

        // Concierge tip nudge (rate-limited)
        const tip = document.querySelector('[data-ai-tip]');
        try {
          const last = parseInt(localStorage.getItem('ai_tip_last') || '0', 10);
          const now = Date.now();
          if (tip && now - last > 6*60*60*1000) { // 6h
            setTimeout(() => {
              tip.classList.remove('opacity-0','translate-y-2');
              setTimeout(() => tip.classList.add('opacity-0','translate-y-2'), 4000);
            }, 1500);
            localStorage.setItem('ai_tip_last', String(now));
          }
        } catch(_) {}

        this._initDone = true;
      },

      updateProgress(){
        const total = this.stepLabels.length;
        const done = this.steps.reduce((a,b)=>a+(b?1:0),0);
        const pct = total ? Math.round((done/total)*100) : 0;
        const bar = document.getElementById('onboard-bar');
        const txt = document.getElementById('onboard-progress');
        if (bar) bar.style.width = pct + '%';
        if (txt) txt.textContent = `${done} / ${total} complete`;
        // Analytics hook
        try { window.dispatchEvent(new CustomEvent('fc:onboarding:progress', { detail: { done, total, pct } })); } catch(_) {}
      },

      toggleStep(i){ this.steps[i] = !this.steps[i]; },
      stepQuick(i){ this.steps[i] = true; },

      reset(){
        const root = document.getElementById('admin-onboarding-popover');
        const key  = root?.dataset?.storageKey || STORAGE_KEY_FALLBACK;
        this.steps = this.stepLabels.map(() => false);
        try { localStorage.removeItem(key); } catch(_) {}
      },

      close(sendDismiss){
        this.open = false;
        if (this._untrap) { this._untrap(); this._untrap = null; }
        // Optionally clear local storage on dismiss
        if (sendDismiss) {
          const root = document.getElementById('admin-onboarding-popover');
          const key = root?.dataset?.storageKey || STORAGE_KEY_FALLBACK;
          try { localStorage.removeItem(key); } catch(_) {}
        }
      },
    };
  };
})();
</script>

