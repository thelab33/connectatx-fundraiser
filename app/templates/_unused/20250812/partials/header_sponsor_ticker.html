{# ============================================================
   FundChamps â€” Header Sponsor Ticker (Live, CSP-safe, A11Y)
   Expects (optional): items=[{name,amount,when,avatar}], socket_ns
   Fallback: fetches /donations/ticker periodically
   ============================================================ #}
{% set socket_ns = socket_ns|default('/donations') %}
{% set items = items if items is defined and items else [] %}

<section id="hdr-ticker"
  class="w-full border-t border-b border-yellow-400/10 bg-black/40"
  role="region" aria-label="Recent support ticker">
  <style>
    /* ----- Scoped to #hdr-ticker only ----- */
    #hdr-ticker .rail{ overflow:hidden }
    #hdr-ticker ul{ display:inline-flex; gap:.5rem; align-items:center; white-space:nowrap; padding:.35rem .75rem }
    #hdr-ticker li{ display:inline-flex; align-items:center; gap:.5rem; border-radius:9999px; background:rgba(255,255,255,.06); padding:.25rem .5rem }
    #hdr-ticker img{ height:20px; width:20px; border-radius:9999px; box-shadow:0 0 0 1px rgba(255,255,255,.12) inset }
    /* marquee (disabled for reduced motion & Save-Data) */
    #hdr-ticker .track.scrolling{ animation:hdr-marquee 26s linear infinite }
    @keyframes hdr-marquee{ from{ transform:translateX(0) } to{ transform:translateX(-50%) } }
    @media (prefers-reduced-motion: reduce){
      #hdr-ticker .track.scrolling{ animation:none !important }
    }
    #hdr-ticker.save-data .track.scrolling{ animation:none !important }
  </style>

  <div class="rail">
    <!-- We duplicate the track for seamless loop when we have enough items -->
    <div class="track" aria-live="polite" aria-atomic="false">
      <ul id="donation-ticker" role="list">
        {% if items and items|length > 0 %}
          {% for it in items %}
          <li role="listitem">
            {% if it.avatar %}<img loading="lazy" decoding="async" src="{{ it.avatar }}" alt="" loading="lazy" decoding="async"/>{% else %}<span aria-hidden="true">ðŸŽ‰</span>{% endif %}
            <span class="font-semibold text-yellow-200">{{ it.name|default('Anonymous') }}</span>
            <span class="text-yellow-100/80">gave</span>
            <span class="font-bold text-yellow-300" aria-label="${{ '{:,.0f}'.format(it.amount|default(0)) }} donation">${{ '{:,.0f}'.format(it.amount|default(0)) }}</span>
            <span class="text-[11px] text-zinc-400">Â· {{ it.when|default('just now') }}</span>
          </li>
          {% endfor %}
        {% endif %}
      </ul>
    </div>
    <div class="track" aria-hidden="true"></div>
  </div>
</section>

<script nonce="{{ csp_nonce() if csp_nonce is defined else '' }}">
(() => {
  const root = document.getElementById('hdr-ticker'); if (!root) return;
  if (navigator.connection?.saveData) root.classList.add('save-data');

  const list = root.querySelector('#donation-ticker');
  const tracks = root.querySelectorAll('.track');
  const endpoint = '/donations/ticker';
  const ns = '{{ socket_ns }}';

  // Basic sanitizer for text nodes
  const esc = (s) => (s==null?'':String(s)).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));

  function liTemplate(it){
    const name = esc(it?.name || 'Anonymous');
    const amt  = Math.round(Number(it?.amount)||0);
    const when = esc(it?.when || 'just now');
    const avatar = esc(it?.avatar || '');
    return `
      <li role="listitem">
        ${avatar ? `<img loading="lazy" decoding="async" src="${avatar}" alt="" loading="lazy" decoding="async">` : `<span aria-hidden="true">ðŸŽ‰</span>`}
        <span class="font-semibold text-yellow-200">${name}</span>
        <span class="text-yellow-100/80">gave</span>
        <span class="font-bold text-yellow-300" aria-label="$${amt.toLocaleString()} donation">$${amt.toLocaleString()}</span>
        <span class="text-[11px] text-zinc-400">Â· ${when}</span>
      </li>`;
  }

  function render(items){
    if (!Array.isArray(items)) return;
    list.innerHTML = items.map(liTemplate).join('');
    // If enough items, enable smooth loop by cloning HTML into the second track
    const html = list.parentElement.innerHTML;
    const enableScroll = items.length >= 6 && !root.classList.contains('save-data') &&
      !matchMedia('(prefers-reduced-motion: reduce)').matches;
    tracks.forEach(t => {
      if (t !== tracks[0]) t.innerHTML = html;
      t.classList.toggle('scrolling', enableScroll);
    });
  }

  async function poll(){
    try {
      if (document.hidden) return;
      const r = await fetch(endpoint, { headers:{'Accept':'application/json'} , cache:'no-store' });
      if (r.ok) { const data = await r.json(); if (Array.isArray(data)) render(data); }
    } catch { /* silent */ }
  }

  // Initial load + schedule (Save-Data â†’ slower)
  poll();
  const interval = navigator.connection?.saveData ? 45000 : 15000;
  setInterval(poll, interval);

  // Socket.IO live push (optional)
  if (window.io) {
    try {
      const socket = io(ns, { transports: ['websocket','polling'] });
      socket.on('new_donation', (d) => {
        if (!d) return;
        const node = document.createElement('template');
        node.innerHTML = liTemplate(d).trim();
        const el = node.content.firstElementChild;
        list.prepend(el);
        // keep list from growing forever
        while (list.children.length > 30) list.lastElementChild?.remove();
      });
    } catch(_) {}
  }
})();
</script>

