{# FC • IMPACT BUCKETS — SV-ELITE • 3-Card MVP (production) #}
{% set NONCE = NONCE if NONCE is defined else '' %}
{% set IMPACT = IMPACT if IMPACT is defined and IMPACT else [
  {'key':'gym','title':'Gym Access (rentals)','icon':'🏟️','raised':900,'goal':1200,'blurb':'Keep practices strong.'},
  {'key':'travel','title':'Tournament Travel','icon':'🚌','raised':240,'goal':900,'blurb':'Gas, hotels on the road.'},
  {'key':'gear','title':'Team Gear','icon':'🎒','raised':60,'goal':400,'blurb':'Shoes, uniforms, socks.'},
] %}

<section id="impact" class="mx-auto w-[min(92rem,96vw)] px-3 sm:px-6">
  <header class="mb-4">
    <h2 class="text-fluid-h2 font-extrabold tracking-tight text-white optical-tight">
      Unlock What Matters — <span class="text-yellow-300">Real Impact Buckets</span>
    </h2>
    <p class="mt-1 max-w-3xl text-sm text-zinc-400">
      Pick a bucket and we’ll route your gift to that need.
    </p>
  </header>

  <div class="grid gap-4 md:grid-cols-3">
    {% for b in IMPACT[:3] %}
      {# ---- numbers (safe) ---- #}
      {% set goal       = (b.goal|default(0)|float) %}
      {% set raised     = (b.raised|default(0)|float) %}
      {% set remaining  = (goal - raised) if goal > raised else 0 %}
      {% set pct_raw    = (0 if goal <= 0 else (raised/goal*100)) %}
      {% set pct        = (0 if pct_raw < 0 else (100 if pct_raw > 100 else pct_raw))|round(1) %}
      {% set pct_frac   = (pct/100)|round(4) %}
      {# prefill: passed in or a “doable” default of 50, capped by remaining #}
      {% set prefill    = (b.prefill if b.prefill is defined else (50 if remaining > 50 else remaining))|int %}
      {% set locked     = (remaining <= 0) %}
      {% set _id        = 'impact-' ~ b.key %}

      <article
        id="{{ _id }}"
        class="hero-glass rounded-2xl p-4 ring-1 ring-white/10 bg-white/5"
        role="group"
        aria-labelledby="{{ _id }}-title"
        data-bucket="{{ b.key }}"
        data-goal="{{ goal|int }}"
        data-raised="{{ raised|int }}"
      >
        <div class="flex items-center justify-between">
          <h3 id="{{ _id }}-title" class="truncate text-[15px] font-extrabold text-white">
            <span aria-hidden="true">{{ b.icon }}</span> {{ b.title }}
          </h3>

          {% if locked %}
            <span class="rounded-full bg-emerald-400/15 px-2 py-0.5 text-[11px] font-semibold text-emerald-300">Fully funded ✅</span>
          {% else %}
            <span class="rounded-full bg-yellow-300/15 px-2 py-0.5 text-[11px] font-semibold text-yellow-300 tabular-nums">
              ${{ goal|int }} goal
            </span>
          {% endif %}
        </div>

        {% if b.blurb %}
          <p class="mt-1 text-[13px] text-zinc-400">{{ b.blurb }}</p>
        {% endif %}

        {# ---- meter (SV-Elite) ---- #}
        <div class="mt-3">
          <div class="fc-meter" role="progressbar"
               aria-label="{{ b.title }} funding progress"
               aria-valuemin="0" aria-valuemax="{{ goal|int }}" aria-valuenow="{{ raised|int }}">
            <div class="fc-meter__track" aria-hidden="true"></div>
            <div class="fc-meter__ticks" aria-hidden="true"></div>
            <div class="fc-meter__bar" style="--p: {{ pct_frac }};" aria-hidden="true"></div>
            <div class="fc-meter__shine" aria-hidden="true"></div>
          </div>

          <p class="mt-1 flex items-center justify-between text-[12px] text-zinc-400 tabular-nums">
            <span><span class="font-semibold text-zinc-200">${{ raised|int }}</span> raised • {{ '%.0f' % pct }}%</span>
            {% if not locked and remaining > 0 %}
              <span>Left: <span class="font-semibold text-yellow-200">${{ remaining|int }}</span></span>
            {% endif %}
          </p>
        </div>

        {# ---- actions (compact) ---- #}
        <div class="mt-3 grid grid-cols-2 gap-2">
          {% if not locked %}
            <button
              class="fc-btn fc-btn-primary btn-compact w-full justify-center"
              data-open="#donate-modal"
              data-bucket="{{ b.key }}"
              {% if prefill > 0 %}data-amount="{{ prefill }}"{% endif %}
              data-analytics="impact:quick-donate:{{ b.key }}"
              aria-describedby="{{ _id }}-title"
              aria-label="Donate{% if prefill>0 %} ${{ prefill }}{% endif %} to {{ b.title }}">
              {% if prefill > 0 %}Donate ${{ prefill }}{% else %}Donate{% endif %}
            </button>

            <button
              class="fc-btn fc-btn-ghost btn-compact w-full justify-center"
              data-open="#donate-modal"
              data-bucket="{{ b.key }}"
              data-analytics="impact:choose:{{ b.key }}"
              aria-describedby="{{ _id }}-title"
              aria-label="Choose custom amount for {{ b.title }}">
              💛 Choose amount
            </button>
          {% else %}
            <button class="fc-btn fc-btn-ghost btn-compact w-full justify-center" disabled>
              Thank you, sponsors! 🎉
            </button>
            <button class="fc-btn fc-btn-ghost btn-compact w-full justify-center" data-share data-analytics="impact:share:{{ b.key }}">
              🔗 Share
            </button>
          {% endif %}
        </div>

        {% if not locked %}
          <button class="mt-2 fc-btn fc-btn-ghost btn-compact w-full justify-center"
                  data-share data-analytics="impact:share:{{ b.key }}" aria-describedby="{{ _id }}-title">
            🔗 Share
          </button>
        {% endif %}
      </article>
    {% endfor %}
  </div>
</section>

<script nonce="{{ NONCE }}">
// Impact Buckets — share + live updates + compact enhancements
(() => {
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  // Share (Web Share → clipboard fallback)
  $$( '[data-share]' ).forEach(btn => {
    if (btn.__shareInit) return; btn.__shareInit = true;
    btn.addEventListener('click', async () => {
      const url = location.href.split('#')[0] + '#impact';
      try { if (navigator.share) { await navigator.share({ title: document.title, url }); return; } } catch {}
      try {
        await navigator.clipboard.writeText(url);
        const t = btn.textContent;
        btn.textContent = 'Link copied!';
        setTimeout(()=>btn.textContent=t, 1200);
      } catch {}
    }, { passive: true });
  });

  // Optional: listen for real-time bucket updates:
  // dispatchEvent(new CustomEvent('fc:bucket:update', { detail: { key:'gym', raised: 1100, goal: 1200 }}))
  addEventListener('fc:bucket:update', ev => {
    const d = ev.detail || {};
    if (!d.key) return;
    const card = document.querySelector(`[data-bucket="${CSS.escape(d.key)}"]`);
    if (!card) return;

    const goal   = Number(d.goal   ?? card.dataset.goal   ?? 0);
    const raised = Number(d.raised ?? card.dataset.raised ?? 0);
    card.dataset.goal = goal; card.dataset.raised = raised;

    // Update meter
    const bar = card.querySelector('.fc-meter__bar');
    const pct = Math.max(0, Math.min(1, goal ? (raised/goal) : 0));
    if (bar) bar.style.setProperty('--p', pct.toFixed(4));

    // Update copy
    const stats = card.querySelector('.tabular-nums');
    const nf = new Intl.NumberFormat(undefined, { maximumFractionDigits: 0 });
    const raisedTxt = nf.format(Math.round(raised));
    const remain = Math.max(0, goal - raised);
    const remainTxt = nf.format(Math.round(remain));

    // First stats row contains both “raised • %” and “left”
    const rows = card.querySelectorAll('p.text-[12px].tabular-nums');
    if (rows[0]) {
      const pctTxt = goal ? Math.round((raised/goal)*100) : 0;
      rows[0].innerHTML = `<span><span class="font-semibold text-zinc-200">$${raisedTxt}</span> raised • ${pctTxt}%</span>${
        goal ? `<span>Left: <span class="font-semibold text-yellow-200">$${remainTxt}</span></span>` : ''
      }`;
    }
  }, { passive: true });
})();
</script>

