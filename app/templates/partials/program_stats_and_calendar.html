{# templates/partials/program_stats_and_calendar.html #}
{% set __nonce = (csp_nonce() if csp_nonce is defined else (NONCE if NONCE is defined else '')) %}
{% set _team = team if team is defined and team else none %}
{% set TEAM_NAME = (_team.team_name if _team and _team.team_name else "Connect ATX Elite") %}

{% set _record = (_team.record if _team and _team.record else {}) %}
{% set _reg = _record.get('regional') or {} %}
{% set _nat = _record.get('national') or {} %}

{% set _stats = (_team.impact_stats if _team and _team.impact_stats else [
  {"label":"Players Enrolled","value":16},
  {"label":"Honor Roll Scholars","value":11},
  {"label":"Tournaments Played","value":12},
  {"label":"Years Running","value":3},
]) %}

{% set _events = (
  calendar_events if calendar_events is defined and calendar_events else
  (events if events is defined and events else [])
) %}
{% set _events = _events[:6] if _events else [] %}

<section aria-labelledby="psc-h" class="mx-auto w-full max-w-6xl px-4 md:px-6">
  <style nonce="{{ __nonce }}">
    #psc .card{background:rgba(15,15,18,.72);border:1px solid var(--fc-border);border-radius:1rem;
      box-shadow:0 10px 32px rgba(250,204,21,.08)}
    #psc .kpi{display:flex;flex-direction:column;gap:.15rem;padding:.85rem;border-radius:.85rem;
      background:var(--fc-surface);border:1px solid var(--fc-border)}
    #psc .kpi .v{font-weight:900;font-size:1.35rem;color:#fff;line-height:1}
    #psc .kpi .l{font-size:.8rem;color:var(--fc-muted)}
  </style>

  <div id="psc" class="grid gap-6 md:grid-cols-2">
    <!-- Program Stats -->
    <article class="card p-5" aria-labelledby="stats-h">
      <header class="mb-3">
        <h3 id="stats-h" class="text-xl font-extrabold text-yellow-300">Program Stats</h3>
        <p class="text-sm text-yellow-100/80">Snapshot of {{ TEAM_NAME }}’s season.</p>
      </header>

      <dl class="grid grid-cols-2 sm:grid-cols-3 gap-3">
        {% for s in _stats %}
          <div class="kpi" role="group" aria-label="{{ s.label }}">
            <dt class="l">{{ s.label }}</dt>
            <dd class="v">{{ s.value }}</dd>
          </div>
        {% endfor %}
      </dl>

      <div class="mt-4 text-xs text-yellow-200/80">
        <span class="inline-block mr-4">Regional: <strong>{{ _reg.get('wins', 0) }}–{{ _reg.get('losses', 0) }}</strong></span>
        <span class="inline-block">National: <strong>{{ _nat.get('wins', 0) }}–{{ _nat.get('losses', 0) }}</strong></span>
      </div>
    </article>

    <!-- Upcoming Schedule -->
    <article class="card p-5" aria-labelledby="cal-h">
      <header class="mb-3 flex items-center justify-between gap-3">
        <div>
          <h3 id="cal-h" class="text-xl font-extrabold text-yellow-300">Upcoming Schedule</h3>
          <p class="text-sm text-yellow-100/80">Next events & games.</p>
        </div>
        <a href="{{ safe_url_for('main_bp.calendar') or '#' }}"
           class="inline-flex items-center rounded-xl bg-yellow-400 px-3 py-1.5 text-sm font-black text-black">
          View Calendar
        </a>
      </header>

      {% if _events %}
        <ul class="divide-y divide-[var(--fc-border)]" role="list">
          {% for e in _events %}
            {% set title = e.title or e.name or 'Event' %}
            {% set when  = e.when or e.start or e.date or '' %}
            {% set where = e.where or e.location or '' %}
            <li class="py-3 flex items-start gap-3">
              <div class="rounded-lg bg-[var(--fc-surface)] px-2 py-1 text-xs font-bold text-yellow-200 shrink-0">
                {{ (when|string)[:16] }}
              </div>
              <div class="min-w-0">
                <div class="truncate font-extrabold text-yellow-100">{{ title }}</div>
                {% if where %}<div class="text-xs text-yellow-100/75">{{ where }}</div>{% endif %}
              </div>
              {% if e.url %}
                <a class="ml-auto inline-flex items-center justify-center rounded-lg border border-[var(--fc-border)] px-2 py-1 text-xs"
                   href="{{ e.url }}" target="_blank" rel="noopener">
                  Details
                </a>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="rounded-lg border border-[var(--fc-border)] bg-[var(--fc-surface)] p-4 text-sm text-yellow-100/80">
          No events scheduled yet. Check back soon!
        </div>
      {% endif %}
    </article>
  </div>
</section>

