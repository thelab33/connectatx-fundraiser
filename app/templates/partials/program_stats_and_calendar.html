{# =============================================================================
   app/templates/partials/program_pulse.html
   FundChamps ‚Ä¢ Program Pulse (SV-Elite, CSP-safe, a11y-first)
   ============================================================================= #}

{# Utilities/bootstrap (idempotent include) #}
{% include "partials/ui_bootstrap.html" ignore missing with context %}

{# ---------- Safe nonce + fallbacks ---------- #}
{% set __nonce = (csp_nonce() if csp_nonce is defined else (NONCE if NONCE is defined else '')) %}

{# ---------- Inputs & hardened defaults ---------- #}
{% set stats = stats if stats is defined and stats else [
  {"label":"GPA Avg","value":3.5},
  {"label":"Student-Athletes","value":22},
  {"label":"Fundraising Goal $","value":"10k"},
  {"label":"Active Sponsors","value":17}
] %}

{% set events = events if events is defined and events else [
  {"date":"2025-07-20","name":"AAU Tournament","location":"East Austin Gym","time":"10:00 AM","is_upcoming":true,"opponent":"All Stars","result":"","highlight":"Opening tourney!","sponsor":null,"type":"Tournament"},
  {"date":"2025-07-22","name":"Team Practice","location":"East Austin Gym","time":"5:00 PM","is_upcoming":false,"opponent":"Scrimmage","result":"W","highlight":"Strong win","sponsor":"Austin Realty","type":"Practice"}
] %}

{% set sponsors_sorted = sponsors_sorted if sponsors_sorted is defined and sponsors_sorted else [] %}
{% set sponsors_total  = sponsors_total  if sponsors_total  is defined else (sponsors_sorted | sum(attribute='amount')) %}
{% set sponsors_count  = sponsors_count  if sponsors_count  is defined else (sponsors_sorted | length) %}
{% set total_slots     = total_slots     if total_slots     is defined else 12 %}
{% set default_logo    = (url_for('static', filename='images/logo.webp') if url_for is defined else '/static/images/logo.webp') %}

{# Decide which sponsors to display (top-N by amount) #}
{% set _base = sponsors_sorted if sponsors_sorted else [] %}
{% set display = (_base | sort(attribute='amount', reverse=True))[:total_slots] %}

{# Seed demo so it never looks empty #}
{% set demo_sponsor = {
  "name":"ESPN",
  "logo":"https://upload.wikimedia.org/wikipedia/commons/2/2f/ESPN_wordmark.svg",
  "url":"https://espn.com",
  "amount":5000,
  "tier":"Platinum",
  "tooltip":"Official Broadcast Sponsor ‚Äì Sports bring communities together!"
} %}
{% if display|length == 0 %}
  {% set display = [demo_sponsor] %}
{% endif %}

<section
  id="program-pulse"
  class="relative overflow-hidden bg-zinc-950/90 py-16 text-white"
  aria-labelledby="pulse-heading"
  data-total="{{ sponsors_total or 0 }}"
  data-count="{{ sponsors_count or 0 }}"
>
  <style nonce="{{ __nonce }}">
    /* ===== Scoped to #program-pulse (no bleed) ===== */
    #program-pulse .fc-card {
      backdrop-filter: blur(10px) saturate(120%);
      -webkit-backdrop-filter: blur(10px) saturate(120%);
      background: linear-gradient(120deg, rgba(255,255,255,.06), rgba(250,220,100,.10));
      border-radius: 1.25rem; border: 1.25px solid rgba(255,255,255,.12);
      box-shadow: 0 8px 28px rgba(250,204,21,.16), 0 1px 10px rgba(255,255,255,.08);
    }
    #program-pulse .kpi {
      display:flex; gap:.6rem; align-items:center; padding:.65rem .85rem;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);
      border-radius:9999px; white-space:nowrap;
    }
    #program-pulse .kpi .label { font-size:.78rem; color:#e5e7eb }
    #program-pulse .kpi .value { font-weight:900; letter-spacing:.2px }
    #program-pulse .next-banner{ border:1px dashed rgba(250,204,21,.35); background:rgba(250,204,21,.08) }
    #program-pulse .chip{
      display:inline-flex; align-items:center; gap:.35rem;
      font-size:.7rem; font-weight:800; text-transform:uppercase;
      border-radius:9999px; padding:.15rem .6rem;
      background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.14);
    }
    #program-pulse table th{ cursor:pointer; user-select:none; }
    #program-pulse table tr[data-upcoming="true"]{ background:rgba(250,204,21,.08); color:#fde68a; font-weight:700; }
    #program-pulse table tr[data-result="W"]{ background:rgba(34,197,94,.10); color:#86efac; }
    #program-pulse table tr[data-result="L"]{ background:rgba(239,68,68,.10); color:#fca5a5; }
    #program-pulse .s-logo {
      height: 28px; width:auto; border-radius:.5rem; background:#fff;
      padding:.25rem .4rem; box-shadow: inset 0 0 0 1px rgba(0,0,0,.06);
    }
    #program-pulse .ribbon {
      display:flex; align-items:center; overflow:auto hidden; gap:1rem; scroll-behavior:smooth;
    }
    #program-pulse .ribbon::-webkit-scrollbar{ height:6px }
    #program-pulse .ribbon::-webkit-scrollbar-thumb{ background:rgba(250,204,21,.3); border-radius:9999px }
    @media (max-width: 640px){
      #program-pulse table thead { display:none }
      #program-pulse table, #program-pulse tbody, #program-pulse tr, #program-pulse td { display:block; width:100% }
      #program-pulse tbody tr { margin-bottom: .9rem; border-radius: .9rem; border:1px solid rgba(255,255,255,.08); background:rgba(24,24,27,.7); padding:.4rem .2rem }
      #program-pulse td { padding:.35rem .6rem }
      #program-pulse td[data-label]::before { content: attr(data-label) ": "; font-weight:700; color:#f5f5f4; margin-right:.25rem }
    }
    @media (prefers-reduced-motion:no-preference){
      #program-pulse .fc-card{ animation: fc-pop .6s cubic-bezier(.4,1.6,.6,1) both }
      @keyframes fc-pop{ from{opacity:0; transform:scale(.98)} to{opacity:1; transform:scale(1)} }
    }
  </style>

  <h2 id="pulse-heading" class="mb-8 text-center text-3xl font-extrabold tracking-tight text-yellow-300 sm:text-4xl">
    üóìÔ∏è Program Pulse ‚Äî Stats & Calendar
  </h2>

  <!-- ===== KPI Row ===== -->
  <div class="mx-auto mb-8 max-w-6xl">
    <div class="fc-card px-4 py-4 sm:px-6">
      <div class="flex flex-wrap items-center justify-center gap-3 sm:gap-4">
        {% for s in stats %}
          <div class="kpi" role="group" aria-label="{{ s.label }}">
            <span class="label">{{ s.label }}</span>
            <span class="value text-yellow-300">{{ s.value }}</span>
          </div>
        {% endfor %}
        <div class="kpi" role="group" aria-label="Sponsors summary">
          <span class="label">Sponsors</span>
          <span class="value text-yellow-300">
            <span id="ss-count">{{ sponsors_count }}</span> ‚Ä¢
            $<span id="ss-total">{{ (sponsors_total or 0) | int }}</span>
          </span>
        </div>
      </div>
    </div>
  </div>

  <div class="mx-auto grid max-w-6xl grid-cols-1 gap-10 lg:grid-cols-12">

    {# ===== Left Column: Next + Filters + Table ===== #}
    <div class="space-y-8 lg:col-span-8">

      {% if events and events|length %}
      <!-- Next event banner -->
      <div class="next-banner rounded-2xl p-4 text-sm sm:text-base" role="region" aria-live="polite" aria-label="Next team event">
        <div class="flex flex-wrap items-center gap-3">
          <span class="chip">Next</span>
          <div id="next-event-text" class="min-w-[200px] flex-1 text-yellow-100">Scanning upcoming events‚Ä¶</div>
          <div class="ml-auto flex gap-2">
            <button id="evt-add-ics" type="button" class="rounded-full bg-yellow-400/90 px-3 py-1.5 text-xs font-black text-black hover:bg-yellow-400">
              + Add .ics
            </button>
            <a id="evt-add-gcal" href="#" class="rounded-full border border-yellow-400/70 px-3 py-1.5 text-xs font-black text-yellow-200 hover:bg-zinc-900" rel="noopener">
              + Google
            </a>
          </div>
        </div>
      </div>
      {% endif %}

      {% if events and events|length %}
      <!-- Filters -->
      <div class="flex w-full flex-wrap items-center gap-3 text-sm">
        <div class="min-w-[220px] flex-1">
          <label for="evt-search" class="sr-only">Search</label>
          <input id="evt-search" type="search" placeholder="Search events, opponents, locations‚Ä¶"
                 class="w-full rounded-lg border border-yellow-400/20 bg-zinc-900/70 px-3 py-2 outline-none ring-0 placeholder:text-zinc-400 focus:border-yellow-400/50" />
        </div>
        <div>
          <label for="evt-type" class="sr-only">Type</label>
          <select id="evt-type" class="rounded-lg border border-yellow-400/20 bg-zinc-900/70 px-3 py-2">
            <option value="">All types</option>
            <option>Tournament</option><option>Game</option><option>Practice</option>
            <option>Scrimmage</option><option>Fundraiser</option>
          </select>
        </div>
        <label class="inline-flex items-center gap-2">
          <input id="evt-upcoming" type="checkbox" class="h-4 w-4 rounded border-yellow-400/40 bg-zinc-900/80" />
          Upcoming only
        </label>
        <div class="ml-auto flex items-center gap-2">
          <button id="evt-export" type="button"
                  class="rounded-full border border-yellow-400/40 bg-black px-4 py-2 font-bold text-yellow-200 hover:bg-zinc-900">
            ‚§ì Export CSV
          </button>
          {% if calendar_ics_url is defined and calendar_ics_url %}
          <a href="{{ calendar_ics_url }}"
             class="rounded-full bg-gradient-to-r from-yellow-400 to-yellow-200 px-5 py-2 font-bold text-black shadow hover:scale-105">
            Export .ics
          </a>
          {% else %}
          <button id="evt-export-ics" type="button"
            class="rounded-full bg-gradient-to-r from-yellow-400 to-yellow-200 px-5 py-2 font-bold text-black shadow hover:scale-105">
            Export .ics
          </button>
          {% endif %}
        </div>
      </div>

      <!-- Table -->
      <div class="w-full overflow-x-auto rounded-2xl border border-yellow-400/10 bg-zinc-900/90 p-5 shadow-xl md:p-8">
        <table class="min-w-full rounded-xl text-left text-sm" aria-describedby="pulse-heading">
          <caption class="sr-only">Team schedule with dates, locations, results and sponsors</caption>
          <thead>
            <tr class="border-b border-yellow-400/10 text-yellow-300">
              <th scope="col" class="px-3 py-2" data-sort="date"     aria-sort="none" title="Click to sort">Date</th>
              <th scope="col" class="px-3 py-2" data-sort="name"     aria-sort="none" title="Click to sort">Event</th>
              <th scope="col" class="px-3 py-2" data-sort="location" aria-sort="none" title="Click to sort">Location</th>
              <th scope="col" class="px-3 py-2" data-sort="time"     aria-sort="none" title="Click to sort">Time</th>
              <th scope="col" class="px-3 py-2" data-sort="result"   aria-sort="none" title="Click to sort">Result</th>
              <th scope="col" class="px-3 py-2" data-sort="sponsor"  aria-sort="none" title="Click to sort">Sponsor</th>
            </tr>
          </thead>
          <tbody id="evt-body">
            {% for e in events %}
            {% set res = (e.result if e.result is defined else '') %}
            {% set res_u = (res ~ '')|upper %}
            {% set upcoming = (e.is_upcoming if e.is_upcoming is defined else None) %}
            <tr class="transition-colors"
                data-row
                itemscope itemtype="https://schema.org/SportsEvent"
                data-date="{{ e.date }}"
                data-name="{{ (e.name if e.name is defined and e.name else (e.opponent if e.opponent is defined else 'Team Event')) }}"
                data-location="{{ e.location }}"
                data-time="{{ e.time }}"
                data-type="{{ e.type or '' }}"
                data-result="{{ 'W' if 'W' in res_u else ('L' if 'L' in res_u else '') }}"
                data-upcoming="{{ 'true' if upcoming else 'auto' }}"
                data-sponsor="{{ e.sponsor or '' }}">
              <td class="whitespace-nowrap px-3 py-2" data-label="Date">
                {% set _dt = (e.date ~ '') %}
                {% set _tm = (e.time if e.time is defined and e.time else '00:00') %}
                <time datetime="{{ _dt }}T{{ _tm }}" itemprop="startDate">{{ _dt.replace('-', '/') }}</time>
              </td>
              <td class="px-3 py-2" data-label="Event">
                <span itemprop="name">{{ (e.name if e.name is defined and e.name else (e.opponent if e.opponent is defined else 'Team Event')) }}</span>
                {% if e.type %}<span class="ml-2 chip" itemprop="eventType">{{ e.type }}</span>{% endif %}
                {% if e.highlight %}<span class="ml-2 text-xs font-semibold text-yellow-300/90">‚Ä¢ {{ e.highlight }}</span>{% endif %}
              </td>
              <td class="px-3 py-2" data-label="Location" itemprop="location">{{ e.location }}</td>
              <td class="px-3 py-2" data-label="Time">{{ e.time }}</td>
              <td class="px-3 py-2 font-semibold" data-label="Result">
                {% if 'W' in res_u %}<span class="text-green-300">üü¢ Win</span>
                {% elif 'L' in res_u %}<span class="text-red-400">üî¥ Loss</span>
                {% elif upcoming %}<span class="text-yellow-200">üü° Upcoming</span>
                {% else %}<span class="text-zinc-400">‚Äî</span>{% endif %}
              </td>
              <td class="px-3 py-2" data-label="Sponsor">
                {% if e.sponsor %}<span class="font-bold">{{ e.sponsor }}</span>{% else %}<span class="text-zinc-400">‚Äî</span>{% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <div class="mt-4 text-xs text-zinc-400">Times shown in your local timezone.</div>
      </div>
      {% else %}
        <div class="w-full rounded-xl border border-yellow-400/20 bg-black/40 p-6 text-sm text-zinc-300">
          No events yet. Check back soon!
        </div>
      {% endif %}
    </div>

    {# ===== Right Column: Sponsors ribbon & callouts ===== #}
    <aside class="space-y-6 lg:col-span-4">
      <!-- Sponsors ribbon (auto de-duped) -->
      <div class="fc-card p-4">
        <div class="mb-3 flex items-center justify-between">
          <h3 class="text-sm font-extrabold uppercase tracking-wide text-yellow-300">Sponsors</h3>
          <span class="text-xs text-zinc-300">Top supporters</span>
        </div>
        <div class="ribbon" data-ribbon>
          {% for s in display %}
            <a href="{{ s.url or '#' }}" target="_blank" rel="noopener noreferrer sponsored" class="shrink-0" aria-label="Visit {{ s.name }}">
              <img class="s-logo" src="{{ s.logo or default_logo }}" alt="{{ s.name }} logo" loading="lazy" decoding="async" />
            </a>
          {% endfor %}
        </div>
      </div>

      <!-- CTA box -->
      <div class="fc-card p-5">
        <h3 class="text-lg font-extrabold text-yellow-200">Fuel the Season</h3>
        <p class="mt-1 text-sm text-zinc-300">Every dollar supports travel, equipment, and academic tutoring.</p>
        <div class="mt-3 flex gap-2">
          <a href="#donate" data-open-donation class="rounded-xl bg-yellow-400 px-4 py-2 text-sm font-black text-black hover:bg-yellow-300">Quick Donate</a>
          <a href="#tiers" data-modal-open="tiers-modal" class="rounded-xl border border-yellow-400/60 px-4 py-2 text-sm font-bold text-yellow-200 hover:bg-zinc-900">See Tiers</a>
        </div>
      </div>
    </aside>
  </div>
</section>

<script nonce="{{ __nonce }}">
(() => {
  const root = document.getElementById('program-pulse');
  if (!root || root.__init) return; root.__init = true;

  /* ---------- Cache ---------- */
  const tbody   = root.querySelector('#evt-body');
  const ribbon  = root.querySelector('[data-ribbon]');
  const nextTxt = root.querySelector('#next-event-text');
  const totalEl = root.querySelector('#ss-total');
  const countEl = root.querySelector('#ss-count');

  /* ---------- Utils ---------- */
  const fmt0 = (n)=> (Math.round(+n||0)).toLocaleString();
  const cmp  = (x,y)=>{ x=(x||'').toLowerCase(); y=(y||'').toLowerCase(); return x<y?-1:x>y?1:0 };
  const hasCrypto = !!(window.crypto && window.crypto.getRandomValues);

  function cryptoRandom(n){
    const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    if (!hasCrypto) return Array.from({length:n},()=>chars[Math.floor(Math.random()*chars.length)]).join('');
    const arr = new Uint8Array(n); window.crypto.getRandomValues(arr);
    return Array.from(arr, v=> chars[v%chars.length]).join('');
  }

  function parseDateTime(date, time){
    if (!date) return new Date(NaN);
    const t = (time||'').trim();
    let norm = t;
    if (t && !/^\d{1,2}:\d{2}\s*[ap]m$/i.test(t) && /^[0-9]{1,2}\s*[ap]m$/i.test(t)) norm = t.replace(/^(\d{1,2})\s*([ap]m)$/i, '$1:00 $2');
    const d1 = new Date(`${date} ${norm||'12:00 PM'}`);
    if (!isNaN(d1)) return d1;
    const d2 = new Date(date);
    return d2;
  }

  function rowToEvent(r){
    const title = (r.dataset.name || 'Team Event');
    const loc   = (r.dataset.location || '');
    const start = parseDateTime(r.dataset.date, r.dataset.time);
    const end   = new Date(start.getTime() + 90*60*1000); // default 90m
    const fmt = (d)=> d.toISOString().replace(/[-:]/g,'').replace('.000','');
    return {
      uid: cryptoRandom(10) + '@fundchamps',
      dtstamp: fmt(new Date()),
      dtstart: fmt(start),
      dtend: fmt(end),
      summary: title,
      location: loc
    };
  }

  function escapeICS(s){ return String(s).replace(/([,;])/g,'\\$1').replace(/\n/g,'\\n') }
  function downloadICS(events, filename){
    const lines = ['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//FundChamps//Calendar//EN'];
    events.forEach(e=>{
      lines.push('BEGIN:VEVENT','UID:'+e.uid,'DTSTAMP:'+e.dtstamp,'DTSTART:'+e.dtstart,'DTEND:'+e.dtend,
                 'SUMMARY:'+escapeICS(e.summary));
      if (e.location) lines.push('LOCATION:'+escapeICS(e.location));
      lines.push('END:VEVENT');
    });
    lines.push('END:VCALENDAR');
    const blob = new Blob([lines.join('\r\n')], { type:'text/calendar;charset=utf-8' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename||'events.ics';
    document.body.appendChild(a); a.click(); a.remove();
  }
  function googleCalUrl(e){
    const qp = new URLSearchParams({
      action:'TEMPLATE', text:e.summary, dates:`${e.dtstart}/${e.dtend}`,
      details:'FundChamps event', location:e.location||'', trp:'true'
    });
    return `https://calendar.google.com/calendar/render?${qp.toString()}`;
  }

  /* ---------- De-dupe EVENTS by (date|time|name|location) ---------- */
  if (tbody) {
    const rows = Array.from(tbody.querySelectorAll('[data-row]'));
    const seen = new Set();
    rows.forEach(r => {
      const key = [
        (r.dataset.date||'').trim().toLowerCase(),
        (r.dataset.time||'').trim().toLowerCase(),
        (r.dataset.name||'').trim().toLowerCase(),
        (r.dataset.location||'').trim().toLowerCase()
      ].join('|');
      if (seen.has(key)) r.remove(); else seen.add(key);
    });
  }

  /* ---------- Localize <time> + mark upcoming ---------- */
  function getRowDate(r){ return parseDateTime(r.dataset.date, r.dataset.time) }
  if (tbody) {
    const now = new Date();
    tbody.querySelectorAll('tr[data-row]').forEach(r => {
      const t = r.querySelector('time[datetime]');
      if (t) {
        const iso = t.getAttribute('datetime'); const d = new Date(iso);
        if (!isNaN(d)) {
          const hasTime = /T\d{2}:\d{2}/.test(iso);
          t.textContent = hasTime
            ? d.toLocaleString(undefined, { dateStyle:'medium', timeStyle:'short' })
            : d.toLocaleDateString(undefined, { dateStyle:'medium' });
        }
      }
      if (r.dataset.upcoming === 'auto') r.dataset.upcoming = getRowDate(r) > now ? 'true' : 'false';
    });
  }

  /* ---------- Next event banner ---------- */
  if (tbody && nextTxt) {
    const rows = Array.from(tbody.querySelectorAll('[data-row]'));
    const upcoming = rows.filter(r => r.dataset.upcoming === 'true');
    if (!upcoming.length) nextTxt.textContent = 'No upcoming events ‚Äî stay tuned!';
    else {
      const next = upcoming.sort((a,b)=> getRowDate(a) - getRowDate(b))[0];
      const when = next.querySelector('time')?.textContent?.trim() || next.dataset.date;
      const what = (next.dataset.name || '').trim();
      const where= (next.dataset.location || '').trim();
      nextTxt.textContent = `Next: ${what} ‚Ä¢ ${when} ‚Ä¢ ${where}`;

      root.querySelector('#evt-add-ics')?.addEventListener('click', ()=>{
        const ev = rowToEvent(next);
        downloadICS([ev], 'next-event.ics');
      });
      const g = root.querySelector('#evt-add-gcal');
      if (g) g.href = googleCalUrl(rowToEvent(next));
    }
  }

  /* ---------- Filters + sort + export ---------- */
  const search = root.querySelector('#evt-search');
  const selType = root.querySelector('#evt-type');
  const chkUpcoming = root.querySelector('#evt-upcoming');

  const sorters = {
    date:(a,b)=> (getRowDate(a) - getRowDate(b)),
    name:(a,b)=> cmp(a.dataset.name,b.dataset.name),
    location:(a,b)=> cmp(a.dataset.location,b.dataset.location),
    time:(a,b)=> cmp(a.dataset.time,b.dataset.time),
    result:(a,b)=> cmp(a.dataset.result,b.dataset.result),
    sponsor:(a,b)=> cmp(a.dataset.sponsor,b.dataset.sponsor),
  };

  function applyFilters(){
    if (!tbody) return [];
    const rows = Array.from(tbody.querySelectorAll('[data-row]'));
    const q = (search?.value||'').trim().toLowerCase();
    const ty = (selType?.value||'').toLowerCase();
    const onlyUp = !!(chkUpcoming?.checked);
    const visible = [];
    rows.forEach((row)=>{
      const matchQ = !q || row.dataset.name.toLowerCase().includes(q)
        || row.dataset.location.toLowerCase().includes(q)
        || row.dataset.sponsor.toLowerCase().includes(q);
      const matchT = !ty || (row.dataset.type||'').toLowerCase() === ty;
      const matchU = !onlyUp || row.dataset.upcoming === 'true';
      row.style.display = matchQ && matchT && matchU ? '' : 'none';
      if (row.style.display === '') visible.push(row);
    });
    return visible;
  }

  let currentSort = { key:'date', dir:'asc' };
  function sortRows(list){
    if (!tbody) return;
    const k = currentSort.key, dir = currentSort.dir === 'asc' ? 1 : -1;
    const sorted = list.sort((a,b)=> sorters[k](a,b)*dir);
    const frag = document.createDocumentFragment();
    sorted.forEach(r=> frag.appendChild(r));
    tbody.appendChild(frag);
  }
  function setSort(key){
    if (currentSort.key === key) currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
    else currentSort = { key, dir:'asc' };
    root.querySelectorAll('th[data-sort]').forEach(th=>{
      th.setAttribute('aria-sort', th.dataset.sort === currentSort.key ? currentSort.dir : 'none');
      th.title = 'Click to sort ' + (th.getAttribute('aria-sort')==='asc'?'‚Üì':'‚Üë');
    });
    sortRows(applyFilters());
  }
  root.querySelectorAll('th[data-sort]').forEach(th=>{
    th.addEventListener('click', ()=> setSort(th.dataset.sort));
    th.addEventListener('keydown', (e)=> { if(e.key==='Enter' || e.key===' ') { e.preventDefault(); setSort(th.dataset.sort); }}); th.tabIndex = 0;
  });
  [search, selType, chkUpcoming].forEach(el=> el?.addEventListener('input', ()=> sortRows(applyFilters())));
  setSort('date');

  // CSV/ICS bulk export
  root.querySelector('#evt-export')?.addEventListener('click', ()=>{
    const visible = applyFilters();
    const header = ['Date','Event','Location','Time','Result','Sponsor'];
    const lines = [header.join(',')];
    visible.forEach(r=>{
      const cells = Array.from(r.children).slice(0,6).map(td=>{
        const txt = td.innerText.replace(/\s+/g,' ').trim().replace(/"/g,'""');
        return `"${txt}"`;
      });
      lines.push(cells.join(','));
    });
    const blob = new Blob([lines.join('\n')], { type:'text/csv;charset=utf-8' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'events.csv';
    document.body.appendChild(a); a.click(); a.remove();
  });

  root.querySelector('#evt-export-ics')?.addEventListener('click', ()=>{
    const visible = applyFilters();
    const evs = visible.map(rowToEvent);
    downloadICS(evs, 'events.ics');
  });

  /* ---------- Sponsors ribbon: de-dupe logos by src ---------- */
  if (ribbon) {
    const seenSrc = new Set();
    Array.from(ribbon.querySelectorAll('img[src]')).forEach(img=>{
      try {
        const key = new URL(img.src, location.href).href;
        if (seenSrc.has(key)) img.parentElement?.remove(); else seenSrc.add(key);
      } catch { /* ignore */ }
    });
  }

  /* ---------- Public API (compatible with other partials) ---------- */
  function addLogoToRibbon(logo, alt, url){
    if (!logo || !ribbon) return;
    const a = document.createElement('a');
    a.href = url || '#'; a.target = '_blank'; a.rel = 'noopener noreferrer sponsored'; a.className = 'shrink-0';
    const img = document.createElement('img');
    img.src = logo; img.alt = alt || 'Sponsor logo'; img.loading='lazy'; img.decoding='async'; img.className='s-logo';
    a.appendChild(img); ribbon.insertBefore(a, ribbon.firstChild);
  }
  window.fcAddSponsorPulseLogo = addLogoToRibbon;

  // Live updates (optional Socket.IO)
  if (typeof window.io === 'function') {
    try {
      const sock = window.io('/sponsors', { transports: ['websocket','polling'] });
      sock.on('sponsor', (payload)=> {
        if (payload?.logo) addLogoToRibbon(payload.logo, `${payload.name} logo`, payload.url);
        // Update totals
        const curTotal = parseFloat(root.dataset.total || '0');
        const curCount = parseInt(root.dataset.count || '0', 10);
        const newTotal = curTotal + (+payload.amount||0);
        root.dataset.total = String(newTotal);
        root.dataset.count = String(curCount + 1);
        if (totalEl) totalEl.textContent = fmt0(newTotal);
        if (countEl) countEl.textContent = String(curCount + 1);
        // (Optional) Analytics hook
        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push({event:'sponsor_update', sponsor_tier: payload.tier||'', sponsor_amount: +payload.amount||0});
      });
    } catch(_) {}
  }

  // Modal triggers (donation / tiers)
  document.addEventListener('click', (e)=>{
    const open = e.target.closest('[data-modal-open]');
    if (open) {
      const id = open.getAttribute('data-modal-open');
      const dlg = document.getElementById(id);
      if (dlg?.showModal) { e.preventDefault(); dlg.showModal(); }
    }
    const donate = e.target.closest('[data-open-donation]');
    if (donate) {
      e.preventDefault();
      const trigger = document.querySelector('[data-modal-open="donation-modal"], [data-modal-open="tiers-modal"]');
      trigger?.click();
    }
  });
})();
</script>

