<!-- Floating AI Concierge Button (z-40) -->
<button
  id="ai-concierge-btn"
  class="fixed bottom-6 right-6 z-40 bg-yellow-400 text-zinc-900 rounded-full p-4 shadow-xl hover:scale-110 focus:scale-105 transition ring-2 ring-yellow-300 hover:ring-yellow-400 focus-visible:ring-4 focus-visible:ring-yellow-400"
  aria-label="Chat with AI Concierge"
  aria-expanded="false"
  aria-controls="ai-concierge"
  type="button"
>
  <span class="sr-only">Open chat</span>üí¨
</button>

<!-- AI Concierge Modal (Dialog, always on top, a11y-first) -->
<dialog
  id="ai-concierge"
  class="fixed inset-0 z-[99999] flex items-center justify-center bg-black/70 backdrop-blur-md transition-opacity duration-300 opacity-0 pointer-events-none"
  aria-labelledby="ai-modal-title"
  aria-modal="true"
  tabindex="-1"
>
  <div
    class="relative flex flex-col w-full max-w-md rounded-2xl bg-zinc-900 -2 shadow-2xl overflow-hidden scale-95 opacity-0 transition-transform transition-opacity duration-300 ease-out"
    style="min-width: 330px"
    role="document"
  >
    <!-- Modal Header -->
    <header class="flex items-center gap-3 py-4 px-6 bg-gradient-to-r from-yellow-400 via-yellow-200 to-yellow-400 -b">
      <span class="text-2xl" aria-hidden="true">ü§ñ</span>
      <h3 id="ai-modal-title" class="flex-1 text-xl font-extrabold text-zinc-900">AI Concierge</h3>
      <button
        type="button"
        class="ml-auto rounded-full bg-zinc-800/40 px-3 py-1 text-xl text-yellow-600 hover:text-red-500 focus-visible:ring-2 focus-visible:ring-yellow-400"
        aria-label="Close chat"
        data-close
      >√ó</button>
    </header>

    <!-- Chat Log (Role="log" for screen readers) -->
    <section
      id="ai-chat-log"
      class="flex-1 overflow-y-auto max-h-[50vh] p-5 bg-black/5 text-yellow-200"
      role="log"
      aria-live="polite"
      aria-relevant="additions"
    >
      <p>Welcome! Ask me anything about the program, events, or fundraising.</p>
    </section>

    <!-- Typing Indicator -->
    <div
      id="typing-indicator"
      class="hidden px-5 pb-2 text-yellow-400 italic select-none text-sm"
      aria-live="polite"
      aria-atomic="true"
    >AI is typing‚Ä¶</div>

    <!-- Shortcuts Tooltip -->
    <div
      class="px-5 py-2 text-xs text-yellow-300 bg-yellow-900/30 text-center select-none -t"
      role="tooltip"
      aria-label="Keyboard shortcuts"
    >
      Press <kbd class="rounded px-1">ESC</kbd> to close,
      <kbd class="rounded px-1">Cmd/Ctrl + /</kbd> to open chat.
    </div>

    <!-- Composer -->
    <form
      id="ai-chat-form"
      class="flex gap-2 p-4 -t bg-zinc-900"
      autocomplete="off"
      aria-label="Send message to AI Concierge"
      novalidate
    >
      <label class="sr-only" for="ai-chat-input">Your message</label>
      <input
        id="ai-chat-input"
        name="message"
        type="text"
        required
        autocomplete="off"
        placeholder="Type your question‚Ä¶"
        aria-required="true"
        class="flex-1 rounded-lg bg-zinc-800 px-4 py-2 text-yellow-100 focus:ring-2 focus:ring-yellow-400 outline-none"
        aria-live="polite"
        aria-atomic="true"
      />
      <button
        id="ai-send-btn"
        type="submit"
        class="relative rounded-lg bg-yellow-400 px-4 py-2 font-bold text-black hover:bg-yellow-300 focus-visible:ring-2 focus-visible:ring-yellow-400 disabled:opacity-50 disabled:cursor-not-allowed"
        disabled
      >
        Send
      </button>
    </form>
  </div>
</dialog>

<style>
  #ai-concierge:not(.closed) {
    opacity: 1 !important;
    pointer-events: auto !important;
    transition: opacity 0.22s cubic-bezier(.4,0,.2,1);
  }
  #ai-concierge.closed {
    opacity: 0 !important;
    pointer-events: none !important;
    transition: opacity 0.18s cubic-bezier(.4,0,.2,1);
  }
  #ai-concierge > div {
    opacity: 1 !important;
    transform: scale(1) !important;
    transition: opacity 0.3s, transform 0.28s cubic-bezier(.4,0,.2,1);
  }
  #ai-concierge.closed > div {
    opacity: 0 !important;
    transform: scale(0.97) !important;
  }
  .confetti-piece {
    position: fixed;
    width: 8px;
    height: 8px;
    border-radius: 2px;
    opacity: 0.9;
    pointer-events: none;
    z-index: 15000;
    filter: drop-shadow(0 0 1px #fff9) drop-shadow(0 0 2px #facc15aa);
    animation: confetti-spin 8s linear infinite;
  }
  @keyframes confetti-spin {
    from { transform: rotate(0deg);}
    to { transform: rotate(360deg);}
  }
</style>

<script type="module">
  const dlg = document.getElementById('ai-concierge');
  const btn = document.getElementById('ai-concierge-btn');
  const inputEl = document.getElementById('ai-chat-input');
  const logEl = document.getElementById('ai-chat-log');
  const typingEl = document.getElementById('typing-indicator');
  const sendBtn = document.getElementById('ai-send-btn');

  const escapeHtml = (str) =>
    str.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));

  // Restore chat history from sessionStorage
  let chatHistory = JSON.parse(sessionStorage.getItem('aiChatHistory') || '[]');
  if (chatHistory.length) {
    logEl.innerHTML = '';
    chatHistory.forEach(({ user, reply }) => {
      logEl.insertAdjacentHTML(
        'beforeend',
        `<div class="my-2 text-right"><span class="inline-block max-w-[80%] break-words rounded-2xl bg-yellow-300 px-4 py-2 text-black">${escapeHtml(user)}</span></div>
         <div class="my-2 text-left"><span class="inline-block max-w-[80%] break-words rounded-2xl bg-zinc-800 px-4 py-2 text-yellow-200">ü§ñ <em>AI:</em> ${escapeHtml(reply)}</span></div>`
      );
    });
    logEl.scrollTop = logEl.scrollHeight;
  }

  // Enable send button only when input has value
  inputEl.addEventListener('input', () => {
    sendBtn.disabled = !inputEl.value.trim();
  });

  // Open modal with accessibility and animation
  function openAIModal() {
    if (!dlg.open) dlg.showModal();
    dlg.classList.remove('closed');
    document.body.style.overflow = 'hidden';
    btn.setAttribute('aria-expanded', 'true');
    setTimeout(() => inputEl.focus(), 150);
  }
  btn.onclick = openAIModal;

  // Close modal, revert focus and scroll locking
  function closeAIModal() {
    dlg.classList.add('closed');
    setTimeout(() => {
      if (dlg.open) dlg.close();
      document.body.style.overflow = '';
      btn.setAttribute('aria-expanded', 'false');
      btn.focus();
    }, 180);
  }

  // Close modal on any [data-close] button or backdrop click
  dlg.addEventListener('click', (e) => {
    if (e.target.closest('[data-close]') || e.target === dlg) closeAIModal();
  });

  // Close modal on ESC
  dlg.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeAIModal();
  });

  // Focus trap inside modal
  dlg.addEventListener('keydown', (e) => {
    if (e.key !== 'Tab') return;
    const focusable = dlg.querySelectorAll('button, [tabindex]:not([tabindex="-1"]), input, textarea, select, a, [role="button"]');
    if (!focusable.length) return;
    const first = focusable[0], last = focusable[focusable.length - 1];
    if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
    else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
  });

  // Confetti animation on AI reply
  function launchConfetti() {
    const confettiCount = 16, colors = ['#FBBF24','#FACC15','#FFD700','#FFC107','#FFEB3B'];
    const rect = dlg.getBoundingClientRect();
    for (let i = 0; i < confettiCount; i++) {
      const confetti = document.createElement('div');
      confetti.className = 'confetti-piece';
      confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.left = `${rect.left + Math.random() * rect.width}px`;
      confetti.style.top = `${rect.top + Math.random() * rect.height}px`;
      document.body.appendChild(confetti);
      confetti.animate(
        [
          {transform:'translate(0,0) rotate(0deg)', opacity:1},
          {transform:`translate(${(Math.random()-0.5)*220}px, ${(Math.random()-0.5)*220}px) rotate(${Math.random()*360}deg)`, opacity:0}
        ],
        {duration:1900+Math.random()*400, easing:'ease-out', fill:'forwards'}
      );
      setTimeout(() => confetti.remove(), 2200);
    }
  }

  // Handle chat submission and update log
  document.getElementById('ai-chat-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const msg = inputEl.value.trim();
    if (!msg) return;
    logEl.insertAdjacentHTML(
      'beforeend',
      `<div class="my-2 text-right"><span class="inline-block max-w-[80%] break-words rounded-2xl bg-yellow-300 px-4 py-2 text-black">${escapeHtml(msg)}</span></div>`
    );
    logEl.scrollTop = logEl.scrollHeight;
    typingEl.classList.remove('hidden');
    inputEl.value = '';
    sendBtn.disabled = true;
    try {
      const response = await fetch('/api/ai-chat', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ message: msg }),
      });
      const data = await (response.ok ? await response.json() : { reply: 'Sorry, service error.' });
      logEl.insertAdjacentHTML(
        'beforeend',
        `<div class="my-2 text-left"><span class="inline-block max-w-[80%] break-words rounded-2xl bg-zinc-800 px-4 py-2 text-yellow-200">ü§ñ <em>AI:</em> ${escapeHtml(data.reply)}</span></div>`
      );
      launchConfetti();
      chatHistory.push({ user: msg, reply: data.reply });
      sessionStorage.setItem('aiChatHistory', JSON.stringify(chatHistory));
    } catch (error) {
      logEl.insertAdjacentHTML(
        'beforeend',
        `<div class="my-2 text-left text-red-500"><span class="inline-block max-w-[80%] break-words rounded-2xl bg-black/80 px-4 py-2">‚ö†Ô∏è ${escapeHtml(error.message)}</span></div>`
      );
    } finally {
      typingEl.classList.add('hidden');
      logEl.scrollTop = logEl.scrollHeight;
      sendBtn.disabled = false;
    }
  });

  // Keyboard shortcut: Cmd/Ctrl + /
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === '/') {
      openAIModal();
      e.preventDefault();
    }
  });
</script>

