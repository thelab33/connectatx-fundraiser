{% macro sponsor_card(sponsor, idx) %}
  {% set tier = sponsor.tier | default('default') %}
  {% set tier_styles = {
    'Platinum': 'bg-yellow-300 text-yellow-900',
    'Gold': 'bg-yellow-200 text-yellow-800',
    'Silver': 'bg-yellow-100 text-yellow-700',
    'Bronze': 'bg-orange-200 text-orange-900',
    'default': 'bg-indigo-900 text-yellow-300',
  } %}
  {% set tier_emojis = {
    'Platinum': 'ü•á',
    'Gold': 'ü•à',
    'Silver': 'ü•â',
    'Bronze': 'üèÖ',
    'default': 'üèÜ',
  } %}

  {% set logo_src = (
    sponsor.logo if sponsor.logo and sponsor.logo.startswith('http') else
    (url_for('static', filename='images/sponsors/' ~ sponsor.logo) if sponsor.logo else url_for('static', filename='images/logo.webp'))
  ) %}

  <article
    tabindex="0"
    aria-label="{{ sponsor.name or 'Sponsor' }}"
    aria-describedby="tooltip-{{ idx }}"
    role="listitem"
    itemscope
    itemtype="https://schema.org/Organization"
    itemprop="sponsor"
    class="group relative flex flex-col items-center px-6 py-7 rounded-3xl shadow-lg
           focus-visible:ring-4 focus-visible:ring-yellow-400
           transition-transform duration-300 hover:scale-105
           {{ tier_styles.get(tier, tier_styles['default']) }}"
  >
    {% if tier == 'Platinum' %}
      <span class="absolute top-2 right-2 pointer-events-none" aria-hidden="true">
        <svg width="32" height="32" fill="none" aria-hidden="true" focusable="false">
          <circle cx="16" cy="16" r="13" fill="#fde68a" opacity=".7" />
        </svg>
      </span>
    {% endif %}

    {% if sponsor.url %}
      <a href="{{ sponsor.url }}" target="_blank" rel="noopener sponsored" tabindex="-1" aria-label="Visit {{ sponsor.name }} website" itemprop="url">
    {% endif %}
      <img
        src="{{ logo_src }}"
        alt="{{ sponsor.name or 'Sponsor' }} logo"
        width="96" height="96"
        class="w-24 h-24 mb-4 rounded-full bg-white shadow-lg object-cover grayscale transition duration-300 group-hover:grayscale-0 group-hover:scale-110"
        loading="lazy"
        decoding="async"
        itemprop="logo"
      />
    {% if sponsor.url %}</a>{% endif %}

    <div class="flex flex-col items-center text-center">
      <h3
        class="text-xl font-extrabold text-yellow-900/90 transition group-hover:text-yellow-600"
        itemprop="name"
      >
        {{ sponsor.name or 'Sponsor' }}
        {% if sponsor.is_new %}
          <span class="ml-2 bg-emerald-400/80 text-emerald-900 px-2 py-0.5 rounded-full text-xs font-bold" aria-label="New sponsor badge">NEW</span>
        {% elif sponsor.is_returning %}
          <span class="ml-2 bg-blue-300/80 text-blue-900 px-2 py-0.5 rounded-full text-xs font-bold animate-bounce" aria-label="Returning sponsor badge">Returning</span>
        {% endif %}
      </h3>

      <span
        class="mt-0.5 font-mono text-lg text-yellow-900/80"
        aria-label="Sponsor amount raised"
        itemprop="donation"
      >
        ${{ sponsor.amount | int | comma | default(0) }}
      </span>

      <span class="mt-2 inline-block px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide
                   {% if tier == 'Platinum' %}bg-yellow-300 text-yellow-900
                   {% elif tier == 'Gold' %}bg-yellow-200 text-yellow-800
                   {% elif tier == 'Silver' %}bg-yellow-100 text-yellow-700
                   {% elif tier == 'Bronze' %}bg-orange-200 text-orange-900
                   {% else %}bg-indigo-900 text-yellow-300{% endif %}"
            itemprop="memberOf"
      >
        {{ tier_emojis.get(tier, 'üèÜ') }} {{ tier if tier != 'default' else 'Champion' }}
      </span>

      {% if sponsor.description %}
        <p
          class="mt-2 max-w-xs text-sm text-zinc-700"
          aria-label="Sponsor description"
          itemprop="description"
        >{{ sponsor.description }}</p>
      {% endif %}
    </div>

    <div
      id="tooltip-{{ idx }}"
      role="tooltip"
      class="pointer-events-none absolute left-1/2 bottom-[-2.3rem] -translate-x-1/2 rounded-xl bg-black/90 px-3 py-1 text-xs text-yellow-200 opacity-0 transition-opacity duration-200 group-hover:opacity-100 group-focus-within:opacity-100"
      aria-hidden="true"
    >
      {{ sponsor.tooltip or sponsor.description or 'Thanks for supporting us!' }}
    </div>
  </article>
{% endmacro %}

<section
  id="sponsor-spotlight"
  class="relative z-20 my-20 px-4 sm:px-8 max-w-6xl mx-auto"
  role="region"
  tabindex="-1"
  aria-labelledby="sponsor-spotlight-heading"
>
  <h2
    id="sponsor-spotlight-heading"
    class="mb-10 text-center text-4xl font-extrabold bg-gradient-to-r from-yellow-400 via-amber-200 to-yellow-400 bg-clip-text text-transparent drop-shadow-xl animate-shine"
  >
    üèÜ Sponsor Spotlight Wall
    <span
      class="block mt-2 text-base font-semibold text-yellow-300/80 animate-fade-in"
      aria-live="polite"
      aria-atomic="true"
    >
      {{ sponsors_sorted|length or 0 }} Champions | ${{ sponsors_total|int|comma|default(0) }} raised
    </span>
  </h2>

  <!-- Top Sponsors (up to 4 premium slots) -->
  <div
    class="grid gap-8 grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-4 justify-center"
    role="list"
    aria-label="Top Sponsors"
  >
    {% for sponsor in sponsors_sorted[:4] %}
      {{ sponsor_card(sponsor, loop.index) }}
    {% endfor %}

    {# Placeholder tiles if less than 4 sponsors #}
    {% set needed = 4 - (sponsors_sorted|length) %}
    {% for _ in range(needed if needed > 0 else 0) %}
      <div
        class="flex min-w-[200px] h-[255px] flex-col items-center justify-center rounded-3xl border-2 border-dashed border-yellow-400 bg-zinc-900/60 text-yellow-300/80 shadow-inner"
        role="listitem"
        tabindex="0"
        aria-label="Available sponsorship spot"
      >
        <span class="text-2xl" aria-hidden="true">‚ú®</span>
        <span class="mt-4 text-center font-bold">This spot is waiting for you!</span>
        <button
          onclick="openSponsorModal()"
          class="mt-4 rounded-full bg-yellow-400 px-6 py-2 font-extrabold text-black shadow-lg transition hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-400"
          aria-label="Become a Sponsor"
          type="button"
        >
          üåü Become a Sponsor
        </button>
      </div>
    {% endfor %}
  </div>

  <!-- Ribbon: ALL sponsor logos (FOMO, even if not top 4) -->
  <div
    class="mt-12 mb-2 flex flex-wrap justify-center gap-4"
    aria-label="All sponsor logos"
  >
    {% for sponsor in sponsors_sorted[:8] %}
      {% set logo_src = (
        sponsor.logo if sponsor.logo and sponsor.logo.startswith('http') else
        (url_for('static', filename='images/sponsors/' ~ sponsor.logo) if sponsor.logo else url_for('static', filename='images/logo.webp'))
      ) %}
      <img
        src="{{ logo_src }}"
        alt="{{ sponsor.name or 'Sponsor' }} logo"
        title="{{ sponsor.name or 'Sponsor' }}"
        class="h-16 w-16 rounded-full bg-white object-cover shadow-inner grayscale transition duration-300 hover:grayscale-0"
        loading="lazy"
        decoding="async"
      />
    {% endfor %}
    <span
      class="ml-3 inline-flex items-center rounded-full bg-zinc-800 px-3 py-1 text-xs font-bold text-yellow-200 shadow"
    >
      + Your Brand Here
    </span>
  </div>
</section>

