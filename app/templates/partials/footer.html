{# === Minimal Footer â€” FundChamps Elite (SV-ELITE MVP v2, base v3.3 aligned) === #}
{% set NONCE          = NONCE if NONCE is defined else (csp_nonce() if csp_nonce is defined else '') %}
{% set now_year       = (now().year if now is defined else 2025) %}
{% set team_name      = (team.team_name if team and team.team_name else 'FundChamps') %}
{% set team_location  = (team.location if team and team.location else ((team.city ~ ', ' ~ team.state) if team and team.city and team.state else 'Austin, TX')) %}
{% set brand_color    = (team.theme_color if team and team.theme_color else '#facc15') %}

{# Logo URL (works with or without Flask) #}
{% set _footer_logo   = (team.footer_logo_url if team and team.footer_logo_url else 'images/logo.webp') %}
{% if '://' in _footer_logo or _footer_logo.startswith('data:') %}
  {% set footer_logo = _footer_logo %}
{% else %}
  {% set footer_logo = (url_for('static', filename=_footer_logo.lstrip('/')) if url_for is defined else '/static/' ~ _footer_logo.lstrip('/')) %}
{% endif %}

{# Progress #}
{% set raised   = (stats.raised if stats is defined and stats.raised is defined else 0) | float %}
{% set goal     = (stats.goal   if stats is defined and stats.goal   is defined else 10000) | float %}
{% set pct_raw  = (raised / goal * 100 if goal else 0) %}
{% set pct      = (0 if pct_raw < 0 else (100 if pct_raw > 100 else pct_raw)) %}

{# Links #}
{% set _donate_default = (url_for('main.donate') if url_for is defined else '/donate') %}
{% set donate_href  = (team.payment_link if team and team.payment_link else (team.paypal if team and team.paypal else _donate_default)) %}
{% set privacy_url  = terms_privacy_url if terms_privacy_url is defined else (privacy_url|default('#privacy')) %}
{% set terms_url    = terms_url|default('#terms') %}
{% set website_href = (team.website if team and team.website else 'https://www.connectatxelite.com') %}
{% set email_addr   = (team.email if team and team.email else 'connectatxelite@gmail.com') %}
{% set email_href   = 'mailto:' ~ email_addr %}

{# Social (optional) #}
{% set ig = (team.instagram if team and team.instagram else None) %}
{% set fb = (team.facebook  if team and team.facebook  else None) %}
{% set tw = (team.twitter   if team and team.twitter   else None) %}

{# Supporters (optional list of names/brands) #}
{% set supporters = (recent_supporters if recent_supporters is defined else None) %}

<footer id="site-footer" role="contentinfo"
  class="fc-section border-t border-yellow-400/20 bg-zinc-950 text-zinc-100"
  aria-labelledby="footer-brand"
  itemscope itemtype="https://schema.org/Organization"
  style="--fc-brand: {{ brand_color }};">
  <meta itemprop="name" content="{{ team_name }}"/>

  <div class="fc-container">
    <div class="grid gap-8 md:grid-cols-3 items-start">
      <!-- Brand -->
      <section class="space-y-3">
        <div class="flex items-center gap-3">
          <img src="{{ footer_logo }}" alt="{{ team_name }} logo"
               class="h-10 w-10 rounded bg-black/40 object-contain ring-1 ring-[color:color-mix(in srgb,var(--fc-brand) 20%,transparent)]"
               loading="lazy" decoding="async" width="40" height="40" />
          <div>
            <h3 id="footer-brand" class="text-lg font-extrabold text-yellow-300">{{ team_name }}</h3>
            <p class="text-sm text-zinc-300">{{ team_location }}</p>
            <p class="text-xs text-zinc-500">Â© {{ now_year }}</p>
          </div>
        </div>

        {% if ig or fb or tw %}
        <nav aria-label="Social links" class="flex items-center gap-2">
          {% if ig %}
          <a href="{{ ig }}" target="_blank" rel="noopener" aria-label="Instagram"
             class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-white/10 bg-black/40 hover:bg-black/55">
            <svg viewBox="0 0 24 24" class="h-4 w-4" fill="none" stroke="currentColor" aria-hidden="true">
              <rect x="2" y="2" width="20" height="20" rx="6" stroke-width="2"/><circle cx="12" cy="12" r="5" stroke-width="2"/><circle cx="18" cy="6" r="1.5" fill="currentColor"/>
            </svg>
          </a>
          {% endif %}
          {% if fb %}
          <a href="{{ fb }}" target="_blank" rel="noopener" aria-label="Facebook"
             class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-white/10 bg-black/40 hover:bg-black/55">
            <svg viewBox="0 0 24 24" class="h-4 w-4" fill="none" stroke="currentColor" aria-hidden="true">
              <rect x="2" y="2" width="20" height="20" rx="6" stroke-width="2"/><path d="M16 8h-2a2 2 0 0 0-2 2v2h4l-1 4h-3v4" stroke-width="2"/>
            </svg>
          </a>
          {% endif %}
          {% if tw %}
          <a href="{{ tw }}" target="_blank" rel="noopener" aria-label="Twitter / X"
             class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-white/10 bg-black/40 hover:bg-black/55">
            <svg viewBox="0 0 24 24" class="h-4 w-4" fill="none" stroke="currentColor" aria-hidden="true">
              <rect x="2" y="2" width="20" height="20" rx="6" stroke-width="2"/><path d="M7 17L17 7M7 7l10 10" stroke-width="2"/>
            </svg>
          </a>
          {% endif %}
        </nav>
        {% endif %}
      </section>

      <!-- Progress + CTA -->
      <section class="space-y-3">
        <div class="relative">
          <div class="h-3 w-full overflow-hidden rounded-full ring-1 ring-white/10 bg-white/5" role="progressbar"
               aria-label="Season fundraising progress"
               aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ '%.1f' % pct }}">
            <div id="footer-meter"
                 class="h-full rounded-full"
                 style="width: {{ '%.1f' % pct }}%;
                        background: linear-gradient(90deg,#fde047,#facc15,#84cc16,#22c55e);
                        box-shadow: inset 0 0 0 1px rgba(255,255,255,.18), 0 3px 10px rgba(34,197,94,.18);">
            </div>
          </div>
          <p class="mt-2 text-sm text-zinc-300">
            $<span id="f-raised">{{ '{:,.0f}'.format(raised) }}</span> of
            $<span id="f-goal">{{ '{:,.0f}'.format(goal) }}</span>
            <span class="ml-1 text-xs text-yellow-200">(<span id="f-pct">{{ '%.1f' % pct }}</span>%)</span>
          </p>
        </div>

        <a id="f-donate" href="{{ donate_href }}"
           class="fc-btn fc-btn-primary inline-flex items-center"
           data-cta="footer:donate">ðŸ’› Donate</a>
      </section>

      <!-- Links + Contact -->
      <section class="space-y-3">
        <nav aria-label="Footer quick links" class="grid grid-cols-2 gap-2 text-sm text-zinc-300">
          <a href="#mission" class="hover:text-yellow-200">Mission</a>
          <a href="#tiers" class="hover:text-yellow-200">Sponsors</a>
          <a href="{{ privacy_url }}" class="hover:text-yellow-200">Privacy</a>
          <a href="{{ terms_url }}" class="hover:text-yellow-200">Terms</a>
        </nav>
        <p class="text-sm">
          <strong class="text-zinc-300">Contact:</strong>
          <a href="{{ email_href }}" class="underline decoration-yellow-400/40 underline-offset-4 hover:text-yellow-200">{{ email_addr }}</a>
        </p>
      </section>
    </div>

    <!-- Supporters (tiny line) -->
    <p class="mt-6 text-xs text-zinc-400">
      <span class="text-zinc-300 font-medium">Recent supporters:</span>
      {% if supporters %}
        {% for s in supporters %}{{ s }}{% if not loop.last %} â€¢ {% endif %}{% endfor %}
        <span class="text-yellow-300/90"> â€¢ Your Brand Next</span>
      {% else %}
        Acme Corp â€¢ Jane D. â€¢ Smith &amp; Co <span class="text-yellow-300/90">â€¢ Your Brand Next</span>
      {% endif %}
    </p>
  </div>

  <!-- Minimal JSON-LD -->
  <script type="application/ld+json" nonce="{{ NONCE }}">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": {{ team_name|tojson if tojson is defined else '"' ~ team_name ~ '"' }},
    "url": {{ website_href|tojson if tojson is defined else '"' ~ website_href ~ '"' }},
    "logo": {{ footer_logo|tojson if tojson is defined else '"' ~ footer_logo ~ '"' }},
    "potentialAction": { "@type": "DonateAction", "target": {{ donate_href|tojson if tojson is defined else '"' ~ donate_href ~ '"' }} }
  }
  </script>
</footer>

<style nonce="{{ NONCE }}">
  /* keep it featherweight; rely on site tokens */
  #site-footer .fc-btn { padding:.7rem 1rem; font-weight:800; border-radius:999px; }
  #site-footer .fc-btn-primary { background: linear-gradient(180deg,#fde047,#facc15); color:#0b0b0c; box-shadow: 0 8px 26px rgb(250 204 21 / 15%); }
  #site-footer .fc-btn:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(255,255,255,.35), 0 0 0 5px rgba(250,204,21,.45); }
</style>

<script nonce="{{ NONCE }}">
(() => {
  if (window.__fcFooterLite) return; window.__fcFooterLite = true;
  const $ = (s, r=document) => r.querySelector(s);
  const bar = $('#footer-meter'), pct = $('#f-pct'), raised = $('#f-raised'), goal = $('#f-goal');

  function fmt(n){ return Number(n||0).toLocaleString(undefined,{maximumFractionDigits:0}); }
  function setMeter(r,g){
    const R = Math.max(0,+r||0), G = Math.max(0,+g||0);
    const P = G ? Math.min(100, Math.max(0, R/G*100)) : 0;
    if (bar) bar.style.width = P.toFixed(1) + '%';
    if (pct) pct.textContent = P.toFixed(1).replace(/\.0$/,'');
    if (raised) raised.textContent = fmt(R);
    if (goal) goal.textContent = fmt(G);
  }

  // initialize from server-rendered values (already set)
  // listen for global updates from hero/tiers
  addEventListener('fc:meter:update', ev => {
    const d = ev.detail || {};
    if ('raised' in d || 'goal' in d) setMeter(d.raised, d.goal);
  }, { passive:true });

  // Add UTM to donate (works for Payment Link or internal route)
  const donate = $('#f-donate');
  if (donate && donate.href) {
    try {
      const u = new URL(donate.href, location.origin);
      u.searchParams.set('utm_source','footer');
      u.searchParams.set('utm_medium','web');
      u.searchParams.set('utm_campaign','fundraiser');
      donate.href = u.toString();
    } catch {}
  }
})();
</script>

