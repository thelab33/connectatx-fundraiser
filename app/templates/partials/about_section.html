{# ================================
   FundChamps ‚Ä¢ About + Testimonials + Story (Elite)
   - Self-contained, mobile-first, CSP-safe
   - Matches Sponsors Hub styling + brand var
   - A11Y: roles, aria, keyboard traps, reduced-motion
   - Contracts: window.openDonationModal(), fc:donate:open
   ================================ #}

{# ---- Vars & Fallbacks ---- #}
{% set player_team   = team.team_name if team and team.team_name is defined else "Connect ATX Elite" %}
{% set team_league   = team.league if team and team.league is defined else "AAU" %}
{% set team_region   = team.region if team and team.region is defined else "Austin, TX" %}
{% set founder_last  = (
  team.founder_lastname if team and team.founder_lastname is defined and team.founder_lastname
  else (team.founderlastname if team and team.founderlastname is defined and team.founderlastname else "Smith")
) %}

{% set img_src_raw      = team.img if team and team.img else 'images/fallback.jpg' %}
{% set img_src          = img_src_raw if '://' in img_src_raw else (url_for('static', filename=img_src_raw) if url_for is defined else '/' ~ img_src_raw.lstrip('/')) %}
{% set video_src_raw    = team.story_video if team and team.story_video else 'videos/story.mp4' %}
{% set video_src        = video_src_raw if '://' in video_src_raw else (url_for('static', filename=video_src_raw) if url_for is defined else '/' ~ video_src_raw.lstrip('/')) %}
{% set video_poster_raw = team.story_poster if team and team.story_poster else 'images/video_poster.jpg' %}
{% set video_poster     = video_poster_raw if '://' in video_poster_raw else (url_for('static', filename=video_poster_raw) if url_for is defined else '/' ~ video_poster_raw.lstrip('/')) %}
{% set kvue_url         = team.kvue_url if team and team.kvue_url else 'https://www.kvue.com/' %}
{% set youtube_id       = team.youtube_id if team and team.youtube_id else 'dQw4w9WgXcQ' %}
{% set brand_color      = (team.theme_color if team and team.theme_color else '#facc15') %}

{% set about_text   = (about.text if about and about.text else "We‚Äôre a family-powered AAU program in Austin, TX building skills, confidence, and character.") %}
{% set mission_text = (mission.text if mission and mission.text else "") %}
{% set testimonials = testimonials if testimonials is defined and testimonials else [
  {"quote":"Winning felt amazing ‚Äî but being part of a team that believes in you matters most.","author": player_team ~ " Player, Class of 2030"},
  {"quote":"I never thought my child would love both books and basketball this much.","author":"Happy Parent"},
  {"quote":"The coaches and families here really care. My son found his tribe.","author":"Team Parent"}
] %}

<section id="about-premium"
  class="relative overflow-hidden bg-zinc-950/95 py-12 md:py-16 text-white"
  itemscope itemtype="https://schema.org/SportsTeam"
  aria-labelledby="aboutp-heading" tabindex="-1"
  style="--fc-brand: {{ brand_color }};">
  <style>
    /* ===== Scope: #about-premium ===== */
    #about-premium .card{
      background:rgba(15,15,15,.72);
      border:1px solid color-mix(in srgb, var(--fc-brand) 18%, transparent);
      border-radius:1rem;
      box-shadow:0 10px 36px rgba(250,204,21,.12);
      transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }
    #about-premium .card:hover{ transform:translateY(-1px); box-shadow:0 16px 46px rgba(250,204,21,.18); border-color:color-mix(in srgb, var(--fc-brand) 30%, transparent) }
    #about-premium .pill{ background:color-mix(in srgb, var(--fc-brand) 14%, transparent); border:1px solid color-mix(in srgb, var(--fc-brand) 24%, transparent); border-radius:9999px; padding:.1rem .55rem; font-weight:700 }
    #about-premium .cta{ transition:transform .15s ease, box-shadow .15s ease }
    #about-premium .cta:hover{ transform:translateY(-1px); box-shadow:0 10px 28px color-mix(in srgb, var(--fc-brand) 22%, transparent) }
    #about-premium .soft{ background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)) }
    #about-premium [data-slide].hidden{ display:none }
    #about-premium [data-tab][aria-selected="true"]{ background:color-mix(in srgb, var(--fc-brand) 55%, #fff); color:#111 }
    #about-premium .stat{ background:color-mix(in srgb, var(--fc-brand) 10%, transparent); border:1px solid color-mix(in srgb, var(--fc-brand) 20%, transparent) }
    #about-premium::before{
      content:""; position:absolute; inset:auto -12% -30% auto; width:52rem; height:52rem; border-radius:9999px;
      background:radial-gradient(closest-side, color-mix(in srgb, var(--fc-brand) 12%, transparent), transparent 62%);
      filter:blur(22px); opacity:.28; pointer-events:none;
    }
    @media (prefers-reduced-motion: reduce){ #about-premium .cta{transition:none} }
  </style>

  <meta itemprop="name" content="{{ player_team }}">
  <meta itemprop="areaServed" content="{{ team_region }}">
  <meta itemprop="memberOf" content="{{ team_league }}">

  <div class="relative z-10 mx-auto w-full max-w-6xl px-4 md:px-6 grid grid-cols-1 gap-6 md:gap-8 lg:grid-cols-2">
    <!-- LEFT: About + micro-stats -->
    <article class="card soft p-6 md:p-8" aria-labelledby="aboutp-heading">
      <header class="mb-4 flex items-start gap-3">
        <img loading="lazy" decoding="async" src="{{ img_src }}" alt="{{ player_team }} watermark"
             class="h-9 w-9 rounded-xl ring-1 ring-white/10 object-cover" loading="lazy" decoding="async" />
        <div class="flex-1">
          <h2 id="aboutp-heading" class="text-2xl sm:text-3xl font-black tracking-tight text-yellow-300" itemprop="description">
            About {{ player_team }}
          </h2>
          <ul class="mt-1 flex flex-wrap gap-1.5 text-[11px] font-semibold text-amber-200" aria-label="Team attributes">
            <li class="pill">AAU ‚Ä¢ {{ team_league }}</li>
            <li class="pill">{{ team_region }}</li>
            <li class="pill">Community Powered</li>
          </ul>
        </div>
      </header>

      <div class="space-y-3 text-zinc-200/95">
        <p class="leading-relaxed">
          <strong class="font-black text-yellow-300">{{ player_team }}</strong> is a
          <span class="font-semibold text-amber-300">family movement</span> in
          <span class="font-semibold text-yellow-200">{{ team_region }}</span>, building
          teamwork, respect, and championship character.
        </p>
        <p class="leading-relaxed">{{ about_text }}</p>
        {% if mission_text %}<p class="leading-relaxed">{{ mission_text }}</p>{% endif %}
        <p class="leading-relaxed">
          Founded by the <strong class="text-yellow-200">{{ founder_last }}</strong> family,
          our <strong class="text-yellow-100">{{ team_league }}</strong> program grew into a thriving community.
        </p>
      </div>

      {# Micro impact stats (edit/override via context) #}
      {% set impact_stats = impact_stats if impact_stats is defined and impact_stats else [
        {"label":"Players Served","value":16},
        {"label":"Honor Roll Students","value":11},
        {"label":"Tournaments/Year","value":12},
        {"label":"Championship Rings","value":3}
      ] %}
      <ul class="mt-5 grid grid-cols-2 sm:grid-cols-4 gap-2">
        {% for s in impact_stats %}
          <li class="stat rounded-xl px-3 py-2 text-center">
            <div class="text-xl font-extrabold text-yellow-300">{{ s.value }}</div>
            <div class="text-[11px] font-semibold text-yellow-100/80">{{ s.label }}</div>
          </li>
        {% endfor %}
      </ul>

      <div class="mt-5 flex flex-wrap gap-2">
        <button type="button"
                class="cta inline-flex items-center gap-2 rounded-full bg-yellow-300 px-5 py-2.5 text-sm sm:text-base font-extrabold text-black"
                data-modal-open="story-modal" aria-haspopup="dialog" aria-controls="story-modal" aria-expanded="false">
          ‚ñ∂ Watch Our Story
        </button>
        <button type="button"
                class="cta inline-flex items-center gap-2 rounded-full border border-yellow-400/60 bg-yellow-300/10 px-5 py-2.5 text-sm font-bold text-yellow-200"
                data-open-donate-modal>
          üíõ Quick Donate
        </button>
      </div>
    </article>

    <!-- RIGHT: Testimonials (carousel) -->
    <section class="card p-6 md:p-7" aria-label="Testimonials">
      <h3 class="mb-3 text-lg font-bold text-yellow-300">What Families Say</h3>
      <div id="aboutp-carousel" data-carousel data-interval="6500"
           aria-live="polite" aria-atomic="true" aria-roledescription="carousel">
        <div class="relative" data-slides>
          {% for t in testimonials %}
          <figure class="{% if not loop.first %}hidden{% endif %}" data-slide data-index="{{ loop.index0 }}">
            <blockquote class="mb-2 text-[15px] sm:text-base italic text-yellow-100">‚Äú{{ t.quote }}‚Äù</blockquote>
            <figcaption class="text-xs font-semibold text-yellow-200">{{ t.author }}</figcaption>
          </figure>
          {% endfor %}
        </div>

        <nav class="mt-3 flex gap-1.5" aria-label="Select testimonial" data-dots>
          {% for i in range(testimonials|length) %}
          <button class="h-2.5 w-2.5 rounded-full border border-yellow-300/50 bg-yellow-300/30 hover:bg-yellow-300/60 focus:bg-yellow-300"
                  type="button" data-dot data-idx="{{ i }}" aria-current="{{ 'true' if i == 0 else 'false' }}"
                  aria-label="Show testimonial {{ i + 1 }}"></button>
          {% endfor %}
        </nav>

        <div class="mt-4 flex items-center gap-3">
          <button class="text-[11px] text-yellow-200 underline-offset-2 hover:underline" type="button" data-copy="#aboutp-carousel">
            Copy quote
          </button>
          <span class="hidden text-[11px] text-green-300" data-toast role="status" aria-live="polite">Copied!</span>
        </div>
      </div>
    </section>
  </div>

  <!-- Story Modal -->
  <dialog id="story-modal" class="z-50 p-0 shadow-2xl" aria-modal="true" aria-labelledby="story-title" role="dialog">
    <div id="story-box" class="relative mx-auto max-w-2xl w-[92vw] sm:w-auto rounded-xl bg-zinc-900 p-5 sm:p-6 shadow-2xl" role="document" tabindex="0">
      <button class="absolute right-2.5 top-2.5 rounded-full bg-black/40 px-2.5 py-1.5 text-2xl text-yellow-300 hover:bg-yellow-300/15 focus:outline-none"
              aria-label="Close story modal" type="button" data-modal-close>√ó</button>
      <h2 id="story-title" class="text-xl font-bold text-yellow-300">Our Story</h2>

      {% set tabs = [
        {'id': 'myvideo', 'label': 'üé• Video'},
        {'id': 'kvue',    'label': 'üì∫ KVUE'},
        {'id': 'yt',      'label': 'üèÄ YouTube'}
      ] %}

      <nav class="mt-3 flex gap-2" aria-label="Video sources" role="tablist" data-tabs>
        {% for t in tabs %}
        <button id="tab-{{ t.id }}"
                class="rounded-full bg-yellow-300/15 px-3 py-1.5 text-sm font-semibold text-yellow-200 hover:bg-yellow-300/35 focus:bg-yellow-300 focus:text-black"
                data-tab data-panel="panel-{{ t.id }}" role="tab" aria-controls="panel-{{ t.id }}"
                aria-selected="{{ 'true' if loop.first else 'false' }}" {% if not loop.first %}tabindex="-1"{% endif %}
                type="button">{{ t.label }}</button>
        {% endfor %}
      </nav>

      {% for t in tabs %}
      <div id="panel-{{ t.id }}" role="tabpanel" class="{% if not loop.first %}hidden{% endif %} mt-3" aria-labelledby="tab-{{ t.id }}" tabindex="0" data-panel>
        {% if t.id == 'myvideo' %}
          <video controls preload="metadata" poster="{{ video_poster }}" class="w-full rounded-lg">
            <source src="{{ video_src }}" type="video/mp4" />
            Sorry, your browser doesn‚Äôt support embedded videos.
          </video>
        {% elif t.id == 'kvue' %}
          <iframe data-src="{{ kvue_url|e }}" class="h-64 w-full rounded" allowfullscreen loading="lazy"
                  sandbox="allow-same-origin allow-scripts allow-popups allow-presentation" referrerpolicy="no-referrer"></iframe>
        {% else %}
          <iframe data-src="https://www.youtube-nocookie.com/embed/{{ youtube_id|e }}" class="h-64 w-full rounded"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  allowfullscreen loading="lazy" sandbox="allow-same-origin allow-scripts allow-popups allow-presentation"
                  referrerpolicy="no-referrer"></iframe>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </dialog>
</section>

<script nonce="{{ csp_nonce() if csp_nonce is defined else '' }}">
(() => {
  const root = document.getElementById('about-premium'); if(!root || root.__init) return; root.__init = true;
  const html = document.documentElement;

  // ---------- Modal open/close + focus trap ----------
  document.addEventListener('click', (e) => {
    const openBtn = e.target.closest('[data-modal-open]'); if (openBtn) {
      e.preventDefault();
      const dlg = document.getElementById(openBtn.getAttribute('data-modal-open'));
      if (dlg){ (dlg.showModal ? dlg.showModal() : dlg.setAttribute('open','')); openBtn.setAttribute('aria-expanded','true'); trap(dlg); html.classList.add('overflow-hidden'); }
    }
    const closeBtn = e.target.closest('[data-modal-close]'); if (closeBtn) { closeBtn.closest('dialog')?.close(); }
  });
  root.querySelectorAll('dialog').forEach(dlg=>{
    dlg.addEventListener('click', e=>{ const box = dlg.querySelector('#story-box'); if (box && !box.contains(e.target)) dlg.close(); });
    dlg.addEventListener('close', ()=>{ html.classList.remove('overflow-hidden'); root.querySelector('[data-modal-open="'+dlg.id+'"]')?.setAttribute('aria-expanded','false'); });
  });
  function trap(el){
    const els = el.querySelectorAll('a,button,input,textarea,select,[tabindex]:not([tabindex="-1"])');
    const first = els[0], last = els[els.length-1];
    el.addEventListener('keydown', onKey);
    function onKey(e){
      if (e.key==='Tab'){
        if (e.shiftKey && document.activeElement===first){ e.preventDefault(); last?.focus(); }
        else if (!e.shiftKey && document.activeElement===last){ e.preventDefault(); first?.focus(); }
      }
      if (e.key==='Escape') el.close();
    }
    first?.focus({preventScroll:true});
  }

  // ---------- Tabs (lazy-load embeds) ----------
  const tabsRoot = root.querySelector('[data-tabs]');
  function activateTab(tab){
    const box = tab.closest('#story-box') || root;
    box.querySelectorAll('[data-tab]').forEach(t=>{const on=t===tab; t.setAttribute('aria-selected', on); t.tabIndex=on?0:-1;});
    const id = tab.getAttribute('data-panel');
    box.querySelectorAll('[data-panel]').forEach(p=>{
      const show = p.id===id;
      p.classList.toggle('hidden', !show);
      if (show){ p.querySelectorAll('iframe[data-src]').forEach(f=>{ if(!f.src) f.src=f.dataset.src; }); }
    });
  }
  tabsRoot?.addEventListener('click', e=>{ const t=e.target.closest('[data-tab]'); if(t) activateTab(t); });
  tabsRoot?.addEventListener('keydown', e=>{
    const tabs = [...tabsRoot.querySelectorAll('[data-tab]')]; const cur = tabsRoot.querySelector('[data-tab][aria-selected="true"]'); const i=tabs.indexOf(cur);
    if (e.key==='ArrowRight') { e.preventDefault(); activateTab(tabs[(i+1)%tabs.length]); }
    if (e.key==='ArrowLeft')  { e.preventDefault(); activateTab(tabs[(i-1+tabs.length)%tabs.length]); }
  });

  // ---------- Testimonials (lite carousel) ----------
  const car = root.querySelector('[data-carousel]');
  if (car){
    const slides=[...car.querySelectorAll('[data-slide]')], dots=[...car.querySelectorAll('[data-dot]')], toast=car.querySelector('[data-toast]');
    let idx=0, t=null, interval=parseInt(car.getAttribute('data-interval')||'6500',10);
    const reduced = matchMedia('(prefers-reduced-motion: reduce)').matches || navigator.connection?.saveData;
    const show = i => { idx=(i+slides.length)%slides.length; slides.forEach((s,k)=>s.classList.toggle('hidden',k!==idx)); dots.forEach((d,k)=>d.setAttribute('aria-current',k===idx?'true':'false')); };
    const play = ()=>{ if(!reduced){ stop(); t=setInterval(()=>show(idx+1), interval); } };
    const stop = ()=>{ if(t) clearInterval(t), t=null; };
    dots.forEach(d=> d.addEventListener('click', ()=> show(parseInt(d.dataset.idx||'0',10))));
    car.addEventListener('mouseenter', stop); car.addEventListener('mouseleave', play);
    car.addEventListener('keydown', e=>{ if(e.key==='ArrowRight') show(idx+1); if(e.key==='ArrowLeft') show(idx-1); });
    show(0); play();

    car.querySelector('[data-copy]')?.addEventListener('click', async ()=>{
      try{
        const q=slides[idx]?.querySelector('blockquote')?.innerText?.trim()||'', a=slides[idx]?.querySelector('figcaption')?.innerText?.trim()||'';
        await navigator.clipboard.writeText(`${q} ‚Äî ${a}`);
        toast?.classList.remove('hidden'); setTimeout(()=> toast?.classList.add('hidden'), 1100);
      }catch(_){}
    });
  }

  // ---------- Donate modal contract ----------
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-open-donate-modal]'); if (!btn) return;
    e.preventDefault();
    (window.openDonationModal?.()) ?? window.dispatchEvent(new CustomEvent('fc:donate:open'));
    if (typeof window.confetti === 'function' && !matchMedia('(prefers-reduced-motion: reduce)').matches){
      window.confetti({ particleCount: 50, spread: 50, origin: { y: 0.7 } });
    }
  });
})();
</script>

