{# ================================
   about_section.html — SV-ELITE (v4)
   - Single centered card (readable measure)
   - Motion-safe counters (IO-gated)
   - CSP-safe video modal (optional)
   - Assumes parent section/container from index.html
   ================================ #}
{% set NONCE = NONCE if NONCE is defined else (csp_nonce() if csp_nonce is defined else '') %}
{% set _team = team if team is defined and team else none %}
{% set TEAM_NAME   = _team.team_name if _team and _team.team_name else "Connect ATX Elite" %}
{% set REGION      = _team.region     if _team and _team.region     else "Austin, TX" %}
{% set MISSION_TXT = _team.mission    if _team and _team.mission    else
"Beyond basketball—we’re shaping leaders, scholars, and role models for our community." %}
{% set SHOW_VIDEO  = SHOW_VIDEO if SHOW_VIDEO is defined else True %}
{% set VIDEO_URL   = VIDEO_URL if VIDEO_URL is defined and VIDEO_URL
  else (_team.video_url if _team and _team.video_url else 'https://www.youtube-nocookie.com/embed/dQw4w9WgXcQ?autoplay=1&mute=1') %}

{# Stats (numbers only; animated) #}
{% set STATS = STATS if STATS is defined and STATS else [
  {"icon":"🏀","label":"Regionals record","value": (_team.regionals_record if _team and _team.regionals_record else "15")},
  {"icon":"🏆","label":"Championships","value": (_team.championships    if _team and _team.championships    else "3")},
  {"icon":"🎓","label":"Top academic athletes","value": (_team.top_academic if _team and _team.top_academic else "12")}
] %}

<div id="fc-about" role="region" aria-labelledby="fc-about-title">
  <style nonce="{{ NONCE }}">
    /* ── Scoped to #fc-about ───────────────────────────────────────────── */
    #fc-about{ scroll-margin-top: var(--fc-sticky-offset, 80px); }

    /* Centered readable card (matches hero polish) */
    #fc-about .about-card{
      --about-max: 60rem;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius: clamp(18px, 16px + 1vw, 28px);
      max-width: var(--about-max);
      margin-inline: auto;
      padding: clamp(1rem, 1rem + 1.4vw, 2rem);
      box-shadow: 0 22px 70px rgba(0,0,0,.35);
    }
    @media (min-width:1024px){ #fc-about .about-card{ padding: 2.25rem 2.5rem; } }

    /* Headline sheen */
    #fc-about .shine-text{
      background-image: linear-gradient(90deg, #f5d04c, #facc15, #f5d04c);
      background-size: 200% 100%;
      -webkit-background-clip: text; background-clip: text; color: transparent;
      animation: about-shine 6s linear infinite; letter-spacing:-.01em;
    }
    @keyframes about-shine { to { background-position: 200% 0 } }

    /* Stats row */
    #fc-about .stats-grid{ display:grid; gap:.6rem; grid-template-columns: repeat(3, minmax(0,1fr)); }
    @media (max-width:520px){ #fc-about .stats-grid{ grid-template-columns: 1fr 1fr 1fr; } }
    #fc-about .stat{
      display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;
      gap:.25rem; padding:.85rem .9rem; border-radius:.9rem;
      background: color-mix(in srgb, #fff 6%, transparent);
      border:1px solid rgba(255,255,255,.10);
    }
    #fc-about .stat .v{ font-variant-numeric: tabular-nums; font-weight:900; font-size:clamp(1.1rem, .9rem + .8vw, 1.6rem); }
    #fc-about .stat .k{ font-size:.8rem; color:#d4d4d8; }

    /* CTA row */
    #fc-about .cta-row{ display:flex; flex-wrap:wrap; gap:.65rem; align-items:center; }

    /* Motion/contrast preferences */
    @media (prefers-reduced-motion: reduce){ #fc-about .shine-text{ animation:none } }
  </style>

  <div class="about-card">
    <h2 id="fc-about-title" class="text-fluid-h1 font-extrabold shine-text mb-2">
      More Than Basketball — We’re Family
    </h2>

    <p class="text-base sm:text-lg text-white/90">
      <span class="text-yellow-400">{{ TEAM_NAME }}</span> is more than a team—it’s a movement built by families, for families.
      We give kids a second home where teamwork, respect, and championship character are built for life.
    </p>

    <p class="mt-3 text-base sm:text-lg text-white/85">{{ MISSION_TXT }}</p>

    <p class="mt-2 text-sm text-yellow-200/90 italic">
      “Family means showing up, believing in each other, and making sure no one is left behind.
      That’s what we do—on the court, and off.” <span class="text-amber-300">&mdash; Coach Angel Rodriguez</span>
    </p>

    <!-- Stats -->
    <div class="mt-5 stats-grid">
      {% for s in STATS %}
      <div class="stat">
        <div class="text-lg" aria-hidden="true">{{ s.icon }}</div>
        <div class="v fc-counter" data-target="{{ (s.value|string)|replace('–','-') }}">{{ s.value }}</div>
        <div class="k">{{ s.label }}</div>
      </div>
      {% endfor %}
    </div>

    <!-- CTAs -->
    <div class="mt-5 cta-row">
      <a href="#fundraiser" class="fc-btn fc-btn-primary" data-cta="about:become-champion">💛 Become a Champion</a>
      {% if SHOW_VIDEO %}
      <button id="fc-video-open" class="fc-btn fc-btn-ghost" type="button" data-video-src="{{ VIDEO_URL }}"
              aria-haspopup="dialog" aria-expanded="false">▶ Watch Our Story</button>
      {% endif %}
    </div>

    <p class="mt-2 text-xs text-white/60">
      Every sponsorship fuels gym time, tutoring, travel, and more. Keep our kids dreaming big.
    </p>
  </div>

  {% if SHOW_VIDEO %}
  <!-- Accessible modal (CSP-safe) -->
  <div id="fc-video-modal" class="fixed inset-0 z-[80] hidden" role="dialog" aria-modal="true" aria-labelledby="fc-video-title">
    <div data-modal-overlay class="absolute inset-0 bg-black/70"></div>
    <div class="relative mx-auto my-10 w-[min(100vw-2rem,960px)] rounded-2xl overflow-hidden ring-1 ring-white/10 bg-black shadow-2xl">
      <div class="flex items-center justify-between px-4 py-3 border-b border-white/10">
        <h4 id="fc-video-title" class="font-bold">Program Highlights</h4>
        <button type="button" class="fc-btn fc-btn-ghost px-3 py-1.5" data-modal-close aria-label="Close video">✕</button>
      </div>
      <div class="relative aspect-video">
        <iframe class="absolute inset-0 w-full h-full" src="" title="Team highlight video"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                referrerpolicy="strict-origin-when-cross-origin"></iframe>
      </div>
    </div>
  </div>
  {% endif %}
</div>

{# --- JS: counters + modal (IO-gated; CSP nonce) --- #}
<script nonce="{{ NONCE }}">
(() => {
  // Counter animation
  const prefersReduce = matchMedia?.('(prefers-reduced-motion: reduce)').matches;
  function anim(el){
    const raw = (el.getAttribute('data-target') || el.textContent || '').trim();
    if(!/^\d+(\.\d+)?$/.test(raw)){ el.textContent = raw; return; }
    const target = parseFloat(raw);
    if (prefersReduce){ el.textContent = target.toLocaleString(); return; }
    let t0=null, dur=900;
    const step=(ts)=>{ if(!t0) t0=ts; const p=Math.min(1,(ts-t0)/dur);
      el.textContent = Math.floor(target*p).toLocaleString();
      if(p<1) requestAnimationFrame(step);
    };
    requestAnimationFrame(step);
  }
  function init(){ document.querySelectorAll('#fc-about .fc-counter').forEach(anim); }

  // IO gate for counters
  (function(){
    const sect = document.getElementById('fc-about');
    if('IntersectionObserver' in window && sect){
      let ran=false;
      const io=new IntersectionObserver((entries)=>{
        if(!ran && entries.some(e=>e.isIntersecting)){ ran=true; init(); io.disconnect(); }
      },{threshold:0.2});
      io.observe(sect);
    } else { init(); }
  })();

  // Modal (optional)
  const modal = document.getElementById('fc-video-modal');
  const trigger = document.getElementById('fc-video-open');
  if (!modal || !trigger) return;
  const iframe  = modal.querySelector('iframe');
  const overlay = modal.querySelector('[data-modal-overlay]');
  const closeBtn= modal.querySelector('[data-modal-close]');
  let last=null;

  const focusables = (root) => Array.from(root.querySelectorAll('a[href],button,textarea,input,select,[tabindex]:not([tabindex="-1"])'))
    .filter(el => !el.hasAttribute('disabled') && !el.getAttribute('aria-hidden'));

  function lock(){ document.documentElement.style.overflow='hidden'; }
  function unlock(){ document.documentElement.style.overflow=''; }
  function trap(e){
    if(e.key!=='Tab') return;
    const f = focusables(modal); if(!f.length) return;
    const [first,lastEl] = [f[0], f[f.length-1]];
    if(e.shiftKey && document.activeElement===first){ e.preventDefault(); lastEl.focus(); }
    else if(!e.shiftKey && document.activeElement===lastEl){ e.preventDefault(); first.focus(); }
  }
  function esc(e){ if(e.key==='Escape') close(); }
  function open(){
    last = document.activeElement;
    modal.classList.remove('hidden');
    iframe && (iframe.src = trigger.getAttribute('data-video-src') || '');
    lock(); (focusables(modal)[0] || modal).focus();
    document.addEventListener('keydown', trap);
    document.addEventListener('keydown', esc);
  }
  function close(){
    modal.classList.add('hidden');
    if (iframe) iframe.src = '';
    unlock();
    document.removeEventListener('keydown', trap);
    document.removeEventListener('keydown', esc);
    last && last.focus?.();
  }
  trigger.addEventListener('click', open, {passive:true});
  (closeBtn || modal).addEventListener('click', (e)=>{ if(e.target===overlay || e.currentTarget===closeBtn) close(); });
})();
</script>

