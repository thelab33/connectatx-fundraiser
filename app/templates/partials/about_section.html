{# ================================
   about_section.html ‚Äî SV-ELITE (Production v2)
   - Grid-fixed, image mosaic, motion-safe counters
   - CSP-safe modal with focus trap + hooks
   - Uses global tokens (fc-*)
   ================================ #}
{% set NONCE = NONCE if NONCE is defined else (csp_nonce() if csp_nonce is defined else '') %}
{% set _team = team if team is defined and team else none %}
{% set TEAM_NAME   = _team.team_name if _team and _team.team_name else "Connect ATX Elite" %}
{% set REGION      = _team.region     if _team and _team.region     else "Austin, TX" %}
{% set MISSION_TXT = _team.mission    if _team and _team.mission    else
"Beyond basketball‚Äîwe‚Äôre shaping leaders, scholars, and role models for our community." %}

{# Safe asset helper: works with or without Flask url_for #}
{% macro asset(path) -%}
  {%- set p = path|string -%}
  {%- if '://' in p or p.startswith('data:') -%}{{ p }}
  {%- else -%}
    {%- if url_for is defined -%}{{ url_for('static', filename=p.lstrip('/')) }}
    {%- else -%}/static/{{ p.lstrip('/') }}{%- endif -%}
  {%- endif -%}
{%- endmacro %}

{# Allow overrides from context #}
{% set STATS = STATS if STATS is defined and STATS else [
  {"icon":"üèÄ","label":"Regionals record","value": _team.regionals_record if _team and _team.regionals_record else "15"},
  {"icon":"üèÜ","label":"Championships","value": _team.championships if _team and _team.championships else "3"},
  {"icon":"üéì","label":"Top academic athletes","value": _team.top_academic if _team and _team.top_academic else "12"}
] %}
{% set IMG1 = IMG1 if IMG1 is defined and IMG1 else (_team.img1 if _team and _team.img1 else 'images/player1.webp') %}
{% set IMG2 = IMG2 if IMG2 is defined and IMG2 else (_team.img2 if _team and _team.img2 else 'images/player2.webp') %}
{% set IMG3 = IMG3 if IMG3 is defined and IMG3 else (_team.img3 if _team and _team.img3 else 'images/player3.webp') %}
{% set VIDEO_URL = VIDEO_URL if VIDEO_URL is defined and VIDEO_URL
  else (_team.video_url if _team and _team.video_url else 'https://www.youtube-nocookie.com/embed/dQw4w9WgXcQ?autoplay=1&mute=1') %}
{% set SHOW_VIDEO = SHOW_VIDEO if SHOW_VIDEO is defined else True %}

<section id="fc-about" class="relative bg-fc-surface text-fc-text py-14 sm:py-20" aria-labelledby="fc-about-title">
  <style nonce="{{ NONCE }}">
    /* Scoped to #fc-about only */
    #fc-about .mosaic { position: relative; }
    #fc-about .mosaic-grid {
      display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr 1fr; gap: .75rem;
      content-visibility: auto; contain-intrinsic-size: 520px;
    }
    #fc-about .tile { position: relative; overflow: hidden; border-radius: .9rem; }
    #fc-about .tile img {
      width: 100%; height: 100%; object-fit: cover; display: block; transform-origin: 50% 50%;
    }
    /* Ken Burns (motion-safe) */
    @media (prefers-reduced-motion: no-preference) {
      #fc-about .tile img { animation: about-ken 14s ease-in-out infinite alternate; }
      @keyframes about-ken { from { transform: scale(1.03) } to { transform: scale(1.12) } }
    }
    /* Ambient sheen + ring */
    #fc-about .tile::after {
      content:""; position:absolute; inset:0; pointer-events:none;
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent 40%);
      opacity:.6;
    }
    #fc-about .tile .ring {
      position:absolute; inset:0; border-radius:inherit;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
    }
    /* Play overlay button */
    #fc-about .play-btn {
      position:absolute; inset:auto auto 10px 10px;
      display:inline-flex; align-items:center; gap:.5rem;
      padding:.55rem .8rem; border-radius:.75rem;
      background: rgba(17,17,17,.6); color:#fff;
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(6px) saturate(120%);
      -webkit-backdrop-filter: blur(6px) saturate(120%);
      font-weight: 700; font-size: .9rem;
    }
    /* Focus ring */
    #fc-about .focusable:focus-visible{ outline: none; box-shadow: 0 0 0 .18rem rgba(250,204,21,.8) }
  </style>

  <div class="mx-auto w-[min(92rem,96vw)] px-3 sm:px-6">
    <div class="grid gap-10 md:grid-cols-2 items-start">
      <!-- Copy / Mission -->
      <div>
        <h2 id="fc-about-title" class="text-2xl md:text-3xl font-extrabold tracking-tight mb-2 optical-tight">
          Our Mission <span class="sr-only">‚Äî {{ TEAM_NAME }} ({{ REGION }})</span>
        </h2>
        <p class="text-fc-text/90 leading-relaxed mb-5 text-pretty">{{ MISSION_TXT }}</p>

        <!-- Counters (reduced-motion aware; IO-triggered) -->
        <dl class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          {% for s in STATS %}
          <div class="rounded-xl border border-fc-border/80 bg-fc-elev/70 p-3">
            <dt class="text-[12px] text-fc-text/70">{{ s.icon }} {{ s.label }}</dt>
            <dd class="mt-1 text-xl font-semibold tracking-tight tabular-nums">
              <span class="fc-counter" data-target="{{ (s.value|string)|replace('‚Äì','-') }}">{{ s.value }}</span>
            </dd>
          </div>
          {% endfor %}
        </dl>

        <!-- Secondary CTAs -->
        <div class="mt-6 flex flex-wrap gap-3">
          <a href="#tiers"
             class="inline-flex items-center rounded-xl px-4 py-2 bg-fc-brand text-black font-semibold shadow transition
                    focus:outline-none focus:ring-2 focus:ring-fc-brand focus:ring-offset-2 focus:ring-offset-fc-surface hover:opacity-90"
             data-analytics="about:tiers">
            View Sponsorship Tiers
          </a>
          <a href="#sponsor-form"
             class="inline-flex items-center rounded-xl px-4 py-2 bg-fc-elev border border-fc-border text-fc-text transition
                    focus:outline-none focus:ring-2 focus:ring-fc-brand focus:ring-offset-2 focus:ring-offset-fc-surface hover:bg-fc-elev/80"
             data-analytics="about:sponsor">
            Sponsor a Champion
          </a>
        </div>
      </div>

      <!-- Image Mosaic + Play -->
      <div class="mosaic">
        <div class="mosaic-grid">
          <figure class="tile col-span-1 row-span-3">
            <img src="{{ asset(IMG1) }}" alt="Practice and teamwork ‚Äî {{ TEAM_NAME }}" loading="lazy" decoding="async" fetchpriority="low">
            <span class="ring" aria-hidden="true"></span>
          </figure>
          <figure class="tile">
            <img src="{{ asset(IMG2) }}" alt="Game day moments ‚Äî {{ TEAM_NAME }}" loading="lazy" decoding="async" fetchpriority="low">
            <span class="ring" aria-hidden="true"></span>
          </figure>
          <figure class="tile">
            <img src="{{ asset(IMG3) }}" alt="Classroom excellence ‚Äî {{ TEAM_NAME }}" loading="lazy" decoding="async" fetchpriority="low">
            <span class="ring" aria-hidden="true"></span>
          </figure>
        </div>

        {% if SHOW_VIDEO %}
        <button
          type="button"
          id="fc-video-open"
          class="play-btn focusable"
          aria-haspopup="dialog"
          aria-controls="fc-video-modal"
          aria-expanded="false"
          data-modal-target="fc-video-modal"
          data-video-src="{{ VIDEO_URL }}"
          data-analytics="about:watch">
          ‚ñ∂ <span>Watch Our Story</span>
        </button>
        <noscript>
          <p class="mt-2">
            <a class="underline text-fc-brand" href="{{ VIDEO_URL }}">Watch Our Story (opens video)</a>
          </p>
        </noscript>
        {% endif %}
      </div>
    </div>
  </div>

  {# --- Video Modal (CSP-safe, focus trapped) --- #}
  <div id="fc-video-modal"
       class="fixed inset-0 z-[1000] hidden"
       role="dialog"
       aria-modal="true"
       aria-labelledby="fc-video-title"
       aria-describedby="fc-video-desc">
    <div class="absolute inset-0 bg-black/70 supports-[backdrop-filter:blur(2px)]:backdrop-blur-sm" data-modal-overlay></div>

    <div class="relative mx-auto max-w-4xl mt-16 rounded-2xl bg-fc-surface border border-fc-border shadow-2xl focus:outline-none"
         role="document" tabindex="-1">
      <div class="flex items-center justify-between px-4 py-3 border-b border-fc-border">
        <h3 id="fc-video-title" class="text-lg font-semibold">Our Story ‚Äî {{ TEAM_NAME }}</h3>
        <button type="button"
                class="rounded-lg px-3 py-1 bg-fc-elev border border-fc-border hover:bg-fc-elev/80"
                data-modal-close="fc-video-modal" aria-label="Close video">‚úï</button>
      </div>

      <p id="fc-video-desc" class="sr-only">Video modal showing {{ TEAM_NAME }} mission film</p>

      <div class="aspect-video">
        <iframe
          title="Our Story ‚Äî {{ TEAM_NAME }}"
          class="w-full h-full rounded-b-2xl"
          src=""
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen
          loading="lazy"
          referrerpolicy="strict-origin-when-cross-origin"></iframe>
      </div>
    </div>
  </div>
</section>

{# --- JS: modal + counters (CSP nonce) --- #}
<script nonce="{{ NONCE }}">
(() => {
  const prefersReduce = matchMedia?.('(prefers-reduced-motion: reduce)').matches;

  // Counter animation: numeric only
  function animateCounter(el){
    const raw = (el.getAttribute('data-target') || el.textContent || '').trim();
    if(!/^\d+(\.\d+)?$/.test(raw)){ el.textContent = raw; return; }
    if(prefersReduce){ el.textContent = Number(raw).toLocaleString(); return; }
    const target = parseFloat(raw);
    let start=null, dur=900;
    const step=(ts)=>{ if(!start) start=ts; const p=Math.min(1,(ts-start)/dur);
      el.textContent = Math.floor(target*p).toLocaleString();
      if(p<1) requestAnimationFrame(step);
    };
    requestAnimationFrame(step);
  }
  function initCounters(){ document.querySelectorAll('.fc-counter').forEach(animateCounter); }

  // IO gate
  (function(){
    const sect = document.getElementById('fc-about');
    if('IntersectionObserver' in window && sect){
      let ran=false;
      const io=new IntersectionObserver((entries)=>{
        if(!ran && entries.some(e=>e.isIntersecting)){ ran=true; initCounters(); io.disconnect(); }
      },{threshold:0.2});
      io.observe(sect);
    } else { initCounters(); }
  })();

  // Modal + focus trap
  const openBtn = document.getElementById('fc-video-open');
  const modal   = document.getElementById('fc-video-modal');
  if (!openBtn || !modal) return;

  const iframe  = modal.querySelector('iframe');
  const overlay = modal.querySelector('[data-modal-overlay]');
  const closeBtn= modal.querySelector('[data-modal-close]');
  let lastFocus = null;

  const focusables = (root) => Array.from(root.querySelectorAll(
    'a[href],button,textarea,input,select,[tabindex]:not([tabindex="-1"])'
  )).filter(el => !el.hasAttribute('disabled') && !el.getAttribute('aria-hidden'));

  function lockBody(){ document.documentElement.style.overflow = 'hidden'; }
  function unlockBody(){ document.documentElement.style.overflow = ''; }

  function trapTab(e){
    if(e.key !== 'Tab') return;
    const f = focusables(modal); if(!f.length) return;
    const first=f[0], last=f[f.length-1];
    if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
    else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
  }
  function escClose(e){ if(e.key==='Escape') close(); }

  function open(){
    lastFocus = document.activeElement;
    modal.classList.remove('hidden');
    openBtn.setAttribute('aria-expanded','true');
    const src = openBtn.getAttribute('data-video-src') || '';
    if(iframe) iframe.src = src;
    lockBody();
    (focusables(modal)[0] || modal).focus();
    document.addEventListener('keydown', trapTab, { passive:false });
    document.addEventListener('keydown', escClose, { passive:false });
    try{ document.dispatchEvent(new CustomEvent('fc:video:open', { detail:{ src } })); }catch(_){}
  }

  function close(){
    modal.classList.add('hidden');
    openBtn.setAttribute('aria-expanded','false');
    if(iframe) iframe.src = '';
    unlockBody();
    document.removeEventListener('keydown', trapTab);
    document.removeEventListener('keydown', escClose);
    if(lastFocus && lastFocus.focus) lastFocus.focus();
    try{ document.dispatchEvent(new CustomEvent('fc:video:close')); }catch(_){}
  }

  openBtn.addEventListener('click', open, { passive:true });
  (closeBtn || modal).addEventListener('click', (e) => {
    if(e.target === overlay || e.currentTarget === closeBtn) close();
  });
})();
</script>

