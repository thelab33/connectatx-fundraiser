{# ============================================
   about_section.html ‚Äî FundChamps SV-ELITE (v4.0 One-Pager)
   - Impact strip + Story card + ‚ÄúWhere Your Gift Goes‚Äù
   - Motion-safe counters (IO gated)
   - CSP-safe vanilla JS, no third-party
   - Gold/Black theme, Inter font, --accent ready
   ============================================ #}
{% set NONCE = NONCE if NONCE is defined else (csp_nonce() if csp_nonce is defined else '') %}
{% macro nonce_attr() -%}nonce="{{ NONCE }}"{%- endmacro %}
{% set _team = team if team is defined and team else none %}
{% set TEAM_NAME   = _team.team_name if _team and _team.team_name else "Connect ATX Elite" %}
{% set REGION      = _team.region     if _team and _team.region     else "Austin, TX" %}
{% set MISSION_TXT = _team.mission    if _team and _team.mission    else
"Beyond basketball‚Äîwe‚Äôre shaping leaders, scholars, and role models for our community." %}
{% set SHOW_VIDEO  = SHOW_VIDEO if SHOW_VIDEO is defined else True %}
{% set VIDEO_URL   = VIDEO_URL if VIDEO_URL is defined and VIDEO_URL
  else (_team.video_url if _team and _team.video_url else 'https://www.youtube-nocookie.com/embed/dQw4w9WgXcQ?autoplay=1&mute=1') %}
{% set EIN         = ein if ein is defined else (_team.ein if _team and _team.ein else None) %}

{# Stats for counters #}
{% set STATS = STATS if STATS is defined and STATS else [
  {"icon":"üèÄ","label":"Regionals record","value": (_team.regionals_record if _team and _team.regionals_record else "15")},
  {"icon":"üèÜ","label":"Championships","value": (_team.championships    if _team and _team.championships    else "3")},
  {"icon":"üéì","label":"Top academic athletes","value": (_team.top_academic if _team and _team.top_academic else "12")}
] %}

{# Impact chip data (optional, auto-hidden if missing) #}
{% set RAISED = raised if raised is defined else 0 %}
{% set GOAL   = goal   if goal   is defined else 50000 %}
{% set DONORS = donors if donors is defined else 0 %}
{% set ATHLETES = athletes if athletes is defined else 0 %}
{% set TRIPS  = trips  if trips  is defined else 0 %}
{% set TUTOR_HOURS = tutor_hours if tutor_hours is defined else 0 %}
{% set PCT = (RAISED / GOAL * 100) if GOAL else 0 %}

{# Gift presets that sync to your amount input #}
{% set GIFT_PRESETS = GIFT_PRESETS if GIFT_PRESETS is defined and GIFT_PRESETS else [
  (25,  "1 team meal"),
  (50,  "1 jersey piece"),
  (100, "1 week of gym time")
] %}

<section id="fc-about" class="fc-section" aria-labelledby="fc-about-title" role="region" data-snap data-team="{{ TEAM_NAME|lower|replace(' ','-') }}">
  <style {{ nonce_attr() }}>
    #fc-about {
      --accent: var(--accent, #facc15);
      --accent-hi: #facc15;
      --accent-lo: #bfa034;
      --bg: #0b0f15;
      --fg: #eaf0fa;
      --card-bg: linear-gradient(180deg, rgba(16,18,24,.96), rgba(16,18,24,.88));
      --card-outline: rgba(255,255,255,.10);
      --muted: #b9c2d0;
      --shadow: 0 18px 56px rgba(0,0,0,.38);
      font-family: 'Inter', system-ui, Arial, sans-serif;
      color: var(--fg);
      scroll-margin-top: var(--fc-sticky-offset, 76px);
      padding-block: clamp(2.2rem, 6vw, 5.6rem);
      background: var(--bg);
    }
    /* Impact strip */
    #fc-about .impact-strip {
      max-width: 1100px; margin-inline: auto;
      display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;
      margin-bottom: clamp(10px, 2vw, 16px);
    }
    #fc-about .chip {
      display:inline-flex; gap:.35rem; align-items:center;
      padding:.46rem .72rem; border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      font-weight:900; color:var(--fg);
      white-space:nowrap;
    }
    #fc-about .chip-cta { margin-left:auto; text-decoration:none; color:#111;
      background: linear-gradient(180deg,#fffbe6,var(--accent));
      border-color: rgba(0,0,0,.25);
    }

    /* Main card */
    #fc-about .about-card {
      max-width: 60rem; margin-inline:auto;
      background: var(--card-bg); border:1px solid var(--card-outline);
      border-radius: clamp(18px, 2vw, 34px);
      box-shadow: var(--shadow);
      padding: clamp(1rem,2.2vw,2.6rem) clamp(1rem,2.4vw,2.8rem);
    }
    #fc-about .shine-text {
      background-image: linear-gradient(90deg, var(--accent-hi), var(--accent), var(--accent-lo));
      background-size: 200% 100%;
      -webkit-background-clip: text; background-clip: text; color: transparent;
      animation: about-shine 6s linear infinite; letter-spacing:-.01em;
    }
    @keyframes about-shine { to { background-position: 200% 0; } }

    /* Stats counters */
    #fc-about .stats-grid { display:grid; gap:.7rem; margin-block: .9rem 0;
      grid-template-columns: repeat(3, minmax(0,1fr)); }
    @media (max-width:540px){ #fc-about .stats-grid{ grid-template-columns: 1fr 1fr 1fr; } }
    #fc-about .stat{ background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.12);
      border-radius:1rem; box-shadow:0 2px 12px rgba(0,0,0,.12);
      display:flex; flex-direction:column; align-items:center; text-align:center; gap:.3rem; padding:.95rem .7rem; }
    #fc-about .stat .v{ font-variant-numeric: tabular-nums; font-weight:1000; font-size:clamp(1.1rem,.95rem + .9vw,1.6rem); }
    #fc-about .stat .k{ font-size:.8rem; color: var(--accent); opacity:.95; }

    /* Gift presets */
    #fc-about .gift-row{ display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.8rem; }
    #fc-about .gift { font-weight:900; }
    #fc-about .gift-note{ margin:.4rem 0 0; color: var(--muted); }

    /* CTAs */
    #fc-about .cta-row{ display:flex; flex-wrap:wrap; gap:.8rem; align-items:center; margin-block: 1rem 0; }
    #fc-about .fc-btn{ display:inline-flex; align-items:center; gap:.33em; padding:.7em 1.12em;
      border-radius:999px; font-weight:1000; font-size:1rem; border:none;
      background:linear-gradient(90deg, var(--accent-hi) 80%, #fffbe6 100%); color:#18181b;
      box-shadow:0 1.5px 8px rgba(0,0,0,.11); cursor:pointer; text-decoration:none; }
    #fc-about .fc-btn-ghost{ background:transparent; color:var(--accent);
      border:2px dashed var(--accent-hi); }
    #fc-about .fc-btn:focus-visible{ outline:3px solid var(--accent); outline-offset:2px; }

    /* Modal */
    .hidden{ display:none !important; }
    #fc-video-modal { background: rgba(0,0,0,.72); }
    #fc-video-modal[aria-modal="true"]{ display:flex; align-items:center; justify-content:center; }

    @media (prefers-reduced-motion: reduce){
      #fc-about .shine-text{ animation:none }
    }
    /* Light mode harmony */
    .light #fc-about{ --bg:#f9fafb; --fg:#0f172a; --muted:#334155; }
    .light #fc-about .chip,
    .light #fc-about .about-card,
    .light #fc-about .stat{ border-color: rgba(0,0,0,.12); }
    .light #fc-about .about-card{ background:linear-gradient(180deg,#fff, #fafaf9); }
  </style>

  {# -------------------- Impact Strip -------------------- #}
  <div class="impact-strip" aria-label="Impact summary">
    <div class="chip"><span style="opacity:.8">Raised</span> <strong>${{ '{:,.0f}'.format(RAISED) }}</strong></div>
    <div class="chip"><span style="opacity:.8">Goal</span> <strong>${{ '{:,.0f}'.format(GOAL) }}</strong></div>
    <div class="chip"><span style="opacity:.8">Progress</span> <strong>{{ '{:.0f}'.format(PCT) }}%</strong></div>
    {% if DONORS %}<div class="chip"><span style="opacity:.8">Donors</span> <strong>{{ DONORS }}</strong></div>{% endif %}
    {% if ATHLETES %}<div class="chip"><span style="opacity:.8">Athletes</span> <strong>{{ ATHLETES }}</strong></div>{% endif %}
    {% if TRIPS %}<div class="chip"><span style="opacity:.8">Trips</span> <strong>{{ TRIPS }}</strong></div>{% endif %}
    {% if TUTOR_HOURS %}<div class="chip"><span style="opacity:.8">Tutor Hrs</span> <strong>{{ TUTOR_HOURS }}</strong></div>{% endif %}
    <a href="#impact" class="chip chip-cta">Full Impact ‚Üí</a>
  </div>

  {# -------------------- Story Card -------------------- #}
  <div class="about-card">
    <h2 id="fc-about-title" class="shine-text" style="font-size:clamp(1.4rem,1rem + 2.4vw,2.2rem); font-weight:1000; margin:0 0 .4rem;">
      More Than Basketball ‚Äî We‚Äôre Family
    </h2>
    <p style="margin:.2rem 0; color:var(--accent)">
      <strong>{{ TEAM_NAME }}</strong> is more than a team‚Äîit‚Äôs a movement built by families, for families.
      We give kids a second home where teamwork, respect, and championship character are built for life.
    </p>
    <p style="margin:.4rem 0; color:inherit;">{{ MISSION_TXT }}</p>
    <p style="margin:.25rem 0 0; color:var(--accent-lo); opacity:.9; font-style:italic;">
      ‚ÄúFamily means showing up, believing in each other, and making sure no one is left behind.
      That‚Äôs what we do‚Äîon the court, and off.‚Äù <span style="color:#fde68a">&mdash; Coach Angel Rodriguez</span>
    </p>

    {# Stats #}
    <div class="stats-grid" style="margin-top:.7rem;">
      {% for s in STATS %}
      <div class="stat">
        <div aria-hidden="true" style="font-size:1.2rem">{{ s.icon }}</div>
        <div class="v fc-counter" data-target="{{ (s.value|string)|replace('‚Äì','-') }}">{{ s.value }}</div>
        <div class="k">{{ s.label }}</div>
      </div>
      {% endfor %}
    </div>

    {# Where Your Gift Goes (syncs to #fcx-custom-amount) #}
    <section aria-label="Where your gift goes" style="margin-top:.9rem;">
      <div class="gift-row">
        {% for amt, label in GIFT_PRESETS %}
          <button type="button" class="chip gift" data-amt="{{ amt }}">+ ${{ amt }} <span style="opacity:.8">‚Ä¢ {{ label }}</span></button>
        {% endfor %}
      </div>
      <p id="gift-copy" class="gift-note">Pick an amount to see the impact. You can edit anytime.</p>
    </section>

    {# CTAs #}
    <div class="cta-row">
      <a href="#fundraiser" class="fc-btn" data-cta="about:become-champion">üíõ Become a Champion</a>
      {% if SHOW_VIDEO %}
      <button id="fc-video-open" class="fc-btn fc-btn-ghost" type="button" data-video-src="{{ VIDEO_URL }}"
              aria-haspopup="dialog" aria-expanded="false">‚ñ∂ Watch 45s</button>
      {% endif %}
    </div>

    <p style="margin:.2rem 0 0; font-size:.9rem; color:#f5e9b4; opacity:.78;">
      üîí Secured by Stripe ‚Ä¢ {% if EIN %}üßæ 501(c)(3) ‚Ä¢ EIN {{ EIN }} ‚Ä¢ {% endif %}üìä Transparent reporting
    </p>
  </div>

  {% if SHOW_VIDEO %}
  <!-- CSP-safe Accessible Modal -->
  <div id="fc-video-modal" class="fixed inset-0 z-[80] hidden" role="dialog" aria-modal="true" aria-labelledby="fc-video-title">
    <div data-modal-overlay class="absolute inset-0 bg-black/70"></div>
    <div class="relative mx-auto my-10 w-[min(100vw-2rem,960px)] rounded-2xl overflow-hidden ring-1 ring-white/10 bg-black shadow-2xl">
      <div class="flex items-center justify-between px-4 py-3 border-b border-white/10">
        <h4 id="fc-video-title" class="font-bold">Program Highlights</h4>
        <button type="button" class="fc-btn fc-btn-ghost px-3 py-1.5" data-modal-close aria-label="Close video">‚úï</button>
      </div>
      <div class="relative" style="aspect-ratio:16/9;">
        <iframe class="absolute inset-0" style="width:100%;height:100%;" src="" title="Team highlight video"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                referrerpolicy="strict-origin-when-cross-origin"></iframe>
      </div>
    </div>
  </div>
  {% endif %}
</section>

<script {{ nonce_attr() }}>
(() => {
  // -------- Counters (IO gated, motion-safe) --------
  const prefersReduce = (typeof matchMedia === 'function') && matchMedia('(prefers-reduced-motion: reduce)').matches;
  function countTo(el){
    const raw = (el.getAttribute('data-target') || el.textContent || '').trim();
    if(!/^\d+(\.\d+)?$/.test(raw)){ el.textContent = raw; return; }
    const target = parseFloat(raw);
    if (prefersReduce){ el.textContent = target.toLocaleString(); return; }
    let t0=null, dur=900;
    const step=(ts)=>{ if(!t0) t0=ts; const p=Math.min(1,(ts-t0)/dur);
      el.textContent = Math.floor(target*p).toLocaleString();
      if(p<1) requestAnimationFrame(step);
    };
    requestAnimationFrame(step);
  }
  function initCounters(){ document.querySelectorAll('#fc-about .fc-counter').forEach(countTo); }
  (function(){
    const sect = document.getElementById('fc-about');
    if('IntersectionObserver' in window && sect){
      let ran=false;
      const io=new IntersectionObserver((entries)=>{
        if(!ran && entries.some(e=>e.isIntersecting)){ ran=true; initCounters(); io.disconnect(); }
      },{threshold:0.2});
      io.observe(sect);
    } else { initCounters(); }
  })();

  // -------- Gift presets ‚Üí sync to amount input --------
  const amountInput = document.getElementById('fcx-custom-amount'); // your existing amount input ID
  const copy = document.getElementById('gift-copy');
  document.querySelectorAll('#fc-about .gift').forEach(btn => {
    btn.addEventListener('click', () => {
      const amt = btn.getAttribute('data-amt') || '0';
      if(amountInput){
        amountInput.value = amt;
        try { amountInput.dispatchEvent(new Event('input')); } catch (e) {}
        try { amountInput.dispatchEvent(new Event('change')); } catch (e) {}
      }
      const txt = btn.textContent.split('‚Ä¢')[1];
      if(copy && txt){ copy.textContent = "That‚Äôs about " + txt.trim() + ". Thank you!"; }
    }, {passive:true});
  });

  // -------- Video modal (CSP-safe, accessible) --------
  const modal = document.getElementById('fc-video-modal');
  const trigger = document.getElementById('fc-video-open');
  if (modal && trigger){
    const iframe  = modal.querySelector('iframe');
    const overlay = modal.querySelector('[data-modal-overlay]');
    const closeBtn= modal.querySelector('[data-modal-close]');
    let last=null;

    const focusables = (root) => Array.from(root.querySelectorAll('a[href],button,textarea,input,select,[tabindex]:not([tabindex="-1"])'))
      .filter(el => !el.hasAttribute('disabled') && !el.getAttribute('aria-hidden'));

    function lock(){ document.documentElement.style.overflow='hidden'; }
    function unlock(){ document.documentElement.style.overflow=''; }
    function trap(e){
      if(e.key!=='Tab') return;
      const f = focusables(modal); if(!f.length) return;
      const first = f[0], lastEl = f[f.length-1];
      if(e.shiftKey && document.activeElement===first){ e.preventDefault(); lastEl.focus(); }
      else if(!e.shiftKey && document.activeElement===lastEl){ e.preventDefault(); first.focus(); }
    }
    function esc(e){ if(e.key==='Escape') close(); }

    function open(){
      last = document.activeElement;
      modal.classList.remove('hidden');
      const src = trigger.getAttribute('data-video-src') || '';
      if(iframe) iframe.src = src;
      lock(); (focusables(modal)[0] || modal).focus();
      document.addEventListener('keydown', trap);
      document.addEventListener('keydown', esc);
    }
    function close(){
      modal.classList.add('hidden');
      if (iframe) iframe.src = '';
      unlock();
      document.removeEventListener('keydown', trap);
      document.removeEventListener('keydown', esc);
      if(last && typeof last.focus === 'function') { last.focus(); }
    }
    trigger.addEventListener('click', open, {passive:true});
    modal.addEventListener('click', (e)=>{ if(e.target===overlay) close(); }, {passive:true});
    if(closeBtn){ closeBtn.addEventListener('click', close, {passive:true}); }
  }
})();
</script>

