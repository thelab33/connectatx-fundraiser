{# ================== About ‚Äî SV-Elite 4.0 (a11y, counters, copy-chips, meter, ribbon, CSP) ================== #}
{% set NONCE = NONCE if NONCE is defined else (csp_nonce() if csp_nonce is defined else '') %}
{% set _team = team if team is defined and team else none %}
{% set TEAM_NAME = _team.team_name if _team and _team.team_name else "Connect ATX Elite" %}
{% set REGION = _team.region if _team and _team.region else "Austin, TX" %}
{% set MISSION_TXT = _team.mission if _team and _team.mission else "Beyond basketball, we‚Äôre building scholars, leaders, and great teammates ‚Äî for life." %}
{% set EIN = _team.ein if _team and _team.ein else "" %}
{% set IS_501C3 = _team.is_501c3 if _team is defined and _team is not none and _team.is_501c3 else true %}
{% set IMPACT_BADGES = IMPACT_BADGES if IMPACT_BADGES is defined and IMPACT_BADGES else [
  "Need-based scholarships", "Tutoring & mentoring", "Travel assistance"
] %}
{% set SHOW_VIDEO = SHOW_VIDEO if SHOW_VIDEO is defined else True %}
{% set VIDEO_URL = VIDEO_URL if VIDEO_URL is defined and VIDEO_URL else (_team.video_url if _team and _team.video_url else 'https://www.youtube-nocookie.com/embed/dQw4w9WgXcQ?autoplay=1&mute=1') %}
{% set STATS = STATS if STATS is defined and STATS else [
  {"icon":"üèÄ","label":"Regionals record","value": (_team.regionals_record if _team and _team.regionals_record else "15")},
  {"icon":"üèÜ","label":"Championships","value": (_team.championships if _team and _team.championships else "3")},
  {"icon":"üéì","label":"Top academic athletes","value": (_team.top_academic if _team and _team.top_academic else "12")}
] %}
{% set TRUST_LOGOS = TRUST_LOGOS if TRUST_LOGOS is defined and TRUST_LOGOS else [] %}
{% set default_logo = (url_for('static', filename='images/logo.webp') if url_for is defined else '/static/images/logo.webp') %}
{% set donate_link = (stripe_payment_link if stripe_payment_link is defined and stripe_payment_link else (safe_url_for('main.donate') if (safe_url_for is defined and has_endpoint('main.donate')) else '/donate')) %}
{% set sms_number = (_team.sms_number if _team and _team.sms_number else '+15125551234') %}
{% set _raised = (funds_raised if funds_raised is defined else none) %}
{% set _goal = (fundraising_goal if fundraising_goal is defined else none) %}
{% macro nonce_attr() -%}nonce="{{ NONCE }}"{%- endmacro %}

<section
  id="fc-about"
  role="region"
  aria-labelledby="fc-about-title"
  class="section section--tight"
  data-share-url="{{ share_url|default(request.url if request is defined else '') }}"
  data-donate="{{ donate_link }}"
  data-sms="{{ sms_number }}"
  data-team="{{ TEAM_NAME }}"
  data-locale="{{ locale_str|default('en-US') }}"
  data-currency="{{ currency_code|default('USD') }}"
>
  <style {{ nonce_attr() }}{{ nonce_attr() }}>
    /* ===== Scope: #fc-about ‚Äî SV-Elite 4.0 ===== */
    #fc-about{ --ring: color-mix(in srgb, var(--fc-gold,#facc15) 65%, #fff); scroll-margin-top: var(--sticky-offset, 80px) }
    #fc-about .about-card{
      position:relative; max-width:64rem; margin-inline:auto; border-radius: clamp(22px, 18px + 1.2vw, 34px);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.12);
      -webkit-backdrop-filter:saturate(120%) blur(10px); backdrop-filter:saturate(120%) blur(10px);
      box-shadow: 0 24px 70px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06), inset 0 0 0 1px rgba(255,255,255,.04);
      overflow:hidden;
    }
    /* Polished conic ring */
    #fc-about .about-card::before{
      content:""; position:absolute; inset:-1px; border-radius:inherit; pointer-events:none; z-index:0;
      background:
        linear-gradient(#0000,#0000) padding-box,
        conic-gradient(from 180deg at 50% 50%, var(--ring), #e5e7eb, var(--ring)) border-box;
      border:1px solid transparent; opacity:.25; filter: drop-shadow(0 12px 40px rgba(0,0,0,.35));
    }
    /* Pointer glow */
    #fc-about .about-card::after{
      content:""; position:absolute; inset:-1px; border-radius:inherit; pointer-events:none; z-index:0;
      background: radial-gradient(38% 28% at var(--mx,60%) var(--my,20%), color-mix(in srgb, var(--fc-gold,#facc15) 24%, transparent) 0%, transparent 70%);
      opacity:0; transition:opacity .2s ease;
    }
    #fc-about .about-card:hover::after{ opacity:.9 }

    /* Content */
    #fc-about .inner{ position:relative; z-index:1; padding:clamp(20px, 2.6vw, 30px) }

    /* Title */
    #fc-about .title{
      font-weight:1000; letter-spacing:-.02em; text-wrap:balance;
      font-size:clamp(1.35rem,1.1rem + 1.4vw,2rem);
      color:transparent;
      background:linear-gradient(180deg,#fff, color-mix(in srgb,var(--fc-gold,#facc15) 75%, #fff));
      -webkit-background-clip:text; background-clip:text;
      text-shadow:0 12px 28px rgba(0,0,0,.35);
      margin:0 0 .35rem 0;
    }
    #fc-about .lede{ font-weight:800; color:#e5e7eb; font-size:clamp(.98rem,.9rem + .35vw,1.12rem); margin:0 0 .25rem 0 }
    #fc-about .body{ margin-top:.25rem; color:#e5e7eb; opacity:.95; font-size:clamp(.95rem,.86rem + .3vw,1.08rem) }

    /* Impact chips */
    #fc-about .impact{ display:flex; flex-wrap:wrap; gap:.45rem; margin-top:.8rem }
    #fc-about .legacy-chip{
      display:inline-flex; align-items:center; gap:.4rem; padding:.32rem .64rem; border-radius:.65rem;
      background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.22); color:#eef2f7; font-weight:900; font-size:.86rem;
      -webkit-backdrop-filter: blur(6px); backdrop-filter: blur(6px);
      transition:transform .15s ease, background .15s ease;
    }
    #fc-about .legacy-chip:hover{ transform:translateY(-1px); background:rgba(255,255,255,.16) }
    #fc-about .legacy-chip:focus-visible{ outline:2px solid color-mix(in srgb, var(--fc-gold,#facc15) 60%, #ffffff 40%); outline-offset:3px }

    /* Stats */
    #fc-about .stats{ display:grid; gap:clamp(.65rem,.6rem + .6vw,1rem); grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); margin-top:.9rem }
    #fc-about .stat{
      display:grid; grid-template-columns:auto 1fr; gap:.35rem .6rem; align-items:center;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:.8rem .9rem;
    }
    #fc-about .stat .icon{ grid-row:1 / span 2; font-size:1.2rem; opacity:.95 }
    #fc-about .stat .v{ grid-column:2; font-weight:900; letter-spacing:.01em; font-variant-numeric:tabular-nums; font-size:clamp(1.05rem,1rem + .4vw,1.3rem); color:#fff }
    #fc-about .stat .k{ grid-column:2; font-size:.85rem; color:#cbd5e1 }

    /* Snapshot / meter */
    #fc-about .snapshot{ margin-top:.9rem }
    #fc-about .kbd{
      padding:.15rem .4rem; border-radius:.45rem; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);
      font-variant-numeric:tabular-nums;
    }
    #fc-about .mini{ display:flex; align-items:center; justify-content:space-between; margin-top:.35rem; font-size:.9rem; color:#e5e7eb }
    #fc-about .fc-meter{ position:relative; height:14px; border-radius:9999px; overflow:hidden; background:rgba(255,255,255,.14); box-shadow:inset 0 0 0 1px rgba(255,255,255,.10) }
    #fc-about .fc-meter__ticks{ position:absolute; inset:0; pointer-events:none; opacity:.28;
      background:repeating-linear-gradient(90deg,rgba(255,255,255,.24) 0, rgba(255,255,255,.24) 1px, transparent 1px, transparent 5%);
    }
    #fc-about .fc-meter__bar{ position:absolute; inset-block:0; left:0; width:calc(var(--p,0) * 100%);
      background: linear-gradient(90deg, #e5e7eb, color-mix(in srgb, var(--fc-gold,#facc15) 45%, #d1d5db));
      box-shadow:0 0 10px color-mix(in srgb, var(--fc-gold,#facc15) 25%, transparent);
      transition: width .6s cubic-bezier(.2,.8,.2,1);
    }
    #fc-about .fc-meter__shine{ position:absolute; inset:0; pointer-events:none;
      background: linear-gradient(180deg, rgba(255,255,255,.25), rgba(255,255,255,0) 60%);
      mix-blend-mode:screen;
    }

    /* CTA row (inherits global fc-btn tokens when present) */
    #fc-about .cta{ display:flex; flex-wrap:wrap; gap:.5rem .6rem; margin-top:.9rem }
    .fc-btn{ display:inline-flex; align-items:center; justify-content:center; gap:.5rem; border-radius:999px; font-weight:900; line-height:1; text-decoration:none }
    .fc-btn-primary{ background:#0b0f15; color:#fff; border:1px solid #000; padding:.85rem 1.2rem; box-shadow:0 8px 24px rgba(0,0,0,.25) }
    .fc-btn-ghost{ background:rgba(255,255,255,.06); color:#e5e7eb; border:1px solid rgba(255,255,255,.14); padding:.78rem 1.1rem }
    .fc-btn:hover{ filter:brightness(1.08) }
    .fc-btn:focus-visible{ outline:2px solid color-mix(in srgb, var(--fc-gold,#facc15) 60%, #ffffff 40%); outline-offset:3px }

    /* Ribbon */
    #fc-about .ribbon{ display:grid; grid-auto-flow:column; grid-auto-columns:max-content; gap:1rem; overflow:auto; padding:.4rem .1rem;
      scrollbar-width:none; -ms-overflow-style:none;
      mask-image:linear-gradient(90deg, transparent, #000 5%, #000 95%, transparent);
      -webkit-mask-image:linear-gradient(90deg, transparent, #000 5%, #000 95%, transparent);
    }
    #fc-about .ribbon::-webkit-scrollbar{ display:none }
    #fc-about .slogo{ height:30px; width:auto; filter:grayscale(.1) contrast(1.1) brightness(.95); opacity:.95 }

    /* Utility / a11y */
    .sr-only{ position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0 }

    /* Guards */
    @media (prefers-reduced-motion:reduce){
      #fc-about .about-card::after{ transition:none }
      #fc-about .fc-meter__bar{ transition:none }
    }
    @media (forced-colors:active){
      #fc-about .about-card{ border:1px solid CanvasText; background:Canvas }
      #fc-about .legacy-chip, .fc-btn-ghost{ background:Canvas; color:CanvasText; border:1px solid CanvasText }
      #fc-about .fc-meter{ background:CanvasText }
      #fc-about .fc-meter__bar{ background:Highlight }
    }
    @media print{
      #fc-about .cta, #fc-about .ribbon{ display:none!important }
      #fc-about .about-card{ box-shadow:none }
    }
  </style>

  <div class="about-card">
    <div class="inner" itemscope itemtype="https://schema.org/SportsTeam" aria-live="polite">
      <meta itemprop="name" content="{{ TEAM_NAME }}" />

      <h2 id="fc-about-title" class="title">More Than Basketball ‚Äî We‚Äôre Family</h2>

      <p class="lede">
        <span class="text-[color:var(--fc-gold)]" itemprop="name">{{ TEAM_NAME }}</span>
        (<span itemprop="areaServed">{{ REGION }}</span>) is family-built and community-backed. We help kids grow as students, athletes, and leaders.
      </p>

      <p class="body" itemprop="description">{{ MISSION_TXT }}</p>

      {% set show_impact = (IMPACT_BADGES and IMPACT_BADGES|length > 0) or IS_501C3 or EIN %}
      {% if show_impact %}
      <div class="impact" role="list" aria-label="Impact highlights">
        {% if IS_501C3 %}
        <button class="legacy-chip" role="listitem" type="button" id="chip-501c3" data-copy="501(c)(3)" title="Copy status">‚úÖ 501(c)(3)</button>
        {% endif %}
        {% if EIN %}
        <button class="legacy-chip" role="listitem" type="button" id="chip-ein" data-copy="{{ EIN }}" title="Copy EIN">EIN: {{ EIN }}</button>
        {% endif %}
        {% for b in IMPACT_BADGES %}
          <span class="legacy-chip" role="listitem">{{ b }}</span>
        {% endfor %}
      </div>
      {% endif %}

      <!-- Stats -->
      <div class="stats" aria-label="Team highlights">
        {% for s in STATS %}
        <div class="stat" role="group" aria-label="{{ s.label }}">
          <div class="icon" aria-hidden="true">{{ s.icon }}</div>
          <div class="v fc-counter" data-target="{{ (s.value|string)|replace('‚Äì','-') }}">{{ s.value }}</div>
          <div class="k">{{ s.label }}</div>
        </div>
        {% endfor %}
      </div>

      <!-- Snapshot (optional) -->
      <div class="snapshot" id="about-snapshot" {% if _raised is none or _goal is none %}hidden{% endif %}>
        <div class="fc-meter" aria-hidden="true">
          <div class="fc-meter__ticks"></div>
          <div class="fc-meter__bar" id="about-bar" style="--p:0"></div>
          <div class="fc-meter__shine"></div>
        </div>
        <div class="mini">
          <span>
            <span id="about-raised" class="kbd">{{ _raised if _raised is not none else '‚Äî' }}</span>
            /
            <span id="about-goal" class="kbd">{{ _goal if _goal is not none else '‚Äî' }}</span>
          </span>
          <strong id="about-pct">0%</strong>
        </div>
      </div>

      <!-- CTAs -->
      <div class="cta" role="group" aria-label="Actions">
        <a href="{{ donate_link }}?utm_source=about&utm_medium=cta&utm_campaign=donate_now"
           class="fc-btn fc-btn-primary" data-analytics="about:donate">üíõ Donate Now</a>

        <a href="{{ tiers_url|default('#tiers') }}" class="fc-btn fc-btn-ghost" data-analytics="about:sponsor_tiers">üèÖ Sponsor Tiers</a>

        {% if SHOW_VIDEO %}
        <button id="fc-video-open" class="fc-btn fc-btn-ghost" type="button"
                data-video-src="{{ VIDEO_URL }}" aria-haspopup="dialog" aria-expanded="false"
                data-analytics="about:video_open">‚ñ∂ Watch Our Story</button>
        {% endif %}

        <a id="fc-sms" class="fc-btn fc-btn-ghost"
           href="sms:{{ sms_number }}?&body={{ ('Pledge for ' ~ TEAM_NAME ~ ' ‚Äî ' ~ (share_url if share_url is defined else (request.url if request is defined else ''))) | urlencode }}"
           data-analytics="about:text_to_donate">üí¨ Text to Donate</a>

        <button id="fc-share" class="fc-btn fc-btn-ghost" type="button" aria-label="Share this program" data-analytics="about:share">üîó Share</button>
      </div>

      {% if TRUST_LOGOS and TRUST_LOGOS|length > 0 %}
      <div class="mt-3">
        <div class="mb-1 text-sm text-zinc-400">Trusted by partners &amp; featured in:</div>
        <div class="ribbon" id="about-ribbon" aria-label="Partners and press">
          {% for src in TRUST_LOGOS[:12] %}
          <img class="slogo" src="{{ src or default_logo }}" alt="Partner logo" loading="lazy" decoding="async"/>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <script {{ nonce_attr() }}{{ nonce_attr() }} type="module">
    (() => {
      const about = document.getElementById("fc-about");
      if (!about) return;

      /* Pointer glow origin */
      about.addEventListener("mousemove", (e) => {
        const card = about.querySelector(".about-card"); if (!card) return;
        const r = card.getBoundingClientRect();
        card.style.setProperty("--mx", (((e.clientX - r.left) / r.width) * 100).toFixed(0) + "%");
        card.style.setProperty("--my", (((e.clientY - r.top) / r.height) * 100).toFixed(0) + "%");
      }, { passive:true });

      /* Copy chips (EIN / 501c3) */
      const copy = (txt) => navigator.clipboard?.writeText(txt).catch(()=>{});
      const bindCopy = (btn) => btn && btn.addEventListener("click",(e)=>{
        const v = e.currentTarget.getAttribute("data-copy") || e.currentTarget.textContent || "";
        copy(v.trim());
        const t = e.currentTarget.textContent; e.currentTarget.textContent = "Copied ‚úì";
        setTimeout(()=> e.currentTarget.textContent = t, 1100);
      }, { passive:true });
      bindCopy(about.querySelector("#chip-ein"));
      bindCopy(about.querySelector("#chip-501c3"));

      /* Counter-on-view (motion-safe) */
      const reduce = matchMedia?.("(prefers-reduced-motion: reduce)")?.matches;
      const counters = Array.from(about.querySelectorAll(".fc-counter"));
      const animateNum = (el) => {
        const end = Number((el.getAttribute("data-target")||"").replace(/[^\d.-]/g,"")) || 0;
        if (reduce) { el.textContent = String(end); return; }
        const t0 = performance.now(), dur = 900;
        const step = (t) => {
          const x = Math.min(1, (t - t0)/dur);
          el.textContent = String(Math.round(end * (1 - Math.pow(1 - x, 3))));
          if (x < 1) requestAnimationFrame(step);
        };
        requestAnimationFrame(step);
      };
      try{
        const io = new IntersectionObserver((ents, obs)=>{
          ents.forEach(ent=>{
            if (ent.isIntersecting){ animateNum(ent.target); obs.unobserve(ent.target); }
          });
        }, { rootMargin: "0px 0px -15% 0px", threshold: .2 });
        counters.forEach(c=> io.observe(c));
        addEventListener("pagehide",()=> io.disconnect(), { once:true });
      }catch{ counters.forEach(animateNum); }

      /* Snapshot meter + locale currency format */
      try{
        const locale = about.dataset.locale || navigator.language || "en-US";
        const currency = about.dataset.currency || "USD";
        const asMoney = (n) => new Intl.NumberFormat(locale, { style:"currency", currency, maximumFractionDigits:0 }).format(n);

        const raisedEl = about.querySelector("#about-raised");
        const goalEl   = about.querySelector("#about-goal");
        const pctEl    = about.querySelector("#about-pct");
        const bar      = about.querySelector("#about-bar");

        const parseNum = (txt) => Number(String(txt||"").replace(/[^0-9.]/g,"")) || 0;
        const rawRaised = parseNum(raisedEl?.textContent);
        const rawGoal   = parseNum(goalEl?.textContent);

        if (rawGoal > 0 && bar && pctEl){
          const pct = Math.max(0, Math.min(1, rawRaised / rawGoal));
          bar.style.setProperty("--p", pct.toFixed(4));
          pctEl.textContent = Math.round(pct * 100) + "%";
          // pretty print the numbers
          raisedEl.textContent = asMoney(rawRaised);
          goalEl.textContent   = asMoney(rawGoal);
        }
      }catch{}

      /* Simple video modal (expects #fc-video-modal elsewhere; no-op if missing) */
      const modal = document.getElementById("fc-video-modal");
      const openBtn = document.getElementById("fc-video-open");
      if (modal && openBtn){
        const iframe = modal.querySelector("iframe");
        const overlay = modal.querySelector("[data-modal-overlay]");
        const closeBtn = modal.querySelector("[data-modal-close]");
        const open = () => { modal.classList.remove("hidden"); openBtn.setAttribute("aria-expanded","true"); const src=openBtn.getAttribute("data-video-src"); if(iframe && src) iframe.src=src; };
        const close= () => { modal.classList.add("hidden"); openBtn.setAttribute("aria-expanded","false"); if(iframe) iframe.src=""; };
        openBtn.addEventListener("click", open, { passive:true });
        closeBtn?.addEventListener("click", close, { passive:true });
        overlay?.addEventListener("click", close, { passive:true });
        document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") close(); }, { passive:true });
      }

      /* Share (Web Share ‚Üí clipboard fallback) */
      const shareBtn = document.getElementById("fc-share");
      shareBtn?.addEventListener("click", async ()=>{
        const url = about.getAttribute("data-share-url") || location.href;
        const data = { title: document.title || "{{ TEAM_NAME|e }}", text: "Support our team ‚Äî every dollar moves a kid forward!", url };
        let ok=false;
        try{ if(navigator.share){ await navigator.share(data); ok=true; } }catch{}
        if(!ok){
          try{ await navigator.clipboard.writeText(url); ok=true; }catch{}
        }
        if(ok){ const t=shareBtn.textContent; shareBtn.textContent="Copied!"; setTimeout(()=> shareBtn.textContent=t, 1100); }
        try{ (window.dataLayer=window.dataLayer||[]).push({event:"share_click", where:"about"});}catch{}
      }, { passive:true });
    })();
  </script>
</section>

<script {{ nonce_attr() }}{{ nonce_attr() }} type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "SportsTeam",
      "name": {{ TEAM_NAME | tojson }},
      "areaServed": {{ REGION | tojson }},
      "memberOf": { "@type": "Organization", "name": "FundChamps" },
      "description": {{ MISSION_TXT | tojson }},
      "url": {{ (share_url if share_url is defined else (request.url if request is defined else '/')) | tojson }}
    },
    {
      "@type": "DonateAction",
      "name": {{ ("Donate to " ~ TEAM_NAME) | tojson }},
      "target": {
        "@type": "EntryPoint",
        "urlTemplate": {{ (donate_link ~ '?utm_source=seo&utm_medium=jsonld&utm_campaign=donate_action') | tojson }},
        "actionPlatform": [ "http://schema.org/DesktopWebPlatform", "http://schema.org/MobileWebPlatform" ]
      }
    }
  ]
}
</script>

