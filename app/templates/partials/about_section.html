{% from "macros/ui.html" import render_button %}
{% from "macros/confetti.html" import launch_confetti %}

{# --- Dynamic Vars & Fallbacks --- #}
{% set player_team = team.team_name if team and team.team_name is defined else 'Connect ATX Elite' %}
{% set team_league = team.league if team and team.league is defined else 'AAU' %}
{% set team_region = team.region if team and team.region is defined else 'Austin, TX' %}
{% set founder_last = team.founder_lastname if team and team.founder_lastname is defined else 'Smith' %}
{% set img_src = team.img if team and team.img else 'images/fallback.jpg' %}
{% set img_src = img_src if '://' in img_src else url_for('static', filename=img_src) %}
{% set rings_img = 'images/team-rings.webp' %}
{% set rings_img = rings_img if '://' in rings_img else url_for('static', filename=rings_img) %}
{% set video_src = team.story_video if team and team.story_video else 'videos/story.mp4' %}
{% set video_poster = team.story_poster if team and team.story_poster else 'images/video_poster.jpg' %}
{% set kvue_url = team.kvue_url if team and team.kvue_url else 'https://www.kvue.com/video/default-url' %}
{% set youtube_id = team.youtube_id if team and team.youtube_id else 'dQw4w9WgXcQ' %}
{% set testimonials = testimonials if testimonials is defined and testimonials else [
  {"quote": "Winning felt amazing ‚Äî but it‚Äôs being part of a team that believes in you that means the most.", "author": player_team ~ " Player, Class of 2030"},
  {"quote": "I never thought my child would love both books and basketball this much.", "author": "Happy Parent"},
  {"quote": "The coaches and families here really care. My son found his tribe.", "author": "Team Parent"}
] %}

<section
  id="about-families"
  class="relative py-16 sm:py-20 px-4 sm:px-8 max-w-7xl mx-auto bg-gradient-to-b from-zinc-950 via-black to-zinc-950 text-white rounded-3xl shadow-lg shadow-yellow-600/30 ring-2 ring-yellow-400/20 overflow-hidden"
  itemscope itemtype="https://schema.org/SportsTeam"
  aria-labelledby="about-main-heading"
  tabindex="-1"
>
  <meta itemprop="name" content="{{ player_team }}" />
  <meta itemprop="areaServed" content="{{ team_region }}" />
  <meta itemprop="memberOf" content="{{ team_league }}" />

  <!-- Decorative Watermarks -->
  <img src="{{ img_src }}" alt="" aria-hidden="true"
       class="absolute left-6 top-12 w-20 md:w-28 opacity-30 pointer-events-none select-none blur-sm rounded-lg" loading="lazy" decoding="async" />
  <img src="{{ img_src }}" alt="" aria-hidden="true"
       class="absolute right-6 bottom-12 w-16 md:w-24 opacity-20 pointer-events-none select-none blur-sm rounded-md" loading="lazy" decoding="async" />

  <h2 id="about-main-heading"
      class="text-4xl md:text-5xl font-extrabold text-center bg-gradient-to-r from-yellow-300 via-yellow-400 to-yellow-200 bg-clip-text text-transparent animate-shine drop-shadow-xl mb-7 outline-none"
      tabindex="0">
    About {{ player_team }} ‚Äî Our Mission &amp; Voices
  </h2>

  <div class="relative z-10 flex flex-col lg:flex-row items-start gap-14">
    <!-- About Card -->
    <article class="flex-1 max-w-xl mx-auto text-center lg:text-left space-y-8">
      <ul class="flex flex-wrap justify-center lg:justify-start gap-3 mb-3" aria-label="Team attributes">
        <li class="inline-flex items-center px-4 py-1.5 rounded-full bg-black/80 text-yellow-200 font-bold text-sm uppercase shadow-sm select-none">{{ player_team }}</li>
        <li class="inline-flex items-center px-4 py-1.5 rounded-full bg-yellow-300/80 text-yellow-900 font-semibold text-sm uppercase shadow-sm select-none">{{ team_league }} Proud</li>
        <li class="inline-flex items-center px-4 py-1.5 rounded-full bg-indigo-900/80 text-yellow-100 font-semibold text-sm uppercase shadow-sm select-none">Community Powered</li>
      </ul>
      <p class="text-lg md:text-xl font-semibold text-white/90 leading-relaxed max-w-md mx-auto lg:mx-0">
        <strong class="text-yellow-400">{{ player_team }}</strong> isn‚Äôt just a team ‚Äî it‚Äôs a <span class="text-yellow-200 font-extrabold">family movement</span> in <span class="text-amber-200">{{ team_region }}</span> where kids and parents find a second home.<br>
        <span class="mt-3 block">We build <span class="text-yellow-400">teamwork</span>, <span class="text-yellow-300">respect</span>, and <span class="text-amber-300">championship character</span> for life.</span>
      </p>
      <div class="bg-zinc-900/90 rounded-2xl p-6 shadow-md text-base text-white/80 max-w-md mx-auto lg:mx-0">
        Founded by the <strong class="text-yellow-300">{{ founder_last }}</strong> family, our <strong class="text-yellow-200">{{ team_league }}</strong> program began as a dad‚Äôs dream for his son ‚Äî and grew into a thriving community.<br>
        <span class="mt-2 block text-amber-200 font-bold leading-tight">Coaches, volunteers, and sponsors shape every student‚Äôs journey ‚Äî every child matters here.</span>
      </div>
      <!-- Story Modal Trigger -->
      <div class="mt-8">
        {{ render_button(label='‚ñ∂Ô∏è Watch Our Story', extra_classes='gap-3 rounded-full bg-gradient-to-r from-yellow-300 via-yellow-400 to-yellow-300 px-8 py-4 text-lg font-extrabold text-black shadow-lg hover:scale-105 focus-visible:ring-4 focus-visible:ring-yellow-300 transition animate-pulse', href='#', type='button', attrs={ "id": 'story-btn', "aria_haspopup": 'dialog', "aria_controls": 'story-modal', "aria_expanded": 'false' }) }}
      </div>
    </article>

    <!-- Testimonials Card -->
    <section class="flex-1 max-w-xl mx-auto mt-8 lg:mt-0" role="region" aria-label="Testimonials" tabindex="0">
      <h3 class="mb-7 text-3xl font-extrabold text-center bg-gradient-to-r from-yellow-300 via-yellow-400 to-yellow-500 bg-clip-text text-transparent drop-shadow-xl">
        üí¨ What Families Say
      </h3>
      <div id="testimonial-carousel" class="relative" aria-live="polite" aria-atomic="true" tabindex="0">
        <figure class="bg-zinc-900/90 rounded-3xl shadow-2xl px-8 py-10 text-center min-h-[170px] transition-all" aria-label="Testimonial quote and author">
          <blockquote id="carousel-quote" class="mb-4 text-xl font-semibold italic text-yellow-100 leading-relaxed"></blockquote>
          <figcaption id="carousel-author" class="font-bold text-yellow-300 text-base"></figcaption>
          <img src="{{ rings_img }}" alt="" aria-hidden="true" class="mx-auto mt-5 h-12 w-12 rounded-full object-cover opacity-70 shadow-inner" loading="lazy" decoding="async" />
        </figure>
        <nav class="mt-6 flex justify-center gap-3" aria-label="Select testimonial">
          {% for i in range(testimonials|length) %}
          <button class="dot h-3 w-3 rounded-full bg-yellow-300/70 transition-colors focus-visible:ring-2 focus-visible:ring-yellow-300"
                  data-idx="{{ i }}" aria-label="Show testimonial {{ i + 1 }}"
                  {% if not i %} aria-current="true" {% else %} tabindex="-1" {% endif %}
                  type="button"></button>
          {% endfor %}
        </nav>
        <button id="copy-quote" class="absolute right-6 bottom-6 text-sm text-yellow-300 underline hover:text-yellow-200 transition focus-visible:ring-2 focus-visible:ring-yellow-300 bg-black/50 px-4 py-2 rounded-xl" aria-label="Copy quote to clipboard" type="button">
          Copy Quote
        </button>
        <span id="copy-toast" class="pointer-events-none fixed bottom-10 left-1/2 -translate-x-1/2 rounded-2xl bg-yellow-400 px-4 py-2 font-bold text-black opacity-0 shadow-md transition-opacity duration-300">Copied!</span>
      </div>
    </section>
  </div>
</section>

<!-- Story Modal (outside main section for overlay) -->
<dialog id="story-modal"
        class="fixed inset-0 z-[12000] hidden items-center justify-center bg-black/90 backdrop-blur-lg transition-opacity duration-200"
        aria-modal="true" aria-labelledby="story-title" role="dialog" tabindex="-1">
  <div id="story-box"
       class="relative w-[95vw] max-w-3xl scale-95 opacity-0 rounded-3xl bg-black/95 shadow-2xl p-6 md:p-10 transition-all duration-300 focus:outline-none"
       role="document" tabindex="0">
    <button id="story-close"
            class="absolute top-5 right-5 text-4xl text-yellow-200 hover:text-yellow-300 focus-visible:ring-4 focus-visible:ring-yellow-300 rounded-lg"
            aria-label="Close story modal" type="button">√ó</button>
    <h2 id="story-title"
        class="mb-4 text-center text-2xl md:text-3xl font-extrabold bg-gradient-to-r from-yellow-300 via-yellow-400 to-yellow-300 bg-clip-text text-transparent drop-shadow animate-shine">
      Our Story: On &amp; Off the Court
    </h2>
    {% set tabs = [
      {'id':'myvideo','label':'üé• Team Video'},
      {'id':'kvue', 'label':'üì∫ KVUE News'},
      {'id':'yt', 'label':'üèÄ YouTube'}
    ] %}
    <nav class="mb-6 flex flex-wrap justify-center gap-4 md:gap-6" aria-label="Video sources" role="tablist">
      {% for t in tabs %}
      <button id="tab-{{ t.id }}"
              class="tab-btn rounded-full py-2 px-6 font-semibold text-base shadow transition focus-visible:ring-4 focus-visible:ring-yellow-300 {% if loop.first %}bg-yellow-400 text-black{% else %}bg-zinc-800 text-yellow-300{% endif %}"
              data-idx="{{ loop.index0 }}" role="tab" aria-controls="panel-{{ t.id }}"
              {% if loop.first %} aria-selected="true" {% else %} aria-selected="false" tabindex="-1" {% endif %}
              type="button">
        {{ t.label }}
      </button>
      {% endfor %}
    </nav>
    {% for t in tabs %}
    <div id="panel-{{ t.id }}"
         role="tabpanel"
         class="panel {% if not loop.first %}hidden{% endif %} w-full max-w-3xl aspect-video mx-auto rounded-2xl overflow-hidden focus:outline-none"
         aria-labelledby="tab-{{ t.id }}" tabindex="0">
      {% if t.id == 'myvideo' %}
      <video controls preload="none" poster="{{ video_poster }}" class="h-full w-full bg-black rounded-2xl">
        <source src="{{ video_src }}" type="video/mp4" />
        Sorry, your browser doesn‚Äôt support embedded videos.
      </video>
      {% elif t.id == 'kvue' %}
      <iframe src="{{ kvue_url }}" class="h-full w-full rounded-2xl" allowfullscreen loading="lazy" referrerpolicy="no-referrer"></iframe>
      {% else %}
      <iframe src="https://www.youtube.com/embed/{{ youtube_id }}" class="h-full w-full rounded-2xl" allowfullscreen loading="lazy" referrerpolicy="no-referrer"></iframe>
      {% endif %}
    </div>
    {% endfor %}
    <p class="mt-6 text-center text-xs text-zinc-400 select-none"><strong>{{ player_team }}</strong> &nbsp;|&nbsp; Family-run ¬∑ Community-powered ¬∑ Champions rising</p>
  </div>
</dialog>

<style>
@keyframes shine { 0%{ background-position:-200px; } 100%{ background-position:200px; } }
.animate-shine { background-size: 200% auto; animation: shine 2.5s linear infinite; }
@media (max-width:900px) { .panel { min-height:220px; } }
</style>

