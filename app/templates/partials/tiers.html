{# ================== Sponsorship Tiers ‚Äî SV-Elite 5.7 Compact Matrix (Pro) ================== #}
{% set NONCE = NONCE if NONCE is defined else (csp_nonce() if csp_nonce is defined else '') %}
{% macro nonce_attr() -%}nonce="{{ NONCE }}"{%- endmacro %}

{% set brand_color            = (team.theme_color if team and team.theme_color else '#facc15') %}
{% set donate_init_url        = (safe_url_for('main.donate') if (safe_url_for is defined and has_endpoint('main.donate')) else '/donate') %}
{% set tiers_stats_url        = (safe_url_for('main.stats_json') if (safe_url_for is defined and has_endpoint('main.stats_json')) else '/stats') %}
{% set tiers_sse_url          = (safe_url_for('main.stats_sse')  if (safe_url_for is defined and has_endpoint('main.stats_sse'))  else '/sse/tiers') %}
{% set currency               = (team.currency if team and team.currency else 'USD') %}
{% set stripe_publishable_key = stripe_publishable_key|default('') %}
{% set stripe_payment_link    = (stripe_payment_link if stripe_payment_link is defined and stripe_payment_link else '') %}
{% set team_name              = (team.team_name if team and team.team_name else 'Connect ATX Elite') %}

<section id="tiers"
         class="section section--flush tiers--compact"
         aria-labelledby="tiers-heading"
         data-where="tiers"
         data-currency="{{ currency }}"
         data-spl="{{ stripe_payment_link|e }}">
  <div class="mx-auto w-[min(1380px,98vw)]">
    <style {{ nonce_attr() }}>
      /* ===== Compact Matrix (flush with hero, 5-up desktop) ===== */
      #tiers{
        --fc-brand: {{ brand_color }};
        --shell-w: min(1380px, 98vw);
        --pad-x: clamp(14px, 2.6vw, 28px);
        --gap: clamp(16px, 1.6vw, 22px);
        --min-col: 220px;
        color-scheme: dark light;
        scroll-margin-top: calc(var(--fc-header-h,72px) + 10px);
      }
      #tiers .sr-only{position:absolute!important;width:1px!important;height:1px!important;padding:0!important;margin:-1px!important;overflow:hidden!important;clip:rect(0,0,1px,1px)!important;white-space:nowrap!important;border:0!important}

      /* Section head + controls align to hero shell */
      #tiers .section-head,
      #tiers .controls,
      #tiers #tiers-grid{
        max-width: var(--shell-w);
        margin-inline: auto;
        padding-inline: var(--pad-x);
      }
      #tiers .section-head{display:flex;align-items:center;justify-content:space-between;gap:.65rem;margin-bottom:.25rem}
      #tiers .heading{
        font-weight:1000;letter-spacing:-.02em;
        font-size:clamp(1.35rem,1.4vw,1.9rem);
        background-image:linear-gradient(180deg,#fff, color-mix(in srgb, var(--fc-brand) 72%, #fff));
        -webkit-background-clip:text;background-clip:text;color:transparent;
      }

      /* Controls (trim) */
      #tiers .controls{display:flex;flex-wrap:wrap;gap:.4rem;align-items:center;margin:.25rem 0 .65rem}
      #tiers .controls .spacer{flex:1}
      #tiers .chip{display:inline-flex;align-items:center;gap:.4rem;padding:.28rem .5rem;border-radius:.55rem;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);font-weight:900;font-size:.8rem;color:#e5e7eb}
      #tiers select{appearance:none;background:#0b0c0f;color:#e5e7eb;border:1px solid rgba(255,255,255,.14);border-radius:.55rem;padding:.35rem .6rem;font-weight:900;font-size:.85rem}

      /* Grid ‚Üí 5 / 4 / 3 / 2 / 1 */
      #tiers #tiers-grid{
        display:grid;
        gap: var(--gap);
        grid-template-columns: repeat(5, minmax(var(--min-col), 1fr));
        align-items: stretch;
      }
      @media (max-width:1280px){ #tiers #tiers-grid{ grid-template-columns: repeat(4, minmax(var(--min-col),1fr)); } }
      @media (max-width:1024px){ #tiers #tiers-grid{ grid-template-columns: repeat(3, minmax(var(--min-col),1fr)); } }
      @media (max-width:768px) { #tiers #tiers-grid{ grid-template-columns: repeat(2, minmax(var(--min-col),1fr)); } }
      @media (max-width:520px) { #tiers #tiers-grid{ grid-template-columns: 1fr; } }

      /* Square-ish tiles with glass */
      #tiers .flip-card{position:relative;aspect-ratio:1 / 1.05;min-height:0;cursor:pointer;perspective:1400px;touch-action:manipulation}
      #tiers .flip-card-inner{position:relative;width:100%;height:100%;transform-style:preserve-3d;transition:transform .6s cubic-bezier(.4,1.2,.4,1)}
      #tiers .flip-card.card-flipped .flip-card-inner,
      #tiers.tiers-hover .flip-card:hover .flip-card-inner{transform:rotateY(180deg)}
      @media (hover:none),(pointer:coarse){ #tiers .flip-card:hover .flip-card-inner{transform:none!important} }
      @media (prefers-reduced-motion:reduce){ #tiers .flip-card-inner{transition:none!important} }

      #tiers .face{position:absolute;inset:0;border-radius:.9rem;overflow:hidden;backface-visibility:hidden;-webkit-backface-visibility:hidden}
      #tiers .front{padding:.9rem}
      #tiers .back{padding:1rem;display:grid;place-items:center;text-align:center;transform:rotateY(180deg) translateZ(1px)}

      #tiers .glass{
        background:linear-gradient(180deg,rgba(17,17,17,.66),rgba(17,17,17,.52));
        -webkit-backdrop-filter:blur(10px) saturate(120%);backdrop-filter:blur(10px) saturate(120%);
        border:1px solid color-mix(in srgb, var(--fc-brand) 22%, transparent);
        box-shadow:0 8px 28px rgba(0,0,0,.28), inset 0 0 0 1px rgba(255,255,255,.06);
      }
      #tiers .glass::before{
        content:"";position:absolute;inset:-1px;border-radius:inherit;pointer-events:none;
        background:radial-gradient(120% 80% at var(--spot-x,50%) var(--spot-y,0%), color-mix(in srgb, var(--fc-brand) 22%, transparent), transparent 52%);
        filter:blur(14px);opacity:.35
      }

      /* Header row */
      #tiers .hdr{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:.45rem}
      #tiers .emoji{font-size:1.15rem}
      #tiers .title{font-weight:1000;color:#fef3c7;line-height:1;font-size:1rem}
      #tiers .meta{font-size:.78rem;color:#cbd5e1}
      #tiers .badge{border:1px solid color-mix(in srgb, var(--fc-brand) 20%, transparent);background:rgba(250,204,21,.10);padding:.1rem .35rem;border-radius:.5rem;font-size:.65rem;color:#fde68a}
      #tiers .ribbon{position:absolute;top:10px;right:10px;background:linear-gradient(90deg,#eab308,#fde68a);color:#111;font-weight:900;font-size:10px;padding:.18rem .44rem;border-radius:.45rem}

      /* Price + micro meter */
      #tiers .price{font-variant-numeric:tabular-nums;font-weight:900;color:#fde68a;font-size:.96rem}
      #tiers .slots{height:6px;border-radius:999px;background:rgba(255,255,255,.10);overflow:hidden;box-shadow:inset 0 0 0 1px rgba(255,255,255,.08);margin-top:.45rem}
      #tiers .slots > i{display:block;height:100%;width:0;background:linear-gradient(90deg,#fde047,#facc15)}

      /* Perk chips (1‚Äì2 rows max) */
      #tiers .perks{display:flex;flex-wrap:wrap;gap:.35rem;margin-top:.55rem}
      #tiers .perk{display:inline-flex;align-items:center;gap:.3rem;padding:.24rem .44rem;font-size:.78rem;font-weight:800;border-radius:.55rem;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);color:#e5e7eb;max-width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

      /* Buttons */
      #tiers .btn-row{display:flex;gap:.45rem;align-items:center;margin-top:.6rem}
      #tiers [data-tier-cta]{font-size:.9rem;padding:.56rem .8rem;border-radius:.6rem}
      #tiers .btn-ghost{padding:.42rem .62rem;border-radius:.6rem;font-size:.82rem;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.16);color:#e5e7eb}

      /* States & accessibility */
      #tiers .flip-card:focus-visible{outline:2px solid color-mix(in srgb, var(--fc-brand) 80%, #fff);outline-offset:2px}
      #tiers .soldout{pointer-events:none;opacity:.6;filter:saturate(.7)}

      /* Make faces fill cells perfectly */
      #tiers #tiers-grid .flip-card,
      #tiers #tiers-grid .flip-card-inner,
      #tiers #tiers-grid .front,
      #tiers #tiers-grid .back{height:100%}

      @media (forced-colors:active){
        #tiers .glass{background:Canvas!important;border-color:CanvasText!important;box-shadow:none}
        #tiers .perk{background:Canvas!important;border-color:CanvasText!important}
      }
    </style>

    <div class="section-head">
      <h2 id="tiers-heading" class="heading" tabindex="0">Sponsorship&nbsp;Tiers</h2>
      <p class="sr-only">Press Enter/Space to flip a tier for details. Press Escape to close.</p>
    </div>

    <div class="controls" aria-label="Tier controls">
      <label class="chip" for="tiers-monthly">
        <input id="tiers-monthly" type="checkbox" aria-describedby="tiers-price-mode" /> Show monthly
      </label>
      <span id="tiers-price-mode" class="sr-only">Toggle between monthly and one-time pricing.</span>
      <div class="spacer" aria-hidden="true"></div>
      <label class="sr-only" for="tiers-sort">Sort tiers</label>
      <select id="tiers-sort" aria-label="Sort tiers">
        <option value="rec">Sort: Recommended</option>
        <option value="price-desc">Price: High ‚Üí Low</option>
        <option value="price-asc">Price: Low ‚Üí High</option>
        <option value="availability">Availability</option>
      </select>
    </div>

    {% set tiers = tiers if tiers is defined and tiers else [
      {"title":"Platinum","amount":"5,000+","benefits":["Logo on jerseys","Shout-outs on social","VIP invites"],"emoji":"üèÜ","badge":"VIP","fomo":"Only 2 Platinum spots left!","slots_left":2},
      {"title":"Gold","amount":"2,500","benefits":["Warm-ups logo","Social features","Appreciation invites"],"emoji":"ü•á","popular":true,"fomo":"Most Popular! Limited to 4 sponsors.","slots_left":4},
      {"title":"Silver","amount":"1,000","benefits":["Social shout-outs","Thank-you certificate","Board listing"],"emoji":"ü•à","fomo":"Recognition on sponsor board.","slots_left":8},
      {"title":"Bronze","amount":"500","benefits":["Public thank-you","Board listing"],"emoji":"ü•â","fomo":"Perfect for first-timers.","slots_left":12},
      {"title":"Custom","amount":"Custom","benefits":["Tailored benefits","Personalized impact"],"emoji":"‚ú®","fomo":"We build a package for you.","slots_left":999}
    ] %}
    {% set cap_map = {'Platinum':2,'Gold':4,'Silver':8,'Bronze':12,'Custom':999} %}

    <!-- Matrix -->
    <div id="tiers-grid"
         class="fc-tiers"
         role="list"
         aria-labelledby="tiers-heading"
         data-stats-url="{{ tiers_stats_url }}"
         data-sse-url="{{ tiers_sse_url }}"
         data-donate-url="{{ donate_init_url }}"
         data-has-stripe="{{ '1' if stripe_publishable_key else '0' }}"
         data-currency="{{ currency }}"
         data-p2p-propagate="1">
      {% for tier in tiers %}
        {% set is_premium = tier.title in ['Gold','Platinum','VIP'] %}
        {% set amt_clean  = 'custom' if tier.amount|string|lower == 'custom' else (tier.amount|string|replace('+','')|replace(',','')) %}
        {% set price_id   = tier.price_id if 'price_id' in tier else None %}
        {% set checkout_url = tier.checkout_url if 'checkout_url' in tier else None %}
        {% set sold_out = (tier.slots_left is not none and (tier.slots_left|int) <= 0) %}

        <article id="tier-card-{{ loop.index }}"
                 class="flip-card {% if sold_out %}soldout{% endif %}"
                 role="listitem"
                 aria-roledescription="sponsorship tier"
                 tabindex="0"
                 aria-labelledby="tier-{{ loop.index }}-title"
                 aria-describedby="tier-{{ loop.index }}-benefits"
                 aria-expanded="false"
                 aria-controls="back-{{ loop.index }}"
                 data-tier="{{ tier.title }}"
                 data-amount="{{ amt_clean }}"
                 data-slots="{{ tier.slots_left or 0 }}"
                 data-cap="{{ cap_map.get(tier.title, 12) }}"
                 {% if price_id %}data-price-id="{{ price_id }}"{% endif %}
                 {% if checkout_url %}data-checkout-url="{{ checkout_url }}"{% endif %}
                 itemscope itemtype="https://schema.org/Offer">
          <meta itemprop="category" content="Sponsorship" />
          <meta itemprop="name" content="{{ tier.title }} Tier" />
          <meta itemprop="priceCurrency" content="{{ currency }}" />
          <meta itemprop="availability" content="https://schema.org/{% if sold_out %}SoldOut{% else %}InStock{% endif %}" />

          <div class="flip-card-inner">
            <!-- FRONT -->
            <div class="face front glass">
              {% if tier.popular %}<span class="ribbon" aria-hidden="true">Popular</span>{% endif %}
              <div class="hdr">
                <span class="emoji" aria-hidden="true">{{ tier.emoji }}</span>
                <div>
                  <h3 id="tier-{{ loop.index }}-title" class="title">{{ tier.title }}</h3>
                  <div class="meta">
                    {% if tier.amount|string|lower == 'custom' %}
                      <span class="price" data-original="custom">Custom package</span>
                    {% else %}
                      From <span class="price" data-amt="{{ amt_clean }}" data-original="${{ tier.amount }}">{{ "$" ~ tier.amount }}</span>{% if '+' in tier.amount|string %}+{% endif %}
                      <span class="sr-only">one-time</span>
                    {% endif %}
                  </div>
                </div>
                {% if tier.badge %}<span class="badge">{{ tier.badge }}</span>{% endif %}
              </div>

              <div class="slots" aria-label="Availability">
                <i role="progressbar"
                   aria-valuemin="0"
                   aria-valuemax="{{ cap_map.get(tier.title, 12) }}"
                   aria-valuenow="{{ (cap_map.get(tier.title, 12) - (tier.slots_left or 0)) }}"
                   style="width: {{ ((cap_map.get(tier.title, 12) - (tier.slots_left or 0)) * 100 // cap_map.get(tier.title, 12)) }}%"></i>
              </div>

              <div id="tier-{{ loop.index }}-benefits" class="perks" aria-label="Benefits">
                {% for ben in tier.benefits %}<span class="perk">{{ ben }}</span>{% endfor %}
              </div>

              <div class="btn-row">
                <button
                  class="{% if sold_out %}opacity-60 cursor-not-allowed {% endif %}{% if is_premium %}bg-yellow-400 text-black ring-1 ring-yellow-400/60{% else %}bg-zinc-900 text-yellow-200 border border-yellow-400/25{% endif %}"
                  data-tier-cta type="button" data-where="tiers"
                  aria-label="Sponsor the {{ tier.title }} tier{% if tier.amount|string|lower != 'custom' %} for ${{ tier.amount }}{% endif %}"
                  {% if sold_out %}disabled{% endif %}{% if stripe_payment_link %} data-payment-link="1"{% endif %}>
                  Sponsor {{ tier.title }}
                </button>
                <button type="button" class="btn-ghost" data-share data-where="tiers" aria-label="Share {{ tier.title }} tier">Share</button>
              </div>
            </div>

            <!-- BACK -->
            <div id="back-{{ loop.index }}" class="face back glass" aria-hidden="true">
              <div>
                <div class="emoji" aria-hidden="true" style="font-size:1.4rem">{{ tier.emoji }}</div>
                <h3 class="title" style="margin-top:.35rem">{{ tier.title }} Tier</h3>
                <p class="meta" style="margin-top:.25rem">{{ tier.fomo or "Sponsor now for max impact!" }}</p>
                <div class="btn-row" style="margin-top:.7rem">
                  <button
                    class="{% if sold_out %}opacity-60 cursor-not-allowed {% endif %}{% if is_premium %}bg-yellow-400 text-black ring-1 ring-yellow-400/60{% else %}bg-zinc-900 text-yellow-200 border border-yellow-400/25{% endif %}"
                    type="button" data-tier-cta data-where="tiers"
                    aria-label="Sponsor the {{ tier.title }} tier now"
                    {% if sold_out %}disabled{% endif %}{% if stripe_payment_link %} data-payment-link="1"{% endif %}>
                    Become a {{ tier.title }} Sponsor
                  </button>
                </div>
              </div>
            </div>
          </div>
        </article>
      {% endfor %}
    </div>

    <div id="tiers-sr" class="sr-only" aria-live="polite" aria-atomic="true"></div>
  </div>
</section>

<script {{ nonce_attr() }} type="module">
/* Compact Matrix JS (lean, a11y, SSE) */
(() => {
  if (window.__tiersBound) return; window.__tiersBound = true;
  const root = document.getElementById('tiers'); const grid = document.getElementById('tiers-grid'); if(!root||!grid) return;

  const HAS_STRIPE = (grid.dataset.hasStripe === '1');
  const SPL        = root.dataset.spl || grid.dataset.spl || '';
  const CURRENCY   = grid.dataset.currency || root.dataset.currency || 'USD';
  const donateUrl  = grid.dataset.donateUrl || '/donate';
  const statsUrl   = grid.dataset.statsUrl  || '/stats';
  const sseUrl     = grid.dataset.sseUrl    || '/sse/tiers';
  const saveData   = !!(navigator.connection && navigator.connection.saveData);
  const prefersReduced = matchMedia?.('(prefers-reduced-motion: reduce)')?.matches;

  const $  = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const sr = $('#tiers-sr');

  const nfmt = (v)=>{ try{ return new Intl.NumberFormat(navigator.language||'en-US',{style:'currency',currency:CURRENCY,maximumFractionDigits:0}).format(v) }catch{ return String(v) } };
  const parseAmt = (raw)=>{ if(raw==null) return null; const s=String(raw); if(/custom/i.test(s)) return null; const n=parseFloat(s.replace(/[^0-9.]/g,'')); return Number.isFinite(n)?n:null; };

  /* Hover gate: only enable flips for fine pointers */
  const mqlFine = matchMedia?.('(hover:hover) and (pointer:fine)'); let moved=false;
  const gate = () => root.classList.toggle('tiers-hover', !!(mqlFine?.matches && moved));
  addEventListener('pointermove', ()=>{ moved=true; gate(); }, { once:true, capture:true });
  mqlFine?.addEventListener?.('change', gate); gate();

  /* Spotlight follow */
  if (!prefersReduced){
    root.addEventListener('pointermove',(e)=>{
      const card=e.target.closest('.glass'); if(!card) return;
      const r=card.getBoundingClientRect();
      card.style.setProperty('--spot-x', (((e.clientX-r.left)/Math.max(1,r.width))*100)+'%');
      card.style.setProperty('--spot-y', (((e.clientY-r.top)/Math.max(1,r.height))*100)+'%');
    },{passive:true});
  }

  /* Flip + ARIA */
  function toggleCard(card, force){
    const on=(typeof force==='boolean')?force:!card.classList.contains('card-flipped');
    card.classList.toggle('card-flipped', on);
    card.setAttribute('aria-expanded', String(on));
    card.querySelector('.front')?.setAttribute('aria-hidden', on?'true':'false');
    card.querySelector('.back') ?.setAttribute('aria-hidden', on?'false':'true');
  }
  document.addEventListener('click',(e)=>{
    const card=e.target.closest('.flip-card'); if(!card) return;
    if (e.target.closest('button,[data-tier-cta],[data-share]')) return;
    toggleCard(card);
  });
  document.addEventListener('keydown',(e)=>{
    const card=e.target.closest('.flip-card'); if(!card) return;
    if (e.key==='Enter'||e.key===' '){ if(document.activeElement?.hasAttribute('data-tier-cta')) return; e.preventDefault(); toggleCard(card); }
    if (e.key==='Escape') toggleCard(card,false);
  });

  /* Monthly toggle */
  const monthlyToggle = document.getElementById('tiers-monthly');
  function renderPrices(){
    const monthly = !!monthlyToggle?.checked;
    grid.querySelectorAll('.price').forEach(el=>{
      const base = parseAmt(el.getAttribute('data-amt'));
      if (!base){ el.textContent = monthly ? 'Custom / mo' : (el.getAttribute('data-original') || 'Custom package'); return; }
      el.textContent = monthly ? (nfmt(Math.max(1,Math.round(base/12))) + '/mo') : nfmt(base);
    });
    try{ localStorage.setItem('fc_tiers_price_mode', monthly?'monthly':'once'); }catch{}
  }
  try{ if(localStorage.getItem('fc_tiers_price_mode')==='monthly') monthlyToggle.checked=true; }catch{}
  monthlyToggle?.addEventListener('change', renderPrices); renderPrices();

  /* Slots UI */
  function updateSlotsUI(card){
    const slotsLeft=Math.max(0,parseInt(card.dataset.slots||'0',10));
    const cap=Math.max(1,parseInt(card.dataset.cap||'1',10));
    const filled=Math.max(0,cap-slotsLeft);
    const pct=Math.min(100,Math.round((filled/cap)*100));
    const bar=card.querySelector('.slots > i'); if(bar){ bar.style.width=pct+'%'; bar.setAttribute('aria-valuenow', String(filled)); }
    const avail=card.querySelector('[itemprop="availability"]'); if(avail) avail.setAttribute('content', slotsLeft<=0?'https://schema.org/SoldOut':'https://schema.org/InStock');
  }
  $$('#tiers-grid .flip-card').forEach(updateSlotsUI);

  /* Checkout */
  async function startCheckout({ tier, amount, card }){
    const priceId = card?.dataset?.priceId || null;
    const checkoutUrl = card?.dataset?.checkoutUrl || null;
    try{ window.fcTrack?.('cta_click',{where:'tiers',tier,amount}); }catch{}
    const decorate=(u,source='tiers',medium='cta',campaign='sponsorship')=>{
      try{ if(window.FC?.decorateUrl) return FC.decorateUrl(u,source,medium,campaign);
           const url=new URL(u,location.origin); url.searchParams.set('utm_source',source); url.searchParams.set('utm_medium',medium); url.searchParams.set('utm_campaign',campaign); return url.toString(); }
      catch{ return u; }
    };
    const prefetch=(href)=>{ try{ if(!href) return; const k='tiers-prefetch-'+href; if(document.querySelector('link[data-key="'+k+'"]')) return; const l=document.createElement('link'); l.rel='prefetch'; l.href=href; l.as='document'; l.setAttribute('data-key',k); document.head.appendChild(l);}catch{} };

    if (checkoutUrl){ const u=decorate(checkoutUrl); prefetch(u); location.assign(u); return; }
    if (HAS_STRIPE && SPL){ const u=decorate(SPL); prefetch(u); location.assign(u); return; }
    if (typeof window.openDonationModal === 'function'){ window.openDonationModal({ tier, amount, priceId }); return; }

    try{
      const r=await fetch(donateUrl,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'same-origin',body:JSON.stringify({tier,amount,price_id:priceId})});
      if (r.ok){ const d=await r.json().catch(()=>({})); if (d?.url){ const u=decorate(d.url); prefetch(u); location.assign(u); return; } }
    }catch{}
    location.assign('/donate?' + new URLSearchParams({tier,amount:amount??'custom'}));
  }

  document.addEventListener('click',(e)=>{
    const btn=e.target.closest('[data-tier-cta]'); if(!btn) return;
    const card=btn.closest('.flip-card'); if(btn.disabled || card.classList.contains('soldout')) return;
    const title=card?.dataset?.tier || 'Custom';
    const amount=parseAmt(card?.dataset?.amount);
    let slots=parseInt(card.dataset.slots||'0',10); if(slots>0){ card.dataset.slots=String(slots-1); updateSlotsUI(card); }
    if (btn.hasAttribute('data-payment-link')) { try{ btn.target='_blank'; btn.rel='nofollow noopener noreferrer'; }catch{} }
    startCheckout({ tier:title, amount, card });
  });

  /* Share */
  document.addEventListener('click',(e)=>{
    const btn=e.target.closest('[data-share]'); if(!btn) return;
    const card=btn.closest('.flip-card'); if(!card) return;
    const tier=card.dataset.tier || 'Sponsor';
    const url=new URL(location.href); url.hash='sponsor='+encodeURIComponent(tier);
    const decorated = (window.FC?.decorateUrl ? FC.decorateUrl(url.toString(),'tiers','share','sponsorship') : url.toString());
    (async()=>{ try{
      if (window.FC?.handleShare) return FC.handleShare('tiers',{title:`${tier} Sponsor ‚Äî {{ team_name }}`,text:`Join as a ${tier} Sponsor for {{ team_name }}!`,url:decorated});
      if (navigator.share) return navigator.share({title:`${tier} Sponsor`,text:`Support {{ team_name }}`,url:decorated});
      await navigator.clipboard.writeText(decorated); sr && (sr.textContent=`${tier} share link copied.`);
    }catch{} })();
  });

  /* Sort */
  const sortSel=document.getElementById('tiers-sort');
  const amt=(c)=>parseAmt(c.dataset.amount)||0;
  function sortCards(mode){
    const cards=[...grid.querySelectorAll('.flip-card')];
    cards.sort((a,b)=>{
      if (mode==='price-desc') return amt(b)-amt(a);
      if (mode==='price-asc')  return amt(a)-amt(b);
      if (mode==='availability'){
        const ap=(+a.dataset.slots||0)/Math.max(1,+a.dataset.cap||1);
        const bp=(+b.dataset.slots||0)/Math.max(1,+b.dataset.cap||1);
        return bp-ap;
      }
      const popA=a.querySelector('.ribbon')?1:0, popB=b.querySelector('.ribbon')?1:0;
      return (popB-popA) || (amt(b)-amt(a));
    });
    cards.forEach(c=>grid.appendChild(c));
  }
  sortSel?.addEventListener('change',()=>sortCards(sortSel.value)); sortCards('rec');

  /* Live slots (SSE ‚Üí poll) */
  const updateFromData=(rows=[])=>{
    rows.forEach(row=>{
      const title=(row?.title||'').toString(); const slots=parseInt(row?.slots_left ?? 0,10);
      const card=$$('#tiers-grid .flip-card').find(el=>(el.dataset.tier||'').toLowerCase()===title.toLowerCase()); if(!card) return;
      const prev=parseInt(card.dataset.slots||'0',10); card.dataset.slots=String(Math.max(0,slots)); updateSlotsUI(card);
      if (slots<prev){ sr && (sr.textContent=`${title} availability updated: ${slots} left.`); }
    });
  };
  const trySSE=()=>{ if(saveData) return false; try{
    if(!('EventSource' in window)) return false;
    const es=new EventSource(sseUrl);
    es.addEventListener('tiers',(e)=>{ try{ updateFromData(JSON.parse(e.data)||[]);}catch{} });
    es.addEventListener('message',(e)=>{ try{ updateFromData(JSON.parse(e.data)||[]);}catch{} });
    addEventListener('pagehide',()=>es.close(),{once:true});
    return true;
  }catch{ return false; } };
  const poll=async()=>{ try{ const r=await fetch(statsUrl,{headers:{Accept:'application/json'}}); if(r.ok) updateFromData(await r.json()); }catch{} setTimeout(poll, saveData?60000:(prefersReduced?45000:20000)); };
  if(!trySSE()) setTimeout(poll,800);
})();
</script>

