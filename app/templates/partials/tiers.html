{# ================== Sponsorship Tiers ‚Äî FundChamps Elite (SV Pro v2.2) ================== #}
{% set brand_color       = (team.theme_color if team and team.theme_color else '#facc15') %}
{% set donate_init_url   = (safe_url_for('donate.initiate') if (safe_url_for is defined and has_endpoint('donate.initiate')) else '/donate/initiate') %}
{% set tiers_stats_url   = (safe_url_for('tiers.stats')      if (safe_url_for is defined and has_endpoint('tiers.stats'))      else '/tiers/stats') %}
{% set currency          = (team.currency if team and team.currency else 'USD') %}
{% set stripe_publishable_key = stripe_publishable_key|default('') %}
{% set stripe_payment_link    = (stripe_payment_link if stripe_payment_link is defined and stripe_payment_link else '') %}

<section
  id="tiers"
  class="bg-zinc-950 py-14 text-zinc-100 sm:py-16"
  aria-labelledby="tiers-heading"
  role="region"
  tabindex="-1"
  data-stats-url="{{ tiers_stats_url }}"
  data-donate-url="{{ donate_init_url }}"
  data-has-stripe="{{ '1' if stripe_publishable_key else '0' }}"
  data-spl="{{ stripe_payment_link|e }}"
  style="
    --fc-brand: {{ brand_color }};
    --fc-brand-200: color-mix(in srgb, {{ brand_color }} 20%, transparent);
    --fc-glass: rgba(17,17,17,.58);
    --fc-spot-x: 50%;
    --fc-spot-y: 0%;
  "
>
  <style nonce="{{ NONCE }}">
    /* ===== Scoped to #tiers only ===== */
    #tiers .grid { contain: layout paint; }
    #tiers .flip-card { perspective: 1800px; min-height: 400px; cursor: pointer; touch-action: manipulation; position: relative; }
    #tiers .flip-card-inner { position: relative; width: 100%; height: 100%; min-height: 372px;
      transform-style: preserve-3d; transition: transform .7s cubic-bezier(.4,1.6,.6,1); }
    #tiers .flip-card.card-flipped .flip-card-inner,
    #tiers .flip-card:focus-visible .flip-card-inner,
    #tiers .flip-card:hover .flip-card-inner { transform: rotateY(180deg); }
    #tiers .flip-card-front, #tiers .flip-card-back { position:absolute; inset:0; backface-visibility:hidden; border-radius: 1rem; overflow: hidden; z-index:1; }
    #tiers .flip-card-back { transform: rotateY(180deg); display:flex; flex-direction:column; align-items:center; justify-content:center; }

    /* ===== Premium glass plate + spotlight + highlight ring ===== */
    #tiers .glassy-card{
      background: var(--fc-glass);
      backdrop-filter: blur(16px) saturate(120%); -webkit-backdrop-filter: blur(16px) saturate(120%);
      position: relative; isolation:isolate;
      border:1px solid color-mix(in srgb, var(--fc-brand) 26%, transparent);
      box-shadow: 0 10px 34px rgba(0,0,0,.38), inset 0 0 0 1px rgba(255,255,255,.06);
    }
    /* spotlight follows cursor (motion-safe) */
    #tiers .glassy-card::before{
      content:""; position:absolute; inset:-1px; border-radius: inherit; pointer-events:none; z-index:0;
      background:
        radial-gradient(160% 90% at var(--fc-spot-x) var(--fc-spot-y),
          color-mix(in srgb, var(--fc-brand) 26%, transparent),
          transparent 55%)
        ,linear-gradient(to top, rgba(255,255,255,.04), transparent 50%);
      filter: blur(18px); opacity:.45;
    }
    /* soft top sheen */
    #tiers .glassy-card::after{
      content:""; position:absolute; inset:0 0 auto 0; height:38%;
      background: linear-gradient(to bottom, rgba(255,255,255,.06), transparent);
      pointer-events:none;
    }

    /* price & badges */
    #tiers .price { font-variant-numeric: tabular-nums; }
    #tiers .badge { border: 1px solid var(--fc-brand-200); background: rgba(250,204,21,.10); }

    /* sold out state */
    #tiers .soldout { pointer-events:none; opacity:.58; filter:saturate(.6); }
    #tiers .ribbon{
      position:absolute; top:12px; right:-42px; transform:rotate(35deg);
      background: linear-gradient(90deg, #eab308, #fde68a); color:#111;
      font-weight:900; font-size:11px; letter-spacing:.02em;
      padding:.25rem 2.25rem; box-shadow:0 6px 22px rgba(234,179,8,.25);
    }

    /* interaction polish */
    #tiers .pulse { animation: tiers-pulse 1100ms ease-out 1; }
    @keyframes tiers-pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.03)} }

    /* motion/contrast guards */
    @media (prefers-reduced-motion: reduce){
      #tiers .flip-card-inner { transition: none !important; }
      #tiers .flip-card:hover .flip-card-inner, #tiers .flip-card:focus-visible .flip-card-inner { transform: none !important; }
      #tiers .pulse { animation: none !important; }
    }
    @media (prefers-contrast: more){
      #tiers .glassy-card{ backdrop-filter:none; -webkit-backdrop-filter:none; background:#111; }
    }
  </style>

  <div class="container mx-auto max-w-6xl px-4 sm:px-6 lg:px-8">
    <h2 id="tiers-heading" class="text-3xl font-extrabold tracking-tight text-yellow-300 sm:text-4xl" tabindex="0" aria-label="Sponsorship Tiers">
      Sponsorship&nbsp;Tiers
    </h2>
    <p class="sr-only">Press Enter to flip a card and see details.</p>

    {% set tiers = tiers if tiers is defined and tiers else [
      {"title":"Platinum","amount":"5,000+","benefits":["Logo on jerseys","Shout-outs on social","VIP invites"],"emoji":"üèÜ","badge":"VIP","fomo":"Only 2 Platinum spots left!","slots_left":2,"price_id":None},
      {"title":"Gold","amount":"2,500","benefits":["Warm-ups logo","Social features","Appreciation invites"],"emoji":"ü•á","popular":true,"fomo":"Most Popular! Limited to 4 sponsors.","slots_left":4,"price_id":None},
      {"title":"Silver","amount":"1,000","benefits":["Social shout-outs","Thank-you certificate","Board listing"],"emoji":"ü•à","fomo":"Recognition on sponsor board.","slots_left":8,"price_id":None},
      {"title":"Bronze","amount":"500","benefits":["Public thank-you","Board listing"],"emoji":"ü•â","fomo":"Perfect for first-timers.","slots_left":12,"price_id":None},
      {"title":"Custom","amount":"Custom","benefits":["Tailored benefits","Personalized impact"],"emoji":"‚ú®","fomo":"We build a package for you.","slots_left":999,"price_id":None}
    ] %}

    <div class="mt-8 grid gap-6 sm:grid-cols-2 lg:grid-cols-3" role="list" aria-label="Available sponsorship tiers">
      {% for tier in tiers %}
        {% set is_premium = tier.title in ['Gold','Platinum','VIP'] %}
        {% set amt_clean = 'custom' if tier.amount|string|lower == 'custom' else (tier.amount|string|replace('+','')|replace(',','')) %}
        {% set price_id = tier.price_id if 'price_id' in tier else None %}
        {% set checkout_url = tier.checkout_url if 'checkout_url' in tier else None %}
        {% set sold_out = (tier.slots_left is not none and (tier.slots_left|int) <= 0) %}

        <article
          class="flip-card group rounded-2xl outline-none focus:ring-2 focus:ring-yellow-300 {% if sold_out %}soldout{% endif %}"
          tabindex="0" role="listitem" aria-roledescription="sponsorship tier"
          aria-labelledby="tier-{{ loop.index }}-title" aria-describedby="tier-{{ loop.index }}-benefits"
          aria-pressed="false"
          data-tier="{{ tier.title }}" data-amount="{{ amt_clean }}" data-slots="{{ tier.slots_left or 0 }}"
          {% if price_id %}data-price-id="{{ price_id }}"{% endif %}
          {% if checkout_url %}data-checkout-url="{{ checkout_url }}"{% endif %}
          itemscope itemtype="https://schema.org/Offer"
        >
          <meta itemprop="category" content="Sponsorship" />
          <meta itemprop="name" content="{{ tier.title }} Tier" />
          <meta itemprop="priceCurrency" content="{{ currency }}" />
          <meta itemprop="availability" content="https://schema.org/{% if sold_out %}SoldOut{% else %}InStock{% endif %}" />

          <div class="flip-card-inner">
            <!-- FRONT -->
            <div class="flip-card-front glassy-card bg-zinc-900/60 p-5 shadow-xl">
              {% if tier.popular %}<div class="ribbon" aria-hidden="true">Most&nbsp;popular</div>{% endif %}
              <div class="flex items-start justify-between gap-3">
                <div class="flex items-center gap-3">
                  <div class="text-2xl" aria-hidden="true">{{ tier.emoji }}</div>
                  <div>
                    <h3 id="tier-{{ loop.index }}-title" class="text-xl font-extrabold text-yellow-300">{{ tier.title }}</h3>
                    <p class="text-sm text-zinc-300">
                      {% if tier.amount|string|lower == 'custom' %}
                        Custom package
                      {% else %}
                        From <span class="price font-semibold text-yellow-200">${{ tier.amount }}</span>{% if '+' in tier.amount|string %}<span class="opacity-80">+</span>{% endif %}
                      {% endif %}
                    </p>
                  </div>
                </div>

                <div class="flex flex-col items-end gap-2 text-right">
                  {% if tier.badge %}<span class="badge rounded-full bg-black/50 px-2 py-0.5 text-[11px] font-semibold text-yellow-200">{{ tier.badge }}</span>{% endif %}
                  {% if tier.slots_left is not none and tier.slots_left|int <= 4 and tier.slots_left|int > 0 %}
                    <span class="mt-1 text-[11px] text-yellow-200/90" data-slots-left aria-live="polite">Only {{ tier.slots_left }} left</span>
                  {% elif sold_out %}
                    <span class="mt-1 text-[11px] text-red-300" data-slots-left aria-live="polite">Sold out</span>
                  {% endif %}
                </div>
              </div>

              <ul id="tier-{{ loop.index }}-benefits" class="mt-4 space-y-2 text-sm">
                {% for ben in tier.benefits %}
                <li class="flex items-start gap-2">
                  <svg viewBox="0 0 20 20" class="mt-0.5 h-4 w-4" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-7.25 7.25a1 1 0 01-1.414 0l-3-3a1 1 0 111.414-1.414l2.293 2.293 6.543-6.543a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                  <span>{{ ben }}</span>
                </li>
                {% endfor %}
              </ul>

              <div class="mt-5">
                <button
                  class="{% if sold_out %}opacity-60 cursor-not-allowed {% endif %}{% if is_premium %}bg-yellow-400 text-black ring-yellow-400/70{% else %}bg-zinc-900 text-yellow-200 border-yellow-400/30{% endif %} inline-flex w-full items-center justify-center gap-2 rounded-lg border px-4 py-2 font-bold shadow ring-1 ring-[color:var(--fc-brand-200)] transition hover:scale-[1.02]"
                  data-tier-cta type="button" aria-describedby="tier-{{ loop.index }}-benefits"
                  aria-label="Sponsor the {{ tier.title }} tier{% if tier.amount|string|lower != 'custom' %} for ${{ tier.amount }}{% endif %}"
                  data-analytics="tiers:cta" {% if sold_out %}disabled{% endif %}>
                  Sponsor {{ tier.title }}
                  <svg viewBox="0 0 20 20" class="h-4 w-4" fill="currentColor" aria-hidden="true"><path d="M12.293 4.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 11-1.414-1.414L14.586 10H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z"/></svg>
                </button>
                <p class="mt-2 text-xs text-zinc-300/80">Limited spots ‚Ä¢ Fast, secure checkout</p>
              </div>
            </div>

            <!-- BACK -->
            <div class="flip-card-back border border-[color:var(--fc-brand-200)] bg-black/70 p-6 text-center shadow-2xl">
              <span class="text-3xl" aria-hidden="true">{{ tier.emoji }}</span>
              <h3 class="mt-2 text-xl font-extrabold text-yellow-300">{{ tier.title }} Tier</h3>
              <p class="mt-2 text-sm text-zinc-200/90">{{ tier.fomo or "Sponsor now for max impact!" }}</p>
              <button
                class="{% if sold_out %}opacity-60 cursor-not-allowed {% endif %}{% if is_premium %}bg-yellow-400 text-black ring-yellow-400/70{% else %}bg-zinc-900 text-yellow-200 border-yellow-400/30{% endif %} mt-4 inline-flex items-center justify-center gap-2 rounded-lg border px-4 py-2 font-bold shadow ring-1 ring-[color:var(--fc-brand-200)] transition hover:scale-[1.02]"
                type="button" data-tier-cta data-analytics="tiers:cta:back" aria-label="Sponsor the {{ tier.title }} tier now" {% if sold_out %}disabled{% endif %}>
                Become a {{ tier.title }} Sponsor
                <svg viewBox="0 0 20 20" class="h-4 w-4" fill="currentColor" aria-hidden="true"><path d="M12.293 4.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 11-1.414-1.414L14.586 10H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z"/></svg>
              </button>
            </div>
          </div>
        </article>
      {% endfor %}
    </div>

    <div class="mt-10 rounded-xl border border-[color:var(--fc-brand-200)] bg-yellow-400/10 px-4 py-3 font-semibold text-yellow-200 shadow-inner">
      Every sponsorship powers <span class="underline underline-offset-2">gym access, travel, and academic support</span> for our team.
      <a href="mailto:team@connectatxelite.org?subject=Invoice%20Request%20‚Äî%20Sponsorship" class="ml-2 underline underline-offset-2">Need an invoice?</a>
    </div>

    <div class="mt-6">
      <button id="tiers-faq-toggle" class="inline-flex items-center gap-2 rounded-lg border border-[color:var(--fc-brand-200)] bg-zinc-900/70 px-4 py-2 font-semibold hover:bg-zinc-900 focus:outline-none focus:ring-2 focus:ring-yellow-300" aria-expanded="false" aria-controls="tiers-faq-body" type="button" tabindex="0">
        <span id="tiers-faq-icon" aria-hidden="true">‚ñ∂</span><span>Frequently Asked Questions</span>
      </button>
      <div id="tiers-faq-body" class="mt-3 hidden rounded-lg border border-[color:var(--fc-brand-200)] bg-black/50 p-4" aria-live="polite" hidden>
        <p><strong>Can I sponsor anonymously?</strong> Yes ‚Äî just let us know.</p>
        <p class="mt-1"><strong>Where does my sponsorship go?</strong> 100% supports gym rental, travel, academics, and gear.</p>
        <p class="mt-1"><strong>How do I sponsor?</strong> Click a tier button or email us.</p>
      </div>
    </div>

    <noscript><div class="mt-6 text-sm text-yellow-200/90">JavaScript is disabled. Please contact us to sponsor or visit the Donate page.</div></noscript>
  </div>
</section>

<script nonce="{{ csp_nonce() if csp_nonce is defined else '' }}">
(() => {
  if (window.__tiersBound) return; window.__tiersBound = true;

  const root   = document.getElementById('tiers');
  const faqT   = document.getElementById('tiers-faq-toggle');
  const faqB   = document.getElementById('tiers-faq-body');
  const faqI   = document.getElementById('tiers-faq-icon');
  const donateUrl = root?.dataset?.donateUrl || '/donate/initiate';
  const statsUrl  = root?.dataset?.statsUrl  || '/tiers/stats';
  const HAS_STRIPE = root?.dataset?.hasStripe === '1';
  const SPL = root?.dataset?.spl || '';
  const prefersReduced = window.matchMedia?.('(prefers-reduced-motion: reduce)')?.matches;

  const parseAmt = (raw) => { if (!raw || /custom/i.test(String(raw))) return null;
    const n = parseFloat(String(raw).replace(/[^0-9.]/g,'')); return isNaN(n) ? null : n; };

  // spotlight follow (motion-safe)
  if (!prefersReduced){
    root.addEventListener('pointermove', (e)=>{
      const card = e.target.closest('.glassy-card'); if(!card) return;
      const r = card.getBoundingClientRect();
      const x = ((e.clientX - r.left)/Math.max(1,r.width))*100;
      const y = ((e.clientY - r.top)/Math.max(1,r.height))*100;
      card.style.setProperty('--fc-spot-x', x+'%');
      card.style.setProperty('--fc-spot-y', y+'%');
    }, {passive:true});
  }

  // flip behavior with ARIA
  document.addEventListener('click', (e) => {
    const card = e.target.closest('.flip-card'); if (!card) return;
    if (e.target.closest('button,[data-tier-cta]')) return;
    toggleCard(card);
  });
  document.addEventListener('keydown', (e) => {
    const card = e.target.closest('.flip-card'); if (!card) return;
    if (e.key === 'Enter' || e.key === ' ') { if (document.activeElement?.hasAttribute('data-tier-cta')) return; e.preventDefault(); toggleCard(card); }
  });
  function toggleCard(card){ card.classList.toggle('card-flipped'); card.setAttribute('aria-pressed', String(card.classList.contains('card-flipped'))); }

  // deep-link: ?tier=Gold or #sponsor=Gold
  (function(){
    const url = new URL(location.href);
    const q = url.searchParams.get('tier') || (location.hash.startsWith('#sponsor=') && location.hash.slice(9));
    if (!q) return;
    const target = Array.from(root.querySelectorAll('.flip-card')).find(el => (el.dataset.tier||'').toLowerCase() === q.toLowerCase());
    if (target){
      target.scrollIntoView({ behavior: prefersReduced?'auto':'smooth', block: 'center' });
      target.classList.add('pulse'); setTimeout(()=>target.classList.remove('pulse'), 1100);
      toggleCard(target); target.focus({ preventScroll:true });
    }
  })();

  // UTM tagging for outbound
  function withUtm(u, tier){
    try{ const url = new URL(u, location.origin);
      url.searchParams.set('utm_source','tiers'); url.searchParams.set('utm_medium','web'); url.searchParams.set('utm_campaign','sponsorship'); url.searchParams.set('utm_content', String(tier||'').toLowerCase());
      return url.toString();
    }catch{ return u; }
  }

  // unified checkout flow
  async function startCheckout({ tier, amount, card }) {
    const priceId = card?.dataset?.priceId || null;
    const checkoutUrl = card?.dataset?.checkoutUrl || null;
    try { window.dispatchEvent(new CustomEvent('fundchamps:tiers:cta', { detail: { tier, amount, priceId } })); } catch {}

    if (checkoutUrl) { try { window.location.assign(withUtm(checkoutUrl, tier)); } catch {} vipMaybe({ tier, amount }); return; }
    if (HAS_STRIPE && SPL) { try { window.location.assign(withUtm(SPL, tier)); } catch {} vipMaybe({ tier, amount }); return; }
    if (typeof window.openDonationModal === 'function') { window.openDonationModal({ tier, amount, priceId }); vipMaybe({ tier, amount }); return; }

    if (window.htmx) {
      try { await htmx.ajax('POST', donateUrl, { values: { tier, amount, price_id: priceId }, swap: 'none' }); vipMaybe({ tier, amount }); return; } catch {}
    }
    try {
      const resp = await fetch(donateUrl, { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'same-origin', body: JSON.stringify({ tier, amount, price_id: priceId }) });
      if (resp.ok) { const data = await resp.json().catch(()=>({})); if (data?.url) { window.location.assign(withUtm(data.url, tier)); return; } }
    } catch {}
    const qs = new URLSearchParams({ tier, amount: amount ?? 'custom' }).toString(); window.location.assign('/donate?' + qs);
  }

  // VIP signal (sync to header/hero)
  function vipMaybe({ tier, amount }) {
    const high = (amount && amount >= 2500) || /platinum|gold|vip/i.test(String(tier));
    if (!high) return;
    try {
      window.dispatchEvent(new CustomEvent('fc:vip:hit', { detail: { threshold: amount || tier, source: 'tiers' }}));
      window.dispatchEvent(new CustomEvent('fc:funds:update', { detail: { sponsorName: `VIP ${tier} Sponsor` }}));
    } catch {}
  }

  // CTA handler + optimistic slot decrement
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-tier-cta]'); if (!btn) return;
    const card = btn.closest('.flip-card'); if (btn.disabled || card.classList.contains('soldout')) return;

    const title = card?.dataset?.tier || 'Custom';
    const amount = parseAmt(card?.dataset?.amount);

    const slotEl = card.querySelector('[data-slots-left]');
    let slots = parseInt(card.dataset.slots || '0', 10);
    if (slotEl && slots > 0) {
      const next = Math.max(0, slots - 1);
      card.dataset.slots = String(next);
      slotEl.textContent = next > 0 ? `Only ${next} left` : 'Sold out';
      if (next === 0) {
        slotEl.classList.add('text-red-300'); card.classList.add('soldout'); btn.disabled = true;
        card.querySelector('[itemprop="availability"]')?.setAttribute('content','https://schema.org/SoldOut');
      }
    }
    startCheckout({ tier: title, amount, card });
  });

  // FAQ toggle (persisted)
  if (faqT && faqB) {
    const key = 'fc:tiers:faq';
    const setState = (expanded) => {
      faqT.setAttribute('aria-expanded', String(expanded));
      faqB.hidden = !expanded; faqB.classList.toggle('hidden', !expanded);
      if (faqI) faqI.textContent = expanded ? '‚ñº' : '‚ñ∂';
      try { localStorage.setItem(key, expanded ? '1' : '0'); } catch {}
    };
    try { setState(localStorage.getItem(key) === '1'); } catch { setState(false); }
    faqT.addEventListener('click', () => setState(faqT.getAttribute('aria-expanded') !== 'true'));
    faqT.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); setState(faqT.getAttribute('aria-expanded') !== 'true'); }});
  }

  // Live slot polling (optional) ‚Äî expects [{ title, slots_left }]
  setTimeout(() => {
    const poll = async () => {
      try {
        const res = await fetch(statsUrl, { headers: { 'Accept': 'application/json' }});
        if (res.ok) {
          const data = await res.json();
          if (Array.isArray(data)) {
            data.forEach(row => {
              const title = (row?.title || '').toString();
              const slots = parseInt(row?.slots_left ?? 0, 10);
              const card = Array.from(root.querySelectorAll('.flip-card')).find(el => (el.dataset.tier||'').toLowerCase() === title.toLowerCase());
              if (!card) return;
              card.dataset.slots = String(Math.max(0, slots));
              const slotEl = card.querySelector('[data-slots-left]'); const btn = card.querySelector('[data-tier-cta]');
              if (slotEl) {
                if (slots <= 0) { slotEl.textContent = 'Sold out'; slotEl.classList.add('text-red-300'); card.classList.add('soldout'); btn && (btn.disabled = true);
                  card.querySelector('[itemprop="availability"]')?.setAttribute('content','https://schema.org/SoldOut'); }
                else { slotEl.textContent = slots <= 4 ? `Only ${slots} left` : `${slots} available`; slotEl.classList.remove('text-red-300'); card.classList.remove('soldout'); btn && (btn.disabled = false);
                  card.querySelector('[itemprop="availability"]')?.setAttribute('content','https://schema.org/InStock'); }
              }
            });
          }
        }
      } catch {}
      setTimeout(poll, prefersReduced ? 45000 : 20000);
    };
    poll();
  }, 1200);
})();
</script>

<script type="application/ld+json" nonce="{{ csp_nonce() if csp_nonce is defined else '' }}">
{
  "@context": "https://schema.org",
  "@type": "OfferCatalog",
  "name": "Sponsorship Tiers",
  "itemListElement": [
    {% for tier in tiers %}
    {
      "@type": "Offer",
      "name": "{{ tier.title }}",
      "priceCurrency": "{{ currency }}",
      {% if tier.amount|string|lower == 'custom' %}
      "price": "0",
      "description": "{{ (tier.fomo or 'Custom sponsorship package')|e }}"
      {% else %}
      "price": "{{ tier.amount|string|replace(',','')|replace('+','') }}",
      "description": "{{ (tier.benefits|join(', '))|e }}"
      {% endif %}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
  ]
}
</script>

