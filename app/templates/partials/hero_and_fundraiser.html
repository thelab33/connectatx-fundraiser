{# ======================= FC HERO ‚Äî SV SaaS ELITE v8 (refactored for v3.3 base) ======================= #}
{% set NONCE = NONCE if NONCE is defined else (csp_nonce() if csp_nonce is defined else '') %}
{% set theme_hex = theme_hex|default('#facc15') %}
{% set team_name = (team.team_name if team and team.team_name else 'Connect ATX Elite') %}
{% set CATCH_PHRASE = catch_phrase if catch_phrase is defined and catch_phrase else 'Fuel the Season, Fund the Future' %}
{% set HERO_TITLE = (hero_title if hero_title is defined and hero_title else team_name ~ ' ‚Äî Fundraiser') %}

{# Punchlines #}
{% set PUNCHLINES = punchlines if punchlines is defined and punchlines else [
  "Sponsor gym time for " ~ team_name ~ ".",
  "Every gift makes court time possible.",
  "We missed practices last season ‚Äî sponsors make all the difference!",
  "Without enough court time, our team can‚Äôt develop the chemistry or skills we need to win and grow."
] %}

{# Numbers #}
{% set _fr = (funds_raised|string)|replace('$','')|replace(',','')|float if funds_raised is defined else 0.0 %}
{% set _fg = (fundraising_goal|string)|replace('$','')|replace(',','')|float if fundraising_goal is defined and fundraising_goal else 10000.0 %}
{% set funds_raised = _fr %}
{% set fundraising_goal = (_fg if _fg > 0 else 1.0) %}
{% set pct_raw = 100.0 * (funds_raised / fundraising_goal) %}
{% set pct = (0 if pct_raw < 0 else (100 if pct_raw > 100 else pct_raw)) | round(1) %}
{% set deadline_dt = fundraiser_deadline|default('2025-12-31T23:59:59') %}

{# Milestones #}
{% set _miles = [0.25,0.50,0.75,1.0] %}
{% set _next = namespace(val=None) %}
{% for m in _miles %}
  {% if funds_raised < (fundraising_goal * m) and _next.val is none %}{% set _next.val = m %}{% endif %}
{% endfor %}
{% set next_pct = (_next.val * 100 if _next.val is not none else 100) %}
{% set to_next = ((fundraising_goal * (_next.val if _next.val is not none else 1.0)) - funds_raised) %}

{# Payments #}
{% set stripe_payment_link = (stripe_payment_link if stripe_payment_link is defined and stripe_payment_link else '') %}

{# Background image (prefer HERO_IMG from base; else compute) #}
{% set _input_src = (
  (HERO_IMG if HERO_IMG is defined and HERO_IMG) or
  (team.hero_bg if team and team.hero_bg is defined and team.hero_bg) or
  (team.hero_image if team and team.hero_image is defined and team.hero_image) or
  (team.team_photo if team and team.team_photo is defined and team.team_photo) or
  (team.photo_url if team and team.photo_url is defined and team.photo_url) or
  'images/connect-atx-team.jpg') %}
{% if '://' in _input_src or _input_src.startswith('data:') %}
  {% set hero_bg = _input_src %}
{% else %}
  {% set hero_bg = (url_for('static', filename=_input_src.lstrip('/')) if url_for is defined else '/static/' ~ _input_src.lstrip('/')) %}
{% endif %}
{% set hero_fallback = (url_for('static', filename='images/logo.webp') if url_for is defined else '/static/images/logo.webp') %}
{% set hero_focus = (team.hero_focus if team and team.hero_focus is defined and team.hero_focus else '50% 24%') %}

{# Safe if duplicated with base preload: browsers dedupe by URL #}
<link rel="preload" as="image" href="{{ hero_bg }}" imagesizes="100vw" fetchpriority="high" />

<div id="fc-hero"
     class="relative isolate"
     data-deadline="{{ deadline_dt }}"
     style="--fc-hero-accent: {{ theme_hex }}; --hero-focus: {{ hero_focus }};">
  <h1 id="fc-hero-title" class="sr-only">{{ HERO_TITLE }}</h1>
  <p id="sr-live" class="sr-only" aria-live="polite" aria-atomic="true"></p>

  <!-- Hero card with TEAM PHOTO under a glass content layer -->
  <div class="relative overflow-hidden rounded-[28px] sm:rounded-[32px] lg:rounded-[36px] p-6 sm:p-8 lg:p-10 fc-hero-glass"
       style="margin-top: clamp(1.2rem, 5vw, 6rem);">

    <!-- Photo layer (matches base selectors) -->
    <div class="hero-bg" aria-hidden="true">
      <img id="fc-hero-img"
           src="{{ hero_bg }}"
           data-fallback="{{ hero_fallback }}"
           alt="{{ team_name }} team photo"
           width="1920" height="1080"
           loading="eager" decoding="async" fetchpriority="high" sizes="100vw" />
      <!-- Light polish overlays -->
      <div class="absolute inset-0 bg-gradient-to-b from-black/80 via-black/45 to-black/20"></div>
      <div class="absolute inset-0 pointer-events-none"
           style="background: radial-gradient(45% 30% at 50% 22%, rgba(255,214,80,.16), transparent 60%); filter: blur(28px)"></div>
      <div class="absolute inset-0 opacity-[.06]"
           style="background-image:url(&quot;data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'><filter id='n'><feTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/></filter><rect width='100%' height='100%' filter='url(%23n)' opacity='.15'/></svg>&quot;); background-size:240px 240px;"></div>
    </div>

    <!-- Content layer (matches base selectors) -->
    <div class="hero-content">
      <!-- Brand + catchphrase -->
      <div class="flex flex-col items-center text-center gap-2 sm:gap-3">
        <p class="legacy-chip inline-block" aria-label="{{ team_name }}"><span class="txt">{{ team_name }}</span></p>
        <p class="title-sub text-base sm:text-xl lg:text-2xl font-semibold text-white/95">{{ CATCH_PHRASE }}</p>
        <p id="fc-hero-sub" class="fc-pill fc-pill--dark text-[13px] sm:text-base text-zinc-50/95" aria-live="polite" aria-atomic="true">
          {{ (PUNCHLINES[0] if PUNCHLINES and PUNCHLINES|length else 'Every gift makes court time possible.') }}
        </p>

        <!-- Countdown -->
        <div class="mt-2 grid grid-cols-4 gap-2 text-center select-none" role="timer" aria-live="polite" aria-atomic="true">
          {% for key in ['Days','Hrs','Min','Sec'] %}
          <div class="rounded-xl bg-white/10 ring-1 ring-white/15 px-3 py-2">
            <div class="tabular text-xl sm:text-2xl font-black text-white" id="fc-ct-{{ key|lower }}" aria-label="{{ key }}">00</div>
            <div class="text-[10px] sm:text-[11px] uppercase tracking-wider text-zinc-300">{{ key }}</div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Progress + Actions -->
      <div class="mt-6 sm:mt-8 grid grid-cols-12 gap-5 lg:gap-6 items-stretch">
        <!-- Progress -->
        <div class="col-span-12 lg:col-span-7 flex flex-col" aria-labelledby="fc-progress-title">
          <div class="flex-1 rounded-2xl p-5 lg:p-6 ring-1 ring-white/10 bg-gradient-to-br from-white/8 to-white/0">
            <h2 id="fc-progress-title" class="sr-only">Fundraising progress</h2>

            <div class="flex items-end justify-between gap-4">
              <div>
                <div class="text-zinc-300 text-xs sm:text-sm">Raised</div>
                <div class="text-3xl sm:text-4xl font-black tabular text-white" id="fc-raised" aria-live="polite">${{ ('%0.0f' % funds_raised) }}</div>
              </div>
              <div class="text-right">
                <div class="text-zinc-300 text-xs sm:text-sm">Goal</div>
                <div class="text-2xl sm:text-3xl font-extrabold tabular text-white" id="fc-goal">${{ ('%0.0f' % fundraising_goal) }}</div>
              </div>
            </div>

            <!-- Meter -->
            <div class="mt-3">
              <div id="fundraiser-meter" class="relative w-full rounded-full overflow-hidden ring-1 ring-white/10"
                   style="--meter-h: clamp(9px, 1.0vw, 12px); height: var(--meter-h);"
                   data-raised="{{ funds_raised }}" data-goal="{{ fundraising_goal }}"
                   role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ ('%.1f' % pct) }}" aria-label="Fundraising progress">
                <div class="absolute inset-0 opacity-35" style="background:linear-gradient(90deg,#eab308 0%, #84cc16 45%, #22c55e 100%);"></div>
                <div class="absolute inset-0 pointer-events-none" style="background-image:linear-gradient(to right, rgba(255,255,255,.18) 0 0); background-size:25% 100%; mix-blend-mode:soft-light; opacity:.28;"></div>
                <div id="fc-bar" class="h-full rounded-full"
                     style="width: {{ pct }}%; background:linear-gradient(90deg,#f2d14b 0%, #34d399 70%, #22c55e 100%); box-shadow:inset 0 0 0 1px rgba(255,255,255,.18), 0 4px 14px rgba(34,197,94,.25); transition:width .6s cubic-bezier(.2,.8,.2,1);"></div>
                <div class="absolute inset-0" style="background:linear-gradient(90deg, rgba(255,255,255,.22), rgba(255,255,255,.06) 35%, rgba(255,255,255,.16)); mix-blend-mode:soft-light;"></div>
              </div>

              <div class="mt-3 flex items-center justify-between">
                <div class="text-xs sm:text-sm text-zinc-200"><span class="sr-only">Progress:</span><span id="fc-pct" class="font-extrabold tabular text-[.92em]" aria-live="polite">{{ ('%.1f' % pct) }}</span>% funded</div>
                <div class="text-xs sm:text-sm text-zinc-200">Deadline: <time id="fc-deadline" class="font-semibold" datetime="{{ deadline_dt }}">{{ deadline_dt }}</time></div>
              </div>

              <div id="fc-next" class="mt-2 text-[12px] sm:text-sm text-zinc-300" aria-live="polite">
                {% if _next.val is not none %}{{ 'Only $%0.0f to reach %d%%' % (to_next, next_pct|round|int) }}{% else %}Great momentum ‚Äî keep it rolling!{% endif %}
              </div>
            </div>

            <!-- Milestones -->
            <div id="fc-milestones" class="mt-4 flex items-center gap-2 text-[11px] text-zinc-300" aria-hidden="true" data-milestones="25,50,75,100">
              {% for m in [25,50,75,100] %}
                {% set active = (pct < m and next_pct|round|int == m) %}
                <span class="inline-flex items-center rounded-lg px-2 py-1 ring-1
                             {% if active %}bg-yellow-300/90 text-zinc-900 ring-yellow-200 shadow-[0_0_0_3px_rgba(250,204,21,.25)]{% else %}bg-white/6 ring-white/10{% endif %}"
                      data-m="{{ m }}">üéØ {{ m }}%</span>
              {% endfor %}
            </div>
          </div>
        </div>

        <!-- Quick actions -->
        <aside class="col-span-12 lg:col-span-5 flex flex-col" aria-labelledby="fc-quick-actions">
          <div class="flex-1 rounded-2xl p-5 lg:p-6 ring-1 ring-white/10 bg-white/5 flex flex-col gap-4">
            <h2 id="fc-quick-actions" class="sr-only">Quick actions</h2>

            <a {% if stripe_payment_link %}href="{{ stripe_payment_link }}"{% else %}href="/donate"{% endif %}
               class="fc-btn fc-btn-primary w-full justify-center text-[1rem] sm:text-[1.125rem] font-black shadow-sm ring-1 ring-white/10"
               id="fc-primary-cta" data-cta="hero:primary" aria-describedby="fc-hero-sub" {% if not stripe_payment_link %}data-open-donate-modal{% endif %}>
               üíõ Fuel the Season
            </a>

            <div class="grid grid-cols-4 gap-2">
              {% for amt in (quick_donate_amounts if quick_donate_amounts is defined else [25,50,100,250]) %}
                <button type="button"
                        class="fc-btn fc-btn-primary w-full justify-center font-black tabular leading-none shadow-sm ring-1 ring-white/10 hover:scale-[1.02]"
                        style="--brand: var(--fc-hero-accent, {{ theme_hex }}); font-size:.95rem; padding:.6rem .7rem;"
                        data-amount="{{ amt }}" data-cta="hero:quick-amount" aria-label="Quick donate {{ amt }} dollars">
                  <span class="sr-only">Donate</span>${{ amt }}<span class="sr-only"> now</span>
                </button>
              {% endfor %}
            </div>

            <div class="rounded-xl ring-1 ring-white/10 bg-white/5 p-3">
              <div class="text-[11px] sm:text-xs text-zinc-200/90 font-medium flex items-center justify-between gap-2">
                <span>Payments Secured ‚Ä¢ PCI-DSS</span><span>Apple/Google Pay ‚Ä¢ Card</span>
              </div>
              <div class="mt-2 relative overflow-hidden rounded-lg ring-1 ring-white/10 bg-white/5">
                <div class="whitespace-nowrap will-change-transform py-1.5 fc-marquee" aria-label="Sponsor ticker" id="fc-ticker">
                  {% set _s = (sponsors if sponsors is defined and sponsors else ['TechNova','River BBQ','Sunrise Dental','Austin Realty']) %}
                  {% for s in _s %}<span class="mx-4 text-xs text-zinc-300">üèÖ {{ s }}</span>{% endfor %}
                  {% for s in _s %}<span class="mx-4 text-xs text-zinc-300">üèÖ {{ s }}</span>{% endfor %}
                </div>
              </div>
            </div>
          </div>
        </aside>
      </div>

      <!-- Credibility avatars -->
      {% set AV = (sponsors if sponsors is defined and sponsors else ['TechNova','River BBQ','Sunrise Dental','Austin Realty','Jane D.','Acme Corp'])[:6] %}
      <div class="mt-6 flex items-center justify-center gap-2.5 sm:gap-3">
        <div class="flex -space-x-3">
          {% for s in AV %}
            <div class="size-8 sm:size-9 rounded-full ring-2 ring-black/50 bg-white/15 grid place-items-center font-extrabold text-yellow-300/95" aria-hidden="true">
              {{ s[0] }}
            </div>
          {% endfor %}
        </div>
        <div class="text-sm text-zinc-200/90">Trusted by our community</div>
      </div>
    </div>
  </div>

  <style nonce="{{ NONCE }}">
    .fc-hero-glass{
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 22px 70px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.06), inset 0 0 0 1px rgba(255,255,255,.04);
      -webkit-backdrop-filter: blur(16px) saturate(1.05);
      backdrop-filter: blur(16px) saturate(1.05);
    }
    .title-sub{ letter-spacing:.002em; text-wrap:balance; }
    .tabular{ font-variant-numeric: tabular-nums; }
    .fc-pill{
      display:inline-flex; align-items:center; gap:.5rem; padding:.35rem .75rem; border-radius:999px;
      background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06)); border:1px solid rgba(255,255,255,.18);
      text-shadow:0 1px 0 rgba(0,0,0,.35); -webkit-backdrop-filter: blur(6px); backdrop-filter: blur(6px);
    }
    .fc-pill--dark{ background: color-mix(in srgb, #000 38%, transparent); border-color: rgba(255,255,255,.12) }
    .legacy-chip{
      position:relative; padding:.55rem 1.2rem; border-radius:1.25rem;
      background:
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02)),
        linear-gradient(90deg, color-mix(in srgb, var(--fc-hero-accent, #facc15) 86%, #fff) 0%, #fff7cc 100%);
      box-shadow: 0 8px 24px rgba(0,0,0,.30), inset 0 0 0 1px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.22);
      backdrop-filter: blur(3px) saturate(1.02);
    }
    .legacy-chip .txt{ font-weight:950; letter-spacing:-.015em; line-height:1; font-size:clamp(20px,2.6vw,32px); color:#0b0c0f; }
    .fc-marquee{ animation: fc-marq 34s linear infinite; display:inline-block }
    @keyframes fc-marq{ from{ transform: translateX(0) } to{ transform: translateX(-50%) } }
    @media (prefers-reduced-motion: reduce){
      .fc-marquee{ animation:none!important }
      .fc-hero-glass{ -webkit-backdrop-filter:none; backdrop-filter:none }
    }
    @media (prefers-contrast: more){
      .fc-hero-glass{ -webkit-backdrop-filter:none; backdrop-filter:none; background: rgba(0,0,0,.68) !important }
      .fc-pill{ background: rgba(255,255,255,.18) }
    }
  </style>

  <script nonce="{{ NONCE }}">
  (() => {
    if (window.__fcHeroInit) return; window.__fcHeroInit = true;
    const $ = (s, r=document) => r.querySelector(s);
    const hero = $('#fc-hero');
    const img  = $('#fc-hero-img');

    /* Image fallback */
    img?.addEventListener('error', () => {
      const f = img?.dataset?.fallback;
      if (f && img.src !== f) img.src = f;
    });

    /* Countdown */
    (function(){
      const ddl = new Date(hero?.dataset?.deadline || ''); if (isNaN(ddl)) return;
      const pad = v => String(v).padStart(2,'0');
      const set = (id,val) => { const el = $('#'+id); if (el) el.textContent = val; };
      const tick = () => {
        const t = Math.max(0, ddl.getTime() - Date.now());
        const dd = Math.floor(t/86400000), hh = Math.floor((t%86400000)/3600000),
              mm = Math.floor((t%3600000)/60000), ss = Math.floor((t%60000)/1000);
        set('fc-ct-days', String(dd)); set('fc-ct-hrs', pad(hh));
        set('fc-ct-min', pad(mm));    set('fc-ct-sec', pad(ss));
      };
      tick(); setInterval(tick, 1000);
    })();

    /* Rotating punchlines */
    (function(){
      const el = $('#fc-hero-sub'); const lines = {{ PUNCHLINES|tojson }};
      if (!el || !lines || lines.length < 2) return; el.style.transition = 'opacity .28s ease';
      let i = 0, t = null;
      const step = () => { el.style.opacity = '0'; setTimeout(() => { i = (i+1) % lines.length; el.textContent = lines[i]; el.style.opacity = '1'; }, 200); };
      const start = () => { if (t) return; t = setInterval(step, 6500); };
      const stop  = () => { if (!t) return; clearInterval(t); t = null; };
      document.addEventListener('visibilitychange', () => document.hidden ? stop() : start());
      start();
    })();

    /* Quick donate (Payment Link aware) */
    async function getCfg(){ try{ const r = await fetch('/api/payments/config', { headers: { accept: 'application/json' } }); if (!r.ok) throw 0; return await r.json(); } catch { return {}; } }
    async function pay(amount){
      const c = await getCfg(); const link = c.payment_link_url || c.link || '{{ stripe_payment_link|e }}';
      const cents = Math.max(0, Math.round((Number(amount)||0) * 100));
      if (link){ const sep = link.includes('?') ? '&' : '?'; location.assign(`${link}${sep}client_reference_id=${encodeURIComponent(String(cents||0))}&utm_source=site&utm_medium=hero&utm_campaign=fundraiser`); return; }
      location.assign('/donate?amount=' + encodeURIComponent(String(amount||0)));
    }
    document.querySelectorAll('[data-amount]').forEach(b => b.addEventListener('click', () => pay(+b.getAttribute('data-amount')||0), {passive:true}));

    /* Meter live updates */
    (function(){
      const m = { wrap:$('#fundraiser-meter'), bar:$('#fc-bar'), pct:$('#fc-pct'), raised:$('#fc-raised'), goal:$('#fc-goal'), next:$('#fc-next') };
      const nf = new Intl.NumberFormat(undefined,{ maximumFractionDigits: 0 }); const fmt$ = n => '$' + nf.format(Math.round(+n || 0));
      function nextText(r,g){ if (!g) return 'Great momentum ‚Äî keep it rolling!'; const T=[.25,.5,.75,1], p=g?(r/g):0; for (const t of T){ if (p<t) return `Only ${fmt$((g*t)-r)} to reach ${Math.round(t*100)}%`; } return 'Great momentum ‚Äî keep it rolling!'; }
      function setMeter(r,g){ const R=+r||0, G=Math.max(0,+g||0), P=Math.max(0,Math.min(100,G?(R/G*100):0));
        m.bar && (m.bar.style.width = P.toFixed(1) + '%');
        m.pct && (m.pct.textContent = P.toFixed(1));
        m.raised && (m.raised.textContent = fmt$(R));
        m.goal && (m.goal.textContent = fmt$(G));
        m.next && (m.next.textContent = nextText(R,G));
        m.wrap?.setAttribute('aria-valuenow', P.toFixed(1));
        const sr = document.getElementById('sr-live'); if (sr) sr.textContent = `Progress: ${P.toFixed(1)}% funded ‚Äî ${fmt$(R)} raised of ${fmt$(G)}.`;
      }
      setMeter({{ funds_raised|round(0) }}, {{ fundraising_goal|round(0) }});
      addEventListener('fc:meter:update', ev => { const d=ev.detail||{}; setMeter(d.raised,d.goal); }, {passive:true});
    })();
  })();
  </script>
</div>

