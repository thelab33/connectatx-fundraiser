{# =============================================================================
   app/templates/partials/hero_and_fundraiser.html
   Prestige Hero (Glass 2.0 ‚Ä¢ Animated ‚Ä¢ CSP-safe ‚Ä¢ ui_bootstrap-integrated)

   Depends on: partials/ui_bootstrap.html (utilities, CSP nonce helper, event bus)
   Listens for: CustomEvent('fc:funds:update', {raised, goal, sponsorName})
   ============================================================================= #}

{# Bring in global utilities (idempotent include) #}
{% include "partials/ui_bootstrap.html" ignore missing with context %}

{# ---------- Safe fallbacks & tokens ---------- #}
{% set NONCE = NONCE if NONCE is defined else (csp_nonce() if csp_nonce is defined else '') %}
{% set team_name = (team.team_name if team and team.team_name is defined else 'Connect ATX Elite') %}
{% set theme_hex = (team.theme_color if team and team.theme_color is defined else '#f59e0b') %}
{% set hero_bg   = (
  team.hero_bg if team and team.hero_bg is defined and team.hero_bg
  else (url_for('static', filename='images/hero.webp') if url_for is defined else '/static/images/hero.webp')
) %}
{% set funds_raised        = (funds_raised if funds_raised is defined else 0) | float %}
{% set fundraising_goal    = (fundraising_goal if fundraising_goal is defined and fundraising_goal else 10000) | float %}
{% set fundraiser_deadline = fundraiser_deadline if fundraiser_deadline is defined and fundraiser_deadline else '2025-12-31T23:59:59' %}
{% set quick_donate_amounts = quick_donate_amounts if quick_donate_amounts is defined and quick_donate_amounts else [25,50,100,250] %}
{% set stripe_publishable_key = stripe_publishable_key|default('') %}
{% set sponsors = sponsors if sponsors is defined and sponsors else ['Austin Realty','TechNova','River BBQ','Sunrise Dental'] %}

{# ---------- Endpoints (robust) ---------- #}
{% set sponsor_list_href    = (url_for('main_bp.sponsor_list') if url_for is defined else '/sponsors') %}
{% set become_sponsor_href  = (url_for('main_bp.become_sponsor') if url_for is defined else '/become-sponsor') %}

{# ---------- Flex upgrade knobs (data-driven) ---------- #}
{% set vip_thresholds = vip_thresholds if vip_thresholds is defined and vip_thresholds else [5000, 10000, 20000] %}
{% set goal_heat_enabled = goal_heat_enabled if goal_heat_enabled is defined else true %}
{% set ab_copy = ab_copy if ab_copy is defined and ab_copy else [
  "Your $25 covers 1 practice",
  "$25 = 1 practice pass"
] %}

{# ---------- Derived values ---------- #}
{% set pct_raw = (100.0 * (funds_raised / (fundraising_goal if fundraising_goal else 1))) if fundraising_goal else 0 %}
{% set pct     = (0 if pct_raw < 0 else (100 if pct_raw > 100 else pct_raw)) | round(1) %}

<section id="fc-hero" class="relative overflow-clip" aria-labelledby="fc-hero-title">
  {# Background image + gradient mask + ambient glow #}
  <div class="absolute inset-0">
    <img src="{{ hero_bg }}" alt="" class="h-full w-full object-cover object-center opacity-75" loading="eager" decoding="async" />
    <div class="absolute inset-0 bg-gradient-to-b from-black/60 via-black/50 to-zinc-950" aria-hidden="true"></div>
    <div class="pointer-events-none absolute inset-0" aria-hidden="true"
         style="box-shadow: 0 0 120px 40px color-mix(in oklab, {{ theme_hex }} 40%, transparent) inset;"></div>
    {# Goal Heat overlay (opacity driven by CSS var --heat) #}
    <div class="pointer-events-none absolute inset-0 heat-layer" aria-hidden="true"></div>
  </div>

  <div class="relative fc-section">
    <!-- Glass 2.0 shell -->
    <div class="rounded-3xl ring-1 ring-white/10 backdrop-blur-xl bg-white/5 p-5 sm:p-8 lg:p-10 shadow-[0_10px_40px_-10px_rgba(0,0,0,0.5)]">
      <!-- Top: Title + Countdown -->
      <div class="fc-head flex-col md:flex-row gap-6">
        <div>
          <h1 id="fc-hero-title" class="text-3xl sm:text-4xl lg:text-5xl font-extrabold leading-tight tracking-tight">
            <span class="inline-block bg-clip-text text-transparent"
                  style="background-image: linear-gradient(90deg, {{ theme_hex }}, #fff);">
              {{ team_name }}
            </span>
            <span class="ml-1 opacity-90">Fundraiser</span>
          </h1>
          <p class="mt-2 text-sm sm:text-base text-zinc-200/90" id="fc-ab-copy">
            <!-- Fallback text if JS is off -->
            Every dollar fuels travel, uniforms, and training. You‚Äôre part of the story.
          </p>
        </div>

        <!-- Countdown -->
        <div class="grid grid-cols-4 gap-2 text-center select-none" role="timer" aria-live="polite">
          {% for key in ['Days','Hrs','Min','Sec'] %}
          <div class="rounded-xl bg-white/5 ring-1 ring-white/10 px-3 py-2">
            <div class="text-2xl sm:text-3xl font-bold tabular-nums" id="fc-ct-{{ key|lower }}">00</div>
            <div class="text-[11px] uppercase tracking-wider text-zinc-300">{{ key }}</div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Progress + CTAs -->
      <div class="mt-6 sm:mt-8 grid lg:grid-cols-5 gap-6">
        <!-- Progress Card -->
        <section class="lg:col-span-3" aria-labelledby="fc-progress-title">
          <div class="rounded-2xl p-5 ring-1 ring-white/10 bg-gradient-to-br from-white/5 to-white/0">
            <h2 id="fc-progress-title" class="sr-only">Fundraising progress</h2>

            <div class="flex items-end justify-between gap-4">
              <div>
                <div class="text-zinc-300 text-sm">Raised</div>
                <div class="text-3xl sm:text-4xl font-extrabold tabular-nums" id="fc-raised" aria-live="polite">
                  ${{ ('%0.0f' % funds_raised) }}
                </div>
              </div>
              <div class="text-right">
                <div class="text-zinc-300 text-sm">Goal</div>
                <div class="text-xl sm:text-2xl font-semibold tabular-nums" id="fc-goal">
                  ${{ ('%0.0f' % fundraising_goal) }}
                </div>
              </div>
            </div>

            <!-- Meter -->
            <div class="mt-4">
              <div class="relative h-4 w-full rounded-full bg-zinc-800/80 ring-1 ring-white/10 overflow-hidden"
                   aria-label="Fundraising progress" role="img">
                <!-- Ambient shine -->
                <div class="absolute inset-0 animate-[shine_3s_linear_infinite] opacity-20 mix-blend-overlay"
                     style="background: linear-gradient(90deg, transparent, white, transparent);"></div>
                <!-- Fill -->
                <div id="fc-bar"
                     class="h-full rounded-full"
                     style="width: {{ pct }}%; background: linear-gradient(90deg, {{ theme_hex }}, #22c55e);"></div>
              </div>

              <!-- Milestones -->
              <div class="relative mt-3 flex justify-between text-[11px] text-zinc-300">
                {% for m in [25,50,75,100] %}
                  <div class="group relative flex-1">
                    <div class="h-3 w-px mx-auto bg-white/20" aria-hidden="true"></div>
                    <div class="absolute -top-7 left-1/2 -translate-x-1/2">
                      <span class="inline-flex items-center gap-1 rounded-full px-2 py-1 ring-1 ring-white/10 bg-white/5 group-[.active]:bg-white/10 group-[.active]:text-white"
                            id="fc-ms-{{ m }}" aria-label="{{ m }}% milestone">
                        <span class="hidden sm:inline">Milestone</span> {{ m }}%
                      </span>
                    </div>
                  </div>
                {% endfor %}
              </div>

              <!-- Percent + deadline -->
              <div class="mt-3 flex items-center justify-between">
                <div class="text-sm text-zinc-300">
                  <span class="sr-only">Progress:</span>
                  <span id="fc-pct" class="font-semibold tabular-nums">{{ ('%.1f' % pct) }}</span>% funded
                </div>
                <div class="text-sm text-zinc-300">
                  Deadline: <time id="fc-deadline" datetime="{{ fundraiser_deadline }}">{{ fundraiser_deadline }}</time>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- CTAs + Security Seal + Donor Ticker -->
        <aside class="lg:col-span-2" aria-labelledby="fc-quick-actions">
          <div class="rounded-2xl p-5 ring-1 ring-white/10 bg-white/5 flex flex-col gap-4">
            <h2 id="fc-quick-actions" class="sr-only">Quick actions</h2>

            <div class="grid grid-cols-2 gap-2">
              {% for amt in quick_donate_amounts %}
                <button type="button"
                        class="fc-cta tier-pulse rounded-xl px-3 py-3 text-base font-semibold ring-1 ring-white/10"
                        style="background: {{ theme_hex }}cc"
                        data-amount="{{ amt }}"
                        aria-label="Quick donate {{ amt }} dollars">
                  ${{ amt }}
                </button>
              {% endfor %}
            </div>

            <div class="flex gap-2">
              <button type="button" id="fc-donate"
                      class="flex-1 rounded-xl px-4 py-3 font-semibold bg-white/10 hover:bg-white/15 ring-1 ring-white/10">
                üí∏ Quick Donate
              </button>
              <a href="{{ become_sponsor_href }}"
                 class="rounded-xl px-4 py-3 font-semibold bg-emerald-500/90 hover:bg-emerald-500">
                ü§ù Become a Sponsor
              </a>
            </div>

            <!-- Security Seal Flip -->
            <div class="relative mt-1 h-12 [perspective:1000px]" aria-hidden="true">
              <div class="absolute inset-0 [transform-style:preserve-3d] transition-transform duration-700 hover:[transform:rotateY(180deg)]">
                <div class="absolute inset-0 grid place-items-center rounded-xl ring-1 ring-white/10 bg-white/5 [backface-visibility:hidden]">
                  <span class="text-xs text-zinc-300">Payments Secured ‚Ä¢ PCI-DSS</span>
                </div>
                <div class="absolute inset-0 grid place-items-center rounded-xl ring-1 ring-white/10 bg-white/5 [transform:rotateY(180deg)] [backface-visibility:hidden]">
                  <span class="text-xs text-zinc-200">
                    {% if stripe_publishable_key %}Secured by Stripe{% else %}PayPal / Card{% endif %}
                  </span>
                </div>
              </div>
            </div>

            <!-- Mini Sponsor/Donor Ticker -->
            <div class="relative mt-2 overflow-hidden rounded-xl ring-1 ring-white/10 bg-white/5">
              <div class="whitespace-nowrap will-change-transform animate-[fcTicker_24s_linear_infinite] py-2" id="fc-ticker" aria-label="Sponsor ticker">
                {% for s in sponsors %}
                  <span class="mx-6 text-xs text-zinc-300">üèÖ {{ s }}</span>
                {% endfor %}
              </div>
            </div>
          </div>
        </aside>
      </div>

      <!-- Micro trust strip -->
      <div class="mt-6 grid sm:grid-cols-3 gap-3 text-center">
        <div class="rounded-xl ring-1 ring-white/10 bg-white/5 px-3 py-2 text-sm text-zinc-300">üéØ Goal tracking in real-time</div>
        <div class="rounded-xl ring-1 ring-white/10 bg-white/5 px-3 py-2 text-sm text-zinc-300">üîí Secure checkout</div>
        <div class="rounded-xl ring-1 ring-white/10 bg-white/5 px-3 py-2 text-sm text-zinc-300">‚ú® VIP shout-outs for top donors</div>
      </div>
    </div>
  </div>

  <style nonce="{{ NONCE }}">
    #fc-hero { --heat: 0; }
    @keyframes shine { 0%{transform:translateX(-100%)} 100%{transform:translateX(100%)} }
    @keyframes fcTicker { 0%{ transform: translateX(0)} 100%{ transform: translateX(-50%)} }
    @media (prefers-reduced-motion: reduce) {
      #fc-hero * { animation: none !important; transition: none !important; }
    }
    .tier-pulse { animation: tierPulse 2.5s ease-in-out infinite; }
    @keyframes tierPulse {
      0%,100%{ transform:scale(1); box-shadow: 0 0 0 0 rgba(255,255,255,.0); }
      50%     { transform:scale(1.02); box-shadow: 0 10px 30px -10px rgba(255,255,255,.15); }
    }
    /* Goal Heat: opacity scales with --heat (0..1) */
    #fc-hero .heat-layer{
      background:
        radial-gradient(120% 80% at 50% 0%,
          {{ theme_hex }} 0%,
          transparent 60%);
      opacity: calc(0.18 + 0.42 * var(--heat));
      transition: opacity .6s ease;
    }
    /* Milestone active state toggled by JS via .active on wrapper group */
    .group.active span { color:#fff }
  </style>

  {# Prefer the utility macro for CSP-safe scripts if available #}
  {% if script_open is defined %}{{ script_open() }}{% else %}<script nonce="{{ NONCE }}">{% endif %}
  (() => {
    if (window.__fcHeroInit) return; window.__fcHeroInit = true;

    const FC = window.FC || {};

    // --- config from Jinja ---
    const VIPS = {{ vip_thresholds|tojson|safe }};
    const HEAT_ON = {{ 'true' if goal_heat_enabled else 'false' }};
    const AB_COPY = {{ ab_copy|tojson|safe }};

    const $  = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const clamp = (n,min,max) => Math.min(Math.max(n,min),max);
    const fmtMoney = v => (new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0})).format(+v||0);

    const els = {
      bar:    $('#fc-bar'),
      raised: $('#fc-raised'),
      goal:   $('#fc-goal'),
      pct:    $('#fc-pct'),
      countdown: {
        days:  $('#fc-ct-days'),
        hrs:   $('#fc-ct-hrs'),
        min:   $('#fc-ct-min'),
        sec:   $('#fc-ct-sec'),
      },
      ticker: $('#fc-ticker'),
      root:   $('#fc-hero'),
      ab:     $('#fc-ab-copy'),
    };

    const state = {
      raised: {{ funds_raised|float }},
      goal:   Math.max(1, {{ fundraising_goal|float }}),
      deadline: new Date('{{ fundraiser_deadline }}'),
    };

    // Prefer shared confetti if provided by ui_bootstrap; else fallback
    const burstConfetti = typeof FC.burstConfetti === 'function'
      ? FC.burstConfetti
      : (function(){
          return function fallbackConfetti(n=24){
            try{
              const c = document.createElement('canvas');
              c.width = innerWidth; c.height = 240;
              Object.assign(c.style,{position:'fixed',left:0,top:0,pointerEvents:'none',zIndex:60});
              document.body.appendChild(c);
              const ctx = c.getContext('2d');
              const parts = Array.from({length:n}).map(()=>({
                x: Math.random()*c.width, y: -20 - Math.random()*60,
                vx:(Math.random()-.5)*3, vy:2+Math.random()*3, r:2+Math.random()*4, a:1
              }));
              const colors = ['#ffffff','{{ theme_hex }}','#22c55e','#60a5fa','#eab308'];
              (function tick(){
                ctx.clearRect(0,0,c.width,c.height);
                parts.forEach(p=>{
                  p.x+=p.vx; p.y+=p.vy; p.a -= 0.012;
                  ctx.globalAlpha = Math.max(0,p.a);
                  ctx.fillStyle = colors[(Math.random()*colors.length)|0];
                  ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
                });
                if(parts.some(p=>p.a>0)) requestAnimationFrame(tick); else c.remove();
              })();
            } catch {}
          }
        })();

    // Animate number helper (easeOutCubic)
    function tweenNumber(el, to, dur=700){
      if(!el) return;
      const from = parseFloat((el.textContent||'0').replace(/[^0-9.-]/g,'')) || 0;
      const start = performance.now();
      const step = (t)=>{
        const k = clamp((t - start)/dur, 0, 1);
        const eased = 1 - Math.pow(1-k,3);
        el.textContent = fmtMoney(from + (to - from) * eased);
        if(k < 1) requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    }

    function setProgress(raised=state.raised, goal=state.goal){
      state.raised = +raised || 0; state.goal = Math.max(+goal||1, 1);
      const pct = clamp((state.raised/state.goal)*100, 0, 100);

      if(els.bar)  els.bar.style.width = pct.toFixed(1) + '%';
      if(els.pct)  els.pct.textContent = pct.toFixed(1);
      if(els.goal) els.goal.textContent = fmtMoney(state.goal);
      if(els.raised) tweenNumber(els.raised, state.raised);

      [25,50,75,100].forEach(m => {
        const ms = document.getElementById(`fc-ms-${m}`);
        const wrap = ms?.closest('.group');
        if(wrap) wrap.classList.toggle('active', pct >= m - 0.01);
      });

      // One-shot session confetti on % milestones
      try {
        const key = 'fc_ms_hit';
        const prev = parseFloat(sessionStorage.getItem(key) || '0');
        const hit = [25,50,75,100].find(m => prev < m && pct >= m);
        if(hit){ sessionStorage.setItem(key, String(hit)); burstConfetti(12 + hit/2); }
      } catch {}

      // Goal Heat
      if(HEAT_ON && els.root){
        els.root.style.setProperty('--heat', (pct/100).toFixed(3));
      }

      // VIP threshold confetti (absolute $ thresholds)
      try {
        const key = 'fc_vip_hit';
        const prev = parseFloat(sessionStorage.getItem(key) || '0');
        const crossed = [...VIPS].sort((a,b)=>a-b).find(th => prev < th && state.raised >= th);
        if(crossed){ sessionStorage.setItem(key, String(crossed)); burstConfetti(24 + Math.min(48, crossed/250)); }
      } catch {}
    }

    function updateCountdown(){
      const now = new Date();
      const diff = Math.max(0, state.deadline - now);
      const s = Math.floor(diff/1000);
      const d = Math.floor(s/86400);
      const h = Math.floor((s%86400)/3600);
      const m = Math.floor((s%3600)/60);
      const sec = s%60;
      const el = els.countdown;
      if(el.days) el.days.textContent = String(d).padStart(2,'0');
      if(el.hrs)  el.hrs.textContent  = String(h).padStart(2,'0');
      if(el.min)  el.min.textContent  = String(m).padStart(2,'0');
      if(el.sec)  el.sec.textContent  = String(sec).padStart(2,'0');
    }

    // Quick donate UX (delegates Checkout creation to backend)
    function openCheckout(amount){
      const key = '{{ stripe_publishable_key }}';
      // Whether Stripe is present or not, we use the same backend entry point in this build.
      window.location.href = `/donate?amount=${encodeURIComponent(amount||0)}`;
    }

    // Wire up buttons
    $$('#fc-hero .fc-cta').forEach(btn=>{
      btn.addEventListener('click', ()=> openCheckout(btn.dataset.amount));
    });
    $('#fc-donate')?.addEventListener('click', ()=> openCheckout(0));

    // A/B copy (sticky per-device)
    (function abCopy(){
      try{
        const key = 'fc_ab_copy_hero_v1';
        let variant = localStorage.getItem(key);
        if(!variant){ variant = Math.random() < 0.5 ? 'A' : 'B'; localStorage.setItem(key, variant); }
        const text = (variant === 'A' ? AB_COPY[0] : (AB_COPY[1] || AB_COPY[0]));
        els.ab && (els.ab.textContent = text);
      } catch {}
    })();

    // Init
    setProgress(state.raised, state.goal);
    updateCountdown();
    setInterval(updateCountdown, 1000);

    // Listen for global updates
    addEventListener('fc:funds:update', (e)=>{
      const d = e.detail || {};
      setProgress(
        typeof d.raised==='number' ? d.raised : state.raised,
        typeof d.goal  ==='number' ? d.goal   : state.goal
      );
      if(d.sponsorName && els.ticker){
        const safe = String(d.sponsorName).replace(/[<>&]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]));
        els.ticker.insertAdjacentHTML('beforeend', `<span class="mx-6 text-xs text-zinc-300">üèÖ ${safe}</span>`);
      }
    }, { passive:true });
  })();
  </script>
</section>

