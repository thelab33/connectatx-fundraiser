{% set teamName = (team.team_name if team and team.team_name is defined else 'Connect ATX Elite') %}
{% set ver = asset_version|default(0) %}

{% set _logo = (team.logo if team and team.logo else 'images/logo.webp') %}
{% set logoSrc = (_logo if '://' in _logo
  else (url_for('static', filename=_logo.lstrip('/'), v=ver) if url_for is defined
  else '/static/' ~ _logo.lstrip('/') ~ '?v=' ~ ver)) %}

{% set _hero = (team.hero_bg if team and team.hero_bg is defined and team.hero_bg else 'images/connect-atx-team.jpg') %}
{% set heroBg = (_hero if '://' in _hero
  else (url_for('static', filename=_hero.lstrip('/'), v=ver) if url_for is defined
  else '/static/' ~ _hero.lstrip('/') ~ '?v=' ~ ver)) %}

{% set fundsRaised = (funds_raised if funds_raised is defined else 0) | float %}
{% set fundraisingGoal = (fundraising_goal if fundraising_goal is defined and fundraising_goal else 10000) | float %}
{% set rawPct = (fundraisingGoal and fundsRaised / fundraisingGoal * 100) | default(0) | round(1) %}
{% set pct = 0 if rawPct < 0 else (100 if rawPct > 100 else rawPct) %}
{% set fundraisingDeadline = fundraising_deadline if fundraising_deadline is defined else None %}
{% set deadlineISO = fundraisingDeadline.isoformat() if fundraisingDeadline else '' %}

{% set statsUrl = stats_url|default('/api/stats') %}
{% set socketNamespace = socket_ns|default('/donations') %}
{% set vipThreshold = (team.vip_amount if team and team.vip_amount else 500) %}
{% set pollIntervalMs = poll_ms|default(15000) %}
{% set quickDonateUrl = quick_donate_url|default('#donate') %}
{% set tiersAnchor = '#tiers' %}

<section id="fc-hero"
  class="relative isolate overflow-hidden"
  data-stats-url="{{ statsUrl }}"
  data-socket-ns="{{ socketNamespace }}"
  data-vip-threshold="{{ vipThreshold }}"
  data-poll-ms="{{ pollIntervalMs }}"
  role="region"
  aria-label="Fundraising Hero Section"
  itemscope itemtype="https://schema.org/DonateAction">

  <style>
    #fc-hero .glass{backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);background:linear-gradient(180deg,rgba(24,24,27,.55),rgba(24,24,27,.75));border:1px solid rgba(250,204,21,.14);box-shadow:0 16px 60px rgba(250,204,21,.15);border-radius:1.5rem}
    #fc-hero .meter-wrap{position:relative;height:12px;border-radius:9999px;overflow:hidden;margin-top:.5rem}
    #fc-hero .meter-bg{position:absolute;inset:0;background:linear-gradient(90deg,rgba(63,63,70,.6),rgba(39,39,42,.6))}
    #fc-hero .meter-bar{position:absolute;inset:0;width:0%;border-radius:9999px;background:linear-gradient(90deg,#fde68a,#facc15,#f59e0b);transition:width .9s cubic-bezier(.22,1,.36,1);will-change:width;transform:translateZ(0)}
    #fc-hero .badge{border:1px solid rgba(250,204,21,.25);background:rgba(250,204,21,.1);font-weight:600;display:inline-flex;align-items:center;gap:.25rem}
    #fc-hero .cta{transition:transform .15s ease,box-shadow .15s ease;font-weight:600;border-radius:9999px}
    #fc-hero .cta:hover,#fc-hero .cta:focus-visible{transform:translateY(-1px);box-shadow:0 10px 30px rgba(250,204,21,.25);outline:none}
    #fc-raised,#fc-goal,#fc-percent{font-variant-numeric:tabular-nums}
    @media (min-width:640px){ #fc-hero .meter-wrap{height:8px} }
    #fc-hero .bg-img{object-position:center var(--fc-hero-y,35%)}
    @media (max-width:640px){ #fc-hero .bg-img{--fc-hero-y:25%} }
    #fc-hero.save-data .meter-bar{transition:none!important}
    #site-header.is-shrunk{backdrop-filter:blur(18px);border-bottom-color:rgba(250,204,21,.18);transition:border-color .2s ease}
    #site-header.is-shrunk .shrinkable{transform:scale(.96);opacity:.95;transition:transform .2s ease,opacity .2s ease}
  </style>

  <div class="absolute inset-0 -z-10" aria-hidden="true">
    <img loading="lazy" decoding="async" src="{{ heroBg }}" alt="" class="bg-img h-full w-full object-cover opacity-35" loading="eager" fetchpriority="high" decoding="async"/>
    <div class="absolute inset-0 bg-gradient-to-b from-black/40 via-black/50 to-zinc-950"></div>
  </div>

  <div class="mx-auto w-full max-w-6xl px-4 py-10 md:py-14">
    <div class="glass relative rounded-3xl p-6 md:p-8">
      <div class="flex items-center gap-4 shrinkable">
        <img loading="lazy" decoding="async" src="{{ logoSrc }}" alt="{{ teamName }} logo" class="h-12 w-12 rounded-xl ring-1 ring-white/10" loading="eager" decoding="async"/>
        <div class="flex flex-col">
          <span class="text-sm text-zinc-300/90">Official Team Hub</span>
          <h1 class="text-2xl sm:text-3xl font-black tracking-tight">{{ teamName }}</h1>
        </div>
        <div class="ml-auto hidden sm:flex items-center gap-2" aria-label="Badges">
          <span class="badge px-3 py-1 text-xs text-amber-200 rounded-full"><span aria-hidden="true">‚≠ê</span> VIP Sponsors Welcome</span>
          <span class="badge px-3 py-1 text-xs text-amber-200 rounded-full"><span aria-hidden="true">üèÜ</span> Community Powered</span>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2">
          <p class="text-balance text-2xl sm:text-3xl font-bold leading-tight">Fuel the season. Fund the future.</p>
          <p class="mt-2 text-zinc-300/90 max-w-prose">Your donation powers travel, tournaments, and training for our student-athletes. Every dollar goes straight to the court.</p>

          <section aria-label="Fundraising Progress" class="mt-6">
            <div class="flex items-end justify-between gap-3">
              <div class="text-sm text-zinc-300/90">
                <span id="fc-raised" class="font-semibold text-white">${{ '{:,.0f}'.format(fundsRaised) }}</span>
                <span class="text-zinc-400/90">raised</span>
                <span class="mx-2 text-zinc-600">‚Ä¢</span>
                <span class="text-zinc-400/90">Goal</span>
                <span id="fc-goal" class="font-semibold text-white">${{ '{:,.0f}'.format(fundraisingGoal) }}</span>
              </div>
              <div class="text-sm text-zinc-300/90"><span id="fc-percent" class="font-semibold text-amber-300">{{ (pct | round(0)) | int }}</span>% funded</div>
            </div>
            <div class="meter-wrap" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ pct|int }}" aria-label="Fundraising progress">
              <div class="meter-bg"></div>
              <div id="fc-meter-bar" class="meter-bar" style="width: {{ pct }}%"></div>
            </div>
            <span id="fc-sr" class="sr-only">Raised ${{ '{:,.0f}'.format(fundsRaised) }} of ${{ '{:,.0f}'.format(fundraisingGoal) }} ({{ pct | round(0) }}%)</span>
          </section>

          <div class="mt-4 flex flex-wrap items-center gap-3 text-sm text-zinc-300/90">
            {% if fundraisingDeadline %}
            <div class="inline-flex items-center gap-2 rounded-xl border border-white/10 bg-white/5 px-3 py-1.5" role="timer" aria-live="polite" aria-atomic="true">
              <span aria-hidden="true">‚è≥</span><span>Ends in:</span><span id="fc-countdown" class="font-semibold text-white">‚Äî</span>
            </div>
            {% endif %}
            <div class="inline-flex items-center gap-2 rounded-xl border border-white/10 bg-white/5 px-3 py-1.5"><span aria-hidden="true">üìç</span><span>East Austin</span></div>
            <div class="inline-flex items-center gap-2 rounded-xl border border-white/10 bg-white/5 px-3 py-1.5"><span aria-hidden="true">üîí</span><span>Secure payments via Stripe</span></div>
          </div>

          <div class="mt-6 flex flex-wrap items-center gap-3">
            <a href="{{ quickDonateUrl }}" data-open-donate-modal="true" role="button" itemprop="target"
               class="cta inline-flex items-center gap-2 rounded-2xl bg-amber-400 px-5 py-3 font-semibold text-zinc-900 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber-500">
              <span aria-hidden="true">üíõ</span> <span data-cta-copy>Quick Donate</span>
            </a>
            <a href="{{ tiersAnchor }}"
               class="cta inline-flex items-center gap-2 rounded-2xl border border-amber-300/40 bg-amber-300/10 px-5 py-3 font-semibold text-amber-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber-400">
              <span aria-hidden="true">üèÖ</span> Become a Sponsor
            </a>
          </div>
        </div>

        <aside class="lg:col-span-1" aria-label="Latest support information">
          <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
            <div class="flex items-center gap-3">
              <div class="h-10 w-10 rounded-xl bg-amber-300/20 ring-1 ring-amber-300/30 grid place-items-center" aria-hidden="true"><span>üéâ</span></div>
              <div class="text-sm">
                <div class="text-zinc-300/90">Latest Support</div>
                <div id="fc-latest" class="font-semibold text-white">Be our next VIP!</div>
              </div>
            </div>
            <hr class="my-4 border-zinc-700/50" />
            <ul class="space-y-2 text-sm text-zinc-300/90" aria-live="polite" aria-atomic="true">
              <li class="flex items-center justify-between"><span>Donors</span><span id="fc-donors" class="font-semibold text-white">‚Äî</span></li>
              <li class="flex items-center justify-between"><span>Avg gift</span><span id="fc-avg" class="font-semibold text-white">‚Äî</span></li>
            </ul>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <script type="application/ld+json" nonce="{{ csp_nonce() if csp_nonce is defined else '' }}">
  {
    "@context": "https://schema.org",
    "@type": "DonateAction",
    "name": "{{ teamName | e }} Fundraiser",
    "target": "{{ quickDonateUrl | e }}"
  }
  </script>

  <script nonce="{{ csp_nonce() if csp_nonce is defined else '' }}">
  (() => {
    if (window.__fcHeroInit) return; window.__fcHeroInit = true;
    window.requestIdleCallback ||= (fn)=> setTimeout(fn, 1);

    const root = document.getElementById('fc-hero'); if (!root) return;
    if (navigator.connection?.saveData) root.classList.add('save-data');

    const $ = (s,c=document)=>c.querySelector(s);
    const fmt = n => '$' + (Math.round(+n || 0)).toLocaleString();

    const cfg = {
      statsUrl: root.dataset.statsUrl || '/api/stats',
      socketNs: root.dataset.socketNs || '/donations',
      vip: parseFloat(root.dataset.vipThreshold) || 500,
      poll: parseInt(root.dataset.pollMs || '15000', 10)
    };

    const meterBar = $('#fc-meter-bar', root);
    const raisedEl = $('#fc-raised', root);
    const goalEl   = $('#fc-goal', root);
    const pctEl    = $('#fc-percent', root);
    const srEl     = $('#fc-sr', root);
    const latestEl = $('#fc-latest', root);
    const donorsEl = $('#fc-donors', root);
    const avgEl    = $('#fc-avg', root);
    const countdownEl = $('#fc-countdown', root);
    const ctaCopy  = $('[data-cta-copy]', root);

    let raised = parseFloat((raisedEl.textContent || '').replace(/[^0-9.]/g,'')) || 0;
    let goal   = parseFloat((goalEl.textContent   || '').replace(/[^0-9.]/g,'')) || 10000;

    function setMeter(p){
      if (meterBar) meterBar.style.width = Math.min(100, Math.max(0, p || 0)) + '%';
      const pbar = root.querySelector('.meter-wrap');
      if (pbar) {
        pbar.setAttribute('aria-valuenow', (p||0).toFixed(0));
      }
    }

    function updateProgress(r, g){
      const R = +r || 0, G = Math.max(0, +g || 0);
      const P = G ? (R / G * 100) : 0;
      raisedEl.textContent = fmt(R);
      goalEl.textContent   = fmt(G);
      pctEl.textContent    = Math.round(P);
      setMeter(P);
      if (srEl) srEl.textContent = `Raised ${fmt(R)} of ${fmt(G)} (${Math.round(P)}%)`;
      raised = R; goal = G;

      if (ctaCopy) ctaCopy.textContent = P >= 80 ? 'Finish the Goal' : (P <= 30 ? 'Kickstart the Season' : 'Quick Donate');
      window.dispatchEvent(new CustomEvent('fc:meter:update', { detail: { raised: R, goal: G, percent: P } }));
      if (P >= 100) {
        try {
          window.dispatchEvent(new CustomEvent('fc:goal', { detail: { source: 'hero' }}));
          if (typeof window.launchConfetti === 'function') window.launchConfetti({ particleCount: 140, spread: 75 });
        } catch {}
      }
    }

    function updateSide(d){
      if (!d) return;
      if (latestEl && (d.latest_supporter?.name || d.latest_supporter_name)) latestEl.textContent = d.latest_supporter?.name || d.latest_supporter_name;
      if (donorsEl && d.donor_count != null) donorsEl.textContent = d.donor_count;
      if (avgEl    && d.avg_gift    != null) avgEl.textContent    = fmt(d.avg_gift);
    }

    {% if fundraisingDeadline %}
    (()=>{
      const iso = "{{ deadlineISO }}"; if (!iso || !countdownEl) return;
      const end = new Date(iso); if (isNaN(end)) { countdownEl.textContent = '‚Äî'; return; }
      const tick = () => {
        const ms = end - new Date();
        if (ms <= 0) { countdownEl.textContent = 'Ended'; clearInterval(id); return; }
        const d = Math.floor(ms / 86400000),
              h = Math.floor(ms % 86400000 / 3600000),
              m = Math.floor(ms % 3600000 / 60000);
        countdownEl.textContent = `${d}d ${h}h ${m}m`;
      };
      tick(); const id = setInterval(tick, 60000);
    })();
    {% endif %}

    root.querySelectorAll('[data-open-donate-modal="true"]').forEach(btn=>{
      btn.addEventListener('click', e => {
        e.preventDefault();
        window.dispatchEvent(new CustomEvent('fc:donate:open'));
        if (typeof window.openDonationModal === 'function') { window.openDonationModal(); return; }
        const dlg = document.getElementById('donation-modal');
        try { dlg?.showModal?.(); } catch {}
      });
    });

    (()=>{
      const h = document.getElementById('site-header'); if (!h) return;
      addEventListener('scroll', () => { if (scrollY > 35) h.classList.add('is-shrunk'); else h.classList.remove('is-shrunk'); }, { passive: true });
    })();

    const slow = !!(navigator.connection && navigator.connection.saveData);
    let pollId = null, inflight = null;

    async function fetchStats(){
      if (document.hidden) return;
      try {
        inflight?.abort?.();
        inflight = new AbortController();
        const res = await fetch(cfg.statsUrl, { cache: 'no-store', headers: { Accept: 'application/json' }, signal: inflight.signal });
        if (!res.ok) return;
        const d = await res.json();
        if (d?.funds_raised != null && d?.fundraising_goal != null) updateProgress(d.funds_raised, d.fundraising_goal);
        updateSide(d);
      } catch {}
    }

    function startPolling(){
      const base = slow ? Math.max(30000, cfg.poll) : cfg.poll;
      fetchStats();
      clearInterval(pollId); pollId = setInterval(fetchStats, base);
    }
    function stopPolling(){ clearInterval(pollId); pollId = null; inflight?.abort?.(); }
    document.addEventListener('visibilitychange', () => { if (document.hidden) stopPolling(); else startPolling(); });

    (()=>{
      if (!window.io) return;
      try {
        const s = io(cfg.socketNs, { transports: ['websocket','polling'] });
        s.on('new_donation', d => {
          if (!d) return;
          if ((+d.amount || 0) >= cfg.vip && typeof window.launchConfetti === 'function') window.launchConfetti({ particleCount: 120, spread: 70 });
          if (d.funds_raised != null && d.fundraising_goal != null) updateProgress(d.funds_raised, d.fundraising_goal);
          if (d.donor_count != null) donorsEl.textContent = d.donor_count;
          if (d.avg_gift    != null) avgEl.textContent    = fmt(d.avg_gift);
          if (d.latest_supporter?.name) latestEl.textContent = d.latest_supporter.name;
        });
      } catch {}
    })();

    const start = () => { if (start._done) return; start._done = true; startPolling(); };
    if ('IntersectionObserver' in window) new IntersectionObserver(e=>{ if (e[0]?.isIntersecting) start(); }, { threshold: .2 }).observe(root);
    else start();

    requestIdleCallback(() => {
      const l = document.createElement('link'); l.rel = 'preload'; l.as = 'image'; l.href = '{{ heroBg }}'; document.head.appendChild(l);
    });
  })();
  </script>
</section>

