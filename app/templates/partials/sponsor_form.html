{% set NONCE = NONCE if NONCE is defined else (csp_nonce() if csp_nonce is defined else '') %}
<section data-ui=""${name//_/ -}"" class="block">
{# =============================================================================
   PARTIAL: sponsor_form.html ‚Äî SaaS-Ready Sponsor Form with Quick Amounts & Impact
   - Works with WTForms if `form` is provided; otherwise falls back to plain inputs
   - Accessible, CSP-friendly (nonce), no inline handlers
   - Quick-pick buttons, live impact message, basic client-side validation
============================================================================= #}

{# --- Safe URL + CSRF fallbacks (no current_app requirement) --- #}
{% if safe_url_for is defined %}
  {% set action_url = safe_url_for('main.become_sponsor', default='/become-sponsor') %}
{% else %}
  {% set action_url = '/become-sponsor' %}
{% endif %}
{% set csrf_val   = (csrf_token() if csrf_token is defined else '') %}
{% set quick_amts = quick_amts if quick_amts is defined else [25, 50, 100, 150, 250] %}

<form
  id="sponsor-donation-form"
  method="POST"
  action="{{ action_url }}"
  autocomplete="on"
  aria-labelledby="sponsor-form-heading"
  class="mx-auto w-full max-w-xl rounded-2xl border border-yellow-400/20 bg-zinc-950/90 p-6 text-zinc-100 shadow-2xl"
  novalidate
>
  {% if form is defined and form and form.hidden_tag is defined %}{{ form.hidden_tag() }}{% else %}
    <input type="hidden" name="csrf_token" value="{{ csrf_val }}">
  {% endif %}

  <h2 id="sponsor-form-heading" class="mb-4 text-2xl font-extrabold text-yellow-300">
    üåü Sponsor a Champion
  </h2>

  <!-- Honeypot (anti-spam) -->
  <div class="absolute left-[-9999px] top-auto h-0 w-0 overflow-hidden" aria-hidden="true">
    <label>Website <input type="text" name="website" tabindex="-1" autocomplete="off" /></label>
  </div>

  <!-- Name or Company -->
  <div class="mb-4">
    <label for="donor-name" class="mb-1 block text-sm font-semibold">Name or Company <span class="text-yellow-300">*</span></label>
    {% if form is defined and form and form.name is defined %}
      {{ form.name(id="donor-name-2", class="w-full rounded-lg border border-yellow-400/20 bg-black/50 px-3 py-2 outline-none focus:ring-2 focus:ring-yellow-300", placeholder="Your Name or Company", required=True, aria_required="true") }}
    {% else %}
      <input type="text" name="name" id="donor-name" required aria-required="true"
             placeholder="Your Name or Company"
             class="w-full rounded-lg border border-yellow-400/20 bg-black/50 px-3 py-2 outline-none focus:ring-2 focus:ring-yellow-300" />
    {% endif %}
    <p id="err-name" class="mt-1 text-xs text-red-300 min-h-[1rem]" role="alert" aria-live="assertive"></p>
  </div>

  <!-- Email -->
  <div class="mb-4">
    <label for="donor-email" class="mb-1 block text-sm font-semibold">Email <span class="text-yellow-300">*</span></label>
    {% if form is defined and form and form.email is defined %}
      {{ form.email(id="donor-email-2", type="email", class="w-full rounded-lg border border-yellow-400/20 bg-black/50 px-3 py-2 outline-none focus:ring-2 focus:ring-yellow-300", placeholder="you@example.com", required=True, aria_required="true") }}
    {% else %}
      <input type="email" name="email" id="donor-email" required aria-required="true"
             placeholder="you@example.com"
             class="w-full rounded-lg border border-yellow-400/20 bg-black/50 px-3 py-2 outline-none focus:ring-2 focus:ring-yellow-300" />
    {% endif %}
    <p id="err-email" class="mt-1 text-xs text-red-300 min-h-[1rem]" role="alert" aria-live="assertive"></p>
  </div>

  <!-- Donation Amount + Quick-picks -->
  <div class="mb-4">
    <label for="donation-amount" class="mb-1 block text-sm font-semibold">Donation Amount (USD) <span class="text-yellow-300">*</span></label>
    <div class="flex items-stretch rounded-lg border border-yellow-400/20 bg-black/50 focus-within:ring-2 focus-within:ring-yellow-300">
      <span class="inline-flex select-none items-center px-3 text-yellow-200/80" aria-hidden="true">$</span>
      {% if form is defined and form and form.amount is defined %}
        {{ form.amount(id="donation-amount-2", inputmode="decimal", class="w-full bg-transparent px-3 py-2 outline-none", placeholder="Amount", required=True, aria_required="true") }}
      {% else %}
        <input id="donation-amount" name="amount" type="number" inputmode="decimal" min="1" step="1"
               placeholder="Amount"
               required aria-required="true"
               class="w-full bg-transparent px-3 py-2 outline-none" />
      {% endif %}
    </div>

    <div class="mt-2 flex flex-wrap gap-2">
      {% for a in quick_amts %}
      <button type="button"
              class="rounded-full border border-yellow-400/30 bg-zinc-900/70 px-3 py-1.5 text-sm font-bold text-yellow-100 hover:bg-zinc-900 focus:outline-none focus:ring-2 focus:ring-yellow-300"
              data-amt="{{ a }}" aria-label="Donate ${{ a }}">${{ a }}</button>
      {% endfor %}
      <button type="button"
              class="rounded-full border border-yellow-400/30 bg-yellow-400/20 px-3 py-1.5 text-sm font-bold text-yellow-200 hover:bg-yellow-400/30 focus:outline-none focus:ring-2 focus:ring-yellow-300"
              data-amt="custom" aria-label="Custom amount">Custom‚Ä¶</button>
    </div>

    <p class="mt-2 text-xs text-yellow-100/90">
      <span class="font-semibold">Tip:</span> $50 covers a team jersey. $150 sponsors a week of practice!
    </p>
    <p id="err-amount" class="mt-1 text-xs text-red-300 min-h-[1rem]" role="alert" aria-live="assertive"></p>
  </div>

  <!-- Payment Method -->
  <fieldset class="mb-5">
    <legend class="mb-2 block text-sm font-semibold">Payment Method</legend>
    <div class="flex items-center gap-4 rounded-lg border border-yellow-400/20 bg-black/40 p-3">
      {% set pay_choice = (form.payment_method.data if (form is defined and form and form.payment_method is defined and form.payment_method.data) else 'stripe') %}
      <label class="inline-flex items-center gap-2">
        <input type="radio" id="pay-stripe" name="payment_method" value="stripe" {% if pay_choice=='stripe' %}checked{% endif %}
               class="h-4 w-4 rounded border-yellow-400/40 bg-zinc-900/80" />
        <span class="text-sm">üí≥ Credit/Debit (Stripe)</span>
      </label>
      <label class="inline-flex items-center gap-2">
        <input type="radio" id="pay-paypal" name="payment_method" value="paypal" {% if pay_choice=='paypal' %}checked{% endif %}
               class="h-4 w-4 rounded border-yellow-400/40 bg-zinc-900/80" />
        <span class="text-sm">üÖøÔ∏è PayPal</span>
      </label>
    </div>
  </fieldset>

  <!-- Submit -->
  <div class="mt-4">
    <button
      id="sponsor-submit"
      type="submit"
      class="inline-flex w-full items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-yellow-400 to-yellow-200 px-5 py-3 font-extrabold text-black shadow-lg transition-transform hover:scale-[1.01] focus-visible:ring-4 focus-visible:ring-yellow-300"
      aria-label="Sponsor Now"
    >
      üåü Sponsor Now
    </button>

    <p class="mt-3 text-xs text-zinc-300">
      100% of your gift supports team programs, scholarships, and court time.
    </p>

    <p id="impact-message" class="mt-2 hidden text-sm font-semibold text-yellow-200" aria-live="polite"></p>
  </div>
</form>

{% if script_open is defined %}{{ script_open() }}{% else %}<script nonce="{{ NONCE }}">{% endif %}
(() => {
  const form   = document.getElementById('sponsor-donation-form');
  if (!form || form.__init) return; form.__init = true;

  const nameEl = document.getElementById('donor-name');
  const emailEl= document.getElementById('donor-email');
  const amtEl  = document.getElementById('donation-amount');
  const msg    = document.getElementById('impact-message');

  const errName  = document.getElementById('err-name');
  const errEmail = document.getElementById('err-email');
  const errAmt   = document.getElementById('err-amount');

  const isEmail = (s) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(s||'').trim());

  // Auto-focus (slight delay to avoid scroll jank)
  window.addEventListener('DOMContentLoaded', () => { setTimeout(() => nameEl?.focus(), 200); });

  // Enter anywhere submits (except inside buttons/links/textarea)
  form.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
      if (e.target.type !== 'submit' && e.target.type !== 'button') {
        e.preventDefault();
        form.querySelector('#sponsor-submit')?.click();
      }
    }
  });

  // Quick-picks
  form.querySelectorAll('[data-amt]').forEach(btn=>{
    btn.addEventListener('click', () => {
      const val = btn.getAttribute('data-amt');
      if (val === 'custom') { amtEl?.focus(); return; }
      if (amtEl) { amtEl.value = String(val); amtEl.focus(); showImpact(+val || 0); }
    });
  });

  // Impact on amount input
  amtEl?.addEventListener('input', () => {
    const v = parseFloat(amtEl.value || '0') || 0;
    if (v > 0) showImpact(v);
    clearError(errAmt, amtEl);
  });

  function showImpact(amount){
    if (!msg) return;
    let text = 'üëè Every dollar counts. Thank you!';
    if (amount >= 150) text = `üéì Your $${fmt0(amount)} = 1 week of gym time for all players!`;
    else if (amount >= 100) text = `üèÄ Your $${fmt0(amount)} = Full scholarship for a player!`;
    else if (amount >= 50)  text = `üëï Your $${fmt0(amount)} = A new team jersey.`;
    msg.textContent = text;
    msg.classList.remove('hidden');
    pulse(msg);
  }

  function pulse(el){
    el.style.animation = 'fc-pulse 0.9s ease-out 1';
    el.addEventListener('animationend', () => el.style.animation = '', { once:true });
  }

  function fmt0(n){ return Math.round(+n || 0).toLocaleString(); }

  // Basic validation on submit (let server do final validation & charge)
  form.addEventListener('submit', (e) => {
    let ok = true;

    if (!nameEl || !nameEl.value.trim()) { setError(errName, nameEl, 'Please enter your name or company.'); ok = false; }
    else clearError(errName, nameEl);

    if (!emailEl || !isEmail(emailEl.value)) { setError(errEmail, emailEl, 'Please enter a valid email address.'); ok = false; }
    else clearError(errEmail, emailEl);

    const amount = parseFloat(amtEl?.value || '0') || 0;
    if (!amtEl || amount <= 0) { setError(errAmt, amtEl, 'Please enter a valid donation amount.'); ok = false; }
    else clearError(errAmt, amtEl);

    if (amount > 0) showImpact(amount);

    if (!ok) { e.preventDefault(); }
  });

  function setError(out, input, text){
    if (out) out.textContent = text || 'This field is required.';
    if (input){ input.setAttribute('aria-invalid','true'); input.classList.add('ring-2','ring-red-400'); }
  }
  function clearError(out, input){
    if (out) out.textContent = '';
    if (input){ input.setAttribute('aria-invalid','false'); input.classList.remove('ring-2','ring-red-400'); }
  }
})();
{% if script_close is defined %}{{ script_close() }}{% else %}</script>{% endif %}

<style nonce="{{ NONCE }}">
  /* tiny animation for the impact message */
  @keyframes fc-pulse { 0%{transform:scale(.98);opacity:.6} 60%{transform:scale(1.02);opacity:1} 100%{transform:scale(1)} }
</style>

</section>
</section>
