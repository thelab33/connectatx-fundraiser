{# =================== Announcement Bar (Pro 2025) =================== #}
{% set NONCE = NONCE if NONCE is defined else (csp_nonce() if csp_nonce is defined else '') %}
{% macro nonce_attr() -%}{% if NONCE %}nonce="{{ NONCE }}"{% endif %}{%- endmacro %}

{# Config + smart defaults #}
{% set ANNOUNCE_ID  = ANNOUNCE_ID  if ANNOUNCE_ID  is defined else 'announce' %}
{% set ANNOUNCE_KEY = ANNOUNCE_KEY if ANNOUNCE_KEY is defined else 'announce.v1' %}
{% set ACCENT       = ACCENT       if ACCENT       is defined else (theme_hex if theme_hex is defined else '#facc15') %}

{# Items: supports type 'sponsor' (with icon) or 'text' #}
{% set ANNOUNCEMENTS = ANNOUNCEMENTS if ANNOUNCEMENTS is defined and ANNOUNCEMENTS else [
  {"type":"sponsor","label":"Nike","href":"#","icon":"/static/images/brands/nike.svg","tone":"brand","sub":"Just do it — support the team!"},
  {"type":"sponsor","label":"Austin Coffee","href":"#","icon":"/static/images/brands/coffee.svg","sub":"Fueling our champions ☕"},
  {"type":"sponsor","label":"Texas BBQ Co.","href":"#","icon":"/static/images/brands/bbq.svg","sub":"Pit-smoked perfection"},
  {"type":"text","label":"Sponsor leaderboard is live — real-time shoutouts!","href":"#leaderboard","tone":"accent"},
  {"type":"text","label":"No shoutouts yet — be the first ✨","href":"#donate"}
] %}

<section id="{{ ANNOUNCE_ID }}"
         class="fcx-announce"
         role="region"
         aria-label="Announcements and sponsors"
         data-key="{{ ANNOUNCE_KEY }}"
         style="--accent: {{ ACCENT|e }};">
  <div class="fcx-ann-inner">
    <div class="fcx-ann-rail" id="{{ ANNOUNCE_ID }}-rail" role="list">
      {% for a in ANNOUNCEMENTS %}
        {% set tone = a.tone if a.tone is defined else ('brand' if a.type=='sponsor' else 'default') %}
        <a class="pill pill--{{ tone }}" role="listitem"
           href="{{ a.href or '#' }}" {% if a.href %}rel="noopener"{% endif %} data-analytics="announce:{{ a.label|replace(' ','_')|lower }}">
          {% if a.icon %}<img class="pill__icon" src="{{ a.icon }}" alt="" width="18" height="18" loading="lazy" decoding="async">{% endif %}
          <span class="pill__label">{{ a.label }}</span>
          {% if a.sub %}<span class="pill__sub" aria-hidden="true">— {{ a.sub }}</span>{% endif %}
        </a>
      {% endfor %}
    </div>

    <div class="fcx-ann-actions" aria-hidden="false">
      <button class="ann-btn prev" type="button" aria-label="Scroll left">‹</button>
      <button class="ann-btn next" type="button" aria-label="Scroll right">›</button>
      <button class="ann-btn close" type="button" aria-label="Hide announcements">×</button>
    </div>
  </div>
</section>

<style {{ nonce_attr() }}>
/* =============== Announcement Bar — Apple/Nike polish =============== */
.fcx-announce{
  --bg: color-mix(in oklab, #0b0c10 90%, transparent);
  --ring: #ffffff1a;
  position: sticky; top: var(--ann-top, 0px); z-index: 69;
  background: var(--bg);
  border-bottom: 1px solid var(--ring);
  color:#fff;
}
.fcx-announce .fcx-ann-inner{
  max-width: 1200px; margin-inline:auto;
  padding: .35rem clamp(10px, 3.5vw, 20px);
  display:grid; grid-template-columns: 1fr auto; gap:.5rem; align-items:center;
}
.fcx-announce .fcx-ann-rail{
  display:flex; gap:.6rem; overflow:auto; scrollbar-width:none; -ms-overflow-style:none;
  scroll-snap-type:x proximity; padding-bottom:.2rem;
}
.fcx-announce .fcx-ann-rail::-webkit-scrollbar{ display:none }
.fcx-announce .pill{
  flex:0 0 auto; display:inline-flex; align-items:center; gap:.48rem; scroll-snap-align:center;
  padding:.42rem .62rem; border-radius:.75rem; text-decoration:none; color:#fff; font-weight:900;
  border:1px solid var(--ring); background:#ffffff12;
  white-space:nowrap; line-height:1;
  transition:transform .14s ease, background .18s ease, color .18s ease, box-shadow .18s ease;
}
.fcx-announce .pill:hover{ transform:translateY(-1px); background:#ffffff18 }
.fcx-announce .pill--accent{ background: var(--accent); border-color: transparent; color:#0b0c0f; box-shadow: 0 8px 20px color-mix(in oklab, var(--accent) 30%, #0000) }
.fcx-announce .pill--brand{ background:#ffffff10 }
.fcx-announce .pill__icon{ width:18px; height:18px; object-fit:contain }
.fcx-announce .pill__label{ font-weight:1000; letter-spacing:.01em }
.fcx-announce .pill__sub{ opacity:.85; font-weight:800 }

.fcx-announce .fcx-ann-actions{ display:flex; align-items:center; gap:.35rem }
.fcx-announce .ann-btn{
  display:inline-grid; place-items:center; width:2rem; height:2rem; border-radius:.55rem;
  background:#ffffff10; border:1px solid var(--ring); color:#fff; font-weight:1000; cursor:pointer;
}
.fcx-announce .ann-btn:hover{ background:#ffffff16 }
.fcx-announce .ann-btn.close{ width:2.05rem; height:2.05rem; font-size:1.1rem }

/* compact header synergy: shrink padding when header is compact */
.fc-header.is-compact + .fcx-announce .fcx-ann-inner{ padding:.28rem clamp(8px,3vw,16px) }

/* motion-safe marquee */
@media (prefers-reduced-motion: no-preference){
  .fcx-announce .fcx-ann-rail[data-marquee="on"]{
    animation: ann-marquee 34s linear infinite;
  }
  .fcx-announce .fcx-ann-rail[data-paused="true"]{ animation-play-state: paused }
  @keyframes ann-marquee{ 0%{ transform: translateX(0) } 100%{ transform: translateX(-50%) } }
}

@media (max-width: 560px){
  .fcx-announce .pill{ padding:.44rem .58rem; font-size:.95rem }
  .fcx-announce .pill__sub{ display:none }
}
</style>

<script {{ nonce_attr() }}>
/* =============== Announcement Bar Controller (CSP-safe) =============== */
(() => {
  'use strict';
  const root = document.getElementById('{{ ANNOUNCE_ID }}'); if (!root) return;
  const rail = root.querySelector('.fcx-ann-rail');
  const prev = root.querySelector('.ann-btn.prev');
  const next = root.querySelector('.ann-btn.next');
  const close= root.querySelector('.ann-btn.close');
  const KEY  = root.getAttribute('data-key') || 'announce.v1';
  const prefersReducedMotion = matchMedia && matchMedia('(prefers-reduced-motion: reduce)').matches;

  // Dismiss persistence
  try { if (localStorage.getItem(KEY) === 'hidden') { root.style.display='none'; return; } } catch {}

  // Scroll helpers
  const scrollBy = (dir) => {
    const delta = Math.min(360, Math.max(160, Math.floor(rail.clientWidth * .6)));
    rail.scrollBy({ left: dir * delta, behavior: 'smooth' });
  };
  prev && prev.addEventListener('click', () => scrollBy(-1));
  next && next.addEventListener('click', () => scrollBy(1));
  close&& close.addEventListener('click', () => { 
    root.style.display='none';
    try { localStorage.setItem(KEY,'hidden'); } catch {}
  });

  // Marquee: duplicate when overflow, pause on hover/focus
  function setupMarquee(){
    if (prefersReducedMotion) return;
    const total = Array.from(rail.children).reduce((w,el)=> w + (el.getBoundingClientRect().width + 10), 0);
    if (total <= rail.clientWidth * 0.98) return; // no need
    // clone contents once so we can loop seamlessly
    rail.append(...Array.from(rail.children).map(n => n.cloneNode(true)));
    rail.setAttribute('data-marquee','on');
    // Pause on hover/focus
    const pause = () => rail.setAttribute('data-paused','true');
    const resume= () => rail.removeAttribute('data-paused');
    root.addEventListener('mouseenter', pause);
    root.addEventListener('mouseleave', resume);
    rail.addEventListener('focusin', pause);
    rail.addEventListener('focusout', resume);
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', setupMarquee, { once:true });
  else setupMarquee();

  // Live shoutout: bump a message when a donation event fires
  window.addEventListener('fc:donation:applied', (e) => {
    const amt = Number(e.detail?.amount||0); if (!amt) return;
    const a = document.createElement('a');
    a.className = 'pill pill--accent'; a.href = '#impact';
    a.textContent = `New shoutout • +$${Math.round(amt).toLocaleString()}`;
    rail.prepend(a);
  }, { passive:true });
})();
</script>

