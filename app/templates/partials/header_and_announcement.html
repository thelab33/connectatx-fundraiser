{# ======================================================
   FundChamps Enterprise Header v8
   SaaS/Agency-Grade Header Component
   CSP-safe, A11y-complete, and motion-polished
====================================================== #}

{% set NONCE = NONCE if NONCE is defined else (csp_nonce() if csp_nonce is defined else '') %}
{% macro nonce_attr() -%}{% if NONCE %}nonce="{{ NONCE }}"{% endif %}{%- endmacro %}

{# ---- Inputs & smart defaults ---- #}
{% set TEAM = team if team is defined else {} %}
{% set TEAM_NAME = TEAM.name or TEAM.team_name or 'Connect ATX Elite' %}
{% set PLATFORM_NAME = PLATFORM_NAME or 'FundChamps' %}
{% set PLATFORM_URL = PLATFORM_URL or '/' %}
{% set ACCENT = ACCENT or (theme_hex if theme_hex is defined else '#facc15') %}
{% set TEAM_LOGO = TEAM.logo or '/static/images/fundchamps-logo.svg' %}
{% set HREF_DONATE = HREF_DONATE or '/donate' %}
{% set HREF_TIERS = HREF_TIERS or '#tiers' %}
{% set HREF_IMPACT = HREF_IMPACT or '#impact' %}
{% set HREF_SPONSOR = HREF_SPONSOR or '/become-sponsor' %}
{% set HREF_ABOUT = HREF_ABOUT or '#about' %}
{% set HREF_CONTACT = HREF_CONTACT or '/contact' %}
{% set USER = USER if USER is defined else None %}
{% set URL_LOGIN = URL_LOGIN or '/login' %}
{% set URL_LOGOUT = URL_LOGOUT or '/logout' %}
{% set URL_DASHBOARD = URL_DASHBOARD or '/dashboard' %}
{% set GOAL = (fundraising_goal or 50000)|int %}
{% set RAISED = (funds_raised or 0)|int %}
{% set PCT = ((RAISED / (GOAL if GOAL>0 else 1)) * 100)|round(1) %}
{% set PCT_CLAMP = 0 if PCT < 0 else (100 if PCT > 100 else PCT) %}

<header id="site-header"
  class="fc-header"
  role="banner"
  aria-label="{{ PLATFORM_NAME }} site header"
  style="--accent: {{ ACCENT }};">
  
  <!-- Skip Links -->
  <nav class="sr-only">
    <a href="#main">Skip to content</a>
    <a href="{{ HREF_DONATE }}">Skip to donate</a>
    <a href="#primary-nav">Skip to navigation</a>
  </nav>

  <!-- Announcement Bar -->
  {% if ANNOUNCE_TEXT %}
  <div class="fc-announce" data-announcement data-id="{{ ANNOUNCE_ID or 'default' }}">
    <span>{{ ANNOUNCE_TEXT|safe }}</span>
    {% if ANNOUNCE_CTA_URL %}
      <a href="{{ ANNOUNCE_CTA_URL }}" class="cta">{{ ANNOUNCE_CTA_LABEL or 'Learn more' }}</a>
    {% endif %}
    <button type="button" aria-label="Dismiss" data-dismiss-announcement>Ã—</button>
  </div>
  {% endif %}

  <!-- Header Core -->
  <div class="fcx-h-inner">

    <!-- Left: Brand -->
    <div class="fcx-brand-block">
      <a href="{{ PLATFORM_URL }}" class="fcx-brand">
        <img src="{{ TEAM_LOGO }}" alt="{{ TEAM_NAME }} logo" width="38" height="38" loading="eager">
        <span class="label">
          <span class="title">{{ PLATFORM_NAME }}</span>
          <span class="strap">Back youth. Build future.</span>
        </span>
      </a>
    </div>

    <!-- Center: Navigation & Actions -->
    <div class="fcx-h-center">
      <nav id="primary-nav" class="fcx-nav" aria-label="Primary navigation">
        <ul>
          <li><a href="{{ HREF_TIERS }}">Tiers</a></li>
          <li><a href="{{ HREF_IMPACT }}">Impact</a></li>
          <li><a href="{{ HREF_SPONSOR }}">Sponsors</a></li>
          <li class="hide-sm"><a href="{{ HREF_ABOUT }}">About</a></li>
          <li class="hide-sm"><a href="{{ HREF_CONTACT }}">Contact</a></li>
        </ul>
      </nav>

      <!-- CTA Row -->
      <div class="fcx-actions">
        <a href="{{ HREF_DONATE }}" class="cta-main">ðŸ’› Sponsor A Champion</a>
        <button id="hdr-share" class="chip" data-share='{{ {"title":"Support "~TEAM_NAME,"text":"Every dollar moves a kid forward â€” join "~TEAM_NAME,"url":(request.base_url if request is defined else "/")}|tojson|e }}'>Share</button>
        <button id="theme-toggle" class="chip" data-theme-toggle>Theme</button>
      </div>

      <!-- Kinetic Tagline -->
      <p class="kinetic"><span>Fuel the Season.</span><span class="accent">Fund the Future.</span></p>

      <!-- Progress Meter -->
      <div class="fcx-progress">
        <meter id="hdr-progress" value="{{ PCT_CLAMP }}" min="0" max="100">{{ PCT_CLAMP }}%</meter>
        <output id="hdr-percent">{{ PCT_CLAMP }}%</output>
      </div>
    </div>

    <!-- Right: Team & Auth -->
    <div class="fcx-h-right">
      <div class="team-pill">
        <img src="{{ TEAM_LOGO }}" alt="{{ TEAM_NAME }} logo" width="32" height="32">
        <div><strong>{{ TEAM_NAME }}</strong><span>on FundChamps</span></div>
      </div>

      {% if USER and USER.is_authenticated %}
        <a href="{{ URL_DASHBOARD }}" class="avatar"><img src="{{ USER.avatar_url or '/static/images/avatar-default.png' }}" width="28" height="28" alt=""></a>
      {% else %}
        <a href="{{ URL_LOGIN }}" class="chip">Sign In</a>
      {% endif %}

      <button id="menu-toggle" class="menu-toggle" aria-expanded="false" aria-controls="menu-panel">â˜°</button>
    </div>
  </div>

  <!-- Menu Panel -->
  <nav id="menu-panel" class="menu-panel" hidden>
    <a href="{{ HREF_TIERS }}">Tiers</a>
    <a href="{{ HREF_IMPACT }}">Impact</a>
    <a href="{{ HREF_SPONSOR }}">Sponsors</a>
    <a href="{{ HREF_ABOUT }}">About</a>
    <a href="{{ HREF_CONTACT }}">Contact</a>
    <button id="menu-theme">Toggle Theme</button>
    <button id="menu-share">Share</button>
    {% if USER and USER.is_authenticated %}
      <a href="{{ URL_DASHBOARD }}">Dashboard</a>
      <a href="{{ URL_LOGOUT }}">Sign out</a>
    {% else %}
      <a href="{{ URL_LOGIN }}">Sign In</a>
    {% endif %}
  </nav>

  <!-- Ribbon -->
  <div class="hdr-ribbon"><span id="hdr-ribbon-fill" style="width: {{ PCT_CLAMP }}%;"></span></div>

  <!-- Mobile Dock -->
  <nav id="fcx-mobile-nav" class="fcx-mobile-nav" hidden>
    <a href="{{ HREF_DONATE }}" class="prominent">Donate</a>
    <a href="{{ HREF_TIERS }}">Tiers</a>
    <button id="mobile-share">Share</button>
  </nav>

  <div id="hdr-announcer" class="sr-only" aria-live="polite" aria-atomic="true"></div>
</header>

{# ===================================================== #
   Enhanced Enterprise Header Styles v9
   Sleeker layout, glass gradient, and motion polish
# ===================================================== #}
<style {{ nonce_attr() }}>
/* --- Core System Tokens --- */
:root {
  --bg: #0B0F1A;
  --fg: #E5E7EB;
  --accent: {{ ACCENT }};
  --muted: rgba(229,231,235,0.65);
  --glass: rgba(255,255,255,0.06);
  --ring: rgba(255,255,255,0.15);
  --glow: 0 0 12px color-mix(in oklab, var(--accent) 50%, transparent);
}

/* --- Base header styles --- */
.fc-header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: linear-gradient(180deg, rgba(10,10,15,0.92) 0%, rgba(10,10,15,0.85) 100%);
  backdrop-filter: blur(14px) saturate(140%);
  border-bottom: 1px solid color-mix(in oklab, var(--fg) 8%, transparent);
  box-shadow: inset 0 -2px 0 var(--accent);
  transition: all 0.35s cubic-bezier(.25,.8,.25,1);
  will-change: transform, background;
}
.fc-header.is-compact {
  transform: translateY(-2px) scale(0.987);
  background: rgba(12,12,12,0.9);
  box-shadow: 0 4px 18px rgba(0,0,0,0.35);
}

/* --- Layout --- */
.fcx-h-inner {
  display: grid;
  grid-template-columns: auto 1fr auto;
  align-items: center;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0.75rem 2rem;
  gap: 1.25rem;
}

/* --- Brand --- */
.fcx-brand {
  display: flex; align-items: center; gap: 0.85rem;
  text-decoration: none; color: inherit;
  transition: opacity .2s ease;
}
.fcx-brand:hover { opacity: 0.9; }
.fcx-brand img { filter: drop-shadow(0 1px 3px rgba(0,0,0,0.3)); }
.fcx-brand .title {
  font-weight: 900;
  font-size: 1.25rem;
  letter-spacing: -0.02em;
}
.fcx-brand .strap {
  color: var(--muted);
  font-size: 0.85rem;
  margin-top: -0.15rem;
}

/* --- Nav --- */
.fcx-nav ul {
  display: flex;
  list-style: none;
  gap: 1.5rem;
  padding: 0;
  margin: 0;
  justify-content: center;
}
.fcx-nav a {
  position: relative;
  font-weight: 700;
  padding: 0.45rem 0.75rem;
  border-radius: 0.6rem;
  text-decoration: none;
  color: inherit;
  transition: color .25s, background .25s;
}
.fcx-nav a::after {
  content: "";
  position: absolute;
  left: 50%; bottom: 0;
  width: 0%; height: 2px;
  background: var(--accent);
  border-radius: 1px;
  transition: width .3s ease, left .3s ease;
}
.fcx-nav a:hover {
  color: var(--accent);
  background: color-mix(in oklab, var(--accent) 6%, var(--glass));
}
.fcx-nav a:hover::after {
  width: 80%;
  left: 10%;
}

/* --- CTA (Primary Button) --- */
.cta-main {
  background: linear-gradient(90deg, #fde047 0%, #facc15 100%);
  color: #111;
  font-weight: 900;
  border-radius: 1rem;
  padding: 0.65rem 1.6rem;
  font-size: 1.05rem;
  letter-spacing: -0.01em;
  box-shadow: var(--glow);
  transition: transform 0.25s ease, filter 0.25s ease, box-shadow 0.35s ease;
}
.cta-main:hover {
  transform: translateY(-2px);
  filter: brightness(1.05);
  box-shadow: 0 0 18px rgba(250,200,21,0.4);
}
.cta-main:active { transform: scale(0.98); }

/* --- Chips (Utility Buttons) --- */
.chip {
  background: var(--glass);
  border: 1px solid var(--ring);
  padding: 0.5rem 1rem;
  border-radius: 0.75rem;
  font-weight: 700;
  color: inherit;
  transition: background 0.25s ease, color 0.25s ease, border-color 0.25s ease;
}
.chip:hover {
  background: color-mix(in oklab, var(--accent) 8%, var(--glass));
  color: var(--accent);
  border-color: color-mix(in oklab, var(--accent) 30%, var(--ring));
}

/* --- Progress Bar --- */
.fcx-progress {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-top: 0.3rem;
}
.fcx-progress meter {
  width: 120px;
  height: 8px;
  border-radius: 6px;
  background: var(--glass);
  accent-color: var(--accent);
  overflow: hidden;
  transition: all 0.6s ease;
}
.fcx-progress meter::-webkit-meter-bar {
  background: var(--glass);
  border-radius: 6px;
}
.fcx-progress meter::-webkit-meter-optimum-value {
  background: linear-gradient(90deg, var(--accent), #fff3);
  border-radius: 6px;
  transition: width 1s cubic-bezier(.23,1,.32,1);
}

/* --- Ribbon (Dynamic Accent Line) --- */
.hdr-ribbon {
  block-size: 4px;
  background: rgba(255,255,255,0.08);
  overflow: hidden;
}
.hdr-ribbon > span {
  display: block;
  height: 100%;
  background: linear-gradient(90deg,var(--accent),#fff3);
  transition: width 1s cubic-bezier(.23,1,.32,1);
  will-change: width;
}

/* --- Tagline --- */
.kinetic {
  font-weight: 900;
  font-size: 1.2rem;
  margin-top: 0.25rem;
  letter-spacing: -0.015em;
  text-wrap: balance;
}
.kinetic .accent {
  color: var(--accent);
  position: relative;
}
.kinetic .accent::after {
  content: "";
  position: absolute;
  left: 0; bottom: 0;
  width: 100%; height: 3px;
  background: linear-gradient(90deg,var(--accent),transparent);
  opacity: 0.4;
  transition: opacity 0.3s;
}
.kinetic:hover .accent::after { opacity: 0.8; }

/* --- Glass Hover Pulse --- */
@keyframes pulse {
  0%,100% { box-shadow: none; }
  50% { box-shadow: var(--glow); }
}
.pulse { animation: pulse 1s ease; }

/* --- Responsive --- */
@media (max-width: 960px) {
  .fcx-h-inner {
    grid-template-columns: 1fr auto;
    grid-template-rows: auto auto;
    padding: 0.7rem 1.2rem;
    row-gap: 0.6rem;
  }
  .fcx-nav ul {
    justify-content: flex-start;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }
  .fcx-nav ul::-webkit-scrollbar { display: none; }
  .hide-sm { display: none !important; }
  .cta-main { font-size: 1rem; padding: 0.6rem 1.2rem; }
}
</style>

{# ===================================================== #
   Script â€” modular enterprise header controller
# ===================================================== #}
<script {{ nonce_attr() }}>
(() => {
  'use strict';

  const $  = (sel, root = document) => root.querySelector(sel);
  const on = (el, ev, fn, opts) => el?.addEventListener(ev, fn, opts);
  const header = $('#site-header'); if (!header) return;

  const els = {
    progress: $('#hdr-progress', header),
    ribbon: $('#hdr-ribbon-fill', header),
    pct: $('#hdr-percent', header),
    mobDock: $('#fcx-mobile-nav', header),
    menuBtn: $('#menu-toggle', header),
    panel: $('#menu-panel', header),
    announcer: $('#hdr-announcer', header),
    share: $('#hdr-share', header),
    mobShare: $('#mobile-share', header),
    donate: $('.cta-main', header),
    themeBtn: $('[data-theme-toggle]', header)
  };

  /* Compact Header */
  const hero = document.querySelector('[data-hero]');
  const toggleCompact = (active) => {
    header.classList.toggle('is-compact', active);
    if (els.mobDock) els.mobDock.hidden = !active;
  };
  if ('IntersectionObserver' in window && hero) {
    new IntersectionObserver(([e]) => toggleCompact(!e.isIntersecting), {threshold:0.15}).observe(hero);
  } else on(window, 'scroll', () => toggleCompact(scrollY>24), {passive:true});

  /* Progress Animation */
  const pulse = (el) => { if (!el) return; el.classList.remove('pulse'); void el.offsetWidth; el.classList.add('pulse'); };
  const updateProgress = (pct=0) => {
    pct = Math.max(0,Math.min(100,pct));
    els.progress.value = pct; els.pct.textContent = `${pct|0}%`;
    els.ribbon.style.width = `${pct}%`; pulse(els.ribbon);
  };
  updateProgress(Number(els.progress.value||0));

  /* Announcement Persistence */
  const announce = header.querySelector('[data-announcement]');
  if (announce) {
    const key = `fc:announce:${announce.dataset.id||'default'}`;
    try { if (localStorage.getItem(key)) announce.remove(); } catch {}
    on(announce.querySelector('[data-dismiss-announcement]'), 'click', () => {
      try { localStorage.setItem(key,'1'); } catch {}; announce.remove();
    });
  }

  /* Theme Toggle */
  (() => {
    const root = document.documentElement, KEY='fc-theme';
    const apply = (mode) => { root.dataset.theme=mode; try{localStorage.setItem(KEY,mode);}catch{} };
    const stored = localStorage.getItem(KEY);
    apply(stored || (matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));
    on(els.themeBtn,'click',()=>apply(root.dataset.theme==='dark'?'light':'dark'));
    on($('#menu-theme',header),'click',()=>els.themeBtn.click());
  })();

  /* Menu Controls */
  const openMenu=()=>{els.panel.hidden=false;els.menuBtn.setAttribute('aria-expanded','true');};
  const closeMenu=()=>{els.panel.hidden=true;els.menuBtn.setAttribute('aria-expanded','false');};
  on(els.menuBtn,'click',()=>els.panel.hidden?openMenu():closeMenu());
  on(document,'keydown',(e)=>e.key==='Escape'&&closeMenu(),{passive:true});

  /* Share */
  const doShare=async(btn)=>{
    const data=JSON.parse(btn.dataset.share||'{}');
    try{if(navigator.share){await navigator.share(data);}else if(navigator.clipboard){await navigator.clipboard.writeText(data.url);btn.textContent='Copied!';setTimeout(()=>btn.textContent='Share',1200);}}
    catch{}
  };
  on(els.share,'click',()=>doShare(els.share));
  on(els.mobShare,'click',()=>doShare(els.share));
  on($('#menu-share',header),'click',(e)=>doShare(e.currentTarget));

  /* Auto UTM Decorator */
  on(els.donate,'pointerdown',()=>{
    if(els.donate.__done)return;
    try{
      const u=new URL(els.donate.href,location.href);
      [['utm_source','site'],['utm_medium','header'],['utm_campaign','fundraiser']]
      .forEach(([k,v])=>{if(!u.searchParams.has(k))u.searchParams.set(k,v);});
      els.donate.href=u.toString();els.donate.__done=true;
    }catch{}
  },{once:true,passive:true});
})();
</script>

