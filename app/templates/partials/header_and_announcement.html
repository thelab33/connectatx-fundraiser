{# =============================================================================
   header_and_announcement.html — Prestige Header (SV-Cohesive, Bulletproof)
   - Compact + auto-shrinks on scroll
   - Announcement / deadline / trust bands (optional)
   - Mini-meter + donor ticker; live-synced via socket/poll
   - CSP-safe, mobile-first, accessibility-first
   ============================================================================ #}

{% include "partials/ui_bootstrap.html" ignore missing with context %}

{# ---------- Safe Fallbacks & Config ---------- #}
{% set NONCE      = NONCE if NONCE is defined else (csp_nonce() if csp_nonce is defined else '') %}
{% set team_name  = team.team_name if team and team.team_name is defined else 'Connect ATX Elite' %}
{% set logo_src   = team.logo if team and team.logo else (url_for('static', filename='images/logo.webp') if url_for is defined else '/static/images/logo.webp') %}
{% set funds_raised     = (funds_raised if funds_raised is defined else 0) | float %}
{% set fundraising_goal = (fundraising_goal if fundraising_goal is defined and fundraising_goal else 10000) | float %}
{% set pct       = (funds_raised / fundraising_goal * 100 if fundraising_goal else 0) | round(1) %}
{% set brand_color = (team.theme_color if team and team.theme_color is defined else '#facc15') %}
{% set compact_threshold = compact_threshold|default(28) %}

{% set has_announcement     = (announcement and announcement.visible) if announcement is defined else false %}
{% set fundraising_deadline = fundraising_deadline if fundraising_deadline is defined else None %}
{% set deadline_iso         = fundraising_deadline.isoformat() if fundraising_deadline else '' %}
{% set show_trust_band      = show_trust_band|default(false) %}

{# ---------- URLs / API Endpoints ---------- #}
{% set stats_url   = stats_url|default('/api/stats') %}
{% set donors_url  = donors_url|default('/api/donors?limit=12') %}
{% set home_url    = home_url|default('/') %}
{% set tenant_slug = tenant_slug|default(team.slug if team and team.slug is defined else 'default') %}
{% set socket_ns   = socket_ns|default('/donations') %}
{% set poll_ms     = poll_ms|default(15000) %}

<section id="header-wrapper" class="block" data-ui="header">

<header id="site-header"
  role="banner"
  class="sticky top-0 z-50 bg-black/70 border-b transition-all border-[color:var(--fc-brand-200)]"
  data-stats-url="{{ stats_url }}"
  data-donors-url="{{ donors_url }}"
  data-tenant="{{ tenant_slug }}"
  data-socket-ns="{{ socket_ns }}"
  data-poll-ms="{{ poll_ms }}"
  data-compact-threshold="{{ compact_threshold }}"
  style="
    --fc-brand: {{ brand_color }};
    --fc-brand-100: color-mix(in srgb, {{ brand_color }} 28%, transparent);
    --fc-brand-200: color-mix(in srgb, {{ brand_color }} 18%, transparent);
    --fc-brand-300: color-mix(in srgb, {{ brand_color }} 40%, black);
    --fc-brand-text: #111827;
  "
>
  <div class="ambient-glow" aria-hidden="true"></div>
  <div id="fc-header-sentinel" aria-hidden="true"></div>

  {# ---- Announcement Bar ---- #}
  {% if has_announcement %}
  <div id="announcement-bar"
       class="announce flex justify-center items-center gap-2 py-1.5 px-3 text-sm font-semibold border-b"
       style="border-color: var(--fc-brand-200)"
       role="status" aria-live="polite" aria-atomic="true"
       data-key="{{ announcement.id if announcement and announcement.id else 'announcement' }}">
    <span>{{ announcement.message|safe }}</span>
    {% if announcement.cta and announcement.cta_url %}
      <a href="{{ announcement.cta_url }}" target="_blank" rel="noopener noreferrer">{{ announcement.cta }}</a>
    {% endif %}
    <button type="button" aria-label="Close announcement"
            class="ml-2 px-2 py-0.5 rounded hover:bg-black/10" data-close-announcement>×</button>
  </div>
  {% endif %}

  {# ---- Deadline Band ---- #}
  {% if fundraising_deadline %}
  <div class="flex items-center justify-center text-sm font-semibold text-black py-1"
       style="background: var(--fc-brand);"
       aria-label="Fundraising deadline countdown" aria-live="polite">
    ⏰ <span id="header-countdown" class="ml-1" data-deadline="{{ deadline_iso }}"></span>
    <span class="ml-1">left — help us reach our goal!</span>
  </div>
  {% endif %}

  <div class="container mx-auto max-w-7xl px-4">
    <div class="row flex items-center justify-between py-2 gap-4">

      {# ---- Logo ---- #}
      <a href="{{ home_url }}" aria-label="{{ team_name }} home"
         class="flex items-center gap-2 shrinkable">
        <img src="{{ logo_src }}" alt="{{ team_name }} logo"
             class="h-9 w-9 rounded-lg border shadow"
             style="border-color: var(--fc-brand)" />
        <span class="hidden sm:inline font-bold text-lg text-[color:var(--fc-brand)]">{{ team_name }}</span>
      </a>

      {# ---- Primary Nav ---- #}
<nav class="hidden lg:flex items-center gap-6 font-semibold text-sm tracking-wide" aria-label="Primary navigation">
  <a href="#mission"
     class="relative group transition-colors duration-200 hover:text-[color:var(--fc-brand)]">
    Mission
    <span class="absolute left-0 -bottom-1 h-0.5 w-0 scale-x-0 bg-[color:var(--fc-brand)] transition-transform duration-200 group-hover:scale-x-100"></span>
  </a>
  <a href="#tiers"
     class="relative group transition-colors duration-200 hover:text-[color:var(--fc-brand)]">
    Sponsorship Tiers
    <span class="absolute left-0 -bottom-1 h-0.5 w-0 scale-x-0 bg-[color:var(--fc-brand)] transition-transform duration-200 group-hover:scale-x-100"></span>
  </a>
  <a href="#program-stats-calendar"
     class="relative group transition-colors duration-200 hover:text-[color:var(--fc-brand)]">
    Schedule
    <span class="absolute left-0 -bottom-1 h-0.5 w-0 scale-x-0 bg-[color:var(--fc-brand)] transition-transform duration-200 group-hover:scale-x-100"></span>
  </a>
</nav>

{# ---- Mini Meter + Donor Ticker ---- #}
<div class="hidden md:flex flex-col items-end gap-2 min-w-[18rem]"
     role="region" aria-label="Fundraising progress">
  <div id="hdr-meter" class="flex items-center gap-2 text-xs font-medium">
    <div class="relative w-40 h-2 bg-zinc-700/70 rounded overflow-hidden shadow-inner">
      <div id="hdr-bar" class="absolute top-0 left-0 h-2 bg-[color:var(--fc-brand)] transition-all duration-700 ease-out"
           style="width: {{ pct }}%"></div>
    </div>
    <span class="whitespace-nowrap">
      <span id="hdr-raised" class="font-semibold">${{ "{:,.0f}".format(funds_raised) }}</span>
      <span class="opacity-60">/</span>
      <span id="hdr-goal">${{ "{:,.0f}".format(fundraising_goal) }}</span>
    </span>
  </div>

  <div class="donor-spot flex items-center gap-2 text-xs italic text-zinc-300 bg-zinc-800/40 px-2 py-1 rounded"
       aria-live="polite">
    <span class="label text-[color:var(--fc-brand)] font-semibold">Latest:</span>
    <span id="hdr-donor-name" class="truncate max-w-[8rem]">Be the first to donate!</span>
    <span id="hdr-donor-amount" class="value font-bold text-green-400"></span>
    <span class="animate-pulse text-yellow-300" aria-hidden="true">★</span>
  </div>
</div>

      {# ---- CTAs ---- #}
      <div class="flex items-center gap-2">
        <button type="button"
          class="cta-btn inline-flex items-center justify-center rounded-lg bg-zinc-900 text-[color:var(--fc-brand)] border font-bold px-3 py-1.5 ring-1 hover:scale-[1.02] transition text-[0.92rem]"
          style="border-color: var(--fc-brand); box-shadow: 0 0 0 1px color-mix(in srgb, var(--fc-brand) 65%, transparent) inset;"
          data-open-donate-modal data-analytics="cta:donate">💸 Donate</button>

        <a href="#tiers" class="cta-btn inline-flex items-center justify-center rounded-lg bg-zinc-900 text-yellow-200 border font-bold px-3 py-1.5 ring-1 hover:opacity-90 text-[0.92rem]"
           style="border-color: var(--fc-brand-200); box-shadow: 0 0 0 1px var(--fc-brand-200) inset;"
           data-analytics="cta:sponsor">🌟 Sponsor</a>

        <a href="#tiers" class="cta-btn vip-pulse hidden sm:inline-flex items-center justify-center rounded-lg bg-black text-yellow-100 border font-bold px-3 py-1.5 ring-2 hover:scale-[1.02] text-[0.92rem]"
           style="border-color: var(--fc-brand); box-shadow: 0 8px 26px color-mix(in srgb, var(--fc-brand) 22%, transparent);"
           data-analytics="cta:vip">🏆 VIP</a>

        <button id="theme-toggle" class="ml-1 text-[color:var(--fc-brand)] px-2 py-1 rounded hover:bg-white/5 text-[1.1rem]"
                aria-label="Toggle theme" type="button">🌙</button>

        <button id="mobile-toggle" class="lg:hidden ml-1 text-[color:var(--fc-brand)] text-[1.5rem]"
                aria-expanded="false" aria-controls="mobile-menu" aria-label="Open mobile menu" type="button">☰</button>
      </div>
    </div>
  </div>

  {# ---- Trust Band ---- #}
  {% if show_trust_band %}
  <div class="bg-zinc-900 text-yellow-300 text-xs text-center py-1 border-t border-[color:var(--fc-brand-200)]">
    🏅 Trusted by 500+ Families · 3.5 GPA Avg · AAU Gold • Austin, TX
  </div>
  {% endif %}

  {# ---- Mobile Menu ---- #}
  <nav id="mobile-menu" hidden aria-label="Mobile">
    <div class="absolute top-3 right-3">
      <button type="button" id="mobile-close" class="text-2xl text-yellow-300" aria-label="Close menu">×</button>
    </div>
    <div class="flex flex-col items-center gap-6 py-12">
      <a href="#mission" role="menuitem">Mission</a>
      <a href="#tiers" role="menuitem">Tiers</a>
      <a href="#program-stats-calendar" role="menuitem">Schedule</a>
      <button data-open-donate-modal class="w-full rounded-lg bg-[color:var(--fc-brand)] px-4 py-2 font-bold text-black">Donate</button>
    </div>
  </nav>
</header>

{# ---- Quick Donate Floater ---- #}
<a href="#donate" hidden data-open-donate-modal
   class="fixed bottom-4 right-4 bg-[color:var(--fc-brand)] text-black font-bold py-2 px-4 rounded-full shadow-lg"
   aria-label="Quick donate button">💸 Quick Donate</a>

{# ---- Script for header interactions ---- #}
{% if script_open is defined %}{{ script_open() }}{% else %}<script nonce="{{ NONCE }}">{% endif %}
(() => {
  // Shrink on scroll
  const header=document.getElementById('site-header'), sentinel=document.getElementById('fc-header-sentinel');
  if(header && sentinel && 'IntersectionObserver' in window){
    new IntersectionObserver(([e])=>header.classList.toggle('is-shrunk', !e.isIntersecting),
      {rootMargin:`-${header.dataset.compactThreshold||28}px 0px 0px 0px`}).observe(sentinel);
  }

  // Announcement close
  document.querySelectorAll('[data-close-announcement]').forEach(b=>b.onclick=()=>b.closest('#announcement-bar')?.remove());

  // Mobile menu
  const toggle=document.getElementById('mobile-toggle'), menu=document.getElementById('mobile-menu'), close=document.getElementById('mobile-close');
  if(toggle && menu){ toggle.onclick=()=>{menu.hidden=false;toggle.setAttribute('aria-expanded','true');};
    close.onclick=()=>{menu.hidden=true;toggle.setAttribute('aria-expanded','false');}; }

  // Mini meter sync
  const nf=new Intl.NumberFormat(); const money=n=>'$'+nf.format(Math.round(n||0));
  window.addEventListener('fc:funds:update',e=>{
    const {raised,goal}=e.detail||{}; const pct=goal?(100*raised/goal):0;
    document.getElementById('hdr-bar').style.width=pct+'%';
    document.getElementById('hdr-pct').textContent=pct.toFixed(0)+'%';
    document.getElementById('hdr-raised').textContent=money(raised);
    document.getElementById('hdr-goal').textContent=money(goal);
  });
})();
{% if script_close is defined %}{{ script_close() }}{% else %}</script>{% endif %}
</section>

