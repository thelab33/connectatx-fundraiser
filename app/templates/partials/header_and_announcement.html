{# ======================================================================
   Header ‚Äî SV Elite v3.5 (Sticky + Sponsor Leaderboard Rail, SV polish)
   - A11y-first, CSP-safe, conflict-proof (scoped to header id)
   - Micro-meter + Donate CTA; pauseable sponsor marquee rail
   ====================================================================== #}
{% set NONCE    = NONCE if NONCE is defined else (csp_nonce() if csp_nonce is defined else '') %}
{% set _hdr_id  = header_id if header_id is defined and header_id else 'site-header' %}
{% set _team    = team if team is defined and team else none %}

{% set platform_name  = platform_name if platform_name is defined and platform_name else 'FundChamps' %}
{% set platform_url   = platform_url if platform_url is defined and platform_url else '/' %}
{% set _p_logo_svg    = 'images/fundchamps-logo.svg' %}
{% set platform_logo_svg = (url_for('static', filename=_p_logo_svg) if url_for is defined else '/static/' ~ _p_logo_svg) %}

{% set team_name   = _team.team_name if _team and _team.team_name is defined else 'Connect ATX Elite' %}
{% set brand_color = (_team.theme_color if _team and _team.theme_color is defined and _team.theme_color else '#facc15') %}
{% set stripe_payment_link = (stripe_payment_link if stripe_payment_link is defined and stripe_payment_link else '') %}

{% set funds_raised     = (funds_raised if funds_raised is defined else 0) | float %}
{% set fundraising_goal = (fundraising_goal if fundraising_goal is defined and fundraising_goal else 10000) | float %}
{% set _raw_pct = (funds_raised / (fundraising_goal if fundraising_goal else 1) * 100) %}
{% set pct = 0 if _raw_pct < 0 else (100 if _raw_pct > 100 else _raw_pct) %}

{% set _logo = (_team.logo if _team and _team.logo else 'images/logo.webp') %}
{% set logoSrc = (_logo if _logo.startswith('http') else (url_for('static', filename=_logo.lstrip('/')) if url_for is defined else '/static/' ~ _logo.lstrip('/'))) %}

{% set TICKER = (
  ticker_items if ticker_items is defined and ticker_items
  else [
    'Shoutout: The Jackson Family ‚Äî $250 üôå',
    'Shoutout: Austin Realty ‚Äî $500 üè†',
    'Shoutout: Coach Rivera ‚Äî $100 üí™',
    'Shoutout: Anonymous ‚Äî $50 üíõ'
  ]
) %}

{% if stripe_payment_link %}
<link rel="preconnect" href="https://js.stripe.com" crossorigin>
{% endif %}

<header id="{{ _hdr_id }}" role="banner"
        class="sticky top-0 z-50 print:hidden"
        style="--fc-brand: {{ brand_color }};">
  <style nonce="{{ NONCE }}">
    #{{ _hdr_id }}{
      isolation:isolate;
      background:linear-gradient(180deg,rgb(5 6 9/.82),rgb(5 6 9/.66));
      -webkit-backdrop-filter:blur(14px) saturate(150%); backdrop-filter:blur(14px) saturate(150%);
      border-bottom:1px solid rgba(255,255,255,.08);
      padding-top:max(0px, env(safe-area-inset-top));
      padding-inline:max(0px, env(safe-area-inset-left)) max(0px, env(safe-area-inset-right));
      contain:content;
    }
    #{{ _hdr_id }} .fc-container{ width:min(88rem,96vw); margin-inline:auto; padding-inline:clamp(.75rem,2vw,1.25rem); }

    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

    /* Row 1 ‚Äî brand | nav+meter | ctas */
    .hdr-row{ display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:.75rem; padding:.55rem 0; }
    .fc-brand{ display:inline-flex; align-items:center; gap:.6rem; text-decoration:none; }
    .fc-brand .logo{ height:clamp(36px,4.2vw,52px); width:auto; }
    .fc-brand .word{
      font-weight:900; letter-spacing:-.02em; font-size:clamp(18px,1.75vw,28px);
      background:linear-gradient(90deg,#f87171,#facc15,#4ade80,#38bdf8,#a78bfa);
      background-size:200% auto; -webkit-background-clip:text; background-clip:text; color:transparent;
      white-space:nowrap; animation:rainbow-shift 8s linear infinite, rainbow-glow 2.5s ease-in-out infinite;
    }
    @keyframes rainbow-shift{ to{ background-position:200% center } }
    @keyframes rainbow-glow{ 0%,100%{ text-shadow:0 0 6px rgba(255,255,255,.15) } 50%{ text-shadow:0 0 16px rgba(255,255,255,.35) } }

    nav.primary a{
      color:rgba(255,255,255,.86); text-decoration:none; font-weight:600;
      transition:color .18s ease;
    }
    nav.primary a:hover, nav.primary a:focus-visible{ color: color-mix(in srgb, var(--fc-brand) 80%, white 20%); outline:none; }

    .hdr-center{ display:flex; align-items:center; justify-content:center; gap:1rem; }

    /* Compact prestige meter */
    .hdr-meter{ display:flex; align-items:center; gap:.5rem; }
    .hdr-meter .track{
      position:relative; width: clamp(140px, 22vw, 220px); height: 12px; border-radius:9999px; overflow:hidden;
      background:rgba(255,255,255,.12); box-shadow:inset 0 0 0 1px rgba(255,255,255,.1);
    }
    .hdr-meter .ticks{
      position:absolute; inset:0; pointer-events:none;
      background:repeating-linear-gradient(90deg,rgba(255,255,255,.22) 0, rgba(255,255,255,.22) 1px, transparent 1px, transparent 5%);
      opacity:.35;
    }
    .hdr-meter .fill{
      position:absolute; inset-block:0; left:0; width:{{ pct|round(1) }}%;
      background:linear-gradient(90deg,#fffbe6,var(--fc-brand),#f59e0b);
      box-shadow:0 0 8px rgba(250,204,21,.45);
      transition:width .6s cubic-bezier(.2,.8,.2,1);
    }
    .hdr-meter .pct{ font-variant-numeric:tabular-nums; min-width:3ch; font-size:.9rem; color:#fde68a; }

    /* Row 2 ‚Äî Sponsor Leaderboard Rail */
    .hdr-rail{
      display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:.5rem;
      padding:.4rem .25rem .55rem; border-top:1px solid rgba(255,255,255,.08);
    }
    .rail-btn{
      --b: rgba(255,255,255,.16);
      display:inline-flex; align-items:center; gap:.45rem; font-weight:800; font-size:.85rem;
      padding:.35rem .65rem; border-radius:.65rem; border:1px solid var(--b); background:rgba(255,255,255,.06);
      color:#e5e7eb;
    }
    .rail-track{ position:relative; overflow:hidden; height:30px; }
    .rail-marquee{ display:flex; align-items:center; gap:1.25rem; white-space:nowrap; will-change:transform; }
    .rail-item{
      display:inline-flex; align-items:center; gap:.45rem; padding:.28rem .55rem; border-radius:999px;
      background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18); color:#e5e7eb; font-weight:700; font-size:.9rem;
      text-shadow:0 1px 0 rgba(0,0,0,.35); -webkit-backdrop-filter:blur(6px); backdrop-filter:blur(6px);
    }
    .rail-cta{ color:#0b0b0c; background:linear-gradient(90deg,#fde047,#facc15); border:1px solid rgba(0,0,0,.16);
      border-radius:999px; padding:.35rem .7rem; font-weight:900; font-size:.85rem; text-decoration:none; }

    /* CTAs */
    .fc-btn{ display:inline-flex; align-items:center; gap:.55rem; border-radius:999px; padding:.6rem 1rem; font-weight:800; }
    .fc-btn-primary{
      background:linear-gradient(90deg,#fde047,#facc15,#fbbf24); color:#0b0b0c;
      box-shadow:0 6px 18px rgba(250,204,21,.35); transition:transform .2s ease;
    }
    .fc-btn-primary:hover{ transform:translateY(-1px) scale(1.02); }
    .fc-btn-primary:focus-visible{ outline:2px solid #fff7cc; outline-offset:3px; }

    /* Scroll/shrink behavior */
    #{{ _hdr_id }}.is-shrunk{ -webkit-backdrop-filter:blur(16px) saturate(160%); backdrop-filter:blur(16px) saturate(160%); box-shadow:0 8px 30px rgb(0 0 0/.35); }
    #{{ _hdr_id }}.is-compact .hdr-meter{ display:none; }
    #{{ _hdr_id }}.is-compact .fc-btn-primary{ padding:.55rem .85rem; font-size:.95rem; }

    @media (max-width:980px){
      nav.primary{ display:none; }
      .hdr-row{ grid-template-columns:auto 1fr auto; }
    }
    @media (max-width:720px){
      .fc-brand .word{ display:none; }
      .rail-item{ font-size:.85rem; }
    }

    /* Motion/forced colors */
    @media (prefers-reduced-motion: reduce){
      .rail-marquee{ animation:none !important; transform:none !important; }
      .fc-btn-primary{ transition:none; }
    }
    @media (forced-colors: active){
      #{{ _hdr_id }}{ background:Canvas; border-bottom:1px solid CanvasText; }
      .rail-item{ background:Canvas; color:CanvasText; border:1px solid CanvasText; }
      .rail-cta{ background:CanvasText; color:Canvas; border:1px solid CanvasText; }
      .hdr-meter .track{ background:Canvas; border:1px solid CanvasText; }
    }
  </style>

  <div class="fc-container">
    <!-- ROW 1 -->
    <div class="hdr-row">
      <!-- Brand -->
      <a href="{{ platform_url }}" class="fc-brand" aria-label="{{ platform_name }} home">
        <img src="{{ platform_logo_svg }}" alt="{{ platform_name }} logo" class="logo" loading="eager" decoding="async" fetchpriority="high"
             onerror="this.style.display='none';var s=this.nextElementSibling;s&&s.classList.remove('hidden')" />
        <span class="word hidden">{{ platform_name }}</span>
      </a>

      <!-- Center: Nav + Meter (desktop) -->
      <div class="hdr-center">
        <nav class="primary hidden md:flex items-center gap-8" aria-label="Primary">
          <a href="#mission">Mission</a>
          <a href="#tiers">Sponsorship Tiers</a>
          <a href="#program-stats-calendar">Schedule</a>
        </nav>

        <div class="hidden md:flex flex-col items-end gap-2 min-w-[16rem]" role="region" aria-label="Fundraising progress">
          <div class="flex items-baseline gap-2 text-sm">
            <span class="font-bold text-[color:var(--fc-brand)]">{{ '${:,.0f}'.format(funds_raised) }}</span>
            <span class="opacity-60">/</span>
            <span class="opacity-80">{{ '${:,.0f}'.format(fundraising_goal) }}</span>
            <span class="ml-2 text-xs font-semibold text-yellow-200"><span id="hdr-pct">{{ pct|round(1) }}</span>%</span>
          </div>
          <div class="hdr-meter w-full" aria-hidden="true">
            <div class="track">
              <div class="ticks"></div>
              <div class="fill"></div>
            </div>
          </div>
          <div id="hdr-sr" class="sr-only" aria-live="polite"></div>
        </div>
      </div>

      <!-- CTAs -->
      <div class="flex items-center gap-3">
        <button type="button" class="fc-btn fc-btn-primary sheen-btn"
                data-open-donate-modal data-analytics="cta:donate">
          üí∏ Donate
        </button>
        <a href="#tiers" class="fc-btn ripple-btn" style="border:1px solid color-mix(in srgb, var(--fc-brand) 35%, white 65%); color:#ffeeb0; background:rgba(255,255,255,.06);">
          üåü Sponsor
        </a>
        <a href="#tiers" class="fc-btn ripple-btn" style="border:1px solid var(--fc-brand); color:#111; background:linear-gradient(90deg,#fde047,#facc15); box-shadow:0 8px 26px color-mix(in srgb, var(--fc-brand) 30%, transparent);">
          üèÜ VIP
        </a>
        <button id="theme-toggle" class="ml-1 text-xl text-[color:var(--fc-brand)] px-2 py-1 rounded hover:bg-white/5" aria-label="Toggle theme" type="button">üåô</button>
        <button id="mobile-toggle" class="md:hidden ml-1 text-[color:var(--fc-brand)] text-2xl" aria-expanded="false" aria-controls="mobile-menu" aria-label="Open mobile menu" type="button">‚ò∞</button>
      </div>
    </div>

    <!-- ROW 2 ‚Äî Leaderboard Rail -->
    <div class="hdr-rail" role="region" aria-label="Live sponsor shoutouts">
      <button class="rail-btn" type="button" id="rail-toggle" aria-pressed="false">
        ‚èØÔ∏è <span class="lbl">Pause</span>
      </button>

      <div class="rail-track" aria-live="polite">
        <div id="hdr-rail-mq" class="rail-marquee">
          {# Or: {% include "partials/sponsor_leaderboard.html" ignore missing with context %} #}
          {% for it in TICKER %}
            <span class="rail-item">üèÜ {{ it }}</span>
          {% endfor %}
        </div>
      </div>

      <a href="#sponsors" class="rail-cta">View Sponsors</a>
    </div>
  </div>

  <style nonce="{{ NONCE }}">
    .sheen-btn{ position:relative; overflow:hidden; }
    .sheen-btn::before{ content:""; position:absolute; inset-block:0; left:-40%; width:40%;
      transform:skewX(-16deg); background:linear-gradient(90deg,transparent,rgba(255,255,255,.35),transparent);
      animation:shine 2.6s linear infinite; }
    @keyframes shine{ from{ transform:translateX(-120%) skewX(-16deg)} to{ transform:translateX(120%) skewX(-16deg)} }
    .ripple-btn{ position:relative; overflow:hidden; }
    .ripple-btn:after{ content:""; position:absolute; inset:0; border-radius:inherit;
      background:radial-gradient(circle,rgba(255,255,255,.45) 10%,transparent 10.01%);
      transform:scale(10,10); opacity:0; transition:transform .6s, opacity .6s; }
    .ripple-btn:active:after{ transform:scale(0,0); opacity:.35; transition:0s; }
    @media (prefers-reduced-motion: reduce){ .sheen-btn::before{ animation:none; opacity:0 } }
  </style>

  <script nonce="{{ NONCE }}">
    (() => {
      if (window.__hdrV35) return; window.__hdrV35 = true;
      const root = document.getElementById('{{ _hdr_id }}');

      // Shrink / compact on scroll
      let lastY = 0;
      const onScroll = () => {
        const y = scrollY || document.documentElement.scrollTop;
        root.classList.toggle('is-shrunk', y > 8);
        root.classList.toggle('is-compact', y - lastY > 12 && y > 80);
        lastY = y;
      };
      addEventListener('scroll', onScroll, { passive:true }); onScroll();

      // Marquee (seamless, pauseable)
      const mq = document.getElementById('hdr-rail-mq');
      const btn = document.getElementById('rail-toggle');
      let w = 0, t = 0, speed = 60; // px/sec
      function setup(){
        if (!mq) return;
        const trackW = mq.parentElement.clientWidth * 2;
        while (mq.scrollWidth < trackW) mq.innerHTML += mq.innerHTML;
        w = mq.scrollWidth; t = 0; mq.style.transform = 'translateX(0)';
      }
      function tick(ts){
        const dt = (tick.lastTs? (ts - tick.lastTs) : 16) / 1000; tick.lastTs = ts;
        if (!btn?.dataset.paused){ t = (t + speed*dt) % w; mq.style.transform = `translateX(${-t}px)`; }
        requestAnimationFrame(tick);
      }
      setup(); requestAnimationFrame(tick);
      addEventListener('resize', setup, { passive:true });

      btn?.addEventListener('click', () => {
        const paused = !!btn.dataset.paused;
        if (paused) { delete btn.dataset.paused; btn.setAttribute('aria-pressed','false'); btn.querySelector('.lbl').textContent='Pause'; }
        else { btn.dataset.paused = '1'; btn.setAttribute('aria-pressed','true'); btn.querySelector('.lbl').textContent='Resume'; }
      }, { passive:true });

      // Optional: live SR updates for pct (if you stream updates in)
      const sr = document.getElementById('hdr-sr');
      const pctEl = document.getElementById('hdr-pct');
      if (sr && pctEl) {
        const v = pctEl.textContent?.trim();
        if (v) sr.textContent = `Fundraiser is ${v}% to goal.`;
      }
    })();
  </script>
</header>

