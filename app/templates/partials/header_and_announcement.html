{# =========================
   Header ‚Äî MVP v1.7 (Robust ‚Ä¢ A11y/Perf/Safety)
   - Self-contained fallbacks (no undefined vars)
   - Safe URL building even if url_for/request are absent
   - Progress math clamped 0‚Äì100
   - Logos: platform + team with sane defaults
   ========================= #}

{# ---- Nonce (only reads existing; no macro required here) ---- #}
{% set NONCE    = NONCE if NONCE is defined else (csp_nonce if csp_nonce is defined else '') %}

{# ---- IDs & core context ---- #}
{% set _hdr_id  = header_id if header_id is defined and header_id else 'site-header' %}
{% set _team    = team if team is defined and team else None %}

{# ---- Platform identity (safe defaults) ---- #}
{% set platform_name  = (platform_name if platform_name is defined and platform_name)|string or 'FundChamps' %}
{% set platform_url   = (platform_url  if platform_url  is defined and platform_url)|string  or '/' %}

{# Build a platform logo URL with or without url_for #}
{% set _p_logo_path   = 'images/fundchamps-logo.svg' %}
{% set platform_logo_svg = (url_for('static', filename=_p_logo_path) if url_for is defined
                            else '/static/' ~ _p_logo_path) %}

{# ---- Team identity (safe defaults) ---- #}
{% set team_name   = (_team.team_name if _team and _team.team_name is defined and _team.team_name)|string or 'Connect ATX Elite' %}
{% set brand_color = (_team.theme_color if _team and _team.theme_color is defined and _team.theme_color)|string or '#facc15' %}

{# Team logo (accepts absolute or static-relative) ---- #}
{% set _raw_team_logo = (_team.logo if _team and _team.logo is defined and _team.logo)|string or 'images/logo.webp' %}
{% set logoSrc = (_raw_team_logo if _raw_team_logo.startswith('http')
                  else ((url_for('static', filename=_raw_team_logo.lstrip('/')) if url_for is defined
                         else '/static/' ~ _raw_team_logo.lstrip('/')))) %}

{# ---- Donate link & Stripe preconnect ---- #}
{% set HREF_DONATE = HREF_DONATE|default('/donate', true) %}
{% set stripe_payment_link = (stripe_payment_link|default('', true)) %}
{% if stripe_payment_link %}
<link rel="preconnect" href="https://js.stripe.com" crossorigin>
{% endif %}

{# ---- Progress math (never raises; clamps 0..100) ---- #}
{% set _fr  = (funds_raised|default(0, true))|float %}
{% set _fg0 = (fundraising_goal|default(10000, true))|float %}
{% set _fg  = 1.0 if _fg0 <= 0 else _fg0 %}
{% set _raw = (_fr / _fg * 100.0) %}
{% set pct  = (0.0 if _raw < 0 else (100.0 if _raw> 100 else _raw)) %}
{% set pct_i = pct|round(0) %}

{# ===========================
   FundChamps Premium Header
   ===========================
   - Ultra-responsive, mobile-first
   - A11y, progressive enhancement
   - Real metrics, action CTAs
   - White label, team-brand safe
   - Minimal, ‚Äúagency product‚Äù polish
#}
<header id="{{ HDR_ID or _hdr_id }}"
        class="fc-header"
        role="banner"
        data-accent="{{ brand_color or ACCENT }}"
        style="--accent: {{ brand_color or ACCENT }};"
        aria-label="{{ PLATFORM_NAME or platform_name }} header"
        data-header
        data-sticky>

  <!-- ‚ôø Accessibility: Skip Links -->
  <nav class="sr-only" aria-label="Skip links">
    <a class="sr-skip" href="#main">Skip to content</a>
    <a class="sr-skip" href="{{ HREF_DONATE }}">Skip to donate</a>
    <a class="sr-skip" href="#primary-nav">Skip to navigation</a>
  </nav>

  <!-- ‚ö° Announcement Bar -->
  {% if ANNOUNCE_TEXT %}
  <div class="fc-announce" id="announce" role="region" aria-live="polite" data-announcement data-id="{{ ANNOUNCE_ID or 'default' }}">
    <div class="fc-announce__inner">
      <span class="fc-announce__msg">{{ ANNOUNCE_TEXT|safe }}</span>
      {% if ANNOUNCE_CTA_URL and ANNOUNCE_CTA_LABEL %}
        <a class="fc-announce__cta" href="{{ ANNOUNCE_CTA_URL }}" data-analytics="announce:cta">{{ ANNOUNCE_CTA_LABEL }}</a>
      {% endif %}
      <button class="fc-announce__close" type="button" aria-label="Dismiss announcement" data-dismiss-announcement>√ó</button>
    </div>
  </div>
  {% endif %}

  <!-- üåü Core Header Grid -->
  <div class="hdr-grid" role="region" aria-label="Header controls">

    <!-- 1Ô∏è‚É£ Brand Crest -->
    <a href="{{ PLATFORM_URL or platform_url }}"
       class="crest"
       aria-label="{{ PLATFORM_NAME or platform_name }} home"
       data-analytics="nav:brand">
      <img src="{{ TEAM_LOGO or platform_logo_svg }}"
           alt="{{ PLATFORM_NAME or platform_name }} logo"
           class="crest-logo"
           width="124" height="38"
           decoding="async" loading="eager" fetchpriority="high" />
      <span class="crest-meta">
        {% if _SHOW_PWR %}<small class="powered">POWERED&nbsp;BY</small>{% endif %}
        <span class="word" aria-hidden="true">
          <span class="w1">{{ _WORD1 or "Fund" }}</span><span class="w2">{{ _WORD2 or "Champs" }}</span>
        </span>
        <span class="strap">{{ _TAGLINE or "Back youth. Build future." }}</span>
      </span>
    </a>

    <!-- 2Ô∏è‚É£ Main Action Hub -->
    <div class="fcx-hub" role="group" aria-label="Donation and sharing">
      <!-- Kinetic Tagline -->
      <p class="kinetic-tag" id="hdr-kinetic" aria-roledescription="tagline">
        <span class="word">Fuel the Season.</span>
        <span class="word word--move">Fund the Future.</span>
      </p>

      <!-- Animated Progress Bar -->
      <div class="fcx-progress" role="group" aria-label="Fundraising progress" aria-live="polite">
        <meter id="hdr-progress" value="{{ pct|round(1) }}" min="0" max="100">{{ pct_i }}%</meter>
        <output class="pct" id="hdr-percent" for="hdr-progress" aria-hidden="true">{{ pct_i }}%</output>
        <span id="hdr-total-pill" class="pill" aria-live="polite">
          {{ ('$' ~ ('{:,.0f}'.format(_fr))) if _fr else '$0' }}
        </span>
      </div>

      <!-- Action Buttons -->
      <div class="fcx-actions">
        <a {% if stripe_payment_link or STRIPE_LINK %}
             href="{{ stripe_payment_link or STRIPE_LINK }}" target="_blank" rel="noopener"
           {% else %}
             href="{{ HREF_DONATE }}"
           {% endif %}
           class="btn btn-donate pulse focus-ring"
           id="hdr-donate-main"
           data-cta="donate"
           data-analytics="cta:donate:header">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M12 21s-6-4.35-8-7.5C1.6 10 4 6 8 6c2 0 3 1 4 1s2-1 4-1c4 0 6.4 4 4 7.5C18 16.65 12 21 12 21z" fill="#000"/>
          </svg>
          <span class="label">üíõ Sponsor A Champion</span>
        </a>

        <button id="hdr-share"
                class="btn btn-lite btn-sm focus-ring"
                type="button"
                data-share='{{ {
                  "title":"Support "~team_name,
                  "text":"Every dollar moves a kid forward ‚Äî join us!",
                  "url": (request.base_url if request is defined else "/")
                }|tojson|e }}'
                aria-label="Share this fundraiser"
                data-analytics="nav:share">
          Share
        </button>

        <button id="theme-toggle"
                class="btn btn-lite btn-sm focus-ring"
                type="button"
                data-theme-toggle
                aria-label="Toggle theme"
                data-analytics="nav:theme">
          üåì
        </button>
      </div>
    </div>

    <!-- 3Ô∏è‚É£ Team Chip -->
    <div class="team-pill fcx-glass">
      <img src="{{ TEAM_LOGO or logoSrc }}" alt="{{ TEAM_NAME or team_name }} logo" width="32" height="32" decoding="async" loading="eager">
      <span class="tp-text">
        <span class="tp-title">{{ TEAM_NAME or team_name }}</span>
        <span class="tp-sub">FundChamps</span>
      </span>
    </div>

    <!-- 4Ô∏è‚É£ Mobile Burger -->
    <button id="menu-toggle" class="burger focus-ring" aria-label="Open menu" aria-expanded="false" aria-controls="site-menu">
      <span class="burger-line"></span>
    </button>
  </div>

  <!-- üîΩ Mobile Drawer -->
  <template id="mobile-nav-tpl">
    <nav id="site-menu" class="mobile-sheet hidden" role="dialog" aria-modal="true" aria-label="Mobile menu">
      <button class="close" aria-label="Close">‚úï</button>
      <a href="{{ HREF_TIERS }}">Tiers</a>
      <a href="{{ HREF_IMPACT }}">Impact</a>
      <a href="{{ HREF_ABOUT }}">About</a>
      <a href="{{ HREF_CONTACT }}">Contact</a>
      <a href="{{ HREF_DONATE }}" class="btn btn-donate mt-auto">Donate</a>
    </nav>
  </template>

  <!-- ü™Ñ Confetti + Progress Animation -->
  <script { { nonce_attr() } }>
  document.addEventListener('DOMContentLoaded', () => {
    const bar = document.querySelector('#hdr-progress');
    const pct = parseFloat(bar?.value || 0);
    const fill = document.querySelector('#hdr-percent');
    if (bar && fill) {
      fill.textContent = pct.toFixed(0) + '%';
      bar.style.transition = 'all .9s ease';
      bar.value = pct;
      if (pct>= 100) {
        import('https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js')
        .then(({ default: confetti }) => confetti({ particleCount: 180, spread: 75, origin: { y: 0.8 } }));
      }
    }
  });
  </script>

</header>

<style {{ nonce_attr() }}>
/* =============================
   FundChamps Elite Header v7
   - Agency SaaS polish: Dark-first, glass, mobile, a11y
   - Three-lane grid: Crest | Hub | Team
   - All tokens overrideable
   ============================= */

/* ---- Theme tokens ---- */
:root {
  --accent: {{ ACCENT_HEX|default('#facc15') }};
  --bg-header: rgba(16,16,20,.91);
  --bg-glass: rgba(24,25,31,.97);
  --border: rgba(255,255,255,.08);
  --text: #e8eaf0;
  --muted: #9fa4b2;
  --donate: var(--accent, #facc15);
}
[data-theme="light"] {
  --bg-header: rgba(252,252,253,.97);
  --bg-glass: rgba(242,245,251,.98);
  --border: rgba(0,0,0,.09);
  --text: #181a22;
  --muted: #616574;
}

/* ---- Header ---- */
.fc-header {
  position: sticky; top: 0; z-index: 80;
  background: var(--bg-header);
  border-bottom: 1.5px solid var(--border);
  backdrop-filter: blur(13px) saturate(1.09);
  box-shadow: 0 8px 32px rgba(0,0,0,.29), 0 1px 0 rgba(255,255,255,.04) inset;
  transition: background .33s, box-shadow .18s;
}
.fc-header::after {
  /* Animated gold underline */
  content: "";
  position: absolute; left: 0; right: 0; bottom: -1px; height: 3px;
  background: linear-gradient(90deg, var(--accent), #fff7 52%, var(--accent));
  background-size: 200% 100%; animation: hdrBar 8s linear infinite;
}
@keyframes hdrBar { to { background-position: -200% 0; } }

/* ---- Grid Layout ---- */
.hdr-grid {
  display: grid; grid-template-columns: auto 1fr auto;
  align-items: center; gap: 1.25rem;
  max-width: 1240px; margin: 0 auto; padding: 0.85rem 1.22rem;
  min-height: 60px;
}

/* ---- Crest ---- */
.crest {
  display: flex; align-items: center; gap: .8rem; min-width: 0; text-decoration: none;
}
.crest-logo {
  height: 38px; width: auto; max-width: 120px; object-fit: contain;
  filter: drop-shadow(0 1px 2px rgba(0,0,0,.12));
}
.crest-meta {
  display: flex; flex-direction: column; min-width: 0; line-height: 1.1;
}
.powered {
  font: 700 .7rem/1 "Inter",system-ui; color: color-mix(in srgb, var(--accent) 66%, #fff);
  letter-spacing: .06em; text-transform: uppercase;
}
.word {
  font: 900 1.12rem/1.12 "Poppins",system-ui;
  text-transform: uppercase; letter-spacing: .01em;
}
.word .w1 { color: var(--text); }
.word .w2 { color: color-mix(in srgb, var(--accent) 90%, #fff); }
.strap {
  margin-top: .13rem; font: 700 .75rem/1.08 "Inter",system-ui;
  color: color-mix(in srgb, var(--text) 60%, #b9bac4); white-space: nowrap;
  overflow: hidden; text-overflow: ellipsis;
}

/* ---- Center Hub: Progress, CTA, Tag ---- */
.fcx-hub, .hub {
  display: flex; flex-direction: column; align-items: center; gap: .5rem;
  min-width: clamp(230px, 44vw, 540px); width: 100%;
}
.kinetic-tag {
  font: 900 .95rem/1.19 "Poppins",system-ui; color: var(--accent);
  display: flex; gap: .5em; justify-content: center; align-items: baseline;
  text-transform: uppercase; letter-spacing: .03em; margin: 0;
}
.kinetic-tag .word--move { color: var(--text); opacity: .86; }
.fcx-progress {
  display: flex; align-items: center; gap: .58rem; width: 100%;
  margin-bottom: 0;
}
.fcx-progress meter {
  flex: 1 1 0; height: 6px; border-radius: 999px; background: #23252a;
  box-shadow: 0 1px 0 #fff3 inset;
  accent-color: var(--accent);
}
.fcx-progress .pct {
  font: 900 .78rem/1 "Inter"; color: var(--accent);
}
.fcx-progress .pill {
  margin-left: .35rem;
  background: var(--accent); color: #111; border-radius: 999px; font: 700 .79rem/1.09 "Inter";
  padding: .18rem .68rem;
  box-shadow: 0 2px 8px rgba(0,0,0,.06);
}

.fcx-actions, .cta {
  display: flex; align-items: center; gap: .47rem; flex-wrap: wrap; justify-content: center;
}
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: .42em;
  padding: .55rem 1.16rem; border-radius: 999px;
  font: 900 .82rem/1.05 "Inter"; letter-spacing: .03em;
  background: var(--bg-glass); color: var(--text);
  border: 1.3px solid var(--border); box-shadow: 0 0 0 1px rgba(0,0,0,.13) inset;
  transition: transform .16s, box-shadow .13s, background .18s, color .14s;
  text-transform: uppercase;
}
.btn-sm { padding: .41rem .8rem; font-size: .78rem; }
.btn-lite {
  background: #24262d; color: var(--muted); border-color: #23262b;
}
[data-theme="light"] .btn-lite {
  background: #f8fafc; color: #7c7e8b; border-color: #e8ecf3;
}
.btn-donate {
  position: relative; border: 2px solid var(--donate);
  background: linear-gradient(180deg, #fffbe7 0%, var(--donate) 99%);
  color: #18150a; box-shadow: 0 1px 0 #fff8 inset, 0 5px 22px rgba(0,0,0,.11);
  font-weight: 1000;
}
.btn-donate::before {
  content: "‚ö°"; margin-right: .42em; font-size: 1.1em; filter: grayscale(0.12) brightness(1.08);
}
.btn-donate.pulse { animation: pulseGlow 2.1s infinite; }
@keyframes pulseGlow { 0%,100%{ filter:none; } 50%{ filter: drop-shadow(0 0 9px #fff9); } }
.btn:hover, .btn:focus-visible {
  transform: translateY(-2px); outline: none;
  box-shadow: 0 8px 24px rgba(0,0,0,.13), 0 0 0 2px var(--accent);
}

/* ---- Team Crest ---- */
.team-link {
  display: flex; align-items: center; gap: .7rem; text-decoration: none;
  transition: transform .13s;
}
.team-link:hover { transform: translateY(-1.5px); }
.team-logo {
  height: 38px; width: 38px; border-radius: .48rem; object-fit: cover;
  box-shadow: 0 2px 8px rgba(0,0,0,.17);
}
.team-chip {
  max-width: 8.5rem; font: 700 .88rem/1.08 "Inter"; color: var(--text); opacity: .9;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

/* ---- Burger (Mobile) ---- */
.burger {
  display: none; width: 40px; aspect-ratio: 1; border-radius: .6rem;
  border: 1.5px solid var(--border); background: var(--bg-glass); color: var(--text);
  align-items: center; justify-content: center; padding: 0;
}
.burger-line, .burger-line::before, .burger-line::after {
  content: ""; display: block; width: 18px; height: 2px; background: currentColor; border-radius: 2px;
}
.burger-line { position: relative; }
.burger-line::before { position: absolute; left: 0; top: -6px; }
.burger-line::after { position: absolute; left: 0; top: 6px; }

/* ---- Slide-in Sheet ---- */
.mobile-sheet.hidden { display: none; }
.mobile-sheet {
  position: fixed; inset: 0; z-index: 99;
  display: flex; flex-direction: column; gap: 1rem;
  background: rgba(0,0,0,.68); backdrop-filter: blur(13px) saturate(1.13);
  padding: 1.2rem;
}
.mobile-sheet .close {
  align-self: flex-end; font-size: 1.45rem; font-weight: 800; color: var(--text);
  background: none; border: none; cursor: pointer;
}
.mobile-sheet a {
  color: var(--text); text-decoration: none; font: 800 1rem/1.2 "Inter";
}
.mobile-sheet a:hover { color: var(--accent); }
.mobile-sheet .btn-donate { margin-top: 1.5rem; align-self: flex-start; }

/* ---- Quick-donate Pill ---- */
.quick-donate {
  position: fixed; right: 1.1rem; bottom: 1.1rem; z-index: 99;
  background: color-mix(in srgb, var(--accent) 96%, #fff 7%);
  color: #151313;
  font: 1000 .93rem/1 "Inter";
  padding: .61rem 1.13rem; border-radius: 999px;
  box-shadow: 0 10px 30px rgba(0,0,0,.17);
  transition: transform .16s, filter .17s;
}
.quick-donate:hover { transform: translateY(-2px); filter: brightness(1.04); }

/* ---- A11y/Focus ---- */
:where(a,button,.btn,.burger):focus-visible {
  outline: none;
  box-shadow: 0 0 0 2px #000, 0 0 0 4px var(--accent);
}
.fc-header img, .fc-header svg { max-height: 44px; max-width: 210px; object-fit: contain; }

/* ---- Responsive ---- */
@media (max-width: 980px) {
  .hdr-grid { grid-template-columns: 1fr auto; }
  .crest-meta, .team-chip { display: none; }
  .burger { display: flex; }
  .team-link { order: 3; justify-self: start; }
}
@media (max-width: 670px) {
  .fc-header { padding-inline: 0; }
  .hdr-grid { padding: .55rem .5rem; }
  .fcx-hub { min-width: 0; }
  .btn, .btn-donate { font-size: .83rem; }
}
@media (max-width: 460px) {
  .btn-donate { font-size: .79rem; padding: .56rem 1.21rem; }
  .hdr-grid { gap: .7rem; }
}
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after { transition: none !important; animation: none !important; }
}
</style>


<script {{ nonce_attr() }}>
(() => {
  // =========== FundChamps Elite Header v7 JS ===========
  if (window.__fcHeaderElite) return; window.__fcHeaderElite = true;

  // --- Core helpers ---
  const $  = (sel, el = document) => el.querySelector(sel);
  const $$ = (sel, el = document) => Array.from(el.querySelectorAll(sel));
  const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
  const fmtPct = n => `${Math.round(n)}%`;
  const fmtMoney = n => {
    const v = Number(n) || 0;
    try { return v.toLocaleString(undefined, { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }); }
    catch { return '$' + Math.round(v).toLocaleString(); }
  };

  // --- Theme / Motion preferences ---
  try {
    const reduced = matchMedia('(prefers-reduced-motion: reduce)').matches;
    const saveData = navigator.connection?.saveData;
    if (reduced || saveData) document.documentElement.classList.add('fc-reduced');
  } catch {}

  // --- DOM references ---
  const hdrId     = '{{ _hdr_id|default("site-header") }}';
  const hdr       = document.getElementById(hdrId); if (!hdr) return;
  const meter     = $('#hdr-meter', hdr);
  const fill      = meter?.querySelector('.fill');
  const pctTxt    = meter?.querySelector('.pct');
  const totalPill = $('#hdr-total-pill', hdr);
  const burger    = $('#menu-toggle', hdr);
  const tpl       = document.getElementById('mobile-nav-tpl');
  let   sheet     = null;
  const shareBtn  = $('#hdr-share', hdr);
  const themeBtn  = $('#theme-toggle', hdr);
  const teamLogo  = $('.team-link .team-logo', hdr);

  // --- Header compact/shrink on scroll ---
  let compact = false, ticking = false;
  const SHRINK_AT = 60, UNSHRINK_AT = 18;
  const handleScroll = () => {
    const y = window.scrollY || document.documentElement.scrollTop || 0;
    if (y> SHRINK_AT && !compact) { hdr.classList.add('is-compact'); compact = true; }
    else if (y < UNSHRINK_AT && compact) { hdr.classList.remove('is-compact'); compact = false; }
    ticking = false;
  };
  window.addEventListener('scroll', () => { if (!ticking) { ticking = true; requestAnimationFrame(handleScroll); } }, { passive: true });
  handleScroll();

  // --- Mobile slide-in menu ---
  const openMenu = () => {
    if (!tpl) return;
    if (!sheet) {
      sheet = tpl.content.firstElementChild.cloneNode(true);
      document.body.appendChild(sheet);
      $('.close', sheet)?.addEventListener('click', closeMenu);
      sheet.addEventListener('click', e => { if (e.target === sheet) closeMenu(); });
      document.addEventListener('keydown', escHandler);
    }
    sheet.classList.remove('hidden');
    burger?.setAttribute('aria-expanded', 'true');
    document.body.style.overflow = 'hidden';
    setTimeout(() => $('.close', sheet)?.focus(), 40); // a11y focus
  };
  const closeMenu = () => {
    sheet?.classList.add('hidden');
    burger?.setAttribute('aria-expanded', 'false');
    document.body.style.overflow = '';
  };
  const escHandler = e => { if (e.key === 'Escape') closeMenu(); };
  burger?.addEventListener('click', openMenu);

  // --- Theme switching (persistent, a11y, safe) ---
  const THEME_KEY = 'fc:theme';
  const applyTheme = mode => {
    if (!mode) return;
    document.documentElement.setAttribute('data-theme', mode);
    try { localStorage.setItem(THEME_KEY, mode); } catch {}
    themeBtn?.setAttribute('aria-pressed', mode === 'dark' ? 'false' : 'true');
  };
  // Load stored theme
  try {
    const stored = localStorage.getItem(THEME_KEY);
    if (stored) applyTheme(stored);
  } catch {}
  themeBtn?.addEventListener('click', () => {
    const root = document.documentElement;
    const current = root.getAttribute('data-theme') === 'light' ? 'light' : 'dark';
    const next = current === 'light' ? 'dark' : 'light';
    applyTheme(next);
  });

  // --- Share (Web Share API or clipboard fallback) ---
  if (shareBtn) {
    let payload = {};
    try { payload = JSON.parse(shareBtn.dataset.share || '{}'); } catch {}
    shareBtn.addEventListener('click', async () => {
      try {
        if (navigator.share) {
          await navigator.share(payload);
        } else if (payload.url || location.href) {
          await navigator.clipboard?.writeText(payload.url || location.href);
          shareBtn.dataset._label = shareBtn.textContent;
          shareBtn.textContent = 'Link Copied!';
          setTimeout(() => { shareBtn.textContent = shareBtn.dataset._label || 'Share'; }, 1400);
        }
      } catch {}
    });
  }

  // --- Meter and total pill (event-ready, API-updatable) ---
  const setMeter = (raised, goal) => {
    const g = Math.max(1, Number(goal) || 1), r = Math.max(0, Number(raised) || 0);
    const pct = clamp((r / g) * 100, 0, 100);
    if (fill)   fill.style.width = pct.toFixed(1) + '%';
    if (pctTxt) pctTxt.textContent = fmtPct(pct);
    if (meter)  meter.setAttribute('aria-valuenow', pct.toFixed(1));
    // Animate logo on update
    if (teamLogo) {
      teamLogo.classList.add('pulse');
      setTimeout(() => teamLogo.classList.remove('pulse'), 950);
    }
  };
  const setTotal = (total) => {
    if (!totalPill) return;
    const val = Math.max(0, Number(total) || 0);
    totalPill.textContent = fmtMoney(val);
    totalPill.dataset.val = String(val);
    totalPill.animate?.(
      [{ transform:'scale(1)' }, { transform:'scale(1.09)' }, { transform:'scale(1)' }],
      { duration: 240, easing: 'cubic-bezier(.2,.9,.35,1.1)' }
    );
  };

  // --- Listen for live API updates ---
  window.addEventListener('fc:meter:update', e => {
    const d = e.detail || {};
    if ('raised' in d || 'goal' in d) setMeter(d.raised, d.goal);
    if ('total' in d) setTotal(d.total);
  }, { passive: true });

  // --- Expose header API globally for future extensibility ---
  window.fcHeader = {
    setMeter, setTotal, openMenu, closeMenu, setTheme: applyTheme
  };

})();
</script>

<script {{ nonce_attr() }}>
(() => {
  const ticker = document.getElementById('hdr-ticker');
  if (!ticker) return;
  if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
    ticker.classList.remove('scrolling');
    return;
  }
  // Only scroll if content is wider than ticker
  const needsScroll = () => ticker.scrollWidth> ticker.clientWidth + 42;
  const setScroll = () => {
    ticker.classList.toggle('scrolling', needsScroll());
  };
  new ResizeObserver(setScroll).observe(ticker);
  setScroll();
})();
</script>

