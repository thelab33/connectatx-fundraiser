// widgets/newsletter.js — Enterprise hydrator (ESM, CSP-safe)
// Features: timed, exit-intent, scroll%, hash, cooldowns (session + N-day),
// honeypot + min dwell, offline queue + retry, SHA-256 email hash, a11y focus trap.

export function initNewsletterModal(root = document) {
  const modal = root.querySelector('#newsletter-modal[data-widget="newsletter"]');
  if (!modal || modal.__init) return;
  modal.__init = true;

  // Nodes
  const box     = modal.querySelector('#newsletter-box');
  const form    = modal.querySelector('#newsletter-form');
  const email   = modal.querySelector('#newsletter-email');
  const invite  = modal.querySelector('#newsletter-invite');
  const errEl   = modal.querySelector('#email-error');
  const hintEl  = modal.querySelector('#email-suggestion');
  const thanks  = modal.querySelector('#newsletter-thankyou');
  const submitB = modal.querySelector('#newsletter-submit');
  const confFx  = modal.querySelector('#swish-confetti');
  const hp      = modal.querySelector('#newsletter-company');

  // Options
  const action       = (modal.dataset.action || '').trim();
  const DELAY_SEC    = parseInt(modal.dataset.delay || '0', 10);
  const SCROLL_PCT   = parseInt(modal.dataset.scroll || '0', 10);
  const EXIT_INTENT  = (modal.dataset.exitIntent || modal.dataset.exit_intent || modal.dataset['exit-intent'] || '0') === '1';
  const COOLDOWN_D   = parseInt(modal.dataset.cooldownDays || '7', 10);
  const MIN_DWELL_MS = parseInt(modal.dataset.minDwellMs || '2500', 10);
  const SCOPE        = (modal.dataset.scope || 'global') + '';

  // Storage keys (scoped)
  const K = (k) => `fc_nl_${k}:${SCOPE}`;
  const now = () => Date.now();
  const start = now();
  let openedAt = 0, lastFocus = null, debounceId = null;

  // Helpers: email + domain suggestion
  const isEmail = v => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(v||'').trim());
  const COMMON = ["gmail.com","yahoo.com","outlook.com","hotmail.com","icloud.com","aol.com","live.com","msn.com","proton.me","protonmail.com"];
  const ldist = (a,b)=>{ a=String(a||""); b=String(b||""); const m=a.length,n=b.length,d=Array.from({length:m+1},(_,i)=>[i,...Array(n).fill(0)]); for(let j=1;j<=n;j++) d[0][j]=j; for(let i=1;i<=m;i++){ for(let j=1;j<=n;j++){ d[i][j]=Math.min(d[i-1][j]+1,d[i][j-1]+1,d[i-1][j-1]+(a[i-1]===b[j-1]?0:1)); } } return d[m][n]; };
  const suggestDomain = (addr) => {
    const parts = String(addr||"").split("@"); if (parts.length!==2) return null;
    const dom = parts[1].toLowerCase().replace(/\s+/g,"").replace(/\.con\b/,".com").replace(/\.cpm\b/,".com");
    let best=null, dmin=9; for (const c of COMMON){ const d=ldist(dom,c); if (d<dmin){ dmin=d; best=c; } }
    return best && dmin>0 && dmin<=2 ? `${parts[0]}@${best}` : null;
  };

  // Context hidden fields
  try {
    modal.querySelector('#nl-source-url').value = location.href;
    modal.querySelector('#nl-referrer').value   = document.referrer || '';
    const p = new URLSearchParams(location.search), utm={};
    ['utm_source','utm_medium','utm_campaign','utm_content','utm_term'].forEach(k=>{ const v=p.get(k); if(v) utm[k]=v; });
    modal.querySelector('#nl-utm').value = JSON.stringify(utm);
  } catch {}

  // Eligibility
  function eligible(){
    try {
      if (localStorage.getItem(K('subscribed')) === '1') return false;
      if (sessionStorage.getItem(K('shown_session')) === '1') return false;
      if (localStorage.getItem(K('optout')) === '1') return false;
      const last = parseInt(localStorage.getItem(K('last')) || '0', 10);
      if (last && (now() - last) < COOLDOWN_D * 86400000) return false;
    } catch {}
    return true;
  }

  // Open/Close
  function openModal(manual=false){
    if (modal.classList.contains('flex')) return;
    if (!manual && now() - start < MIN_DWELL_MS) return; // don't open too fast

    lastFocus = document.activeElement;
    modal.classList.remove('hidden');
    modal.showModal?.();
    requestAnimationFrame(()=>{ modal.classList.add('flex'); modal.style.opacity='1'; box.style.opacity='1'; box.style.transform='scale(1)'; });
    document.documentElement.style.overflow='hidden';
    email?.focus();
    modal.setAttribute('aria-hidden','false');
    openedAt = now();
    try { sessionStorage.setItem(K('shown_session'),'1'); localStorage.setItem(K('last'), String(now())); } catch {}
    try { (window.dataLayer = window.dataLayer || []).push({ event:'newsletter_open', scope:SCOPE }); } catch {}
  }
  function closeModal(){
    box.style.opacity='0'; box.style.transform='scale(.98)'; modal.style.opacity='0';
    setTimeout(()=>{
      modal.close?.(); modal.classList.add('hidden'); modal.classList.remove('flex');
      document.documentElement.style.overflow='';
      form?.reset(); thanks?.classList.add('hidden');
      if (errEl){ errEl.textContent=''; errEl.classList.add('sr-only'); }
      email?.setAttribute('aria-invalid','false');
      modal.setAttribute('aria-hidden','true');
      lastFocus?.focus?.();
      try { (window.dataLayer = window.dataLayer || []).push({ event:'newsletter_close', scope:SCOPE }); } catch {}
    }, 160);
  }

  // Triggers
  if (DELAY_SEC>0 && eligible()) setTimeout(()=>{ if(eligible()) openModal(false); }, DELAY_SEC*1000);
  const tryHash = ()=>{ if ((location.hash||'').replace(/^#/,'')==='newsletter') openModal(true); };
  addEventListener('hashchange', tryHash, { passive:true }); tryHash();

  // Delegated open/close
  root.addEventListener('click', (e)=>{
    const o = e.target.closest?.('[data-open-newsletter]');
    const c = e.target.closest?.('[data-newsletter-close]');
    if (o){ e.preventDefault(); openModal(true); }
    if (c){ e.preventDefault(); try{ localStorage.setItem(K('optout'),'1'); }catch{} closeModal(); }
  }, { passive:false });

  // Scroll %
  if (SCROLL_PCT>0){
    const onScroll=()=>{
      const pct = (scrollY / Math.max(1, document.documentElement.scrollHeight - innerHeight)) * 100;
      if (pct >= SCROLL_PCT && eligible()){ openModal(false); removeEventListener('scroll', onScroll); }
    };
    addEventListener('scroll', onScroll, { passive:true });
  }

  // Exit intent
  if (EXIT_INTENT){
    const onLeave=(e)=>{ if (e.clientY <= 0 && eligible()){ openModal(false); removeEventListener('mouseout', onLeave); } };
    addEventListener('mouseout', onLeave, { passive:true });
  }

  // Backdrop + Esc
  modal.addEventListener('click', e => { if (e.target === modal) closeModal(); }, { passive:true });
  addEventListener('keydown', e => { if (e.key==='Escape' && !modal.classList.contains('hidden')) closeModal(); });

  // Focus trap
  modal.addEventListener('keydown', e=>{
    if (e.key!=='Tab') return;
    const f = modal.querySelectorAll('a,button,input,select,textarea,[tabindex]:not([tabindex="-1"])');
    if (!f.length) return;
    const first = f[0], last = f[f.length-1];
    if (e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
    else if (!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
  });

  // Live validation + suggestion
  email?.addEventListener('input', ()=>{
    clearTimeout(debounceId);
    debounceId = setTimeout(()=>{
      const v = email.value.trim();
      const hint = suggestDomain(v);
      if (hintEl){
        hintEl.textContent = (hint && isEmail(hint)) ? `Did you mean ${hint}?` : '';
        hintEl.style.cursor = hint ? 'pointer' : '';
        if (hint && !hintEl.__bound){
          hintEl.addEventListener('click', ()=>{ email.value = hint; hintEl.textContent=''; email.dispatchEvent(new Event('input')); });
          hintEl.__bound = true;
        }
      }
      if (!v){ if (errEl){errEl.textContent=''; errEl.classList.add('sr-only');} email.setAttribute('aria-invalid','false'); return; }
      if (!isEmail(v)){ if (errEl){ errEl.textContent='Please enter a valid email address.'; errEl.classList.remove('sr-only'); } email.setAttribute('aria-invalid','true'); }
      else { if (errEl){ errEl.textContent=''; errEl.classList.add('sr-only'); } email.setAttribute('aria-invalid','false'); }
    }, 160);
  });

  // Offline queue
  const qkey = K('queue');
  const enqueue = (obj)=>{ try{ const q=JSON.parse(localStorage.getItem(qkey)||'[]'); q.push(obj); localStorage.setItem(qkey, JSON.stringify(q)); }catch{} };
  async function postJSON(payload, timeout=7000){
    if (!action) return false;
    const ctl = new AbortController(); const t = setTimeout(()=>ctl.abort(), timeout);
    try{
      const res = await fetch(action, {
        method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'},
        body:JSON.stringify(payload), credentials:'same-origin', signal:ctl.signal
      });
      clearTimeout(t); return res.ok;
    }catch{ clearTimeout(t); return false; }
  }
  async function flushQueue(){
    try{
      const q = JSON.parse(localStorage.getItem(qkey)||'[]'); if(!q.length) return;
      const next = q.shift(); const ok = await postJSON(next);
      if (ok){ localStorage.setItem(qkey, JSON.stringify(q)); if (q.length) setTimeout(flushQueue, 500); }
    }catch{}
  }
  addEventListener('online', flushQueue, { passive:true });

  // Hash email (SHA-256 when available)
  async function hashEmail(v){
    try{
      if (crypto?.subtle){
        const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(String(v)));
        return 'sha256_' + Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
      }
    }catch{}
    // tiny fallback
    let h=0; for (let i=0;i<String(v).length;i++) h=(h*31 + v.charCodeAt(i))>>>0;
    return 'h' + h.toString(16);
  }

  // Submit
  form?.addEventListener('submit', async (e)=>{
    e.preventDefault();

    const dwell = now() - start;
    const eVal = (email?.value || '').trim();
    const iVal = (invite?.value || '').trim();

    if (hp && hp.value) { closeModal(); return; }
    if (dwell < MIN_DWELL_MS){
      if (errEl){ errEl.textContent='Please take a moment and try again.'; errEl.classList.remove('sr-only'); }
      return;
    }
    if (!isEmail(eVal)){
      if (errEl){ errEl.textContent='Please enter a valid email address.'; errEl.classList.remove('sr-only'); }
      email?.setAttribute('aria-invalid','true'); return;
    }

    if (errEl){ errEl.textContent=''; errEl.classList.add('sr-only'); }
    email?.setAttribute('aria-invalid','false');

    const orig = submitB?.getAttribute('data-label') || submitB?.textContent || '';
    if (submitB){ submitB.disabled=true; submitB.classList.add('opacity-60','pointer-events-none'); submitB.textContent=submitB.getAttribute('data-busy')||'Subscribing…'; }
    email && (email.disabled = true); invite && (invite.disabled = true);

    const payload = {
      email: eVal, invite: iVal || undefined,
      source_url: modal.querySelector('#nl-source-url')?.value || '',
      referrer:   modal.querySelector('#nl-referrer')?.value || '',
      utm: (()=>{ try{ return JSON.parse(modal.querySelector('#nl-utm')?.value || '{}'); }catch{ return {}; } })(),
      t_opened: openedAt || null, t_submitted: now()
    };

    let ok=false;
    if (navigator.onLine) {
      ok = await postJSON(payload);
      if (!ok && !action){
        try{
          location.href = `mailto:news@example.org?subject=Newsletter%20Subscribe&body=${encodeURIComponent(eVal)}${iVal? '%0AInvite:%20'+encodeURIComponent(iVal):''}`;
          ok = true;
        }catch{}
      }
    } else {
      enqueue(payload); ok = true;
    }

    if (ok){
      thanks?.classList.remove('hidden');
      confFx && (confFx.style.opacity = 1, setTimeout(()=> confFx.style.opacity = 0, 900));
      try { localStorage.setItem(K('subscribed'),'1'); } catch {}
      try {
        const h = await hashEmail(eVal);
        (window.dataLayer = window.dataLayer || []).push({ event:'newsletter_subscribed', scope:SCOPE, email_hash:h });
      } catch {}
      setTimeout(closeModal, 1200);
    } else {
      if (errEl){ errEl.textContent='Something went wrong. Please try again soon.'; errEl.classList.remove('sr-only'); }
      if (submitB){ submitB.disabled=false; submitB.classList.remove('opacity-60','pointer-events-none'); submitB.textContent=orig; }
      email && (email.disabled = false); invite && (invite.disabled = false);
    }
  });

  // Kick queued sends (if any)
  flushQueue().catch(()=>{});
}

// Optional auto-init (safe to include multiple times)
if (typeof document !== 'undefined') {
  const boot = () => initNewsletterModal();
  document.readyState !== 'loading'
    ? boot()
    : document.addEventListener('DOMContentLoaded', boot, { once:true });
}

