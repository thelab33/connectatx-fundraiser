{# =====================================================================
   ui_bootstrap.html  —  FundChamps Prestige UI Utilities
   - Silicon Valley–level drop-in: CSP-safe, SaaS-clean, HTMX-friendly
   - Provides: NONCE-safe <script>/<style> macros, event bus, polling
   - Centralized so every partial stays lean & consistent
   ===================================================================== #}

{# ---------- Safe Vars ---------- #}
{% set NONCE      = NONCE if NONCE is defined else (csp_nonce() if csp_nonce is defined else '') %}
{% set _stats_url = stats_url|default('/demo/stats') %}
{% set _poll_ms   = poll_ms|default(15000) %}
{% set _autostats = autostats if autostats is defined else true %}

{# ---------- Script & Style Macros ---------- #}
{% macro script_open(async=false, defer=false) -%}
  <script nonce="{{ NONCE }}"{% if async %} async{% endif %}{% if defer %} defer{% endif %}>
{%- endmacro %}

{% macro script_close() -%}
  </script>
{%- endmacro %}

{% macro style_open() -%}
  <style nonce="{{ NONCE }}">
{%- endmacro %}

{% macro style_close() -%}
  </style>
{%- endmacro %}

{# ---------- Event Bus (HTMX + Socket.IO friendly) ---------- #}
{{ script_open() }}
window.fcBus = window.fcBus || {
  emit: (evt, data) => document.dispatchEvent(new CustomEvent(evt, { detail: data })),
  on:   (evt, cb)   => document.addEventListener(evt, e => cb(e.detail)),
  once: (evt, cb)   => {
    const fn = e => { cb(e.detail); document.removeEventListener(evt, fn); };
    document.addEventListener(evt, fn);
  }
};
{{ script_close() }}

{# ---------- Poller (auto stats refresh, extendable) ---------- #}
{% if _autostats %}
  {{ script_open() }}
  (function(){
    async function fetchStats(){
      try {
        const res = await fetch("{{ _stats_url }}", { headers: { "X-Requested-With": "fetch" } });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const json = await res.json();
        window.fcBus.emit("fc:funds:update", json);
      } catch(e) {
        console.warn("⚠️ Stats fetch failed:", e);
      }
    }
    // initial fire
    fetchStats();
    // repeat poll
    setInterval(fetchStats, {{ _poll_ms|int }});
  })();
  {{ script_close() }}
{% endif %}

{# ---------- Progressive Enhancements ---------- #}
{{ script_open() }}
// CSP-safe helpers (nonce applied)
window.fcUX = window.fcUX || {
  // Confetti burst for VIP sponsor
  confetti: (opts={}) => {
    if (!window.confetti) return;
    const def = { particleCount: 80, spread: 70, origin: { y: 0.6 } };
    window.confetti(Object.assign(def, opts));
  },
  // Smooth scroll to target
  scrollTo: (id) => {
    const el = document.getElementById(id);
    if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
  },
  // Quick a11y announcer (screenreader friendly)
  announce: (msg, politeness="polite") => {
    let live = document.getElementById("fc-live");
    if (!live) {
      live = document.createElement("div");
      live.id = "fc-live";
      live.setAttribute("aria-live", politeness);
      live.className = "sr-only";
      document.body.appendChild(live);
    }
    live.textContent = msg;
  }
};
{{ script_close() }}

{# ---------- Minimal a11y SR container ---------- #}
<div id="fc-live" class="sr-only" aria-live="polite"></div>

