{# -----------------------------------------------------------------------------
  Base layout — FundChamps Prestige Elite (SV-Premium, refined)
  - CSP-safe NONCE, optional SRI + preconnects
  - Single CSS payload (tailwind.min.css)
  - Donate-aware SEO, OG/Twitter, canonical, theme-color sync
  - Header shrink sentinel included (id="site-header-sentinel")
  - Enhancements:
      1) Header sentinel element
      2) JSON-LD (Organization + DonateAction)
      3) Theme-color auto-sync (brand + color-scheme)
      4) Metrics beacons (impression + click)
      5) PWA hooks (manifest + SW registration, guarded)
----------------------------------------------------------------------------- #}
{% set NONCE = NONCE if NONCE is defined else (csp_nonce() if csp_nonce is defined else '') %}
{% set _ver = ASSET_VER if ASSET_VER is defined else (ASSET_VERSION if ASSET_VERSION is defined else (VERSION if VERSION is defined else None)) %}
{% set SRI = SRI if SRI is defined else {} %}
{% set _route = (request.endpoint if request is defined else '') %}
{% set _TEAM = (team if team is defined else (_team if _team is defined else {})) %}
{% set _brand_hex = _TEAM.theme_color if _TEAM and _TEAM.theme_color else '#facc15' %}
{% set _brand_name = _TEAM.team_name if _TEAM and _TEAM.team_name else 'Connect ATX Elite' %}
{% set _brand_slug = (_TEAM.team_slug if _TEAM and _TEAM.team_slug else _brand_name)|lower|replace(' ', '-')|replace('--','-') %}
{% set _title_default = _brand_name %}
{% set _desc_default = 'Fuel the season. Fund the future.' %}
{% set _is_donate = (_route == 'main.donate') %}
{% set _page_title = ( (_is_donate and (_TEAM.og_title_donate if _TEAM and _TEAM.og_title_donate)) or
                       (_TEAM.og_title if _TEAM and _TEAM.og_title) or
                       (_is_donate and _brand_name ~ ' — Donate') or
                       (_brand_name ~ ' — Fundraiser') ) %}
{% set _page_desc = ( (_is_donate and (_TEAM.og_description_donate if _TEAM and _TEAM.og_description_donate)) or
                      (_TEAM.og_description if _TEAM and _TEAM.og_description) or
                      _desc_default ) %}
{% set _hero_img = _TEAM.hero_image or _TEAM.hero_bg or 'images/hero.avif' %}
{% set _og_img = _TEAM.og_image or 'images/og_default.jpg' %}

{# Versioned asset URLs #}
{% set href_tailwind = url_for('static', filename='css/tailwind.min.css', v=_ver) if _ver else url_for('static', filename='css/tailwind.min.css') %}
{% set js_href       = url_for('static', filename='js/bundle.min.js', v=_ver)      if _ver else url_for('static', filename='js/bundle.min.js') %}
{% set js_donate     = url_for('static', filename='js/donate.min.js', v=_ver)      if _ver else url_for('static', filename='js/donate.min.js') %}

{# Optional SRI #}
{% set sri_css     = SRI.get('css/tailwind.min.css') if SRI else None %}
{% set sri_js_main = SRI.get('js/bundle.min.js') if SRI else None %}
{% set sri_js_don  = SRI.get('js/donate.min.js') if SRI else None %}

{# Optional PWA manifest path (set WEB_MANIFEST in context/config to enable) #}
{% set _manifest = WEB_MANIFEST if WEB_MANIFEST is defined else None %}

<!doctype html>
<html
  lang="en"
  class="h-full antialiased scroll-smooth selection:bg-yellow-300/30"
  data-theme="dark"
  data-brand="{{ _brand_slug }}"
  data-route="{{ _route|default('') }}"
>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <meta name="color-scheme" content="dark light" />
    <meta name="theme-color" content="#0b0b0c" id="meta-theme-color" />
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <meta name="robots" content="index,follow,max-image-preview:large" />
    {% if request is defined %}
      <link rel="canonical" href="{{ request.base_url }}" />
      <meta property="og:url" content="{{ request.base_url }}" />
    {% endif %}

    <title>{% block title %}{{ _page_title }}{% endblock %}</title>
    <meta name="description" content="{{ _page_desc }}" />

    {# --- OG/Twitter --- #}
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="{{ _brand_name }}" />
    <meta property="og:title" content="{{ _page_title }}" />
    <meta property="og:description" content="{{ _page_desc }}" />
    <meta property="og:image" content="{{ url_for('static', filename=_og_img, v=_ver) if _ver else url_for('static', filename=_og_img) }}" />
    <meta property="og:locale" content="en_US" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="{{ _page_title }}" />
    <meta name="twitter:description" content="{{ _page_desc }}" />
    <meta name="twitter:image" content="{{ url_for('static', filename=_og_img, v=_ver) if _ver else url_for('static', filename=_og_img) }}" />

    {# --- PWA hooks (enhancement #5) --- #}
    {% if _manifest %}
      <link rel="manifest" href="{{ url_for('static', filename=_manifest, v=_ver) if _ver else url_for('static', filename=_manifest) }}">
      <meta name="apple-mobile-web-app-capable" content="yes">
      <meta name="mobile-web-app-capable" content="yes">
    {% endif %}

    {# Preconnects (idle) — Stripe, Socket, YouTube #}
    <link rel="preconnect" href="https://js.stripe.com" crossorigin>
    <link rel="preconnect" href="/socket.io/" crossorigin>
    <link rel="preconnect" href="https://www.youtube-nocookie.com" crossorigin>
    <link rel="dns-prefetch" href="https://js.stripe.com">
    <link rel="dns-prefetch" href="https://www.youtube-nocookie.com">

    {# Useful LCP hint if hero image exists #}
    {% if url_for is defined and _hero_img %}
      <link rel="preload" as="image" href="{{ url_for('static', filename=_hero_img, v=_ver) if _ver else url_for('static', filename=_hero_img) }}" imagesizes="100vw">
    {% endif %}

    {# --- SINGLE CSS PIPELINE --- #}
    <link rel="preload" as="style" href="{{ href_tailwind }}"{% if sri_css %} integrity="{{ sri_css }}" crossorigin="anonymous"{% endif %} />
    <link rel="stylesheet" href="{{ href_tailwind }}"{% if sri_css %} integrity="{{ sri_css }}" crossorigin="anonymous"{% endif %} />

    {# Lock 1rem and add optional fluid heading helpers — no global clamps elsewhere #}
    <style nonce="{{ NONCE }}">
      html { font-size: 16px; text-rendering: optimizeLegibility; }
      .text-fluid-h1 { font-size: clamp(1.75rem, 1.1rem + 2.2vw, 2.75rem); }
      .text-fluid-h2 { font-size: clamp(1.25rem, 1rem + 1.2vw, 1.75rem); }
      @media (prefers-reduced-motion: reduce) {
        .fc-reveal { transition: none !important; }
      }
    </style>

    {# --- Structured Data (enhancement #2) --- #}
    <script type="application/ld+json" nonce="{{ NONCE }}">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": {{ _brand_name|tojson }},
      "url": {{ (request.base_url if request is defined else '/')|tojson }},
      "brand": {{ _brand_name|tojson }},
      "sameAs": [],
      "logo": {{ url_for('static', filename=_og_img, v=_ver) if _ver else url_for('static', filename=_og_img) | tojson }}
    }
    </script>
    {% if _is_donate %}
    <script type="application/ld+json" nonce="{{ NONCE }}">
    {
      "@context": "https://schema.org",
      "@type": "DonateAction",
      "name": "Donate to {{ _brand_name }}",
      "target": {{ (request.base_url if request is defined else '/donate')|tojson }},
      "actionStatus": "https://schema.org/PotentialActionStatus"
    }
    </script>
    {% endif %}

    {% block extra_css %}{% endblock %}
    {% block head %}{% endblock %}
  </head>

  <body class="min-h-full bg-zinc-950 text-zinc-100">
    <a id="skip-to-content" href="#main" class="sr-only focus:not-sr-only focus:fixed focus:top-2 focus:left-2">Skip to content</a>

    {# Header shrink sentinel (enhancement #1) #}
    <div id="site-header-sentinel" aria-hidden="true" class="h-0 w-full"></div>

    {# Header section (global) #}
    {% include "partials/header_and_announcement.html" ignore missing with context %}

    <main id="main" role="main" class="relative">
      <h1 class="sr-only">{% block h1 %}{{ _brand_name }}{% endblock %}</h1>
      {% block content %}{% endblock %}
    </main>

    {# Footer section (global) #}
    {% include "partials/footer.html" ignore missing with context %}

    {# -- Modals & Misc (do not block page load, ignore missing) -- #}
    {% include "partials/donation_modal.html" ignore missing %}
    {% include "partials/newsletter.html" ignore missing %}

    {# Core JS script for Tailwind and other features #}
    <script src="{{ js_href }}" defer nonce="{{ NONCE }}"{% if sri_js_main %} integrity="{{ sri_js_main }}" crossorigin="anonymous"{% endif %}></script>
    {% if _is_donate %}
      <script src="{{ js_donate }}" defer nonce="{{ NONCE }}"{% if sri_js_don %} integrity="{{ sri_js_don }}" crossorigin="anonymous"{% endif %}></script>
    {% endif %}

    {% block extra_js %}{% endblock %}

    {# Elite polish: Ripple, reveal on scroll, back-to-top ring, theme/meta sync, metrics, PWA (enhancements #3–#5) #}
    <script nonce="{{ NONCE }}">
    (() => {
      if (window.__fcPolish) return; window.__fcPolish = true;

      const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      // --- Theme/meta sync (enhancement #3)
      const BRAND = '{{ _brand_hex }}';
      const metaTheme = document.querySelector('#meta-theme-color');
      const setThemeColor = () => {
        const dark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        // darker UI chrome in dark mode, brand tint in light
        metaTheme && (metaTheme.content = dark ? '#0b0b0c' : BRAND);
        document.documentElement.style.setProperty('--fc-brand', BRAND);
        document.documentElement.style.setProperty('--fc-ring', `color-mix(in srgb, ${BRAND} 65%, transparent)`);
      };
      setThemeColor();
      (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)')).addEventListener?.('change', setThemeColor);

      // --- Cosmetics
      const css = `
        body{ letter-spacing:.002em; -webkit-font-smoothing:antialiased; }
        .tabular-nums{ font-variant-numeric: tabular-nums; }
        .fc-reveal{ opacity:0; transform:translateY(12px); transition:opacity .6s ease, transform .6s ease; }
        .fc-reveal.is-in{ opacity:1; transform:none; }
        .fc-focus{ outline:none; box-shadow: 0 0 0 0px transparent; }
        .fc-focus:focus-visible{ box-shadow:0 0 0 3px var(--fc-ring); border-radius:12px; }
        .fc-btn{ border-radius:999px; font-weight:800; position:relative; overflow:hidden; padding:.7rem 1.1rem; display:inline-flex; align-items:center; gap:.55rem; }
        .fc-btn-primary{ background:linear-gradient(180deg,#fde047,#facc15); color:#0b0b0c; box-shadow:0 10px 30px rgb(250 204 21 / 15%); }
        .fc-btn-ghost{ color:#fff; background: rgb(255 255 255 / 7%); border:1px solid rgb(255 255 255 / 15%); }
        .fc-input{ background:rgb(255 255 255 / 6%); border:1px solid rgb(255 255 255 / 12%); border-radius:12px; padding:.65rem .85rem; color:#fff; }
        .fc-input::placeholder{ color:rgb(255 255 255 /.55); }
      `;
      const style = document.createElement('style'); style.textContent = css; try { style.nonce='{{ NONCE }}'; } catch(e){}
      document.head.appendChild(style);

      const $ = (s, r=document) => r.querySelector(s);
      const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

      // Ripple (skip if reduced motion)
      function attachRipple(){
        if (prefersReduced) return;
        $$('.fc-btn,[data-ripple]').forEach(btn=>{
          if (btn.__rip) return; btn.__rip = true;
          btn.addEventListener('click', e=>{
            const r = document.createElement('span'); r.className='fc-ripple';
            const rect=btn.getBoundingClientRect();
            const x=(e.clientX??(rect.left+rect.width/2))-rect.left;
            const y=(e.clientY??(rect.top+rect.height/2))-rect.top;
            const d=Math.max(rect.width,rect.height)*1.1;
            Object.assign(r.style,{width:d+'px',height:d+'px',left:x+'px',top:y+'px'});
            btn.appendChild(r);
            r.animate([{transform:'translate(-50%,-50%) scale(0)',opacity:.35},{transform:'translate(-50%,-50%) scale(18)',opacity:0}],{duration:650,easing:'cubic-bezier(.22,1,.36,1)'}).onfinish=()=>r.remove();
          }, {passive:true});
        });
      }

      // Reveal on Scroll (skip if reduced motion)
      function attachReveals(){
        if (prefersReduced) return;
        const els=$$('[data-reveal], .fc-reveal').filter(el=>!el.__reveal);
        if(!els.length) return;
        if(!('IntersectionObserver' in window)){ els.forEach(el=>el.classList.add('is-in')); return; }
        const io=new IntersectionObserver(ents=>{
          ents.forEach(ent=>{ if(ent.isIntersecting){ ent.target.classList.add('is-in'); io.unobserve(ent.target);} });
        },{threshold:.14});
        els.forEach(el=>{ el.classList.add('fc-reveal'); io.observe(el); el.__reveal=true; });
      }

      // Metrics beacons (enhancement #4)
      const beacon = (url, data) => {
        try {
          const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
          navigator.sendBeacon && navigator.sendBeacon(url, blob);
        } catch(e) {}
      };
      // Impression on load
      beacon('/metrics/impression', {
        route: document.documentElement.dataset.route || '',
        at: Date.now(),
        brand: document.documentElement.dataset.brand || ''
      });
      // Click tracking for elements with data-track or primary buttons
      document.addEventListener('click', (e) => {
        const el = e.target.closest('[data-track], .fc-btn-primary, [data-cta]');
        if (!el) return;
        beacon('/metrics/click', {
          id: el.getAttribute('data-track') || el.getAttribute('id') || '',
          text: (el.getAttribute('data-cta') || el.textContent || '').trim().slice(0,80),
          at: Date.now()
        });
      }, {passive:true});

      // Bootstrap
      attachRipple(); attachReveals();
      document.addEventListener('DOMContentLoaded',()=>{ attachRipple(); attachReveals(); },{once:true});
      document.addEventListener('htmx:afterSwap',()=>{ attachRipple(); attachReveals(); },{passive:true});

      // PWA service worker (enhancement #5 — guarded, optional)
      {% if _manifest %}
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          // only attempt if /sw.js exists; errors are swallowed
          navigator.serviceWorker.register('/sw.js').catch(()=>{});
        }, {once:true});
      }
      {% endif %}
    })();
    </script>
    <style nonce="{{ NONCE }}">.fc-ripple{position:absolute;border-radius:9999px;transform:translate(-50%,-50%) scale(0);opacity:.35;background:#fff;pointer-events:none}</style>
  </body>
</html>
