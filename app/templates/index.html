{# ============================================================================
  index.html â€” FundChamps Elite (modern, partial-aware)
  Renders in the right order and finds your partials even if filenames differ.
============================================================================ #}
{% extends "base.html" %}
{% import 'partials/_fmt.html' as fmt %}
{% from 'partials/_core_helpers.html' import nonce_attr %}

{# ---------- Feature flags (URL override) ---------- #}
{% set _q   = request.args if request is defined else {} %}
{% set _OFF = ['0','false','off','no','disable'] %}
{% set SHOW_TIERS  = (show_tiers  if show_tiers  is defined else (_q.get('tiers','1')  |lower not in _OFF)) %}
{% set SHOW_IMPACT = (show_impact if show_impact is defined else (_q.get('impact','1') |lower not in _OFF)) %}
{% set SHOW_ABOUT  = (show_about  if show_about  is defined else (_q.get('about','1')  |lower not in _OFF)) %}

{# ---------- Runtime links ---------- #}
{% set SPL         = (stripe_payment_link if stripe_payment_link is defined and stripe_payment_link) or '' %}
{% set HREF_DONATE = SPL or (safe_url_for('main.donate') if (safe_url_for is defined and has_endpoint is defined and has_endpoint('main.donate')) else '/donate') %}

{# ---------- Fundraising math (safe defaults) ---------- #}
{% set GOAL       = (fundraising_goal if fundraising_goal else 50000)|int %}
{% set RAISED     = (funds_raised if funds_raised else 0)|int %}
{% set PCT        = (100.0 * RAISED / (GOAL if GOAL > 0 else 1))|round(1) %}
{% set PCT_CLAMP  = 0 if PCT < 0 else (100 if PCT > 100 else PCT) %}

{# ---------- Title/SEO ---------- #}
{% block title %}{{ fundraiser_title or 'FundChamps | Connect ATX Elite' }}{% endblock %}
{% block h1 %}{% endblock %}

{% block content %}

  {# ===== 0) Sponsor Leaderboard (no extra wrapper to avoid duplicate IDs) ===== #}
  {% include "partials/sponsor_leaderboard.html" ignore missing with context %}

  {# ===== 1) Hero (compact) ===== #}
  {% include "partials/hero_and_fundraiser.html" ignore missing with context %}

  {# ===== 2) Tiers (3-up squares) ===== #}
  {% if SHOW_TIERS %}
    {% include "partials/tiers.html" ignore missing with context %}
  {% endif %}

  {# ===== 3) Impact (collapsible to reduce scroll) ===== #}
  {% if SHOW_IMPACT %}
    <section class="section section--tight container">
      <details class="fc-fold" open>
        <summary>
          <span>Impact Buckets</span>
          <span class="fold-kbd">less scroll</span>
        </summary>
        <div class="fold-body">
          {% include "partials/impact_lockers_premium.html" ignore missing with context %}
        </div>
      </details>
    </section>
  {% endif %}

  {# ===== 4) About (collapsible) ===== #}
  {% if SHOW_ABOUT %}
    <section class="section section--tight container">
      <details class="fc-fold">
        <summary>
          <span>About Our Program</span>
        </summary>
        <div class="fold-body">
          {% include "partials/about_section.html" ignore missing with context %}
        </div>
      </details>
    </section>
  {% endif %}

<script {{ nonce_attr(NONCE) }}>
(() => {
  const links = [...document.querySelectorAll('.local-nav a[href^="#"]')];
  if (!links.length || window.__FC_SPY__) return; window.__FC_SPY__ = true;

  const map = new Map(
    links.map(a => [a, document.querySelector(a.getAttribute('href'))]).filter(([,el])=>!!el)
  );
  const setActive = (a) => links.forEach(l => l.classList.toggle('is-active', l === a));

  const io = new IntersectionObserver((ents) => {
    const vis = ents.filter(e => e.isIntersecting).sort((a,b)=> b.intersectionRatio - a.intersectionRatio)[0];
    if (!vis) return;
    for (const [a, el] of map) if (el === vis.target) { setActive(a); break; }
  }, { rootMargin: "-40% 0px -55% 0px", threshold: [0, .2, .5, .8] });

  map.forEach(el => io.observe(el));
})();
</script>
<style {{ nonce_attr(NONCE) }}>
  .local-nav a.is-active{ font-weight:900; text-decoration:underline; text-underline-offset:4px }
</style>

{% endblock %}

