{% import 'partials/macros.html' as fc with context %}
{% extends "base.html" %}
{% import 'partials/macros.html' as fc with context %}
{% from 'partials/_core_helpers.html' import nonce_attr %}

{# ==== PAGE CONFIG ==== #}
{% set _q   = request.args if request is defined else {} %}
{% set SHELL_MAX = (team.shell_max if team is defined and team.shell_max is defined else shell_max|default(None, true)) %}
{% set panel_val = show_scoreboard if show_scoreboard is defined else _q.get('panel','1') %}
{% set SHOW_SCOREBOARD = panel_val not in ['0','false','off','no','disable','disabled','none','null',''] %}
{% set tmp_SHOW_TIERS = show_tiers      if show_tiers      is defined else _q.get('tiers','1') %}
{% set SHOW_TIERS = tmp_SHOW_TIERS not in ['0','false','off','no','disable','disabled','none','null',''] %}
{% set tmp_SHOW_IMPACT_ABOUT = show_impact_about if show_impact_about is defined else _q.get('impact_about','1') %}
{% set SHOW_IMPACT_ABOUT = tmp_SHOW_IMPACT_ABOUT not in ['0','false','off','no','disable','disabled','none','null',''] %}
{% set SCOREBOARD_PLACE = SCOREBOARD_PLACE|default('prehero') %}
{% set _hero_choice = (_q.get('hero','classic')|lower) %}
{% set HERO_PARTIAL = hero_partial if hero_partial is defined
                      else ('partials/hero_cinematic.html' if _hero_choice == 'cinematic'
                            else 'partials/hero_classic.html') %}

{% set GOAL       = (fundraising_goal if fundraising_goal else 50000)|int %}
{% set RAISED     = (funds_raised if funds_raised else 0)|int %}
{% set PCT        = (100.0 * RAISED / (GOAL if GOAL>0 else 1))|round(1) %}
{% set PCT_CLAMP  = 0 if PCT < 0 else (100 if PCT>100 else PCT) %}

{% set donors       = donors if donors is defined else 0 %}
{% set athletes     = athletes if athletes is defined else (team.athletes if team is defined and team.athletes is defined else 0) %}
{% set trips        = trips if trips is defined else 0 %}
{% set tutor_hours  = tutor_hours if tutor_hours is defined else 0 %}
{% set metrics = metrics if metrics is defined and metrics else {
  "raised": RAISED, "goal": GOAL, "donors": donors,
  "kids": athletes, "trips": trips, "tutor_hours": tutor_hours
} %}

{% block title %}{{ fundraiser_title or 'FundChamps | Connect ATX Elite' }}{% endblock %}
{% block h1 %}{% endblock %}

{% block content %}
  <div class="fcx-main" id="home" data-route="home" data-pct="{{ PCT_CLAMP }}">

    <!-- ===== HERO SECTION ===== -->
    <section id="hero" class="band band--hero" aria-labelledby="hero-title" data-hero>
      <h2 id="hero-title" class="sr-only">Fundraiser Highlight</h2>
      <div class="shell shell--hero" data-animate="fade-up">
        {% include HERO_PARTIAL ignore missing with context %}
      </div>
    </section>

    <!-- ===== IMPACT & SCOREBOARD DASHBOARD ===== -->
    <div class="rail-combo-panel flex flex-col md:flex-row md:gap-6 items-stretch
                max-w-5xl mx-auto -mt-16 md:-mt-24 z-20 relative px-3">
      {% if SHOW_IMPACT_ABOUT %}
        <div class="impact-rail flex-1 bg-zinc-900/95 rounded-2xl shadow-lg p-4 mb-3 md:mb-0">
          {% include "partials/impact_lockers_premium.html" ignore missing with context %}
        </div>
      {% endif %}
      {% if SHOW_SCOREBOARD %}
        <div class="scoreboard-rail flex-1 bg-zinc-900/95 rounded-2xl shadow-lg p-4">
          {% include "partials/_scoreboard_panel.html" ignore missing with context %}
        </div>
      {% endif %}
    </div>

    <!-- ===== QUICK ACTIONS ===== -->
    <div class="quick-actions flex flex-wrap justify-center gap-3 mt-4 mb-2 px-2 max-w-4xl mx-auto">
      {{ fc.cta_btn("Donate Now", "site", classes="fcx-btn fcx-btn-accent") }}
      <a href="#tiers" class="fcx-btn fcx-btn-outline">Become a Sponsor</a>
      {{ fc.share_btn("Share", "main", classes="fcx-btn fcx-btn-dark") }}
    </div>

    <!-- ===== SPONSORSHIP TIERS ===== -->
    {% if SHOW_TIERS %}
      <section id="tiers" class="band band--tiers" aria-labelledby="tiers-title">
        <h2 id="tiers-title" class="sr-only">Sponsorship Tiers</h2>
        <div class="shell shell--tiers" data-animate="fade-up" data-animate-delay="60">
          {% include "partials/tiers.html" ignore missing with context %}
        </div>
      </section>
    {% endif %}
  </div>

  <!-- ======= SAAS UPSELL / FLEX ======= -->
  {% if show_org_dashboard %}{% include "partials/saas_org_dashboard_widget.html" ignore missing with context %}{% endif %}
  {% if show_custom_branding %}{% include "partials/saas_branding_bar.html" ignore missing with context %}{% endif %}
  {% if show_mobile_app_prompt %}{% include "partials/saas_mobile_app_prompt.html" ignore missing with context %}{% endif %}
  {% if show_api_integrations %}{% include "partials/saas_api_integrations_widget.html" ignore missing with context %}{% endif %}
  {% if show_ai_analytics %}{% include "partials/saas_ai_analytics_widget.html" ignore missing with context %}{% endif %}

{% endblock %}

<style {{ nonce_attr() }}>
:root{
  {% if SHELL_MAX %}--fcx-shell-max: {{ SHELL_MAX }};{% endif %}
  --fcx-gutter: clamp(14px, 5vw, 36px);
  --band-gap: clamp(16px, 2vw, 32px);
  --band-vpad: clamp(20px, 4vw, 54px);
  --hero-bg: radial-gradient(120% 80% at 50% -18%, rgba(8,9,13,.85) 0, rgba(6,7,10,.92) 60%, transparent 100%);
  --tiers-bg: linear-gradient(180deg, rgba(15,17,24,.6), rgba(12,14,20,.7));
}
html { overflow-x: clip; }
.sr-only { position:absolute !important; clip:rect(1px,1px,1px,1px); clip-path:inset(50%); width:1px; height:1px; overflow:hidden; white-space:nowrap; border:0; padding:0; }
.fcx-main { width:100%; }
.band { position: relative; left: 50%; right: 50%; margin-left: -50vw; margin-right: -50vw; width: 100vw; margin-bottom: var(--band-gap);}
.band--hero  { background: var(--hero-bg);}
.band--tiers { background: var(--tiers-bg);}
.shell { max-width: var(--fcx-shell-max, none); width: 100%; margin-inline: auto; padding-inline: var(--fcx-gutter); padding-block: var(--band-vpad);}
.shell--hero  { padding-block: max(18px, var(--band-vpad)); }
.shell--tiers { padding-block: max(16px, var(--band-vpad)); }
.rail-combo-panel { margin-bottom: 0.5em; }
@media (max-width: 700px) {
  .rail-combo-panel { flex-direction: column; gap: 0.5em; margin-top: -2em; }
}
.quick-actions .fcx-btn { min-width: 140px; font-size: 1.07em; font-weight: 600;}
.quick-actions { gap: 0.7em; }
</style>

<script {{ nonce_attr() }}>
(() => {
  const header = document.getElementById('site-header');
  if (!header || !('ResizeObserver' in window)) return;
  const root = document.documentElement;
  const setH = () => root.style.setProperty('--fc-header-h', `${header.getBoundingClientRect().height}px`);
  new ResizeObserver(setH).observe(header); setH();
})();
(() => {
  const rm = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const rd = window.matchMedia && window.matchMedia('(prefers-reduced-data: reduce)').matches;
  const els = document.querySelectorAll('[data-animate]');
  if (rm || rd || !('IntersectionObserver' in window)) { els.forEach(el => el.classList.add('is-in')); return; }
  const io = new IntersectionObserver((entries) => {
    for (const e of entries) if (e.isIntersecting) { e.target.classList.add('is-in'); io.unobserve(e.target); }
  }, { rootMargin: '0px 0px -10% 0px', threshold: .1 });
  els.forEach(el => io.observe(el));
})();
</script>

