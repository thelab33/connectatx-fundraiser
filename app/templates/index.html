{# ============================================================================
   index.html — Home Composition (Bulletproof)
   - Extends base.html (base imports ui_bootstrap macros so partials can use them)
   - Flags are merged (defaults ⟶ user flags) so overrides never lose keys
   - Anchors for header nav are guaranteed
   - CSP-safe page script uses script_open/script_close with fallback
   ============================================================================ #}
{% extends "base.html" %}

{# ---------- Page-level safe fallbacks ---------- #}
{% set team_name = (team.team_name if team and team.team_name is defined else "Connect ATX Elite") %}
{% set LITE = (request.args.get("lite") in ("1","true","yes")) if request is defined else false %}
{% set __dev = (app_env|default('development') == 'development') %}

{# ---------- Section Flags (merged) ---------- #}
{% set __defaults = {
  "hero":             true,
  "layout_bands":     false,
  "meter_strip":      true,
  "tiers":            true,
  "program_pulse":    not LITE,
  "funds_allocation": not LITE,
  "impact_lockers":   not LITE,
  "about":            true,
  "impact_challenge": not LITE,
  "testimonials":     not LITE,
  "newsletter":       true,
  "sponsor_hub":      true,
  "ai_concierge":     false
} %}
{% set __incoming = flags if flags is defined and flags else {} %}
{% set FLAGS = __defaults | combine(__incoming) %}

{# ---------- SEO / Head Title ---------- #}
{% block head_title %}{{ team_name }} — Fundraiser{% endblock %}

{# ---------- HERO (Top of Fold) ---------- #}
{% block hero %}
  {% if FLAGS.hero %}
    <div id="top"></div> {# Anchor guaranteed #}
    {% include "partials/hero_and_fundraiser.html" ignore missing %}
  {% elif __dev %}
    <section class="fc-section">
      <div class="fc-card p-6 text-yellow-200/80">⚠️ Hero disabled by flags.hero=false</div>
    </section>
  {% endif %}
{% endblock %}

{# ---------- MAIN CONTENT ---------- #}
{% block content %}

  {% if FLAGS.layout_bands %}
    {% include "partials/layout_bands.html" ignore missing %}
  {% endif %}

  {% if FLAGS.meter_strip %}
    {% include "partials/meter_strip.html" ignore missing %}
  {% endif %}

  <div id="tiers"></div>
  {% if FLAGS.tiers %}
    {% include "partials/tiers.html" ignore missing %}
  {% elif __dev %}
    <section class="fc-section"><div class="fc-card p-6">⚠️ tiers.html missing/disabled</div></section>
  {% endif %}

  <div id="program-stats-calendar"></div>
  {% if FLAGS.program_pulse %}
    {% include "partials/program_stats_and_calendar.html" ignore missing %}
  {% elif __dev %}
    <section class="fc-section"><div class="fc-card p-6">⚠️ program_stats_and_calendar.html missing/disabled</div></section>
  {% endif %}

  {% if FLAGS.funds_allocation %}
    {% include "partials/funds_allocation_bar_premium.html" ignore missing %}
  {% elif __dev and not LITE %}
    <section class="fc-section"><div class="fc-card p-6">⚠️ funds_allocation_bar_premium.html missing/disabled</div></section>
  {% endif %}

  {% if FLAGS.impact_lockers %}
    {% include "partials/impact_lockers_premium.html" ignore missing %}
  {% elif __dev and not LITE %}
    <section class="fc-section"><div class="fc-card p-6">⚠️ impact_lockers_premium.html missing/disabled</div></section>
  {% endif %}

  <div id="mission"></div>
  {% if FLAGS.about %}
    {% include "partials/about_and_mission.html" ignore missing %}
    {% include "partials/about_section.html" ignore missing %}
  {% elif __dev %}
    <section class="fc-section"><div class="fc-card p-6">⚠️ about disabled</div></section>
  {% endif %}

  {% if FLAGS.impact_challenge %}
    {% include "partials/impact_challenge_coaches_premium.html" ignore missing %}
  {% endif %}

  {% if FLAGS.testimonials %}
    {% include "partials/testimonials.html" ignore missing %}
  {% endif %}

  {% if FLAGS.sponsor_hub %}
    {% include "partials/sponsor_hub.html" ignore missing %}
  {% endif %}

{% endblock %}

{# ---------- PAGE-SCOPED SCRIPTS ---------- #}
{% block scripts_extra %}
  {% if FLAGS.ai_concierge %}
    {% include "partials/ai_concierge.html" ignore missing %}
  {% endif %}

  {% if script_open is defined %}{{ script_open() }}{% else %}<script nonce="{{ NONCE }}">{% endif %}
  (function(){
    window.FC = Object.assign({}, window.FC || {}, {
      page: "home",
      team: {{ team_name|tojson }},
      flags: {{ FLAGS|tojson }}
    });
    {% if __dev %}
      const missing = [];
      function probe(id, path){ if(!document.querySelector(id)){ missing.push(path); } }
      probe('#mission', 'partials/about_and_mission.html');
      probe('#program-stats-calendar', 'partials/program_stats_and_calendar.html');
      if (missing.length) console.warn('FundChamps: missing or anchor-less partials:', missing);
    {% endif %}
  })();
  {% if script_close is defined %}{{ script_close() }}{% else %}</script>{% endif %}
{% endblock %}

