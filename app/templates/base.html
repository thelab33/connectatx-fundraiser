{# ============================================================================
   base.html — FundChamps • SV-Elite 5.x (P2P • CSP-safe • Shopify-ready)
   - Tight rhythm & seam math (no scattered gaps)
   - Asset macros (SRI passthrough), absolute URL helpers, nonces
   - P2P param persistence + safe link decoration
   - SEO/OG/Twitter + JSON-LD (Organization, optional Person, DonateAction)
   - A11y: skip link, polite live region, scroll-margin, focus styles
   - Perf: forged-hero preloads, preconnects, reduced-motion/data guards
   - Skin toggle: set <html data-skin="shopify"> for Apple/Nike vibe
   - Starforge brand spine (optional include) for surprise brand placement
   ========================================================================== #}
{% set _TEAM        = team|default(_team|default({})) %}
{% set _brand_hex   = _TEAM.theme_color|default('#f2c94c') %}
{% set _brand_name  = _TEAM.team_name|default('Connect ATX Elite') %}
{% set LOCALE       = LOCALE|default('en_US') %}
{% set _route       = request.endpoint if request is defined else '' %}
{% set _is_donate   = (_route == 'main.donate') %}
{% set _ver         = ASSET_VER|default(ASSET_VERSION|default(VERSION|default(None))) %}
{% set SRI          = SRI|default({}) %}
{% set NONCE        = NONCE|default(csp_nonce() if csp_nonce is defined else '') %}
{% set _favicon     = _TEAM.favicon|default('images/favicon.svg') %}
{% set _apple_icon  = _TEAM.apple_icon|default('images/apple-touch-icon.png') %}
{% set USE_SOCKETIO = USE_SOCKETIO|default(false) %}
{% set _manifest    = WEB_MANIFEST|default(None) %}
{% set GA_ID        = GA_ID|default(None) %}
{% set POSTHOG_KEY  = POSTHOG_KEY|default(None) %}
{% set POSTHOG_HOST = POSTHOG_HOST|default('https://app.posthog.com') %}
{% set SKIN         = SKIN|default('default') %}

{# ---------- helpers ---------- #}
{% macro _slugify(s) -%}
  {%- if s -%}{{ s|string|lower|replace(' ', '-')|replace('_', '-')|replace('--','-')|trim('-') }}{%- endif -%}
{%- endmacro %}
{% set _brand_slug = _slugify(_TEAM.team_slug|default(_brand_name)) %}

{% macro nonce_attr() -%}nonce="{{ NONCE }}"{%- endmacro %}
{% macro sri(path)   -%}{{ SRI.get(path) if SRI else None }}{%- endmacro %}
{% macro asset(path) -%}
  {%- if path and path|length -%}{{ url_for('static', filename=path, v=_ver if _ver else None) }}{%- endif -%}
{%- endmacro %}
{% macro asset_abs(path) -%}
  {%- set rel = asset(path) -%}
  {%- if rel and (rel[:4]=='http' or rel[:2]=='//') -%}{{ rel }}
  {%- elif request is defined and rel -%}{{ request.url_root ~ rel.lstrip('/') }}
  {%- else -%}{{ rel or '' }}{%- endif -%}
{%- endmacro %}
{% macro abs_url(u) -%}
  {%- if not u -%}{{ '' }}
  {%- elif u[:4]=='http' or u[:2]=='//' -%}{{ u }}
  {%- elif request is defined -%}{{ request.url_root ~ u.lstrip('/') }}
  {%- else -%}{{ u }}{%- endif -%}
{%- endmacro %}

{# ---------- P2P (peer/campaign) ---------- #}
{% set PEER          = peer|default(_peer|default({})) %}
{% set P2P_CAMPAIGN  = campaign|default(_campaign|default({})) %}
{% set _peer_name    = PEER.display_name|default(PEER.name|default(None)) %}
{% set _peer_slug    = _slugify(PEER.slug|default(_peer_name|default(''))) %}
{% set _peer_img     = PEER.og_image|default(PEER.avatar_url|default(PEER.photo_url|default(None))) %}
{% set _camp_title   = P2P_CAMPAIGN.title|default(None) %}
{% set _camp_img     = P2P_CAMPAIGN.og_image|default(P2P_CAMPAIGN.cover_image|default(None)) %}
{% set _og_brand_img = _TEAM.og_image|default('images/og_default.jpg') %}
{% set _is_p2p       = (_peer_name or _camp_title) and true or false %}

{# ---------- SEO strings ---------- #}
{% set _desc_default = 'Fuel the season. Fund the future.' %}
{% set _base_title = (
      _is_donate and _TEAM.og_title_donate
   ) or _TEAM.og_title
   or (_is_donate and (_brand_name ~ ' — Donate'))
   or (_brand_name ~ ' — Fundraiser')
%}
{% set _p2p_title = (_peer_name and (_peer_name ~ ' — ' ~ _brand_name)) or (_camp_title and (_camp_title ~ ' — ' ~ _brand_name)) or None %}
{% set _page_title = _p2p_title or _base_title %}
{% set _base_desc = (_is_donate and _TEAM.og_description_donate) or _TEAM.og_description or _desc_default %}
{% set _p2p_desc  = PEER.tagline|default(PEER.bio|default(None)) or P2P_CAMPAIGN.tagline|default(P2P_CAMPAIGN.summary|default(None)) or None %}
{% set _page_desc = _p2p_desc or _base_desc %}
{% set _og_img    = _peer_img or _camp_img or _og_brand_img %}
{% set _og_img_abs= asset_abs(_og_img) %}

<!doctype html>
<html lang="en"
      class="h-full antialiased selection:bg-white/20"
      data-theme="dark" data-brand="{{ _brand_slug }}" data-route="{{ _route|default('') }}" data-skin="{{ SKIN }}">
<head>
  <!-- Core meta -->
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, interactive-widget=resizes-content"/>
  <meta name="color-scheme" content="dark light"/>
  <meta name="referrer" content="strict-origin-when-cross-origin"/>
  <meta name="robots" content="index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1"/>
  <meta name="format-detection" content="telephone=no,address=no,email=no"/>
  <meta name="csrf-token" content="{{ (csrf_token() if csrf_token is defined else '') }}"/>

  <!-- PWA bars (auto-tuned below) -->
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="{{ _brand_hex }}"/>
  <meta name="theme-color" media="(prefers-color-scheme: dark)"  content="#0b0b0c" id="meta-theme-color"/>

  {% if request is defined %}
    <link rel="canonical" href="{{ request.base_url }}"/>
    <meta property="og:url" content="{{ request.base_url }}"/>
  {% endif %}

  <!-- SEO / Social -->
  <title>{% block title %}{{ _page_title }}{% endblock %}</title>
  <meta name="description" content="{{ _page_desc }}"/>
  <meta property="og:type" content="{{ _is_p2p and 'profile' or 'website' }}"/>
  <meta property="og:site_name" content="{{ _brand_name }}"/>
  <meta property="og:title" content="{{ _page_title }}"/>
  <meta property="og:description" content="{{ _page_desc }}"/>
  <meta property="og:image" content="{{ _og_img_abs }}"/>
  <meta property="og:image:alt" content="{{ _brand_name }}"/>
  <meta property="og:locale" content="{{ LOCALE }}"/>
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:title" content="{{ _page_title }}"/>
  <meta name="twitter:description" content="{{ _page_desc }}"/>
  <meta name="twitter:image" content="{{ _og_img_abs }}"/>
  <meta name="twitter:image:alt" content="{{ _brand_name }}"/>
  {% if _TEAM.twitter %}<meta name="twitter:site" content="{{ _TEAM.twitter }}"/>{% endif %}

  <!-- Icons -->
  <link rel="icon" type="image/svg+xml" href="{{ asset(_favicon) }}"/>
  <link rel="alternate icon" type="image/png" href="{{ asset('images/favicon.png') }}"/>
  <link rel="apple-touch-icon" href="{{ asset(_apple_icon) }}"/>
  <meta name="apple-mobile-web-app-title" content="{{ _brand_name }}"/>

  {% if _manifest %}
    <link rel="manifest" href="{{ asset(_manifest) }}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  {% endif %}

  <!-- Hints -->
  <link rel="preconnect" href="https://js.stripe.com" crossorigin>
  <link rel="preconnect" href="https://checkout.stripe.com" crossorigin>
  <link rel="dns-prefetch" href="https://js.stripe.com">
  <link rel="dns-prefetch" href="https://checkout.stripe.com">
  {% if POSTHOG_KEY %}<link rel="preconnect" href="{{ POSTHOG_HOST }}" crossorigin>{% endif %}
  {% if USE_SOCKETIO %}<link rel="preconnect" href="/socket.io/" crossorigin>{% endif %}
  {% if request is defined %}<link rel="preconnect" href="{{ request.url_root }}">{% endif %}

  {# LCP image hint:
     - if a custom hero is provided, just preload that
     - otherwise hint the forged hero set (AVIF) by convention at /static/images/hero/*
  #}
  {% if hero_image_url is defined and hero_image_url %}
    <link rel="preload" as="image" href="{{ hero_image_url }}" fetchpriority="high" imagesrcset="{{ hero_image_url }}">
  {% else %}
    <link rel="preload" as="image"
          href="{{ asset('images/hero/hero-1920.avif') }}"
          imagesizes="100vw"
          imagesrcset="{{ asset('images/hero/hero-1920.avif') }} 1920w, {{ asset('images/hero/hero-1280.avif') }} 1280w, {{ asset('images/hero/hero-960.avif') }} 960w"
          fetchpriority="high">
  {% endif %}

  <!-- CSS bundles -->
  <link rel="stylesheet" href="{{ asset('css/app.min.css') }}"
        {% if sri('css/app.min.css') %}integrity="{{ sri('css/app.min.css') }}" crossorigin="anonymous"{% endif %}/>
  <link rel="stylesheet" href="{{ asset('css/starforge.min.css') }}"
        {% if sri('css/starforge.min.css') %}integrity="{{ sri('css/starforge.min.css') }}" crossorigin="anonymous"{% endif %}/>
  <link rel="preload" href="{{ asset('css/fc_elite.css') }}" as="style">
  <link rel="stylesheet" href="{{ asset('css/fc_elite.css') }}"
        {% if sri('css/fc_elite.css') %}integrity="{{ sri('css/fc_elite.css') }}" crossorigin="anonymous"{% endif %}/>

  {# Shopify skin (optional) #}
  {% if SKIN == 'shopify' %}
    {% include "partials/_shopify_head_include.html" ignore missing %}
  {% endif %}

  {# Starforge brand spine (optional assets; safe if 404) #}
  <link rel="stylesheet" href="{{ asset('starforge/brand-spine.css') }}">
  <link rel="modulepreload" href="{{ asset('starforge/enable-brand-spine.js') }}">

  {# ---------------- Layout layer (tight rhythm + seam math tokens) ---------------- #}
  <style {{ nonce_attr() }}>
    :root{
      --fc-brand: {{ _brand_hex }}; --fc-gold: var(--fc-brand);
      --fc-ink:#0B0B10; --fc-ash:#1B1E26; --fc-coal:#111318;

      --container-max: 1200px; --container-reading: 72ch;
      --radius-xl: 1.25rem;
      --gutter: clamp(16px, 3vw, 28px);
      --section-y: clamp(1.6rem, 3.6vw, 3.2rem);
      --section-y-tight: calc(var(--section-y) * .65);

      /* sticky stack (header + ticker) – filled by seam script */
      --fc-header-h: 72px; --sticky-offset: var(--fc-header-h);

      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    .container{ max-width:var(--container-max); margin-inline:auto; padding-inline:var(--gutter); }
    .container-wide{ max-width: calc(var(--container-max) + 180px); }
    .container-narrow{ max-width:min(var(--container-reading), var(--container-max)); }

    .section{ padding-block: var(--section-y); }
    .section--tight{ padding-block: var(--section-y-tight); }
    .section--loose{ padding-block: calc(var(--section-y) * 1.35); }
    .section--flush-top{ padding-top:0 !important; }

    .seam-header{ margin-top: calc(-1 * var(--sticky-offset)); padding-top: var(--sticky-offset); }
    .seam-after-hero{ padding-top: calc(var(--section-y-tight) * .5); }
    .section + .section{ padding-top: var(--section-y-tight); }

    html{ scroll-padding-top: var(--fc-header-h); }
    section[aria-labelledby], section[id]{ scroll-margin-top: var(--sticky-offset); }

    .bleed-x{ position:relative; left:50%; right:50%; margin-left:-50vw; margin-right:-50vw; width:100vw; }
    .stack > * + *{ margin-top: clamp(.6rem, .7vw, .9rem); }
    .tight > * + *{ margin-top: .55rem; }

    .bg-ash{ background: var(--fc-ash); }
    .bg-coal{ background: var(--fc-coal); }
    .bg-gold{ background: var(--fc-gold); }
    .text-ink{ color: var(--fc-ink); }
    .text-gold{ color: var(--fc-gold); }

    .card{
      background: linear-gradient(180deg,#161922 0%, #0F1117 100%);
      border:1px solid rgba(255,255,255,.07);
      border-radius: var(--radius-xl);
      padding: clamp(.9rem, 1.2vw, 1.25rem);
      display:flex; flex-direction:column;
      box-shadow: 0 14px 36px rgba(0,0,0,.28);
    }
    .card > .grow{ flex:1; }
    .badge{
      display:inline-flex; align-items:center; gap:.5rem;
      background: color-mix(in srgb, var(--fc-gold) 12%, transparent);
      color: var(--fc-gold);
      border:1px solid color-mix(in srgb, var(--fc-gold) 35%, transparent);
      padding:.35rem .6rem; border-radius:999px; font-weight:600; font-size:.8rem;
    }
    .divider{ height:1px; background:rgba(255,255,255,.06) }
    .shadow-soft{ box-shadow:0 10px 30px rgba(0,0,0,.35) }

    .section h2{ margin:0; line-height:1.04; font-weight:900; letter-spacing:.01em }
    .section h2 + p{ margin-top: clamp(.35rem, .5vw, .6rem) }

    html, body{ overflow-x:hidden; }
    .section[data-lazy]{ content-visibility:auto; contain-intrinsic-size:600px; }

    :focus-visible{ outline:2px solid color-mix(in srgb, var(--fc-gold) 65%, transparent); outline-offset:2px; }
    .sr-only{ position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0 }

    @media (prefers-reduced-motion: reduce){
      *{ animation-duration:.001ms !important; animation-iteration-count:1 !important; transition-duration:.001ms !important; scroll-behavior:auto !important; }
    }
    @media (prefers-contrast: more){
      .card{ background:#0f1117; border-color:#fff; }
    }
    @media print{
      header, footer, [role="dialog"]{ display:none !important; }
      .bleed-x{ margin:0; width:auto; left:auto; right:auto; }
      .section{ padding-block:1rem; }
    }
    @supports not (color: color-mix(in srgb, black, white)){
      :focus-visible{ outline-color: var(--fc-gold) }
      .badge{ background: transparent; border-color: var(--fc-gold); color: var(--fc-gold) }
    }
  </style>

  {# ---------------- JSON-LD ---------------- #}
  <script type="application/ld+json" {{ nonce_attr() }}>
  {
    "@context": "https://schema.org",
    "@graph": [
      {
        "@type": "Organization",
        "name": "{{ _brand_name|e }}",
        {% if request is defined %}"url": "{{ request.base_url }}",{% endif %}
        "logo": "{{ asset_abs(_peer_img or _og_img) }}",
        "image": "{{ asset_abs(_og_img) }}",
        "brand": "{{ _brand_slug|e }}"
        {% if _TEAM and (_TEAM.instagram or _TEAM.facebook or _TEAM.twitter or _TEAM.website) %},
        "sameAs": [
          {% if _TEAM.website %}"{{ _TEAM.website }}"{% if _TEAM.instagram or _TEAM.facebook or _TEAM.twitter %},{% endif %}{% endif %}
          {% if _TEAM.instagram %}"{{ _TEAM.instagram }}"{% if _TEAM.facebook or _TEAM.twitter %},{% endif %}{% endif %}
          {% if _TEAM.facebook %}"{{ _TEAM.facebook }}"{% if _TEAM.twitter %},{% endif %}{% endif %}
          {% if _TEAM.twitter %}"{{ _TEAM.twitter }}"{% endif %}
        ]{% endif %}
      }
      {% if _is_p2p and _peer_name %},
      { "@type": "Person", "name": "{{ _peer_name|e }}"{% if _peer_img %}, "image": "{{ asset_abs(_peer_img) }}"{% endif %} }
      {% endif %},
      {
        "@type": "DonateAction",
        "name": "Donate to {{ _brand_name|e }}{% if _is_p2p and _peer_name %} — {{ _peer_name|e }}{% endif %}",
        "recipient": { "@type": "Organization", "name": "{{ _brand_name|e }}" },
        "target": {
          "@type": "EntryPoint",
          "urlTemplate": "{% if safe_url_for is defined and has_endpoint('main.donate') %}{{ safe_url_for('main.donate') }}{% elif request is defined %}{{ request.base_url ~ 'donate' }}{% else %}/donate{% endif %}"
        }
      }
    ]
  }
  </script>

  {# ---------------- Analytics (optional) ---------------- #}
  {% if GA_ID %}
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ GA_ID }}"></script>
    <script {{ nonce_attr() }}>
      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      gtag('js', new Date());
      gtag('config', '{{ GA_ID }}', { anonymize_ip: true, send_page_view: true });
    </script>
  {% endif %}
  {% if POSTHOG_KEY %}
    <link rel="preconnect" href="{{ POSTHOG_HOST }}" crossorigin>
    <script {{ nonce_attr() }}>
      !function(d,w){var p=w.posthog||(w.posthog=[]),s=d.createElement("script");s.async=true;
        s.src=("{{ POSTHOG_HOST }}".replace(/\/$/,"")||"https://app.posthog.com")+"/static/array.js";
        var x=d.getElementsByTagName("script")[0]; x.parentNode.insertBefore(s,x);
        p.init && p.init('{{ POSTHOG_KEY }}', { api_host: '{{ POSTHOG_HOST }}' });
      }(document, window);
    </script>
  {% endif %}

  <script {{ nonce_attr() }}>
    window.fcTrack = function(event, props){
      try { window.dataLayer && window.dataLayer.push({ event, ...(props||{}) }); } catch {}
      try { window.posthog && window.posthog.capture && window.posthog.capture(event, props||{}); } catch {}
    };
  </script>

  {# allow child templates to inject head extras while preserving render guard #}
  {% block extra_head %}
    {% if _rendered is not defined %}
      {% set _rendered = namespace(hero=false, pulse=false, impact=false, tiers=false, about=false, concierge=false, bundles=false) %}
    {% elif _rendered.bundles is not defined %}
      {% set _rendered = namespace(hero=_rendered.hero, pulse=_rendered.pulse, impact=_rendered.impact, tiers=_rendered.tiers, about=_rendered.about, concierge=_rendered.concierge, bundles=false) %}
    {% endif %}
    {% if not _rendered.bundles %}
      {% set _rendered.bundles = true %}
      {% include "bundles/fundchamps_starforge_ui_ux_elite_enhancement_v3.html" ignore missing with context %}
    {% endif %}
  {% endblock %}
</head>

<body class="min-h-full bg-[color:var(--fc-ink)] text-zinc-100">
  {# Render guard & skip link #}
  {% if _rendered is not defined %}
    {% set _rendered = namespace(hero=false, pulse=false, impact=false, tiers=false, about=false, concierge=false, bundles=_rendered.bundles if _rendered is defined else false) %}
  {% endif %}
  <a href="#main" class="sr-only focus:not-sr-only focus:fixed focus:left-3 focus:top-3 focus:z-50 focus:px-3 focus:py-2 focus:rounded-md focus:bg-black focus:text-white">Skip to content</a>

  {% block header %}{% include "partials/header_and_announcement.html" ignore missing with context %}{% endblock %}
  {% block above_main %}{% endblock %}

  <main id="main" role="main" class="relative" tabindex="-1">
    <h1 class="sr-only">{% block h1 %}{{ _brand_name }}{% endblock %}</h1>
    <p id="sr-live" class="sr-only" aria-live="polite" aria-atomic="true"></p>

    {% block section_ticker %}{% endblock %}
    {% block section_hero %}{% endblock %}
    {% block section_pulse %}{% endblock %}
    {% block section_impact %}{% endblock %}
    {% block section_tiers %}{% endblock %}
    {% block section_about %}{% endblock %}
    {% block section_concierge %}{% endblock %}
    {% block sections_extra %}{% endblock %}

    {% block content %}{% endblock %}
  </main>

  {% block below_main %}{% endblock %}
  {% block footer %}{% include "partials/footer.html" ignore missing with context %}{% endblock %}

  <!-- Preload primary bundle -->
  <link rel="preload" as="script" href="{{ asset('js/bundle.min.js') }}"
        {% if sri('js/bundle.min.js') %}crossorigin="anonymous" integrity="{{ sri('js/bundle.min.js') }}"{% endif %}>

  <!-- Preload stats/tiers to speed first CTA -->
  <link rel="preload" as="fetch"
        href="{% if safe_url_for is defined and has_endpoint('main.stats_json') %}{{ safe_url_for('main.stats_json') }}{% else %}/stats{% endif %}"
        crossorigin="anonymous">

  <!-- JS bundles -->
  <script id="fc-bundle" src="{{ asset('js/bundle.min.js') }}" defer
          data-ver="{{ _ver or '' }}"
          {% if sri('js/bundle.min.js') %}integrity="{{ sri('js/bundle.min.js') }}" crossorigin="anonymous"{% endif %}></script>
  {% if _is_donate %}
    <script id="fc-donate" src="{{ asset('js/donate.min.js') }}" defer
            {% if sri('js/donate.min.js') %}integrity="{{ sri('js/donate.min.js') }}" crossorigin="anonymous"{% endif %}></script>
  {% endif %}
  {% if USE_SOCKETIO %}
    <script src="/socket.io/socket.io.js" defer></script>
  {% endif %}

  {# SV-Elite config + theme-color auto-tune #}
  <script {{ nonce_attr() }}>
    window.FC_CFG = { donorsURL: "/api/donors?limit=20" };
    (function(){
      var meta = document.getElementById('meta-theme-color'); if(!meta) return;
      function setColor(){
        try{ meta.setAttribute('content', matchMedia('(prefers-color-scheme: dark)').matches ? '#0b0b0c' : '{{ _brand_hex }}'); }catch(_){}
      }
      setColor(); try { matchMedia('(prefers-color-scheme: dark)').addEventListener('change', setColor); } catch {}
    })();
  </script>

  {# Shopify body include (skin toggle & persistence) #}
  {% if SKIN == 'shopify' %}
    {% include "partials/_shopify_body_include.html" ignore missing %}
  {% endif %}

  {# P2P referral propagation (internal eligible links only) #}
  <script {{ nonce_attr() }}>
  (() => {
    if (window.__fcP2P) return; window.__fcP2P = true;
    const qs = new URLSearchParams(location.search);
    const REF_KEYS = ['ref','ref_id','referrer','r','invite'];
    const P2P_KEYS = ['peer','peer_id','peer_slug','p2p','campaign','campaign_id'];
    const ctx = {
      peer: "{{ _peer_slug or '' }}",
      campaign: "{{ (P2P_CAMPAIGN.slug or P2P_CAMPAIGN.id)|default('') }}",
      team: "{{ _brand_slug }}"
    };
    [...REF_KEYS, ...P2P_KEYS].forEach(k => { const v = qs.get(k); if (v) ctx[k] = v; });
    try { localStorage.setItem('fc_ref_ctx', JSON.stringify(ctx)); } catch {}
    try { document.cookie = "fc_ref="+encodeURIComponent(ctx.ref||ctx.ref_id||ctx.r||'')+"; Path=/; Max-Age="+(60*60*24*60)+"; SameSite=Lax"; } catch {}
    try { window.fcCtx = Object.assign({}, window.fcCtx||{}, { p2p: ctx }); } catch {}

    function decorate(url){
      try{ const u=new URL(url,location.origin);
        ['ref','ref_id','r','invite','peer','peer_id','peer_slug','campaign','campaign_id'].forEach(k=>{ const v=ctx[k]; if(v) u.searchParams.set(k,v); });
        return u.toString();
      }catch{ return url; }
    }
    addEventListener('click', (e) => {
      const a = e.target.closest && e.target.closest('a[href]'); if (!a) return;
      const href = a.getAttribute('href'); if (!href) return;
      const internal = href.startsWith('/') && !href.startsWith('//');
      if (!internal) return;
      if (/\/donate\b/.test(href) || /\b(sponsor|tiers|checkout)\b/.test(href)){
        a.setAttribute('href', decorate(href));
      }
    }, { capture:true, passive:true });
    addEventListener('fc:donate:open', (ev) => { try { ev.detail = Object.assign({}, ev.detail||{}, { p2p: ctx }); } catch {} });
    try { window.fcTrack && window.fcTrack('p2p_page', ctx); } catch {}
  })();
  </script>

  {# Boot + vitals #}
  <script {{ nonce_attr() }}>
  (() => {
    if (window.__fcBoot2) return; window.__fcBoot2 = true;
    window.fcReady = (fn) => (document.readyState === 'loading')
      ? document.addEventListener('DOMContentLoaded', fn, { once:true })
      : queueMicrotask(fn);
    window.fcEmit = function(evt, detail){ try { window.dispatchEvent(new CustomEvent(evt, { detail: detail||{} })); } catch {} };

    try{
      const ab=(new URLSearchParams(location.search).get('ab')||'').toLowerCase();
      if (ab==='monthly'||ab==='once') localStorage.setItem('fc_tiers_price_mode',ab);
    }catch{}

    fcReady(() => {
      window.fcTrack && window.fcTrack('page_ready', {
        route: document.documentElement.dataset.route||'',
        brand: document.documentElement.dataset.brand||''
      });
    });
    addEventListener('load', () => {
      try{
        const t=performance.timing;
        const ttfb=(t.responseStart&&t.requestStart)?(t.responseStart-t.requestStart):undefined;
        window.fcTrack && window.fcTrack('page_loaded', { route: document.documentElement.dataset.route||'', ttfb });
      }catch{}
    }, { once:true });

    try {
      const po = new PerformanceObserver((list) => {
        list.getEntries().forEach((e) => {
          let metric, val;
          if (e.entryType==='paint' && e.name==='first-contentful-paint'){ metric='FCP'; val=e.startTime; }
          if (e.entryType==='largest-contentful-paint'){ metric='LCP'; val=e.startTime; }
          if (metric) window.fcTrack && window.fcTrack('web_vital', { metric, value: Math.round(val) });
        });
      });
      po.observe({type:'paint', buffered:true});
      po.observe({type:'largest-contentful-paint', buffered:true});

      const po2 = new PerformanceObserver((list) => {
        let last; list.getEntries().forEach(e => { last = e; });
        if (last) window.fcTrack && window.fcTrack('web_vital', { metric:'INP', value: Math.round(last.duration) });
      });
      po2.observe({ type:'event', buffered:true, durationThreshold:40 });
    } catch {}
  })();
  </script>

  {# Sticky seam height calculator (header + sponsor ticker) #}
  <script {{ nonce_attr() }}>
  (() => {
    if (window.__fcSeam) return; window.__fcSeam = true;
    const root   = document.documentElement;
    const header = document.getElementById('site-header');
    const ticker = document.getElementById('sponsor-leaderboard');
    const calc = () => {
      const h = (header?.offsetHeight || 0) + (ticker?.offsetHeight || 0);
      if (h > 0) {
        root.style.setProperty('--fc-header-h', h + 'px');
        root.style.setProperty('--sticky-offset', h + 'px');
      }
    };
    try {
      calc();
      const ro = new ResizeObserver(calc);
      header && ro.observe(header);
      ticker && ro.observe(ticker);
      addEventListener('resize', calc, { passive:true });
      addEventListener('load', calc, { once:true });
      document.addEventListener?.('htmx:afterSettle', calc);
    } catch {}
  })();
  </script>

  {# SV-Elite JS (counters, ticker, CTA pulse, micro-interactions) #}
  <script src="{{ asset('js/fc_elite.js') }}" defer
          {% if sri('js/fc_elite.js') %}integrity="{{ sri('js/fc_elite.js') }}" crossorigin="anonymous"{% endif %}></script>

  {# Starforge before-</body> include (honors render guard) #}
  {% block body_scripts %}
    {% if _rendered and _rendered.bundles %}
      {% include "partials/starforge_patch_include.html" ignore missing with context %}
    {% endif %}
  {% endblock %}

  {% block extra_js %}{% endblock %}

  {# Optional: spin up brand spine JS if shipped (this lets you “relocate” the team
     name into the vertical spine near hero; the include is in the hero page). #}
  <script {{ nonce_attr() }} type="module">
    try{ import('{{ asset("starforge/enable-brand-spine.js") }}').catch(()=>{}); }catch(_){}
  </script>
</body>
</html>

