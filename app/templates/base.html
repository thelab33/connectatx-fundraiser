{# ---------------------------------------------------------------------------
  Base layout — FundChamps Prestige Elite (SV-Premium, modular v3.3)
  - Section slots (ticker/hero/tiers/impact/allocation/about/cta/concierge)
  - Single CSS pipeline, CSP nonce, JSON-LD, metrics, confetti, sockets (opt)
  - Hero Compat: ensures inline hero <img> shows under glass card content
  - Back-compat: {% block content %} still works
--------------------------------------------------------------------------- #}
{% set NONCE = NONCE if NONCE is defined else (csp_nonce() if csp_nonce is defined else '') %}
{% set _ver = ASSET_VER if ASSET_VER is defined else (ASSET_VERSION if ASSET_VERSION is defined else (VERSION if VERSION is defined else None)) %}
{% set SRI = SRI if SRI is defined else {} %}
{% set _route = (request.endpoint if request is defined else '') %}
{% set _TEAM  = (team if team is defined else (_team if _team is defined else {})) %}
{% set _brand_hex  = _TEAM.theme_color if _TEAM and _TEAM.theme_color else '#facc15' %}
{% set _brand_name = _TEAM.team_name  if _TEAM and _TEAM.team_name  else 'Connect ATX Elite' %}
{% set _brand_slug = (_TEAM.team_slug if _TEAM and _TEAM.team_slug else _brand_name)|lower|replace(' ', '-')|replace('--','-') %}
{% set _title_default = _brand_name %}
{% set _desc_default  = 'Fuel the season. Fund the future.' %}
{% set _is_donate = (_route == 'main.donate') %}
{% set _page_title = ( (_is_donate and (_TEAM.og_title_donate if _TEAM and _TEAM.og_title_donate)) or
                       (_TEAM.og_title if _TEAM and _TEAM.og_title) or
                       (_is_donate and _brand_name ~ ' — Donate') or
                       (_brand_name ~ ' — Fundraiser') ) %}
{% set _page_desc = ( (_is_donate and (_TEAM.og_description_donate if _TEAM and _TEAM.og_description_donate)) or
                      (_TEAM.og_description if _TEAM and _TEAM.og_description) or
                      _desc_default ) %}
{% set _hero_img = _TEAM.hero_image or _TEAM.hero_bg or _TEAM.team_photo or 'images/hero.avif' %}
{% set _og_img   = _TEAM.og_image   or 'images/og_default.jpg' %}

{# Versioned assets #}
{% set href_tailwind = url_for('static', filename='css/tailwind.min.css', v=_ver) if _ver else url_for('static', filename='css/tailwind.min.css') %}
{% set js_href       = url_for('static', filename='js/bundle.min.js',  v=_ver) if _ver else url_for('static', filename='js/bundle.min.js') %}
{% set js_donate     = url_for('static', filename='js/donate.min.js',  v=_ver) if _ver else url_for('static', filename='js/donate.min.js') %}

{# Optional SRI #}
{% set sri_css     = SRI.get('css/tailwind.min.css') if SRI else None %}
{% set sri_js_main = SRI.get('js/bundle.min.js')     if SRI else None %}
{% set sri_js_don  = SRI.get('js/donate.min.js')     if SRI else None %}

{# Optional PWA manifest + sockets #}
{% set _manifest = WEB_MANIFEST if WEB_MANIFEST is defined else None %}
{% set USE_SOCKETIO = USE_SOCKETIO if USE_SOCKETIO is defined else false %}

<!doctype html>
<html lang="en"
  class="h-full antialiased scroll-smooth selection:bg-yellow-300/30"
  data-theme="dark" data-brand="{{ _brand_slug }}" data-route="{{ _route|default('') }}">
<head>
  {% block head_pre_meta %}
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <meta name="color-scheme" content="dark light" />
    <meta name="theme-color" content="#0b0b0c" id="meta-theme-color" />
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <meta name="robots" content="index,follow,max-image-preview:large" />
    {% if request is defined %}
      <link rel="canonical" href="{{ request.base_url }}" />
      <meta property="og:url" content="{{ request.base_url }}" />
    {% endif %}
  {% endblock %}

  {% block head_meta %}
    <title>{% block title %}{{ _page_title }}{% endblock %}</title>
    <meta name="description" content="{{ _page_desc }}" />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="{{ _brand_name }}" />
    <meta property="og:title" content="{{ _page_title }}" />
    <meta property="og:description" content="{{ _page_desc }}" />
    <meta property="og:image" content="{{ url_for('static', filename=_og_img, v=_ver) if _ver else url_for('static', filename=_og_img) }}" />
    <meta property="og:locale" content="en_US" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="{{ _page_title }}" />
    <meta name="twitter:description" content="{{ _page_desc }}" />
    <meta name="twitter:image" content="{{ url_for('static', filename=_og_img, v=_ver) if _ver else url_for('static', filename=_og_img) }}" />
    <meta name="twitter:image:alt" content="{{ _brand_name }} fundraiser" />
    <link rel="icon" href="{{ url_for('static', filename=_og_img, v=_ver) if _ver else url_for('static', filename=_og_img) }}" />
  {% endblock %}

  {% block head_pwa %}
    {% if _manifest %}
      <link rel="manifest" href="{{ url_for('static', filename=_manifest, v=_ver) if _ver else url_for('static', filename=_manifest) }}">
      <meta name="apple-mobile-web-app-capable" content="yes">
      <meta name="mobile-web-app-capable" content="yes">
      <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    {% endif %}
  {% endblock %}

  {% block head_preconnects %}
    <link rel="preconnect" href="https://js.stripe.com" crossorigin>
    {% if USE_SOCKETIO %}<link rel="preconnect" href="/socket.io/" crossorigin>{% endif %}
    <link rel="preconnect" href="https://www.youtube-nocookie.com" crossorigin>
    <link rel="dns-prefetch" href="https://js.stripe.com">
    <link rel="dns-prefetch" href="https://www.youtube-nocookie.com">
  {% endblock %}

  {% block head_preload %}
    {% if url_for is defined and _hero_img %}
      <link rel="preload" as="image"
            href="{{ url_for('static', filename=_hero_img, v=_ver) if _ver else url_for('static', filename=_hero_img) }}"
            imagesizes="100vw" />
    {% endif %}
  {% endblock %}

  {% block styles %}
    <link rel="preload" as="style" href="{{ href_tailwind }}"{% if sri_css %} integrity="{{ sri_css }}" crossorigin="anonymous"{% endif %} />
    <link rel="stylesheet" href="{{ href_tailwind }}"{% if sri_css %} integrity="{{ sri_css }}" crossorigin="anonymous"{% endif %} />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/fc-tokens.css', v=_ver) if _ver else url_for('static', filename='css/fc-tokens.css') }}">
    <style nonce="{{ NONCE }}">
      :root{
        --fc-space-y: clamp(2.15rem, 4.5vh, 4.5rem);
        --fc-sticky-offset: clamp(64px, 7.5vh, 96px);
        --fc-brand: {{ _brand_hex }};
        --fc-ring: color-mix(in srgb, var(--fc-brand) 65%, transparent);
        --fc-header-h: 0px;
      }
      html, body { scroll-behavior: smooth; }
      main { overscroll-behavior-y: contain; }
      @supports (scroll-snap-type: y proximity){
        main { scroll-snap-type: y proximity; }
        main > section, main > [data-snap] { scroll-snap-align: start; scroll-margin-top: var(--fc-sticky-offset); }
        @media (prefers-reduced-motion: reduce){ main { scroll-snap-type: none; } }
      }

      /* Rhythm + containers */
      .fc-section{ padding-block: var(--fc-space-y); }
      .fc-container{ width:min(88rem, 96vw); margin-inline:auto; padding-inline:clamp(.75rem, 2vw, 1.25rem); }
      img { border-radius:.5rem; height:auto; max-width:100%; display:block; }

      /* Dense mode */
      body.is-dense * { letter-spacing:.01em; }
      body.is-dense p, body.is-dense li { line-height:1.6; }
      body.is-dense section { padding-block: var(--fc-space-y); }
      body.is-dense .fc-card, body.is-dense .glass, body.is-dense .impact-card, body.is-dense .tier-card{
        border-radius:14px; padding:1rem 1.15rem; transition:transform .22s ease, box-shadow .22s ease, border-color .22s ease;
      }
      body.is-dense .fc-card:hover, body.is-dense .glass:hover, body.is-dense .impact-card:hover, body.is-dense .tier-card:hover{
        transform:translateY(-3px) scale(1.005); box-shadow:0 10px 24px rgba(0,0,0,.28);
      }
      :focus-visible { outline:2px solid var(--fc-ring); outline-offset:2px; }

      /* ---------- HERO COMPAT: ensure inline photo shows under hero content ---------- */
      #fc-hero .fc-hero-glass{ position:relative; isolation:isolate; }
      #fc-hero .fc-hero-glass .hero-bg{ position:absolute; inset:0; z-index:0; }
      #fc-hero .fc-hero-glass .hero-bg img{
        width:100%; height:100%; object-fit:cover;
        object-position: var(--hero-focus, 50% 24%);
        filter:saturate(1.05) contrast(1.08);
      }
      #fc-hero .fc-hero-glass .hero-content{ position:relative; z-index:1; }
      /* ----------------------------------------------------------------------------- */

      /* Perf: below-the-fold */
      main > section:nth-of-type(n+2){ content-visibility:auto; contain-intrinsic-size: 900px; }
    </style>
  {% endblock %}

  {% block head_early_js %}
    <script nonce="{{ NONCE }}">
      (() => {
        try{
          const qs = new URLSearchParams(location.search);
          if (qs.get('dense')==='1') localStorage.setItem('fc:dense','1');
          if (qs.get('dense')==='0') localStorage.removeItem('fc:dense');
          if (localStorage.getItem('fc:dense')==='1') document.documentElement.classList.add('is-dense');
        }catch{}
      })();
    </script>
    <script nonce="{{ NONCE }}">
      (() => {
        const BRAND = '{{ _brand_hex }}';
        const metaTheme = document.querySelector('#meta-theme-color');
        const applyTheme = () => {
          const prefersDark = matchMedia?.('(prefers-color-scheme: dark)').matches ?? true;
          if (metaTheme) metaTheme.content = prefersDark ? '#0b0b0c' : BRAND;
          document.documentElement.style.setProperty('--fc-brand', BRAND);
          document.documentElement.style.setProperty('--fc-ring', 'color-mix(in srgb, ' + BRAND + ' 65%, transparent)');
        };
        applyTheme();
        matchMedia?.('(prefers-color-scheme: dark)')?.addEventListener('change', applyTheme);

        // Header height → CSS var for sticky offsets
        const hdr = document.getElementById('site-header');
        const setH = () => document.documentElement.style.setProperty('--fc-header-h', ((hdr?.offsetHeight)||0) + 'px');
        setH(); addEventListener('resize', setH, { passive:true });
      })();
    </script>
  {% endblock %}

  {% block json_ld %}
    <script type="application/ld+json" nonce="{{ NONCE }}">
    {"@context":"https://schema.org","@type":"Organization","name":{{ _brand_name|tojson }},"url":{{ (request.base_url if request is defined else '/')|tojson }},"brand":{{ _brand_name|tojson }},"logo":{{ (url_for('static', filename=_og_img, v=_ver) if _ver else url_for('static', filename=_og_img)) | tojson }}}
    </script>
    {% if _is_donate %}
    <script type="application/ld+json" nonce="{{ NONCE }}">
    {"@context":"https://schema.org","@type":"DonateAction","name":"Donate to {{ _brand_name }}","target":{{ (request.base_url if request is defined else '/donate')|tojson }},"actionStatus":"https://schema.org/PotentialActionStatus"}
    </script>
    {% endif %}
  {% endblock %}

  {% block extra_css %}{% endblock %}
  {% block head %}{% endblock %}
</head>

<body class="min-h-full bg-zinc-950 text-zinc-100">
  <a id="skip-to-content" href="#main" class="sr-only focus:not-sr-only focus:fixed focus:top-2 focus:left-2">Skip to content</a>
  <div id="site-header-sentinel" aria-hidden="true" class="h-0 w-full"></div>

  {% block header %}
    {% include "partials/header_and_announcement.html" ignore missing with context %}
  {% endblock %}

  {% block above_main %}{% endblock %}

  <main id="main" role="main" class="relative">
    <h1 class="sr-only">{% block h1 %}{{ _brand_name }}{% endblock %}</h1>

    {# --- Section slots for Nike/Apple storytelling flow --- #}
    {% block section_ticker %}{% endblock %}
    {% block section_hero %}{% endblock %}
    {% block section_tiers %}{% endblock %}
    {% block section_impact %}{% endblock %}
    {% block section_allocation %}{% endblock %}
    {% block section_about %}{% endblock %}
    {% block section_mid_cta %}{% endblock %}
    {% block section_concierge %}{% endblock %}
    {% block sections_extra %}{% endblock %}

    {# Back-compat: old pages can still render everything via content #}
    {% block content %}{% endblock %}
  </main>

  {% block below_main %}{% endblock %}

  {% block footer %}
    {% include "partials/footer.html" ignore missing with context %}
  {% endblock %}

  {% block modals %}
    {% include "partials/donation_modal.html" ignore missing %}
    {% include "partials/newsletter.html"      ignore missing %}
  {% endblock %}

  {% block core_scripts %}
    <script src="{{ js_href }}" defer nonce="{{ NONCE }}"{% if sri_js_main %} integrity="{{ sri_js_main }}" crossorigin="anonymous"{% endif %}></script>
    {% if _is_donate %}
      <script src="{{ js_donate }}" defer nonce="{{ NONCE }}"{% if sri_js_don %} integrity="{{ sri_js_don }}" crossorigin="anonymous"{% endif %}></script>
    {% endif %}
    {% if USE_SOCKETIO %}<script src="/socket.io/socket.io.js" defer nonce="{{ NONCE }}"></script>{% endif %}
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" defer></script>
  {% endblock %}

  {% block extra_js %}{% endblock %}

  {% block tail_scripts %}
    <script nonce="{{ NONCE }}">
    (() => {
      if (window.__fcPolish) return; window.__fcPolish = true;

      // Metrics beacons
      const beacon = (url, data) => { try { navigator.sendBeacon?.(url, new Blob([JSON.stringify(data)], {type:'application/json'})); } catch {} };
      beacon('/metrics/impression', { route: document.documentElement.dataset.route || '', at: Date.now(), brand: document.documentElement.dataset.brand || '' });
      addEventListener('click', e => {
        const el = e.target.closest('[data-track], .fc-btn-primary, [data-cta]');
        if (!el) return;
        beacon('/metrics/click', {
          id: el.getAttribute('data-track') || el.id || '',
          text: (el.getAttribute('data-cta') || el.textContent || '').trim().slice(0,80),
          at: Date.now()
        });
      }, {passive:true});

      // Confetti on shoutout swaps
      function popConfetti(){ try{ window.confetti?.({ particleCount: 40, spread: 70, origin:{ y: .18 } }) }catch{} }
      document.addEventListener('htmx:afterSwap', (e) => {
        if (e.target?.classList?.contains('fc-marquee')) popConfetti();
      }, {passive:true});

      // Optional Socket.IO: prepend shoutout pill
      {% if USE_SOCKETIO %}
      addEventListener('DOMContentLoaded', () => {
        const boot = () => {
          if (!window.io) return;
          const socket = io();
          socket.on('new_shoutout', data => {
            const rail = document.querySelector('#sponsor-leaderboard .fc-ticker__rail, #sponsor-leaderboard .fc-t-rail');
            if (!rail) return;
            const span = document.createElement('span');
            span.className = 'pill';
            const t = String((data.tier||'').toLowerCase());
            const badge = t==='platinum' ? '✨' : t==='gold' ? '🏅' : t==='silver' ? '🎉' : t==='bronze' ? '🥉' : '🔥';
            span.innerHTML = `${badge} <span class="text-white">${data.sponsor||''}</span> ${data.msg||''}`;
            rail.prepend(span); popConfetti();
          });
        };
        setTimeout(boot, 0);
      }, {once:true});
      {% endif %}

      // Prefetch donate target for snappy CTA
      const prefetch = (url) => { const l=document.createElement('link'); l.rel='prefetch'; l.href=url; document.head.appendChild(l); };
      addEventListener('pointerover', e => {
        const el = e.target.closest('a[href*="donate"], [data-open-donate-modal]');
        if (el) try{ prefetch((el.href||'/donate')); }catch{}
      }, {passive:true});
      addEventListener('focusin', e => {
        const el = e.target.closest('a[href*="donate"], [data-open-donate-modal]');
        if (el) try{ prefetch((el.href||'/donate')); }catch{}
      }, {passive:true});
    })();
    </script>
    <script src="{{ url_for('static', filename='js/fc-ui.js', v=_ver) if _ver else url_for('static', filename='js/fc-ui.js') }}" defer></script>
  {% endblock %}
</body>
</html>

