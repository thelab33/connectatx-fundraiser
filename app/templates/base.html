{# =======================================================================
   FundChamps • SaaS Base (SV-Elite 3.2)
   - Single CSS include (output.css) to prevent cascade conflicts
   - CSP-safe (nonce helper), SRI-ready, white-label theming
   - Strong SEO/OG, JSON-LD, PWA optional, motion & contrast safe
   - Slots/blocks designed for product pages (hero/tiers/impact/etc.)
   ======================================================================= #}
{% set _TEAM = team if team is defined else (_team if _team is defined else {}) %}
{% set _brand_hex  = (_TEAM.theme_color if _TEAM and _TEAM.theme_color else '#facc15') %}
{% set _brand_name = (_TEAM.team_name  if _TEAM and _TEAM.team_name  else 'Connect ATX Elite') %}
{% set _brand_slug = (_TEAM.team_slug  if _TEAM and _TEAM.team_slug  else _brand_name)|lower|replace(' ', '-')|replace('--','-') %}
{% set _route      = (request.endpoint if request is defined else '') %}
{% set _is_donate  = (_route == 'main.donate') %}
{% set _ver        = ASSET_VER if ASSET_VER is defined else (ASSET_VERSION if ASSET_VERSION is defined else (VERSION if VERSION is defined else None)) %}
{% set SRI         = SRI if SRI is defined else {} %}
{% set NONCE       = NONCE if NONCE is defined else (csp_nonce() if csp_nonce is defined else '') %}
{% set _og_img     = _TEAM.og_image  if _TEAM and _TEAM.og_image  else 'images/og_default.jpg' %}
{% set _favicon    = _TEAM.favicon   if _TEAM and _TEAM.favicon   else 'images/favicon.svg' %}
{% set _apple_icon = _TEAM.apple_icon if _TEAM and _TEAM.apple_icon else 'images/apple-touch-icon.png' %}
{% set _desc_default = 'Fuel the season. Fund the future.' %}
{% set _page_title = (
      (_is_donate and (_TEAM.og_title_donate if _TEAM and _TEAM.og_title_donate))
   or (_TEAM.og_title if _TEAM and _TEAM.og_title)
   or (_is_donate and (_brand_name ~ ' — Donate'))
   or (_brand_name ~ ' — Fundraiser')
) %}
{% set _page_desc = (
      (_is_donate and (_TEAM.og_description_donate if _TEAM and _TEAM.og_description_donate))
   or (_TEAM.og_description if _TEAM and _TEAM.og_description)
   or _desc_default
) %}
{% set USE_SOCKETIO = USE_SOCKETIO if USE_SOCKETIO is defined else false %}
{% set _manifest = WEB_MANIFEST if WEB_MANIFEST is defined else None %}

{# helpers #}
{% macro nonce_attr() -%}nonce="{{ NONCE }}"{%- endmacro %}
{% macro sri(path) -%}{{ SRI.get(path) if SRI else None }}{%- endmacro %}
{% macro asset(path) -%}{{ url_for('static', filename=path, v=_ver) if _ver else url_for('static', filename=path) }}{%- endmacro %}

<!doctype html>
<html lang="en"
      class="h-full antialiased scroll-smooth selection:bg-yellow-300/30"
      data-theme="dark" data-brand="{{ _brand_slug }}" data-route="{{ _route|default('') }}">
<head>
  <!-- Core meta -->
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="color-scheme" content="dark light"/>
  <meta name="theme-color" content="#0b0b0c" id="meta-theme-color"/>
  <meta name="referrer" content="strict-origin-when-cross-origin"/>
  <meta name="robots" content="index,follow,max-image-preview:large"/>
  <meta name="csrf-token" content="{{ (csrf_token() if csrf_token is defined else '') }}"/>

  {% if request is defined %}
    <link rel="canonical" href="{{ request.base_url }}"/>
    <meta property="og:url" content="{{ request.base_url }}"/>
  {% endif %}

  <!-- SEO -->
  <title>{% block title %}{{ _page_title }}{% endblock %}</title>
  <meta name="description" content="{{ _page_desc }}"/>
  <meta property="og:type" content="website"/>
  <meta property="og:site_name" content="{{ _brand_name }}"/>
  <meta property="og:title" content="{{ _page_title }}"/>
  <meta property="og:description" content="{{ _page_desc }}"/>
  <meta property="og:image" content="{{ asset(_og_img) }}"/>
  <meta property="og:locale" content="en_US"/>
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:title" content="{{ _page_title }}"/>
  <meta name="twitter:description" content="{{ _page_desc }}"/>
  <meta name="twitter:image" content="{{ asset(_og_img) }}"/>

  <!-- Icons -->
  <link rel="icon" type="image/svg+xml" href="{{ asset(_favicon) }}"/>
  <link rel="alternate icon" type="image/png" href="{{ asset('images/favicon.png') }}"/>
  <link rel="apple-touch-icon" href="{{ asset(_apple_icon) }}"/>

  <!-- PWA (optional) -->
  {% if _manifest %}
    <link rel="manifest" href="{{ asset(_manifest) }}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  {% endif %}

  <!-- Hints (kept mild) -->
  <link rel="preconnect" href="https://js.stripe.com" crossorigin>
  <link rel="dns-prefetch" href="https://js.stripe.com">
  <link rel="preconnect" href="https://www.paypal.com" crossorigin>
  <link rel="dns-prefetch" href="https://www.paypal.com">
  {% if USE_SOCKETIO %}<link rel="preconnect" href="/socket.io/" crossorigin>{% endif %}

  {# =====================================================================
     CSS: SINGLE build output to prevent cascade conflicts.
     Build from app/static/css/input.css -> output.css
     ===================================================================== #}
  <link rel="stylesheet" href="{{ asset('css/output.css') }}"
        {% if sri('css/output.css') %}integrity="{{ sri('css/output.css') }}" crossorigin="anonymous"{% endif %}/>

  <!-- Critical micro styles (CSP-safe, tiny only) -->
  <style {{ nonce_attr() }}>
    :root{
      --fc-brand: {{ _brand_hex }};
      --fc-ring: color-mix(in srgb, var(--fc-brand) 65%, transparent);
      --fc-sticky-offset: clamp(64px, 7.5vh, 96px);
    }
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    :focus-visible{ outline:2px solid var(--fc-ring); outline-offset:2px; }
    section[aria-labelledby], section[id]{ scroll-margin-top: var(--fc-sticky-offset); }
    .fc-container{ width:min(88rem,96vw); margin-inline:auto; padding-inline:clamp(.75rem,2vw,1.25rem); }
  </style>

  <!-- Tiny early JS (theme + compact density) -->
  <script {{ nonce_attr() }}>
    (() => {
      try{
        const qs = new URLSearchParams(location.search);
        if (qs.get('dense')==='1') localStorage.setItem('fc:dense','1');
        if (qs.get('dense')==='0') localStorage.removeItem('fc:dense');
        if (localStorage.getItem('fc:dense')==='1') document.documentElement.dataset.compact = '1';
      }catch{}
      const BRAND='{{ _brand_hex }}', meta=document.getElementById('meta-theme-color');
      const apply=()=>{ const dark=matchMedia?.('(prefers-color-scheme: dark)').matches ?? true;
        if(meta) meta.content = dark ? '#0b0b0c' : BRAND; };
      apply(); matchMedia?.('(prefers-color-scheme: dark)')?.addEventListener('change', apply);
    })();
  </script>

  <!-- JSON-LD -->
  <script {{ nonce_attr() }} type="application/ld+json">
    {"@context":"https://schema.org","@type":"Organization",
     "name":{{ _brand_name|tojson }},
     "url":{{ (request.base_url if request is defined else '/')|tojson }},
     "logo":{{ asset(_og_img)|tojson }}}
  </script>
  {% if _is_donate %}
  <script {{ nonce_attr() }} type="application/ld+json">
    {"@context":"https://schema.org","@type":"DonateAction",
     "name":"Donate to {{ _brand_name }}",
     "target":{{ (request.base_url if request is defined else '/donate')|tojson }}}
  </script>
  {% endif %}

  {% block extra_head %}{% endblock %}
</head>

<body class="min-h-full bg-zinc-950 text-zinc-100">
  <a id="skip-to-content" href="#main" class="sr-only focus:not-sr-only focus:fixed focus:top-2 focus:left-2 z-50 rounded px-4 py-2 bg-black/85 text-white">
    Skip to content
  </a>

  {# Header (ships with meter + marquee; CSP-safe) #}
  {% block header %}{% include "partials/header_and_announcement.html" ignore missing with context %}{% endblock %}

  {% block above_main %}{% endblock %}

  <main id="main" role="main" class="relative">
    <h1 class="sr-only">{% block h1 %}{{ _brand_name }}{% endblock %}</h1>

    {# Product page slots (compose what you need per page) #}
    {% block section_ticker %}{% endblock %}
    {% block section_hero %}{% endblock %}
    {% block section_tiers %}{% endblock %}
    {% block section_impact %}{% endblock %}
    {% block section_allocation %}{% endblock %}
    {% block section_about %}{% endblock %}
    {% block section_mid_cta %}{% endblock %}
    {% block section_concierge %}{% endblock %}
    {% block sections_extra %}{% endblock %}

    {# Back-compat content slot #}
    {% block content %}{% endblock %}
  </main>

  {% block below_main %}{% endblock %}

  {% block footer %}{% include "partials/footer.html" ignore missing with context %}{% endblock %}

  {% block modals %}
    {% include "partials/donation_modal.html" ignore missing %}
    {% include "partials/newsletter.html"      ignore missing %}
  {% endblock %}

  {# JS: defer; one main bundle + optional donate + optional socket.io #}
  <script src="{{ asset('js/bundle.min.js') }}" defer
          {% if sri('js/bundle.min.js') %}integrity="{{ sri('js/bundle.min.js') }}" crossorigin="anonymous"{% endif %}></script>
  {% if _is_donate %}
    <script src="{{ asset('js/donate.min.js') }}" defer
            {% if sri('js/donate.min.js') %}integrity="{{ sri('js/donate.min.js') }}" crossorigin="anonymous"{% endif %}></script>
  {% endif %}
  {% if USE_SOCKETIO %}
    <script src="/socket.io/socket.io.js" defer></script>
  {% endif %}

  {% block extra_js %}{% endblock %}
</body>
</html>

