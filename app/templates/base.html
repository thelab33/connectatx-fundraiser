{# templates/base.html — Production-grade, CSP-safe, component-first #}
{% set asset_version = asset_version|default(0) %}
{% set __team_name  = (team.team_name if team and team.team_name is defined else 'FundChamps') %}
{# Support both csp_nonce() and NONCE #}
{% set __nonce      = (csp_nonce() if csp_nonce is defined else (NONCE if NONCE is defined else '')) %}
{% set __brand      = (team.theme_color if team and team.theme_color is defined else '#facc15') %}
{% set __desc       = (page_description if page_description is defined and page_description else 'Community-funded performance. Travel, gear, and academics — powered by local supporters.') %}

{# Assets (override via css_path/js_path if needed) #}
{% set __css_path   = css_path if css_path is defined and css_path else 'css/tailwind.min.css' %}
{% set __js_path    = js_path  if js_path  is defined and js_path  else 'js/bundle.min.js' %}

{# Logo/fallback #}
{% set __logo_rel   = (team.logo_path if team and team.logo_path is defined and team.logo_path else 'images/logo.webp') %}
{% set __logo_url   = (url_for('static', filename=__logo_rel, v=asset_version) if url_for is defined else '/static/' ~ __logo_rel) %}

{# Direction (explicit > auto → rtl-langs) #}
{% set __rtl_langs = ['ar','he','fa','ur'] %}
{% set __dir = (lang_dir if lang_dir is defined and lang_dir in ['ltr','rtl'] else ('rtl' if (lang_code in __rtl_langs) else 'ltr')) %}

{# Stripe preconnect if configured #}
{% set __stripe_pk = (app_config.get('STRIPE_PUBLIC_KEY') or app_config.get('STRIPE_PUBLISHABLE_KEY')) if app_config is defined else None %}

<!doctype html>
<html lang="{{ lang_code|default('en', true) }}" dir="{{ __dir }}"
      class="no-js scroll-smooth antialiased bg-zinc-950 text-white"
      data-env="{{ app_env if app_env is defined else 'development' }}">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,viewport-fit=cover" />
    <meta name="color-scheme" content="dark light" />
    <meta name="theme-color" content="{{ __brand }}">
    <meta name="description" content="{{ __desc }}">
    <meta name="robots" content="index,follow" />
    <title>{% block head_title %}{{ __team_name }} — FundChamps{% endblock %}</title>

    {# Open Graph / Twitter #}
    {% block head_meta %}
      <meta property="og:type" content="website" />
      <meta property="og:site_name" content="{{ __team_name }}" />
      <meta property="og:title" content="{% block og_title %}{{ __team_name }}{% endblock %}" />
      <meta property="og:description" content="{{ __desc }}" />
      <meta property="og:image" content="{{ __logo_url }}" />
      <meta property="og:image:alt" content="{{ __team_name }} logo" />
      <meta property="og:locale" content="{{ lang_code|default('en') }}" />
      <meta name="twitter:card" content="summary_large_image" />
      <meta name="twitter:title" content="{{ __team_name }}" />
      <meta name="twitter:description" content="{{ __desc }}" />
      <meta name="twitter:image" content="{{ __logo_url }}" />
      <meta name="twitter:image:alt" content="{{ __team_name }} logo" />
      {% if canonical_url is defined and canonical_url %}
        <link rel="canonical" href="{{ canonical_url }}">
      {% endif %}
      {% if __stripe_pk %}
        <link rel="preconnect" href="https://js.stripe.com" crossorigin>
        <link rel="preconnect" href="https://api.stripe.com" crossorigin>
      {% endif %}
    {% endblock %}

    {# CSS (Tailwind bundle) #}
    <link rel="preload" href="{{ url_for('static', filename=__css_path, v=asset_version) }}" as="style" />
    <link rel="stylesheet" href="{{ url_for('static', filename=__css_path, v=asset_version) }}" />

    {# Favicons #}
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png', v=asset_version) }}" />
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg', v=asset_version) }}" />
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='apple-touch-icon.png', v=asset_version) }}" />

    {# Global tokens/utilities #}
    {% include 'partials/ui_bootstrap.html' ignore missing %}

    {# Per-page extras: preload fonts, extra metas, etc. #}
    {% block head_extra %}{% endblock %}

    {# Optional JSON-LD (pages can override/extend) #}
    {% block head_jsonld %}
      <script type="application/ld+json" nonce="{{ __nonce }}">
      {{ {
        "@context":"https://schema.org",
        "@type":"SportsTeam",
        "name": __team_name,
        "sport": "Basketball",
        "url": (request.url_root if request is defined else ""),
        "brand": { "@type":"Brand", "name": __team_name }
      }|tojson }}
      </script>
    {% endblock %}

    <style nonce="{{ __nonce }}">
      :root{
        --fc-brand: {{ __brand }};
        --fc-brand-100: color-mix(in srgb, {{ __brand }} 28%, transparent);
        --fc-brand-200: color-mix(in srgb, {{ __brand }} 20%, transparent);
        --fc-brand-300: color-mix(in srgb, {{ __brand }} 40%, black);
      }
      .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    </style>

    {# Toggle no-js → js as early as possible #}
    <script nonce="{{ __nonce }}">
      try{document.documentElement.classList.remove('no-js');document.documentElement.classList.add('js')}catch(e){}
    </script>

    {# Preload JS bundle (deferred) #}
    <link rel="preload" href="{{ url_for('static', filename=__js_path, v=asset_version) }}" as="script" />
  </head>

  <body class="min-h-screen">
    <a href="#app" class="sr-only focus:not-sr-only focus:fixed focus:top-2 focus:left-2 focus:z-50 focus:rounded-md focus:bg-black focus:text-white focus:px-3 focus:py-2">
      Skip to content
    </a>

    {% block body_top %}{% endblock %}
    {% block hero %}{% endblock %}

    <main id="app" class="flex flex-col gap-8">
      {% block content %}{% endblock %}
    </main>

    {% block footer %}{% endblock %}

    {# Portals for modals/menus #}
    <div id="portals" aria-hidden="true"></div>

    {# App config (CSP-safe) #}
    <script nonce="{{ __nonce }}">
      (function(){
        window.FC = window.FC || {};
        FC.cfg = {
          team_id: {{ team.id if team and team.id else 'null' }},
          team_name: {{ __team_name|tojson }},
          asset_v: {{ asset_version|int }},
          brand: {{ __brand|tojson }},
          env: {{ (app_env if app_env is defined else 'development')|tojson }}
        };
        try{ document.documentElement.style.setProperty('--fc-brand', FC.cfg.brand); }catch(e){}
      })();
    </script>

    {# Your compiled JS bundle (safe to remove if not used) #}
    <script src="{{ url_for('static', filename=__js_path, v=asset_version) }}"
            defer nonce="{{ __nonce }}"></script>

    {# Page-level scripts (inline/deferred as needed by child templates) #}
    {% block scripts_extra %}{% endblock %}

    {# Very-late scripts (analytics beacons, etc.) #}
    {% block scripts_tail %}{% endblock %}

    <noscript>
      <div class="fixed inset-x-0 bottom-0 z-50 m-3 rounded-lg bg-yellow-200 px-4 py-3 text-black shadow">
        JavaScript is disabled. Some interactive features (donation modals, live updates) may not work.
      </div>
    </noscript>
  </body>
</html>

