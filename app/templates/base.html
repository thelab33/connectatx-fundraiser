{# ============================================================================
   FundChamps • SaaS Base Layout (v6, Agency Edition)
============================================================================ #}

{% set NONCE = NONCE if NONCE is defined else (csp_nonce if csp_nonce is defined else (csp_nonce() if csp_nonce is defined else '')) %}
{% macro nonce_attr() -%}{% if NONCE %}nonce="{{ NONCE }}"{% endif %}{%- endmacro %}

{# --- Branding, SEO, Config --- #}
{% set _ver        = (ASSET_VER or ASSET_VERSION or VERSION) if (ASSET_VER is defined or ASSET_VERSION is defined or VERSION is defined) else '' %}
{% set _TEAM       = team if team is defined else (_team if _team is defined else {}) %}
{% set _brand_hex  = _TEAM.theme_color or '#facc15' %}
{% set _brand_name = _TEAM.team_name  or 'Connect ATX Elite' %}
{% set _brand_slug = (_TEAM.team_slug or _brand_name)|lower|replace(' ', '-')|replace('--','-') %}
{% set _desc_default  = 'Fuel the season. Fund the future.' %}
{% set _route = (request.endpoint if request is defined else '') %}
{% set _is_donate = (_route == 'main.donate') %}
{% set _page_title = (_TEAM.og_title_donate if (_is_donate and _TEAM and _TEAM.og_title_donate)
                      else _TEAM.og_title if (_TEAM and _TEAM.og_title)
                      else (_brand_name ~ (' — Donate' if _is_donate else ' — Fundraiser'))) %}
{% set _page_desc = (_TEAM.og_description_donate if (_is_donate and _TEAM and _TEAM.og_description_donate)
                     else _TEAM.og_description if (_TEAM and _TEAM.og_description)
                     else _desc_default) %}
{% set _hero_img = _TEAM.hero_image or _TEAM.hero_bg or 'images/hero/hero-1920.avif' %}
{% set _og_img   = _TEAM.og_image   or 'images/og_default.jpg' %}
{% set _manifest = WEB_MANIFEST if WEB_MANIFEST is defined else None %}
{% set _has_manifest = _manifest is not none %}
{% set USE_SOCKETIO = (USE_SOCKETIO if USE_SOCKETIO is defined else false) %}

{% set HREF_DONATE = HREF_DONATE if HREF_DONATE is defined and HREF_DONATE else (
    stripe_payment_link if (stripe_payment_link is defined and stripe_payment_link)
    else (url_for('main.donate') if (url_for is defined and has_endpoint is defined and has_endpoint('main.donate')) else '/donate')
  ) %}

{% set _og_path   = (_og_img if '://' in _og_img else (url_for('static', filename=_og_img, v=_ver) if url_for is defined else '/static/' ~ _og_img)) %}
{% set _hero_path = (_hero_img if '://' in _hero_img else (url_for('static', filename=_hero_img, v=_ver) if url_for is defined else '/static/' ~ _hero_img)) %}
{% set _manifest_path = (_manifest if _has_manifest and '://' in _manifest else (url_for('static', filename=_manifest, v=_ver) if _has_manifest and url_for is defined else None)) %}

<!doctype html>
<html lang="en"
      class="h-full antialiased selection:bg-yellow-300/25"
      data-theme="dark" data-brand="{{ _brand_slug }}" data-route="{{ _route|default('') }}">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="color-scheme" content="dark light"/>
  <meta name="theme-color" content="#0b0b0c" id="meta-theme-color"/>
  <meta name="referrer" content="strict-origin-when-cross-origin"/>
  <meta name="robots" content="index,follow,max-image-preview:large"/>

  {% if csrf_token is defined %}<meta name="csrf-token" content="{{ csrf_token() }}">{% endif %}
  <meta name="csp-nonce" content="{{ NONCE }}"/>
  <script {{ nonce_attr() }}>window.__CSP_NONCE="{{ NONCE }}";</script>

  <title>{% block title %}{{ _page_title }}{% endblock %}</title>
  <meta name="description" content="{{ _page_desc }}"/>
  {% if request is defined %}<link rel="canonical" href="{{ request.base_url }}"/>{% endif %}
  <meta property="og:type" content="website"/>
  <meta property="og:site_name" content="{{ _brand_name }}"/>
  <meta property="og:title" content="{{ _page_title }}"/>
  <meta property="og:description" content="{{ _page_desc }}"/>
  <meta property="og:image" content="{{ _og_path }}"/>
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:title" content="{{ _page_title }}"/>
  <meta name="twitter:description" content="{{ _page_desc }}"/>
  <meta name="twitter:image" content="{{ _og_path }}"/>
  <meta name="twitter:image:alt" content="{{ _brand_name }} fundraiser"/>

  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png', v=_ver) if url_for is defined else _og_path }}"/>
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='apple-touch-icon.png', v=_ver) if url_for is defined else _og_path }}"/>

  <link rel="preload" as="image" href="{{ _hero_path }}" imagesizes="(max-width:980px) 100vw, 60vw" fetchpriority="high"/>

  {% if _manifest_path %}
    <link rel="manifest" href="{{ _manifest_path }}"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  {% endif %}

  <link rel="preconnect" href="https://js.stripe.com" crossorigin>
  <link rel="dns-prefetch" href="https://js.stripe.com">
  <link rel="preconnect" href="https://www.paypal.com" crossorigin>
  <link rel="dns-prefetch" href="https://www.paypal.com">

  {% set _font_var = url_for('static', filename='fonts/Inter-roman.var.woff2', v=_ver) if url_for is defined else '/static/fonts/Inter-roman.var.woff2' %}
  <link rel="preload" as="font" type="font/woff2" href="{{ _font_var }}" crossorigin>
  <style {{ nonce_attr() }}>
    @font-face{
      font-family:"InterVar";
      src: url("{{ _font_var }}") format("woff2");
      font-weight: 100 900;
      font-display: swap;
      font-style: normal;
    }
    :root{
      --fc-accent: {{ _brand_hex }};
      --fc-brand:  var(--fc-accent);
      --fc-ring: color-mix(in srgb, var(--fc-brand) 65%, transparent);
      --fcx-shell-max: none;
      --fcx-gutter: clamp(14px, 5vw, 36px);
    }
    html,body{scroll-behavior:smooth}
    body{
      font-family:"InterVar", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      font-feature-settings:"cv02","cv03","cv04","cv11";
      font-variation-settings:"opsz" 14;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .fcx-section, .fcx-section--hero, .fcx-section--tiers{
      max-width: var(--fcx-shell-max); width:100%; margin-inline:auto; margin-bottom:3rem; padding-inline: var(--fcx-gutter);
      display:flex; flex-direction:column; gap:clamp(12px,2vw,20px);
      content-visibility:auto; contain-intrinsic-size: 1px 600px;
    }
    @media (prefers-reduced-motion: reduce){
      *{animation-duration:0.001ms!important; animation-iteration-count:1!important; transition-duration:0.001ms!important}
    }
  </style>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.min.css', v=_ver) if url_for is defined else '/static/css/tailwind.min.css' }}"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/fc-tokens.css', v=_ver) if url_for is defined else '/static/css/fc-tokens.css' }}"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/fc-widgets.css', v=_ver) if url_for is defined else '/static/css/fc-widgets.css' }}"/>

  {% block extra_head %}{% endblock %}
  {% block extra_css %}{% endblock %}
  {% block head %}{% endblock %}
</head>

<body class="min-h-full bg-zinc-950 text-zinc-100">
  <a id="skip-to-content" href="#main" class="sr-only focus:not-sr-only focus:fixed focus:top-2 focus:left-2 z-[1000]">Skip to content</a>
  <div id="site-header-sentinel" aria-hidden="true" class="h-0 w-full"></div>

  {# --- Header + Announcement Bar (keep, usually needed) --- #}
  {% include "partials/header_and_announcement.html" ignore missing with context %}

  {# --- Widgets: Optional, feature-toggled --- #}
  {% if show_qr_modal %}
    {% include "partials/widgets/qr_modal.html" ignore missing with context %}
  {% endif %}
  {% if show_command_palette %}
    {% include "partials/widgets/command_palette.html" ignore missing with context %}
  {% endif %}
  {% if show_newsletter %}
    {% include "partials/newsletter.html" ignore missing %}
  {% endif %}
  {# Block for per-page widgets (optional) #}
  {% block widgets %}{% endblock %}

  {# --- Main content --- #}
  <main id="main" role="main" class="relative">
    <h1 class="sr-only">{% block h1 %}{{ _brand_name }}{% endblock %}</h1>
    {% block content %}{% endblock %}
  </main>

  {# --- Footer (always needed) --- #}
  {% include "partials/footer.html" ignore missing with context %}

  {% include "partials/donation_modal.html" ignore missing %}
  
  {# --- Core JS bundles (deferred, nonced) --- #}
  <script src="{{ url_for('static', filename='js/bundle.min.js', v=_ver) if url_for is defined else '/static/js/bundle.min.js' }}" defer {{ nonce_attr() }}></script>
  {% if _is_donate %}
    <script src="{{ url_for('static', filename='js/donate.min.js', v=_ver) if url_for is defined else '/static/js/donate.min.js' }}" defer {{ nonce_attr() }}></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" defer {{ nonce_attr() }}></script>
  {% endif %}
  {% if USE_SOCKETIO %}
    <script src="/socket.io/socket.io.js" defer {{ nonce_attr() }}></script>
  {% endif %}
  <script src="{{ url_for('static', filename='js/fc-ui.js', v=_ver) if url_for is defined else '/static/js/fc-ui.js' }}" defer {{ nonce_attr() }}></script>

  {% block extra_js %}{% endblock %}
</body>
</html>

