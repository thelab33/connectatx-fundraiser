{# templates/base.html — Elite, DRY, deployment-ready #}
{% set asset_version = asset_version|default(0) %}
{% set team_name = team.team_name if team and team.team_name is defined else 'Connect ATX Elite' %}
{% set theme_hex  = team.theme_color|default('#facc15', true) %}

<!doctype html>
<html
  lang="{{ lang_code|default('en', true) }}"
  data-theme="{{ theme|default('dark', true) }}"
  class="no-js scroll-smooth antialiased bg-zinc-950 text-white font-sans{% if team and team.body_class %} {{ team.body_class }}{% endif %}"
  style="min-height:100%"
  itemscope itemtype="https://schema.org/WebSite"
>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, viewport-fit=cover" />

    <title>{% block head_title %}{{ team_name }} — FundChamps{% endblock %}</title>
    <meta name="description" content="{% block meta_description %}{{ team.meta_description|default('Connect ATX Elite — family-run AAU basketball in East Austin. Fuel the season; fund the future.', true) }}{% endblock %}" />
    <link rel="canonical" href="{% block canonical_url %}{{ request.base_url }}{% endblock %}" />
    <meta name="robots" content="index,follow,max-image-preview:large" />
    <meta name="color-scheme" content="dark light" />
    <meta name="theme-color" media="(prefers-color-scheme: dark)"  content="{{ theme_hex }}" />
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="{{ theme_hex }}" />

    {# OpenGraph / Twitter #}
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="FundChamps" />
    <meta property="og:title" content="{% block og_title %}{{ team.og_title|default(team_name ~ ' | Empowering Youth', true) }}{% endblock %}" />
    <meta property="og:description" content="{% block og_description %}{{ team.og_description|default('Every dollar goes to tournaments, travel, gear, and academics.', true) }}{% endblock %}" />
    <meta property="og:image" content="{{ (team.og_image if team and team.og_image else url_for('static', filename='images/connect-atx-team-mobile.jpg.webp', v=asset_version)) }}" />
    <meta property="og:url" content="{{ request.base_url }}" />
    <meta name="twitter:card" content="summary_large_image" />

    {# Performance hints #}
    <link rel="preconnect" href="https://js.stripe.com" crossorigin>
    <link rel="preconnect" href="https://www.paypal.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.socket.io">

    {# CSS (async with noscript fallback) #}
    <link rel="preload" as="style" href="{{ url_for('static', filename='css/tailwind.min.css', v=asset_version) }}" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.min.css', v=asset_version) }}"></noscript>

    {# Small utility style: support [x-cloak] without Alpine flash #}
    <style>[x-cloak]{display:none!important}</style>

    {# Page-specific head additions/preloads #}
    {% block head_extra %}{% endblock %}

    {# JS bootstrap: remove no-js, set save-data & mobile 100vh fix (CSP nonce-friendly) #}
    <script nonce="{{ csp_nonce() if csp_nonce is defined else '' }}">
      document.documentElement.classList.remove('no-js');
      try {
        if (navigator.connection && navigator.connection.saveData) document.documentElement.classList.add('save-data');
        const setVh=()=>{ document.documentElement.style.setProperty('--vh', `${window.innerHeight*0.01}px`); };
        setVh(); addEventListener('resize', setVh);
      } catch(_) {}
    </script>

    {# Optional JSON-LD for SportsTeam/Org #}
    {% if team %}
      {% set jsonld = {
        "@context":"https://schema.org",
        "@type":"SportsTeam",
        "name": team_name,
        "sport":"Basketball",
        "url": request.base_url,
        "areaServed": team.region if team.region is defined else "Austin, TX"
      } %}
      <script type="application/ld+json" nonce="{{ csp_nonce() if csp_nonce is defined else '' }}">{{ jsonld|tojson }}</script>
    {% endif %}
  </head>

  <body class="min-h-screen selection:bg-yellow-300/20 selection:text-yellow-100">
    {# Skip link for a11y #}
    <a href="#main" class="sr-only focus:not-sr-only focus:fixed focus:top-2 focus:left-2 focus:z-50 focus:rounded-md focus:bg-black focus:text-white focus:px-3 focus:py-2">Skip to content</a>

    {% block body_top %}
      {# Flash + onboarding (optional, harmless if missing) #}
      {% include 'partials/flash_and_onboarding.html' ignore missing %}

      {# Header (single source; hero/meter stay out of base) #}
      {% include 'partials/header_and_announcement.html' %}
    {% endblock %}

    <main id="main" class="relative w-full overflow-x-hidden">
      {% block content %}{% endblock %}
    </main>

    {% include 'partials/back_to_top.html' ignore missing %}
    {% include 'partials/footer.html' %}

    {# App config (exposed once; keep tiny) #}
    <script nonce="{{ csp_nonce() if csp_nonce is defined else '' }}">
      window.FC_APP = Object.freeze({
        stripe: {{ (payments_config.stripe_enabled if payments_config is defined else true)|tojson }},
        paypal: {{ (payments_config.paypal_enabled if payments_config is defined else true)|tojson }},
        theme: {{ theme|default('dark', true)|tojson }},
        version: {{ asset_version|int }}
      });
    </script>

    {# Core JS (no extra UI here to avoid duplicate partials) #}
    <script src="{{ url_for('static', filename='js/bundle.min.js', v=asset_version) }}" defer></script>
    <script src="{{ url_for('static', filename='js/fc-header-hero.js', v=asset_version) }}" defer></script>

    {# Page-specific scripts #}
    {% block scripts_extra %}{% endblock %}
  </body>
</html>

