{# ================= Base — SV-Elite (modern, CSP-safe, partial-aware) ================= #}
{% from 'partials/_core_helpers.html' import nonce_attr, sri, asset, asset_abs, script_tag, link_css %}
{% import 'partials/_fmt.html' as fmt %}

{# ---------- Inputs / team context ---------- #}
{% set TEAM        = team|default(_team|default({})) %}
{% set BRAND_HEX   = TEAM.theme_color|default('#f2c94c') %}
{% set BRAND_NAME  = TEAM.team_name|default('Connect ATX Elite') %}
{% set BRAND_SLUG  = (TEAM.team_slug or BRAND_NAME)|string|lower|replace(' ','-')|replace('_','-')|replace('--','-')|trim('-') %}

{# ---------- Runtime / environment ---------- #}
{% set LOCALE       = LOCALE|default('en_US') %}
{% set ROUTE        = request.endpoint if request is defined else '' %}
{% set IS_DONATE    = ROUTE == 'main.donate' %}
{% set VER          = ASSET_VER|default(ASSET_VERSION|default(VERSION|default(None))) %}
{% set NONCE        = NONCE|default(csp_nonce() if csp_nonce is defined else '') %}
{% set SRI          = SRI|default({}) %}
{% set SKIN         = SKIN|default('default') %}
{% set USE_SOCKETIO = USE_SOCKETIO|default(false) %}
{% set DEBUG        = DEBUG|default(false) %}
{% set GA_ID        = GA_ID|default(None) %}
{% set POSTHOG_KEY  = POSTHOG_KEY|default(None) %}
{% set POSTHOG_HOST = POSTHOG_HOST|default('https://app.posthog.com') %}
{% set WEBMANIFEST  = WEB_MANIFEST|default(None) %}

{# ---------- Icons / favs ---------- #}
{% set FAVICON     = TEAM.favicon|default('images/favicon.svg') %}
{% set APPLE_ICON  = TEAM.apple_icon|default('images/apple-touch-icon.png') %}

{# ---------- P2P / OG context ---------- #}
{% set PEER        = peer|default(_peer|default({})) %}
{% set CAMPAIGN    = campaign|default(_campaign|default({})) %}
{% set PEER_NAME   = PEER.display_name|default(PEER.name|default(None)) %}
{% set PEER_SLUG   = (PEER.slug|default(PEER_NAME|default('')))|string|lower|replace(' ','-')|replace('_','-')|replace('--','-')|trim('-') %}
{% set PEER_IMG    = PEER.og_image|default(PEER.avatar_url|default(PEER.photo_url|default(None))) %}
{% set CAMP_TITLE  = CAMPAIGN.title|default(None) %}
{% set CAMP_IMG    = CAMPAIGN.og_image|default(CAMPAIGN.cover_image|default(None)) %}
{% set IS_P2P      = PEER_NAME or CAMP_TITLE %}

{# ---------- Title / description / OG ---------- #}
{% set DESC_DEFAULT = 'Fuel the season. Fund the future.' %}
{% set BASE_TITLE   = TEAM.og_title_donate if IS_DONATE else TEAM.og_title %}
{% set BASE_TITLE   = BASE_TITLE or (BRAND_NAME ~ (IS_DONATE and ' — Donate' or ' — Fundraiser')) %}
{% set P2P_TITLE    = (PEER_NAME and (PEER_NAME ~ ' — ' ~ BRAND_NAME)) or (CAMP_TITLE and (CAMP_TITLE ~ ' — ' ~ BRAND_NAME)) %}
{% set PAGE_TITLE   = P2P_TITLE or BASE_TITLE %}
{% set BASE_DESC    = (IS_DONATE and TEAM.og_description_donate) or TEAM.og_description or DESC_DEFAULT %}
{% set P2P_DESC     = PEER.tagline|default(PEER.bio|default(CAMPAIGN.tagline|default(CAMPAIGN.summary|default(None)))) %}
{% set PAGE_DESC    = P2P_DESC or BASE_DESC %}
{% set OG_BRAND_IMG = TEAM.og_image|default('images/og_default.jpg') %}
{% set OG_IMG       = PEER_IMG or CAMP_IMG or OG_BRAND_IMG %}

{# ---------- Donate URL for global CTAs ---------- #}
{% set SPL         = (stripe_payment_link if stripe_payment_link is defined and stripe_payment_link) or '' %}
{% set HREF_DONATE = SPL or (safe_url_for('main.donate') if (safe_url_for is defined and has_endpoint is defined and has_endpoint('main.donate')) else '/donate') %}

<!doctype html>
<html lang="en"
      class="h-full antialiased selection:bg-white/20"
      data-theme="dark"
      data-brand="{{ BRAND_SLUG }}"
      data-route="{{ ROUTE|default('') }}"
      data-skin="{{ SKIN }}">
  <head>
    <!-- Meta / Canonical -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <meta name="color-scheme" content="dark light" />
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <meta name="robots" content="index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1" />
    <meta name="format-detection" content="telephone=no,address=no,email=no" />
    <meta name="csrf-token" content="{{ (csrf_token() if csrf_token is defined else '') }}" />
    <link rel="sitemap" type="application/xml" href="/sitemap.xml" />
    {% if request is defined %}
      <link rel="canonical" href="{{ request.base_url }}" />
      <meta property="og:url" content="{{ request.base_url }}" />
    {% endif %}

    <!-- Theme colors -->
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="{{ BRAND_HEX }}" />
    <meta name="theme-color" media="(prefers-color-scheme: dark)"  content="#0b0b0c" id="meta-theme-color" />

    <title>{% block title %}{{ PAGE_TITLE }}{% endblock %}</title>
    <meta name="description" content="{{ PAGE_DESC }}" />

    <!-- Open Graph / Twitter -->
    <meta property="og:type" content="{{ IS_P2P and 'profile' or 'website' }}" />
    <meta property="og:site_name" content="{{ BRAND_NAME }}" />
    <meta property="og:title" content="{{ PAGE_TITLE }}" />
    <meta property="og:description" content="{{ PAGE_DESC }}" />
    <meta property="og:image" content="{{ asset_abs(OG_IMG) }}" />
    <meta property="og:image:alt" content="{{ BRAND_NAME }}" />
    <meta property="og:locale" content="{{ LOCALE }}" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="{{ PAGE_TITLE }}" />
    <meta name="twitter:description" content="{{ PAGE_DESC }}" />
    <meta name="twitter:image" content="{{ asset_abs(OG_IMG) }}" />
    <meta name="twitter:image:alt" content="{{ BRAND_NAME }}" />
    {% if TEAM.twitter %}<meta name="twitter:site" content="{{ TEAM.twitter }}" />{% endif %}

    <!-- Icons / Manifest -->
    <link rel="icon" type="image/svg+xml" href="{{ asset(FAVICON) }}" />
    <link rel="alternate icon" type="image/png" href="{{ asset('images/favicon.png') }}" />
    <link rel="apple-touch-icon" href="{{ asset(APPLE_ICON) }}" />
    <meta name="apple-mobile-web-app-title" content="{{ BRAND_NAME }}" />
    {% if WEBMANIFEST %}
      <link rel="manifest" href="{{ asset(WEBMANIFEST) }}" />
      <meta name="apple-mobile-web-app-capable" content="yes" />
      <meta name="mobile-web-app-capable" content="yes" />
      <meta name="apple-mobile-web-app-status-bar" content="black-translucent" />
    {% endif %}

    <!-- Hints (Stripe + analytics) -->
    {% for h in ['https://js.stripe.com','https://checkout.stripe.com','https://api.stripe.com'] %}
      <link rel="dns-prefetch" href="{{ h }}" />
      <link rel="preconnect"   href="{{ h }}" crossorigin />
    {% endfor %}
    {% if POSTHOG_KEY %}<link rel="preconnect" href="{{ POSTHOG_HOST }}" crossorigin />{% endif %}
    {% if USE_SOCKETIO %}<link rel="preconnect" href="/socket.io/" crossorigin />{% endif %}
    {% if request is defined %}<link rel="preconnect" href="{{ request.url_root }}" />{% endif %}
    <link rel="preconnect" href="https://checkout.stripe.com" crossorigin>
    <link rel="prefetch" as="document" href="{{ HREF_DONATE }}">

    <!-- Hero preload -->
    {% if hero_image_url %}
      <link rel="preload" as="image" href="{{ hero_image_url }}" fetchpriority="high" />
    {% else %}
      <link rel="preload" as="image" href="{{ asset('images/hero/hero-1920.avif') }}" imagesizes="100vw"
            imagesrcset="{{ asset('images/hero/hero-1920.avif') }} 1920w, {{ asset('images/hero/hero-1280.avif') }} 1280w, {{ asset('images/hero/hero-960.avif') }} 960w"
            fetchpriority="high" />
    {% endif %}

    <!-- CSS: single authoritative bundle -->
    {{ link_css(asset('css/app.min.css'), 'css/app.min.css') }}

    <!-- JSON-LD (Org + FundChamps brand + Donate action) -->
    <script {{ nonce_attr(NONCE) }} type="application/ld+json">
      {
        "@context":"https://schema.org",
        "@graph":[
          {
            "@type":"Organization",
            "name":"{{ BRAND_NAME|e }}"{% if request is defined %},
            "url":"{{ request.base_url }}"{% endif %},
            "logo":"{{ asset_abs(PEER_IMG or OG_IMG) }}",
            "image":"{{ asset_abs(OG_IMG) }}",
            "brand":"{{ BRAND_SLUG|e }}"{% if TEAM and (TEAM.instagram or TEAM.facebook or TEAM.twitter or TEAM.website) %},
            "sameAs":[
              {% if TEAM.website %}"{{ TEAM.website }}"{% if TEAM.instagram or TEAM.facebook or TEAM.twitter %},{% endif %}{% endif %}
              {% if TEAM.instagram %}"{{ TEAM.instagram }}"{% if TEAM.facebook or TEAM.twitter %},{% endif %}{% endif %}
              {% if TEAM.facebook %}"{{ TEAM.facebook }}"{% if TEAM.twitter %},{% endif %}{% endif %}
              {% if TEAM.twitter %}"{{ TEAM.twitter }}"{% endif %}
            ]{% endif %}
          },
          { "@type":"Brand","name":"FundChamps","url":"https://fundchamps.org" }{% if IS_P2P and PEER_NAME %},
          { "@type":"Person","name":"{{ PEER_NAME|e }}"{% if PEER_IMG %},"image":"{{ asset_abs(PEER_IMG) }}"{% endif %} }{% endif %},
          {
            "@type":"DonateAction",
            "name":"Donate to {{ BRAND_NAME|e }}{% if IS_P2P and PEER_NAME %} — {{ PEER_NAME|e }}{% endif %}",
            "recipient":{"@type":"Organization","name":"{{ BRAND_NAME|e }}"},
            "target":{"@type":"EntryPoint","urlTemplate":"{% if safe_url_for is defined and has_endpoint('main.donate') %}{{ safe_url_for('main.donate') }}{% elif request is defined %}{{ request.base_url ~ 'donate' }}{% else %}/donate{% endif %}"}
          }
        ]
      }
    </script>

    <!-- Analytics bootstrap -->
    <script {{ nonce_attr(NONCE) }}>
      window.dataLayer = window.dataLayer || [];
      window.fcTrack = function (event, props) {
        try { window.dataLayer.push({ event, ...(props || {}) }); } catch {}
        try { window.posthog?.capture?.(event, props || {}); } catch {}
      };
    </script>
    {% if GA_ID %}
      <script {{ nonce_attr(NONCE) }} async src="https://www.googletagmanager.com/gtag/js?id={{ GA_ID }}"></script>
      <script {{ nonce_attr(NONCE) }}>
        function gtag(){ (window.dataLayer = window.dataLayer || []).push(arguments); }
        gtag('js', new Date()); gtag('config', '{{ GA_ID }}', { anonymize_ip: true, send_page_view: true });
      </script>
    {% endif %}
    {% if POSTHOG_KEY %}
      <script {{ nonce_attr(NONCE) }}>
        (function(d,w){
          var ph = w.posthog || (w.posthog=[]), s = d.createElement('script');
          s.async=1; s.src=(("{{ POSTHOG_HOST }}".replace(/\/$/,'')||'https://app.posthog.com') + '/static/array.js');
          d.head.appendChild(s); if (ph.init) ph.init('{{ POSTHOG_KEY }}', { api_host:'{{ POSTHOG_HOST }}' });
        })(document, window);
      </script>
    {% endif %}

    {% block extra_head %}{% endblock %}
  </head>

  <body class="min-h-full bg-[color:var(--fc-ink)] text-zinc-100">
    {% block header %}{% include "partials/header_and_announcement.html" ignore missing with context %}{% endblock %}

    <main id="main" role="main" class="relative" tabindex="-1">
      <h1 class="sr-only">{% block h1 %}{{ BRAND_NAME }}{% endblock %}</h1>
      <p id="sr-live" class="sr-only" aria-live="polite" aria-atomic="true"></p>

      {% block section_hero %}{% endblock %}
      {% block section_impact %}{% endblock %}
      {% block section_tiers %}{% endblock %}
      {% block section_about %}{% endblock %}
      {% block sections_extra %}{% endblock %}
      {% block content %}{% endblock %}
    </main>

    {# --- Newsletter lives in base so every page can pick it up --- #}
    {% block below_main %}
      {% include "partials/newsletter.html" ignore missing with context %}
    {% endblock %}

    {% block footer %}{% include "partials/footer.html" ignore missing with context %}{% endblock %}

    <!-- JS boot with ESM + SRI fallback -->
    <link rel="modulepreload" href="{{ asset('js/main.js') }}" />
    {% if sri('js/bundle.min.js') %}
      <link rel="preload" as="script" href="{{ asset('js/bundle.min.js') }}" crossorigin="anonymous" integrity="{{ sri('js/bundle.min.js') }}" />
    {% else %}
      <link rel="preload" as="script" href="{{ asset('js/bundle.min.js') }}" />
    {% endif %}
    <script {{ nonce_attr(NONCE) }}>
      (function(){
        var head=document.head;
        function fallback(){
          var s=document.createElement('script'); s.defer=true;
          {% if sri('js/bundle.min.js') %}s.integrity="{{ sri('js/bundle.min.js') }}"; s.crossOrigin='anonymous';{% endif %}
          {% if NONCE %}try{s.setAttribute('nonce','{{ NONCE }}')}catch(e){}{% endif %}
          s.src="{{ asset('js/bundle.min.js') }}"; head.appendChild(s);
        }
        try{
          var m=document.createElement('script'); m.type='module'; m.defer=true;
          {% if NONCE %}m.setAttribute('nonce','{{ NONCE }}');{% endif %}
          m.src="{{ asset('js/main.js') }}"; m.onerror=fallback; head.appendChild(m);
        }catch(_){ fallback(); }
      })();
    </script>

    {% if IS_DONATE %}
      {{ script_tag(asset('js/donate.min.js'), defer=true, sri_key='js/donate.min.js', nonce=NONCE) }}
    {% endif %}
    {% if USE_SOCKETIO %}
      <script {{ nonce_attr(NONCE) }} src="/socket.io/socket.io.js" defer></script>
    {% endif %}

    <!-- Dynamic theme + meta color -->
    <script {{ nonce_attr(NONCE) }}>
      (function () {
        var meta = document.getElementById("meta-theme-color");
        var root = document.documentElement;
        try{ var saved = localStorage.getItem('fc_theme'); if (saved) root.setAttribute('data-theme', saved); }catch{}
        function setColor() {
          var theme = root.getAttribute('data-theme') || (matchMedia("(prefers-color-scheme: dark)").matches ? 'dark' : 'light');
          if (meta) meta.setAttribute("content", theme === 'dark' ? "#0b0b0c" : "{{ BRAND_HEX }}");
        }
        setColor();
        try { matchMedia("(prefers-color-scheme: dark)").addEventListener("change", setColor); } catch {}
        window.fcTheme = {
          set: function(mode){ if(!mode) return; root.setAttribute('data-theme', mode);
            try{localStorage.setItem('fc_theme',mode)}catch{}; setColor(); },
          toggle: function(){ this.set(root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }
        };
      })();
    </script>

    <!-- Sticky seam calc (header + leaderboard) -->
    <script {{ nonce_attr(NONCE) }}>
      (function(){
        if (window.__fcSeam) return; window.__fcSeam = true;
        var root   = document.documentElement;
        var header = document.getElementById("site-header");
        var ticker = document.getElementById("sponsor-leaderboard");
        function calc(){
          var h = (header && header.offsetHeight || 0) + (ticker && ticker.offsetHeight || 0);
          if (h){
            root.style.setProperty("--fc-header-h", h + "px");
            root.style.setProperty("--sticky-offset", h + "px");
          }
        }
        function raf(){ requestAnimationFrame(calc); }
        raf();
        try{
          var ro = new ResizeObserver(raf);
          if (header) ro.observe(header);
          if (ticker) ro.observe(ticker);
          addEventListener("pagehide", function(){ ro.disconnect(); }, { once:true });
        }catch{}
        addEventListener("resize", raf, { passive:true });
        addEventListener("load", raf, { once:true });
        document.addEventListener && document.addEventListener("htmx:afterSettle", raf);
      })();
    </script>

    <!-- P2P / UTM propagation (exports window.addParams) -->
    <script {{ nonce_attr(NONCE) }}>
      (function(){
        var qs = new URLSearchParams(location.search);
        var KEYS = ["ref","ref_id","peer","peer_id","peer_slug","campaign","campaign_id"];
        try {
          var incoming = Object.fromEntries(KEYS.map(function(k){return [k,qs.get(k)]}).filter(function(x){return x[1]}));
          if (Object.keys(incoming).length) {
            localStorage.setItem("fc_ref_ctx", JSON.stringify({ v:1, ttl:Date.now()+30*24*3600*1000, data:incoming }));
          }
        } catch {}

        var merged = (function(){
          var out = {};
          KEYS.forEach(function(k){ var v = qs.get(k); if (v) out[k]=v; });
          try {
            var raw = localStorage.getItem("fc_ref_ctx");
            if (raw) {
              var o = JSON.parse(raw);
              if (o && o.ttl && Date.now() <= o.ttl && o.data) {
                Object.keys(o.data).forEach(function(k){ if (o.data[k] && !out[k]) out[k] = o.data[k]; });
              }
            }
          } catch {}
          return out;
        })();

        function addParams(url, extra){
          extra = extra || {};
          try {
            var u = new URL(url, location.origin);
            Object.entries(Object.assign({}, merged, extra)).forEach(function(p){ var k=p[0],v=p[1]; if (v!=null && v!=='') u.searchParams.set(k,v); });
            return u.toString();
          } catch {
            var sep = url.indexOf("?")>-1 ? "&" : "?";
            return url + sep + new URLSearchParams(Object.assign({}, merged, extra)).toString();
          }
        }
        window.addParams = addParams;

        function decorate(root){
          root = root || document;
          root.querySelectorAll('a[href*="donate"], a[href*="sponsor"], a[data-p2p-propagate="1"]').forEach(function(a){
            var where = a.getAttribute("data-analytics-meta") || "{}";
            var medium = "cta";
            try{ var m = JSON.parse(where); if (m.where) medium = m.where; }catch{}
            a.href = addParams(a.getAttribute("href") || "#", { utm_source:"site", utm_medium:medium, utm_campaign:"fundraiser" });
            if (a.hasAttribute("data-payment-link") && !a.hasAttribute("target")){
              a.target = "_blank"; a.rel = "nofollow noopener noreferrer";
            }
          });
          root.querySelectorAll("[data-share]").forEach(function(btn){
            try{
              var area = (btn.closest("#site-header,#fc-hero,#footer") || {}).id || "body";
              var p = JSON.parse(btn.getAttribute("data-share") || "{}");
              p.url = addParams(p.url || location.href, { utm_source:"share", utm_medium: area.replace('fc-',''), utm_campaign:"fan_share" });
              btn.setAttribute("data-share", JSON.stringify(p));
            }catch{}
          });
        }
        if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", function(){ decorate(document); });
        else decorate(document);
      })();
    </script>

    <!-- Global analytics click delegate -->
    <script {{ nonce_attr(NONCE) }}>
      document.addEventListener('click', function(e){
        var a = e.target.closest && e.target.closest('[data-analytics]');
        if (!a) return;
        var ev = a.getAttribute('data-analytics');
        var meta = {};
        try{ meta = JSON.parse(a.getAttribute('data-analytics-meta') || '{}'); }catch{}
        window.fcTrack && window.fcTrack(ev, meta);
      }, { capture:true, passive:true });
    </script>

    <!-- Sticky Donate Dock -->
    <div id="fc-dock" style="position:fixed;inset:auto 16px 16px auto;z-index:60;display:none;">
      <a id="fc-dock-btn"
         href="{{ HREF_DONATE }}"
         class="sf-btn sf-btn-primary sf-btn-sm"
         aria-label="Donate"
         style="display:inline-flex;align-items:center;gap:.5rem;border-radius:999px;padding:.65rem 1rem;font-weight:900;">
        <span aria-hidden="true">💛</span> Donate
      </a>
    </div>
    <script {{ nonce_attr(NONCE) }}>
      (function(){
        var btn  = document.getElementById('fc-dock-btn');
        var dock = document.getElementById('fc-dock');
        if (!btn || !dock) return;
        try { btn.href = window.addParams ? addParams(new URL(btn.href, location.origin).toString()) : btn.href; } catch {}
        var shown = false;
        var hero = document.querySelector('#top, #fc-hero, [data-rails]');
        if (!hero) return;
        var io = new IntersectionObserver(function(ents){
          var above = ents[0] && !ents[0].isIntersecting;
          if (above && !shown){ dock.style.display='block'; shown=true; }
          if (!above && shown){ dock.style.display='none'; shown=false; }
        }, { threshold: 0.01 });
        io.observe(hero);
      })();
    </script>

  </body>
</html>

