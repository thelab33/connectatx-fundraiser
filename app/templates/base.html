{# ================= Base Context + Helpers — SV-Elite (enterprise refactor) ================ #}
{# ---------- Core helpers (declare first so we can use them below) ---------- #}
{% macro nonce_attr() -%}{% if NONCE %}nonce="{{ NONCE }}"{% endif %}{%- endmacro %}
{% macro sri(path)   -%}{{ SRI.get(path) if SRI else None }}{%- endmacro %}
{% macro asset(path) -%}
  {%- if path -%}
    {%- if url_for is defined -%}{{ url_for('static', filename=path, v=VER if VER else None) }}
    {%- else -%}/static/{{ path.lstrip('/') }}{% endif -%}
  {%- endif -%}
{%- endmacro %}
{% macro asset_abs(path) -%}
  {%- set rel = asset(path) -%}
  {%- if not rel -%}{% set _ = None %}{{ '' }}
  {%- elif rel.startswith('http') or rel.startswith('//') -%}{{ rel }}
  {%- elif request is defined -%}{{ request.url_root ~ rel.lstrip('/') }}
  {%- else -%}{{ rel }}{% endif -%}
{%- endmacro %}
{% macro script_tag(src, module=false, defer=true, async=false, sri_key=None) -%}
  <script {{ nonce_attr() }}{% if module %} type="module"{% endif %}{% if async %} async{% endif %}{% if defer %} defer{% endif %}
          src="{{ src }}"{% if sri(sri_key) %} integrity="{{ sri(sri_key) }}" crossorigin="anonymous"{% endif %}></script>
{%- endmacro %}
{% macro link_css(href, sri_key=None) -%}
  <link rel="stylesheet" href="{{ href }}"{% if sri(sri_key) %} integrity="{{ sri(sri_key) }}" crossorigin="anonymous"{% endif %}>
{%- endmacro %}

{# ---------- Inputs / team context ---------- #}
{% set TEAM         = team|default(_team|default({})) %}
{% set BRAND_HEX    = TEAM.theme_color|default('#f2c94c') %}
{% set BRAND_NAME   = TEAM.team_name|default('Connect ATX Elite') %}
{% set BRAND_SLUG   = (TEAM.team_slug or BRAND_NAME)|string|lower|replace(' ', '-')|replace('_','-')|replace('--','-')|trim('-') %}

{# ---------- Runtime / environment ---------- #}
{% set LOCALE       = LOCALE|default('en_US') %}
{% set ROUTE        = request.endpoint if request is defined else '' %}
{% set IS_DONATE    = ROUTE == 'main.donate' %}
{% set VER          = ASSET_VER|default(ASSET_VERSION|default(VERSION|default(None))) %}
{% set NONCE        = NONCE|default(csp_nonce() if csp_nonce is defined else '') %}
{% set SRI          = SRI|default({}) %}
{% set SKIN         = SKIN|default('default') %}
{% set USE_SOCKETIO = USE_SOCKETIO|default(false) %}
{% set DEBUG        = DEBUG|default(false) %}
{% set GA_ID        = GA_ID|default(None) %}
{% set POSTHOG_KEY  = POSTHOG_KEY|default(None) %}
{% set POSTHOG_HOST = POSTHOG_HOST|default('https://app.posthog.com') %}
{% set WEBMANIFEST  = WEB_MANIFEST|default(None) %}

{# ---------- Icons / favs ---------- #}
{% set FAVICON      = TEAM.favicon|default('images/favicon.svg') %}
{% set APPLE_ICON   = TEAM.apple_icon|default('images/apple-touch-icon.png') %}

{# ---------- P2P / OG context ---------- #}
{% set PEER         = peer|default(_peer|default({})) %}
{% set CAMPAIGN     = campaign|default(_campaign|default({})) %}
{% set PEER_NAME    = PEER.display_name|default(PEER.name|default(None)) %}
{% set PEER_SLUG    = (PEER.slug|default(PEER_NAME|default('')))|string|lower|replace(' ', '-')|replace('_','-')|replace('--','-')|trim('-') %}
{% set PEER_IMG     = PEER.og_image|default(PEER.avatar_url|default(PEER.photo_url|default(None))) %}
{% set CAMP_TITLE   = CAMPAIGN.title|default(None) %}
{% set CAMP_IMG     = CAMPAIGN.og_image|default(CAMPAIGN.cover_image|default(None)) %}
{% set IS_P2P       = PEER_NAME or CAMP_TITLE %}

{# ---------- Title / description / OG ---------- #}
{% set DESC_DEFAULT = 'Fuel the season. Fund the future.' %}
{% set BASE_TITLE   = TEAM.og_title_donate if IS_DONATE else TEAM.og_title %}
{% set BASE_TITLE   = BASE_TITLE or (BRAND_NAME ~ (IS_DONATE and ' — Donate' or ' — Fundraiser')) %}
{% set P2P_TITLE    = (PEER_NAME and (PEER_NAME ~ ' — ' ~ BRAND_NAME)) or (CAMP_TITLE and (CAMP_TITLE ~ ' — ' ~ BRAND_NAME)) %}
{% set PAGE_TITLE   = P2P_TITLE or BASE_TITLE %}
{% set BASE_DESC    = (IS_DONATE and TEAM.og_description_donate) or TEAM.og_description or DESC_DEFAULT %}
{% set P2P_DESC     = PEER.tagline|default(PEER.bio|default(CAMPAIGN.tagline|default(CAMPAIGN.summary|default(None)))) %}
{% set PAGE_DESC    = P2P_DESC or BASE_DESC %}
{% set OG_BRAND_IMG = TEAM.og_image|default('images/og_default.jpg') %}
{% set OG_IMG       = PEER_IMG or CAMP_IMG or OG_BRAND_IMG %}

<!doctype html>
<html lang="en" class="h-full antialiased selection:bg-white/20"
      data-theme="dark" data-brand="{{ BRAND_SLUG }}" data-route="{{ ROUTE|default('') }}" data-skin="{{ SKIN }}">
<head>
  <!-- Meta / Canonical -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="color-scheme" content="dark light">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="{{ BRAND_HEX }}">
  <meta name="theme-color" media="(prefers-color-scheme: dark)"  content="#0b0b0c" id="meta-theme-color">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta name="robots" content="index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1">
  <meta name="format-detection" content="telephone=no,address=no,email=no">
  <meta name="csrf-token" content="{{ (csrf_token() if csrf_token is defined else '') }}">
  <link rel="sitemap" type="application/xml" href="/sitemap.xml">
  {% if request is defined %}
    <link rel="canonical" href="{{ request.base_url }}">
    <meta property="og:url" content="{{ request.base_url }}">
  {% endif %}

  <title>{% block title %}{{ PAGE_TITLE }}{% endblock %}</title>
  <meta name="description" content="{{ PAGE_DESC }}">

  <!-- Open Graph / Twitter -->
  <meta property="og:type" content="{{ IS_P2P and 'profile' or 'website' }}">
  <meta property="og:site_name" content="{{ BRAND_NAME }}">
  <meta property="og:title" content="{{ PAGE_TITLE }}">
  <meta property="og:description" content="{{ PAGE_DESC }}">
  <meta property="og:image" content="{{ asset_abs(OG_IMG) }}">
  <meta property="og:image:alt" content="{{ BRAND_NAME }}">
  <meta property="og:locale" content="{{ LOCALE }}">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ PAGE_TITLE }}">
  <meta name="twitter:description" content="{{ PAGE_DESC }}">
  <meta name="twitter:image" content="{{ asset_abs(OG_IMG) }}">
  <meta name="twitter:image:alt" content="{{ BRAND_NAME }}">
  {% if TEAM.twitter %}<meta name="twitter:site" content="{{ TEAM.twitter }}">{% endif %}

  <!-- Icons / Manifest -->
  <link rel="icon" type="image/svg+xml" href="{{ asset(FAVICON) }}">
  <link rel="alternate icon" type="image/png" href="{{ asset('images/favicon.png') }}">
  <link rel="apple-touch-icon" href="{{ asset(APPLE_ICON) }}">
  <meta name="apple-mobile-web-app-title" content="{{ BRAND_NAME }}">
  {% if WEBMANIFEST %}
    <link rel="manifest" href="{{ asset(WEBMANIFEST) }}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar" content="black-translucent">
  {% endif %}

  <!-- Hints -->
  {% for h in ['https://js.stripe.com','https://checkout.stripe.com','https://api.stripe.com'] %}
    <link rel="dns-prefetch" href="{{ h }}"><link rel="preconnect" href="{{ h }}" crossorigin>
  {% endfor %}
  {% if POSTHOG_KEY %}<link rel="preconnect" href="{{ POSTHOG_HOST }}" crossorigin>{% endif %}
  {% if USE_SOCKETIO %}<link rel="preconnect" href="/socket.io/" crossorigin>{% endif %}
  {% if request is defined %}<link rel="preconnect" href="{{ request.url_root }}">{% endif %}

  <!-- Preload hero (if provided) -->
  {% if hero_image_url %}
    <link rel="preload" as="image" href="{{ hero_image_url }}" fetchpriority="high">
  {% else %}
    <link rel="preload" as="image"
          href="{{ asset('images/hero/hero-1920.avif') }}"
          imagesizes="100vw"
          imagesrcset="{{ asset('images/hero/hero-1920.avif') }} 1920w, {{ asset('images/hero/hero-1280.avif') }} 1280w, {{ asset('images/hero/hero-960.avif') }} 960w"
          fetchpriority="high">
  {% endif %}

  <!-- CSS -->
  {{ link_css(asset('css/app.min.css'), 'css/app.min.css') }}
  {% if SKIN == 'shopify' %}{% include "partials/_shopify_head_include.html" ignore missing %}{% endif %}
  <link rel="stylesheet" href="{{ asset('starforge/brand-spine.css') }}">
  <link rel="modulepreload" href="{{ asset('starforge/enable-brand-spine.js') }}">

  <!-- Design tokens / base utilities -->
  <style {{ nonce_attr() }}>
    :root{
      --fc-brand: {{ BRAND_HEX }}; --fc-gold: var(--fc-brand);
      --fc-ink:#0B0B10; --fc-ash:#1B1E26; --fc-coal:#111318;
      --container-max: 1200px; --container-reading: 72ch;
      --radius-xl: 1.25rem; --gutter: clamp(16px, 3vw, 28px);
      --section-y: clamp(1.6rem, 3.6vw, 3.2rem);
      --section-y-tight: calc(var(--section-y) * .65);
      --fc-header-h: 72px; --sticky-offset: var(--fc-header-h);
      --safe-top: env(safe-area-inset-top, 0px); --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    html{ scroll-padding-top: var(--fc-header-h) }
    .container{ max-width:var(--container-max); margin-inline:auto; padding-inline:var(--gutter) }
    .container-wide{ max-width: calc(var(--container-max) + 180px) }
    .container-narrow{ max-width:min(var(--container-reading), var(--container-max)) }
    .section{ padding-block: var(--section-y) }
    .section--tight{ padding-block: var(--section-y-tight) }
    .section--loose{ padding-block: calc(var(--section-y) * 1.35) }
    .section--flush-top{ padding-top:0 !important }
    .seam-header{ margin-top: calc(-1 * var(--sticky-offset)); padding-top: var(--sticky-offset) }
    .seam-after-hero{ padding-top: calc(var(--section-y-tight) * .5) }
    .section + .section{ padding-top: var(--section-y-tight) }
    section[aria-labelledby], section[id]{ scroll-margin-top: var(--sticky-offset) }
    .stack > * + *{ margin-top: clamp(.6rem, .7vw, .9rem) } .tight > * + *{ margin-top:.55rem }
    html, body{ overflow-x:hidden }
    .sr-only{ position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0 }
    @media (prefers-reduced-motion: reduce){
      *{ animation-duration:.001ms !important; animation-iteration-count:1 !important; transition-duration:.001ms !important; scroll-behavior:auto !important }
    }
    @media print{ header, footer, [role="dialog"]{ display:none !important } .section{ padding-block:1rem } }
  </style>

  <!-- JSON-LD -->
  <script {{ nonce_attr() }} type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@graph":[
      {
        "@type":"Organization",
        "name":"{{ BRAND_NAME|e }}",
        {% if request is defined %}"url":"{{ request.base_url }}",{% endif %}
        "logo":"{{ asset_abs(PEER_IMG or OG_IMG) }}",
        "image":"{{ asset_abs(OG_IMG) }}",
        "brand":"{{ BRAND_SLUG|e }}"{% if TEAM and (TEAM.instagram or TEAM.facebook or TEAM.twitter or TEAM.website) %},
        "sameAs":[
          {% if TEAM.website %}"{{ TEAM.website }}"{% if TEAM.instagram or TEAM.facebook or TEAM.twitter %},{% endif %}{% endif %}
          {% if TEAM.instagram %}"{{ TEAM.instagram }}"{% if TEAM.facebook or TEAM.twitter %},{% endif %}{% endif %}
          {% if TEAM.facebook %}"{{ TEAM.facebook }}"{% if TEAM.twitter %},{% endif %}{% endif %}
          {% if TEAM.twitter %}"{{ TEAM.twitter }}"{% endif %}
        ]{% endif %}
      }
      {% if IS_P2P and PEER_NAME %},
      { "@type":"Person", "name":"{{ PEER_NAME|e }}"{% if PEER_IMG %}, "image":"{{ asset_abs(PEER_IMG) }}"{% endif %} }
      {% endif %},
      {
        "@type":"DonateAction",
        "name":"Donate to {{ BRAND_NAME|e }}{% if IS_P2P and PEER_NAME %} — {{ PEER_NAME|e }}{% endif %}",
        "recipient":{"@type":"Organization","name":"{{ BRAND_NAME|e }}"},
        "target":{"@type":"EntryPoint","urlTemplate":"{% if safe_url_for is defined and has_endpoint('main.donate') %}{{ safe_url_for('main.donate') }}{% elif request is defined %}{{ request.base_url ~ 'donate' }}{% else %}/donate{% endif %}"}
      }
    ]
  }
  </script>

  <!-- Analytics bootstrap -->
  <script {{ nonce_attr() }}>
    window.dataLayer = window.dataLayer || [];
    window.fcTrack = function(event, props){
      try{ window.dataLayer.push({event, ...(props||{})}); }catch{}
      try{ window.posthog?.capture?.(event, props||{}); }catch{}
    };
  </script>
  {% if GA_ID %}
    <script {{ nonce_attr() }} async src="https://www.googletagmanager.com/gtag/js?id={{ GA_ID }}"></script>
    <script {{ nonce_attr() }}>
      function gtag(){(window.dataLayer=window.dataLayer||[]).push(arguments)}
      gtag('js', new Date()); gtag('config','{{ GA_ID }}',{ anonymize_ip:true, send_page_view:true });
    </script>
  {% endif %}
  {% if POSTHOG_KEY %}
    <script {{ nonce_attr() }}>
      !function(d,w){var ph=w.posthog||(w.posthog=[]),s=d.createElement('script');
        s.async=1;s.src=('{{ POSTHOG_HOST }}'.replace(/\/$/,'')||'https://app.posthog.com')+'/static/array.js';
        d.head.appendChild(s); ph.init&&ph.init('{{ POSTHOG_KEY }}',{api_host:'{{ POSTHOG_HOST }}'});} (document,window);
    </script>
  {% endif %}

  {% block extra_head %}{% endblock %}
  <link rel="stylesheet" href="/static/css/qr-badge.css">
</head>

<body class="min-h-full bg-[color:var(--fc-ink)] text-zinc-100">
  {% block header %}{% include "partials/header_and_announcement.html" ignore missing with context %}{% endblock %}
  {% block above_main %}{% endblock %}

  <main id="main" role="main" class="relative" tabindex="-1">
    <h1 class="sr-only">{% block h1 %}{{ BRAND_NAME }}{% endblock %}</h1>
    <p id="sr-live" class="sr-only" aria-live="polite" aria-atomic="true"></p>

    {% block section_ticker %}{% endblock %}
    {% block section_hero %}{% endblock %}
    {% block section_pulse %}{% endblock %}
    {% block section_impact %}{% endblock %}
    {% block section_tiers %}{% endblock %}
    {% block section_about %}{% endblock %}
    {% block section_concierge %}{% endblock %}
    {% block sections_extra %}{% endblock %}
    {% block content %}{% endblock %}
  </main>

  {% block below_main %}{% endblock %}
  {% block footer %}{% include "partials/footer.html" ignore missing with context %}{% endblock %}

  <!-- JS boot with ESM + SRI fallback -->
  <link rel="modulepreload" href="{{ asset('js/main.js') }}">
  <link rel="preload" as="script" href="{{ asset('js/bundle.min.js') }}" {% if sri('js/bundle.min.js') %}crossorigin="anonymous" integrity="{{ sri('js/bundle.min.js') }}"{% endif %}>
  <script {{ nonce_attr() }}>
    (function(){
      var head=document.head;
      function fallback(){
        var s=document.createElement('script'); s.defer=true;
        {% if sri('js/bundle.min.js') %}s.integrity="{{ sri('js/bundle.min.js') }}"; s.crossOrigin='anonymous';{% endif %}
        s.src="{{ asset('js/bundle.min.js') }}"; head.appendChild(s);
      }
      try{
        var m=document.createElement('script'); m.type='module'; m.defer=true;
        {% if NONCE %}m.setAttribute('nonce','{{ NONCE }}');{% endif %}
        m.src="{{ asset('js/main.js') }}"; m.onerror=fallback; head.appendChild(m);
      }catch(_){ fallback(); }
    })();
  </script>

  {% if IS_DONATE %}{{ script_tag(asset('js/donate.min.js'), defer=true, sri_key='js/donate.min.js') }}{% endif %}
  {% if USE_SOCKETIO %}<script {{ nonce_attr() }} src="/socket.io/socket.io.js" defer></script>{% endif %}

  <!-- Dynamic theme meta color -->
  <script {{ nonce_attr() }}>
    (function(){
      var meta=document.getElementById('meta-theme-color'); if(!meta) return;
      function setColor(){ meta.setAttribute('content', matchMedia('(prefers-color-scheme: dark)').matches ? '#0b0b0c' : '{{ BRAND_HEX }}'); }
      setColor(); try{ matchMedia('(prefers-color-scheme: dark)').addEventListener('change', setColor);}catch{}
    })();
  </script>

  <!-- Sticky seam calc -->
  <script {{ nonce_attr() }}>
    (() => {
      if (window.__fcSeam) return; window.__fcSeam = true;
      const root=document.documentElement, header=document.getElementById('site-header'), ticker=document.getElementById('sponsor-leaderboard');
      const calc=()=>{ const h=(header?.offsetHeight||0)+(ticker?.offsetHeight||0);
        if(h){ root.style.setProperty('--fc-header-h', h+'px'); root.style.setProperty('--sticky-offset', h+'px'); }
      };
      const raf=()=>requestAnimationFrame(calc); raf();
      if('ResizeObserver' in window){ const ro=new ResizeObserver(raf); header&&ro.observe(header); ticker&&ro.observe(ticker); }
      addEventListener('resize', raf, { passive:true }); addEventListener('load', raf, { once:true });
      document.addEventListener?.('htmx:afterSettle', raf);
    })();
  </script>

  <!-- P2P / UTM propagation -->
  <script {{ nonce_attr() }}>
    (() => {
      const qs = new URLSearchParams(location.search);
      const KEYS = ["ref","ref_id","peer","peer_id","peer_slug","campaign","campaign_id"];
      try{
        const incoming = Object.fromEntries(KEYS.map(k=>[k, qs.get(k)]).filter(([,v])=>v));
        if(Object.keys(incoming).length){
          localStorage.setItem("fc_ref_ctx", JSON.stringify({v:1, ttl: Date.now()+30*24*3600*1000, data: incoming}));
        }
      }catch{}
      const merged = (()=>{ const out={}; KEYS.forEach(k=>{ const v=qs.get(k); if(v) out[k]=v; });
        try{ const raw=localStorage.getItem('fc_ref_ctx'); if(raw){ const o=JSON.parse(raw); if(o?.ttl && Date.now()<=o.ttl && o.data){ for(const[k,v]of Object.entries(o.data)) if(v && !out[k]) out[k]=v; } } }catch{} return out; })();
      const addParams = (url, extra={}) => {
        try{ const u=new URL(url, location.origin); Object.entries({...merged, ...extra}).forEach(([k,v])=>{ if(v!=null&&v!=="") u.searchParams.set(k,v); }); return u.toString(); }
        catch{ const sep=url.includes('?')?'&':'?'; return url + sep + new URLSearchParams({...merged, ...extra}).toString(); }
      };
      const decorate = (root=document) => {
        root.querySelectorAll('a[href*="donate"], a[href*="sponsor"], a[data-p2p-propagate="1"]').forEach(a=>{
          const where = a.getAttribute('data-analytics-meta') || '{}';
          let medium = 'cta'; try{ const m=JSON.parse(where); if(m.where) medium = m.where; }catch{}
          a.href = addParams(a.getAttribute('href')||'#', {utm_source:"site", utm_medium: medium, utm_campaign:"fundraiser"});
          if (a.hasAttribute('data-payment-link') && !a.hasAttribute('target')) { a.target="_blank"; a.rel="nofollow noopener noreferrer"; }
        });
        root.querySelectorAll('[data-share]').forEach(btn=>{
          try{ const area = btn.closest('#site-header,#fc-hero,#footer')?.id || 'body';
            const p = JSON.parse(btn.getAttribute('data-share')||'{}');
            p.url = addParams(p.url || location.href, {utm_source:"share",utm_medium:area.replace('fc-',''),utm_campaign:"fan_share"});
            btn.setAttribute('data-share', JSON.stringify(p));
          }catch{}
        });
      };
      if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', decorate); else decorate();
    })();
  </script>

  {% if SKIN == 'shopify' %}{% include "partials/_shopify_body_include.html" ignore missing %}{% endif %}
  {% block body_scripts %}{% include "partials/starforge_patch_include.html" ignore missing with context %}{% endblock %}
  {% block extra_js %}{% endblock %}

  {% if DEBUG %}
    <!-- DEV helpers (strip in prod) -->
    <script {{ nonce_attr() }} defer src="/static/js/qrcode.min.js"></script>
    <script {{ nonce_attr() }} defer src="/static/js/hero-qr-init.js"></script>
    <script {{ nonce_attr() }} defer src="/static/js/sse-meter.js"></script>
    <script {{ nonce_attr() }} defer src="/static/js/qr-init-shim.js"></script>
  {% endif %}
</body>
</html>

